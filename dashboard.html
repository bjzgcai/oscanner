<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Engineer Skill Evaluator - LLM-Powered Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .header .badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .input-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group button {
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .input-group button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .input-group button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .note {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .repo-info {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .repo-info h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .contributors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .contributor-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .contributor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .contributor-card.active {
            border-color: #667eea;
            background: #e8eaf6;
        }

        .contributor-card .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .contributor-card .name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .contributor-card .commits {
            font-size: 0.9rem;
            color: #666;
        }

        .evaluation-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .eval-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .eval-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #667eea;
        }

        .eval-header-info h2 {
            color: #333;
            margin-bottom: 5px;
        }

        .eval-header-info .stats {
            color: #666;
            font-size: 0.95rem;
        }

        .eval-llm-badge {
            margin-left: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }

        .dimensions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .dimension-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .dimension-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .dimension-card .score {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin: 15px 0;
        }

        .dimension-card .description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
            transition: width 0.8s ease;
        }

        .reasoning-section {
            background: #e8eaf6;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .reasoning-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .reasoning-section p {
            color: #555;
            line-height: 1.6;
        }

        .commit-summary {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
        }

        .commit-summary h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .summary-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .languages-list {
            margin-top: 15px;
        }

        .language-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            margin: 5px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GitHub Engineer Skill Evaluator</h1>
            <p>LLM-Powered Six-Dimensional Engineering Capability Analysis</p>
            <div class="badge">Powered by Claude 4.5 haiku</div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <input
                    type="text"
                    id="repoUrl"
                    placeholder="Enter GitHub repository URL (e.g., https://github.com/octocat/Hello-World)"
                    value="">
                <button id="analyzeBtn" onclick="analyzeRepository()">Analyze Repository</button>
            </div>
            <div class="note">
                Enter a GitHub repository URL to analyze contributors' engineering capabilities using AI-powered commit analysis
            </div>
        </div>

        <div class="error" id="errorMessage"></div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Fetching repository data...</p>
        </div>

        <div class="results" id="results">
            <div class="repo-info" id="repoInfo">
                <h2 id="repoName"></h2>
                <p id="repoDescription"></p>
                <div class="contributors-grid" id="contributorsGrid"></div>
            </div>

            <div class="evaluation-section" id="evaluationSection" style="display: none;">
                <div class="eval-header" id="evalHeader"></div>
                <div class="chart-container">
                    <canvas id="skillsChart"></canvas>
                </div>
                <div class="dimensions-grid" id="dimensionsGrid"></div>
                <div class="reasoning-section" id="reasoningSection"></div>
            </div>

            <div class="commit-summary" id="commitSummary" style="display: none;"></div>
        </div>
    </div>

    <script>
        let API_SERVER_URL = 'http://localhost:8000';
        let repoData = null;
        let contributorsData = [];
        let currentEvaluation = null;
        let chart = null;

        const dimensions = [
            {
                name: "AI Model Full-Stack",
                key: "ai_fullstack",
                description: "AI/ML model development, training, optimization, and deployment capabilities"
            },
            {
                name: "AI Native Architecture",
                key: "ai_architecture",
                description: "AI-first system design, API architecture, and microservices patterns"
            },
            {
                name: "Cloud Native Engineering",
                key: "cloud_native",
                description: "Containerization, infrastructure as code, CI/CD, and cloud platform expertise"
            },
            {
                name: "Open Source Collaboration",
                key: "open_source",
                description: "Contribution quality, code review, issue management, and communication"
            },
            {
                name: "Intelligent Development",
                key: "intelligent_dev",
                description: "AI-assisted development, automation, testing, and development efficiency"
            },
            {
                name: "Engineering Leadership",
                key: "leadership",
                description: "Technical decision-making, optimization, security, and best practices"
            }
        ];

        async function detectApiServer() {
            const ports = [8000, 8001, 8002, 8003, 8004, 8005];
            for (const port of ports) {
                try {
                    const url = `http://localhost:${port}/health`;
                    const response = await fetch(url, { method: 'GET' });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'healthy') {
                            API_SERVER_URL = `http://localhost:${port}`;
                            console.log(`✓ API server detected at port ${port}`);
                            return true;
                        }
                    }
                } catch (e) {
                    continue;
                }
            }
            console.warn('⚠ API server not detected');
            return false;
        }

        detectApiServer();

        async function analyzeRepository() {
            const repoUrl = document.getElementById('repoUrl').value.trim();

            if (!repoUrl) {
                showError('Please enter a GitHub repository URL');
                return;
            }

            const match = repoUrl.match(/github\.com\/([^\/]+)\/([^\/]+)/);
            if (!match) {
                showError('Invalid GitHub URL format. Please use: https://github.com/username/repository');
                return;
            }

            const owner = match[1];
            const repo = match[2].replace(/\.git$/, '');

            showLoading(true, 'Fetching repository data...');
            hideError();
            hideResults();

            try {
                // Fetch commits list
                setLoadingText('Fetching commits...');
                const commitsResponse = await fetch(
                    `${API_SERVER_URL}/api/commits/${owner}/${repo}?limit=100`
                );

                if (!commitsResponse.ok) {
                    throw new Error('Failed to fetch commits');
                }

                const commitsResult = await commitsResponse.json();
                const commits = commitsResult.data;

                // Extract unique contributors
                const contributorsMap = new Map();
                for (const commit of commits) {
                    const author = commit.author;
                    const commitAuthor = commit.commit?.author;

                    if (author && author.login) {
                        if (!contributorsMap.has(author.login)) {
                            contributorsMap.set(author.login, {
                                login: author.login,
                                avatar_url: author.avatar_url,
                                name: commitAuthor?.name || author.login,
                                commits: 0
                            });
                        }
                        contributorsMap.get(author.login).commits++;
                    }
                }

                contributorsData = Array.from(contributorsMap.values())
                    .sort((a, b) => b.commits - a.commits)
                    .slice(0, 20);

                repoData = {
                    owner,
                    repo,
                    full_name: `${owner}/${repo}`,
                    url: repoUrl
                };

                displayRepoInfo();
                showResults();

                if (contributorsData.length > 0) {
                    await evaluateContributor(0);
                }

            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayRepoInfo() {
            document.getElementById('repoName').textContent = repoData.full_name;
            document.getElementById('repoDescription').textContent =
                `Analyzing ${contributorsData.length} contributors`;

            const grid = document.getElementById('contributorsGrid');
            grid.innerHTML = contributorsData.map((contributor, index) => `
                <div class="contributor-card" onclick="evaluateContributor(${index})">
                    <img src="${contributor.avatar_url}" alt="${contributor.login}" class="avatar">
                    <div class="name">${contributor.login}</div>
                    <div class="commits">${contributor.commits} commits</div>
                </div>
            `).join('');
        }

        async function evaluateContributor(index) {
            const contributor = contributorsData[index];

            // Update active state
            document.querySelectorAll('.contributor-card').forEach((card, i) => {
                card.classList.toggle('active', i === index);
            });

            showLoading(true, `Analyzing ${contributor.login}'s commits with AI...`);

            try {
                // Call evaluation API
                const response = await fetch(
                    `${API_SERVER_URL}/api/evaluate/${repoData.owner}/${repoData.repo}/${contributor.login}?limit=30`,
                    { method: 'POST' }
                );

                if (!response.ok) {
                    throw new Error('Failed to evaluate contributor');
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Evaluation failed');
                }

                currentEvaluation = result.evaluation;
                displayEvaluation(contributor, currentEvaluation);

            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayEvaluation(contributor, evaluation) {
            const section = document.getElementById('evaluationSection');
            section.style.display = 'block';

            // Header
            const header = document.getElementById('evalHeader');
            header.innerHTML = `
                <img src="${contributor.avatar_url}" alt="${contributor.login}">
                <div class="eval-header-info">
                    <h2>${contributor.login}</h2>
                    <div class="stats">
                        ${evaluation.total_commits_analyzed} commits analyzed •
                        ${evaluation.commits_summary.total_additions} additions •
                        ${evaluation.commits_summary.total_deletions} deletions
                    </div>
                </div>
                <div class="eval-llm-badge">AI-Powered Analysis</div>
            `;

            // Chart
            createChart(evaluation.scores);

            // Dimensions
            const grid = document.getElementById('dimensionsGrid');
            grid.innerHTML = dimensions.map(dim => `
                <div class="dimension-card">
                    <h4>${dim.name}</h4>
                    <div class="score">${evaluation.scores[dim.key] || 0}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${evaluation.scores[dim.key] || 0}%"></div>
                    </div>
                    <div class="description">${dim.description}</div>
                </div>
            `).join('');

            // Reasoning
            if (evaluation.scores.reasoning) {
                const reasoningSection = document.getElementById('reasoningSection');
                reasoningSection.innerHTML = `
                    <h3>AI Analysis Summary</h3>
                    <p>${evaluation.scores.reasoning}</p>
                `;
            }

            // Commit summary
            const summarySection = document.getElementById('commitSummary');
            summarySection.style.display = 'block';
            summarySection.innerHTML = `
                <h3>Contribution Summary</h3>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-value">${evaluation.total_commits_analyzed}</div>
                        <div class="summary-stat-label">Commits Analyzed</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">+${evaluation.commits_summary.total_additions}</div>
                        <div class="summary-stat-label">Lines Added</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">-${evaluation.commits_summary.total_deletions}</div>
                        <div class="summary-stat-label">Lines Deleted</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${evaluation.commits_summary.files_changed}</div>
                        <div class="summary-stat-label">Files Changed</div>
                    </div>
                </div>
                <div class="languages-list">
                    ${evaluation.commits_summary.languages.map(lang =>
                        `<span class="language-tag">${lang}</span>`
                    ).join('')}
                </div>
            `;
        }

        function createChart(scores) {
            const ctx = document.getElementById('skillsChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: dimensions.map(d => d.name),
                    datasets: [{
                        label: 'Engineering Skills',
                        data: dimensions.map(d => scores[d.key] || 0),
                        fill: true,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgb(102, 126, 234)',
                        pointBackgroundColor: 'rgb(102, 126, 234)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(102, 126, 234)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: '#ddd'
                            },
                            grid: {
                                color: '#ddd'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                stepSize: 20,
                                font: {
                                    size: 12
                                }
                            },
                            pointLabels: {
                                font: {
                                    size: 13,
                                    weight: '600'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function showLoading(show, text = 'Loading...') {
            document.getElementById('loading').classList.toggle('active', show);
            document.getElementById('analyzeBtn').disabled = show;
            if (text) {
                document.getElementById('loadingText').textContent = text;
            }
        }

        function setLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('active');
        }

        function showResults() {
            document.getElementById('results').classList.add('active');
        }

        function hideResults() {
            document.getElementById('results').classList.remove('active');
        }

        // Allow Enter key to trigger analysis
        document.getElementById('repoUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeRepository();
            }
        });
    </script>
</body>
</html>
