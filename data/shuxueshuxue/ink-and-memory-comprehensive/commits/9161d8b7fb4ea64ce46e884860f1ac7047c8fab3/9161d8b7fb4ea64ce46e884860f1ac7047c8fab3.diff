commit 9161d8b7fb4ea64ce46e884860f1ac7047c8fab3
Author: lexicalmathical <lexicalmathical@gmail.com>
Date:   Sun Nov 23 12:02:35 2025 +0800

    Guard against session id races during save

diff --git a/frontend/src/App.tsx b/frontend/src/App.tsx
index bd6c7c6..be163e2 100644
--- a/frontend/src/App.tsx
+++ b/frontend/src/App.tsx
@@ -350,12 +350,24 @@ export default function App() {
   const saveSessionToDatabase = useCallback(async (editorState: EditorState, firstLine?: string) => {
     const line = firstLine ?? getFirstLineFromState(editorState);
     const { saveSession } = await import('./api/voiceApi');
-    const sessionId = editorState.currentEntryId || crypto.randomUUID();
-    await saveSession(sessionId, editorState, line);
+    const idToSave = editorState.currentEntryId || crypto.randomUUID();
+    await saveSession(idToSave, editorState, line);
+
     if (engineRef.current) {
-      engineRef.current.setCurrentEntryId(sessionId);
+      const liveId = engineRef.current.getState().currentEntryId;
+      const snapshotId = editorState.currentEntryId;
+      const isSafeToUpdate =
+        !liveId ||
+        liveId === idToSave ||
+        (snapshotId && liveId === snapshotId);
+
+      if (isSafeToUpdate) {
+        engineRef.current.setCurrentEntryId(idToSave);
+      } else {
+        console.warn(`ðŸ›¡ï¸ Race Condition Caught: Save finished for ${idToSave}, but editor is on ${liveId}. Skipping ID reset.`);
+      }
     }
-    return sessionId;
+    return idToSave;
   }, [getFirstLineFromState]);
 
   const persistSessionImmediately = useCallback(async (editorState: EditorState) => {
@@ -791,16 +803,26 @@ export default function App() {
     if (!isAuthenticated) return;
 
     const autoSaveTimer = setTimeout(async () => {
-      const currentState = ensureStateForPersistence();
-      if (!currentState) return;
-      if (!currentState.currentEntryId) {
+      const stateSnapshot = ensureStateForPersistence();
+      if (!stateSnapshot) return;
+
+      if (engineRef.current) {
+        const liveId = engineRef.current.getState().currentEntryId;
+        const snapshotId = stateSnapshot.currentEntryId;
+        if (liveId && snapshotId && liveId !== snapshotId) {
+          console.warn(`âœ‹ Auto-save aborted: timer captured ${snapshotId} but editor is now on ${liveId}`);
+          return;
+        }
+      }
+
+      if (!stateSnapshot.currentEntryId) {
         console.error('BUG: currentEntryId should always be defined after engine init');
         return;
       }
 
       try {
-        const firstLine = getFirstLineFromState(currentState);
-        await saveSessionToDatabase(currentState, firstLine);
+        const firstLine = getFirstLineFromState(stateSnapshot);
+        await saveSessionToDatabase(stateSnapshot, firstLine);
         console.log('Auto-saved to database');
       } catch (error) {
         console.error('Auto-save failed:', error);
