commit 8bdf52a41839f01122382bdcdf515877db9b9cd5
Author: lexicalmathical <lexicalmathical@gmail.com>
Date:   Fri Nov 7 09:56:33 2025 +0800

    Refactor naming and add emotion selection overlay UX
    
    Backend changes:
    - Rename 'tagline' â†’ 'systemPrompt' for consistency across config.py, stateless_analyzer.py, server.py
    - Update startup message with accurate API endpoints after PolyCLI refactor
    - Remove legacy endpoint documentation (analyze, chat, generate-image now via /polycli/api/trigger-sync)
    
    Frontend changes:
    - Rename LeftSidebar â†’ TopNavBar (component was misnamed, actually renders as horizontal top nav)
    - Add full-screen white overlay to StateChooser with emotion selection flow:
      * Large greeting header "What's your emotion today?"
      * Interactive 3D StateCube for emotion selection
      * Smooth 800ms fade-out animation (opacity + transform)
      * Zero coupling to App.tsx (fully encapsulated in StateChooser)
    - Update CLAUDE.md with comprehensive documentation
    
    ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
    
    Co-Authored-By: Claude <noreply@anthropic.com>

diff --git a/.DS_Store b/.DS_Store
new file mode 100644
index 0000000..9ad47cc
Binary files /dev/null and b/.DS_Store differ
diff --git a/CLAUDE.md b/CLAUDE.md
index dc75cf8..74b849b 100644
--- a/CLAUDE.md
+++ b/CLAUDE.md
@@ -1,467 +1,216 @@
-# Ink & Memory - Complete Development Guide
+# CLAUDE.md
 
-## ğŸš€ Deployment to Production
+This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
 
-### Prerequisites
-- SSH access to Alibaba Cloud server (101.201.227.31)
-- SSH key at `~/Codebase/serverManagement/keys/Jeffry.pem`
-- Local development environment with Node.js and Python
-
-### Complete Deployment Process
-
-Run these commands from your local machine to deploy both frontend and backend:
-
-```bash
-# 1. Build Frontend
-cd /Users/lexicalmathical/Codebase/ink-and-memory/frontend
-npm run build
-
-# 2. Deploy Frontend
-scp -i ~/Codebase/serverManagement/keys/Jeffry.pem -r dist/* \
-  root@101.201.227.31:/var/www/lexicalmathical.com/ink-and-memory/
-
-# Fix permissions
-ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
-  "chown -R www-data:www-data /var/www/lexicalmathical.com/ink-and-memory/"
-
-# 3. Update PolyCLI (if needed)
-cd ~/Codebase/PolyCLI
-tar czf /tmp/polycli.tar.gz src/ pyproject.toml README.md
-
-scp -i ~/Codebase/serverManagement/keys/Jeffry.pem /tmp/polycli.tar.gz \
-  root@101.201.227.31:/tmp/
-
-ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 "
-  mkdir -p /tmp/PolyCLI &&
-  cd /tmp && tar xzf polycli.tar.gz -C /tmp/PolyCLI &&
-  cd /root/ink-and-memory/backend && source .venv/bin/activate &&
-  pip install --upgrade /tmp/PolyCLI/
-"
-
-# 4. Deploy Backend
-cd ~/Codebase/ink-and-memory/backend
-scp -i ~/Codebase/serverManagement/keys/Jeffry.pem *.py \
-  root@101.201.227.31:/root/ink-and-memory/backend/
-
-# 5. Restart Backend Server
-ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 "
-  tmux send-keys -t ink-and-memory:0 C-c
-  sleep 2
-  tmux send-keys -t ink-and-memory:0 'cd /root/ink-and-memory/backend && source .venv/bin/activate && python server.py' Enter
-"
-```
-
-### Verify Deployment
-
-```bash
-# Check backend is running
-ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
-  "lsof -i :8765"
+---
 
-# Check frontend files
-ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
-  "ls -lh /var/www/lexicalmathical.com/ink-and-memory/"
+## Project Overview
 
-# Test live URLs
-curl -I https://lexicalmathical.com/ink-and-memory/
-curl -s https://lexicalmathical.com/ink-and-memory/api/sessions | jq
-```
+**Ink & Memory** is a Disco Elysium-inspired journaling interface where inner voice personas comment on your writing in real-time. The system uses LLMs to generate commentary from distinct archetypes that interrupt and debate as you write.
 
-### Production URLs
-- **App**: https://lexicalmathical.com/ink-and-memory/
-- **API**: https://lexicalmathical.com/ink-and-memory/api/
-- **Control Panel**: https://lexicalmathical.com/ink-and-memory/control-panel
+**Key Innovation**: Trace-based energy accumulation system where writing builds up energy until threshold is reached, then triggers LLM analysis. Comments appear as watercolor highlights with personas commenting in the margins.
 
-## ğŸ—ï¸ Architecture
+---
 
-### Frontend (React + TypeScript + Vite)
-- **Location**: `/Users/lexicalmathical/Codebase/ink-and-memory/frontend/`
-- **Build Output**: `dist/` (generated by `npm run build`)
-- **Deployment**: Static files served by nginx from `/var/www/lexicalmathical.com/ink-and-memory/`
-- **Base Path**: `/ink-and-memory/` (configured in `vite.config.ts`)
+## Development Commands
 
 ### Backend (Python + PolyCLI)
-- **Location**: `/Users/lexicalmathical/Codebase/ink-and-memory/backend/`
-- **Server Location**: `/root/ink-and-memory/backend/` on Alibaba Cloud
-- **Port**: 8765 (proxied through nginx)
-- **Environment**: Python virtual environment at `.venv/`
-- **Managed by**: tmux session `ink-and-memory:0`
-
-### Key Configuration Files
-
-**Frontend - `vite.config.ts`:**
-```typescript
-export default defineConfig({
-  plugins: [react()],
-  base: '/ink-and-memory/',  // CRITICAL: Must match deployment path
-  server: {
-    proxy: {
-      '/ink-and-memory/api': {
-        target: 'http://localhost:8765',
-        changeOrigin: true,
-        rewrite: (path) => path.replace(/^\/ink-and-memory/, '')
-      }
-    }
-  }
-})
-```
-
-**Frontend - `src/api/voiceApi.ts`:**
-```typescript
-const API_BASE = '/ink-and-memory';  // Production: nginx proxies to backend
-```
-
-**Backend - `server.py`:**
-```python
-# Uses PolyCLI session registry
-# Runs on port 8765
-# Models configured via models.json
-```
-
-## ğŸ”§ Development
-
-### Local Development Setup
-
-**Frontend:**
-```bash
-cd frontend
-npm install
-npm run dev
-# Runs on http://localhost:5173
-```
 
-**Backend:**
 ```bash
+# Setup
 cd backend
 uv venv
-source .venv/bin/activate  # or .venv/Scripts/activate on Windows
+source .venv/bin/activate  # Windows: .venv\Scripts\activate
 
-# Install PolyCLI
+# Install PolyCLI from local development
 cd ~/Codebase/PolyCLI
 uv pip install -e .
 
 cd ~/Codebase/ink-and-memory/backend
-uv pip install beautifulsoup4 requests 'httpx[socks]'
+uv pip install beautifulsoup4 requests 'httpx[socks]' Pillow PyJWT
 
-# Create models.json with API config
+# Start server
 python server.py
 # Runs on http://localhost:8765
 ```
 
-### API Configuration
-
-Create `backend/models.json` with your API configuration.
-The backend uses PolyCLI's model configuration system.
-
----
-
-## ğŸ“ CRITICAL IMPLEMENTATION DETAILS
+### Frontend (React + TypeScript + Vite)
 
-### 1. Comment Positioning System (SCROLL-INDEPENDENT)
+```bash
+cd frontend
 
-**Problem Solved**: Comments were shifting position when scrolling then clicking on text.
+# Development
+npm install
+npm run dev
+# Runs on http://localhost:5173
 
-**Solution** (`frontend/src/App.tsx:998-1042`):
-- Use `offsetTop` (document-relative) instead of `getBoundingClientRect()` (viewport-relative)
-- Position comments relative to their cell wrapper (the div with `position: relative`)
-- Account for all padding/margins in calculation
+# Production build
+npm run build
+# Output: dist/
 
-**Key Code**:
-```typescript
-// Get textarea for this group's cell
-const cellTextarea = textareaRefs.current.get(group.cellId);
-const cellWrapper = cellTextarea.parentElement; // The div with position: relative
-const cellOffsetTop = cellWrapper.offsetTop;
+# Lint
+npm run lint
 
-// Calculate line height
-const computedStyle = window.getComputedStyle(cellTextarea);
-const fontSize = parseFloat(computedStyle.fontSize) || 18;
-const lineHeightRatio = parseFloat(computedStyle.lineHeight) / fontSize || 1.8;
-const lineHeight = fontSize * lineHeightRatio;
-
-const containerPadding = parseFloat(window.getComputedStyle(cellWrapper.parentElement || cellWrapper).paddingLeft) || 20;
-const gap = Math.max(30, window.innerWidth * 0.02);
-const leftPosition = containerPadding + group.maxLineWidth + gap;
-
-// @@@ CRITICAL: Position using offsetTop (scroll-independent)
-// - cellOffsetTop: position relative to content container
-// - 20px: scroll container padding (line 884)
-// - 24px: StateChooser marginBottom (line 892)
-// - subtract 0.7 lineHeight: fine-tuned vertical alignment after iterative testing
-const topPosition = cellOffsetTop + group.centerY + 20 + 24 - (lineHeight * 0.7);
+# Preview production build
+npm preview
 ```
 
-**Why 0.7 lineHeight?** After iterative testing:
-- 1.0 lineHeight: too far up
-- 0.5 lineHeight: too far down
-- 0.7 lineHeight: perfect alignment âœ…
+---
 
-### 2. Browser Auto-Scroll Prevention
+## Architecture Deep Dive
 
-**Problem**: Browser was auto-scrolling element into view on focus, causing "lift up" effect.
+### Core Data Flow
 
-**Solution** (`frontend/src/App.tsx:952-956`):
-```typescript
-onFocus={(e) => {
-  // @@@ Prevent browser from scrolling element into view on focus
-  // This stops the "lift up" effect when clicking after scrolling
-  e.preventDefault();
-}}
 ```
-
-### 3. Scroll Smoothness Fix
-
-**Problem**: "Stuck zones" at top and bottom where you had to scroll twice to reach true edges.
-
-**Root Cause**: Fixed stats bar (41px) at bottom not accounted for in outer container height.
-
-**Solution** (`frontend/src/App.tsx:787-794`):
-```typescript
-<div style={{
-  display: 'flex',
-  height: '100vh',
-  paddingTop: isMobile ? '0' : '48px',
-  paddingBottom: '41px',  // @@@ Space for fixed stats bar at bottom
-  fontFamily: 'system-ui, -apple-system, sans-serif',
-  boxSizing: 'border-box'  // @@@ CRITICAL: Include padding in height calculation
-}}>
+User types â†’ Weight accumulates â†’ Threshold (40 energy) â†’ Backend analysis
+         â†“                                                         â†“
+    EditorEngine                                    PolyCLI session function
+         â†“                                                         â†“
+  Apply comment â†’ Collision detection â†’ Highlight phrase in cell
 ```
 
-### 4. Comment Grouping by 2-Row Blocks
+### Critical Components
 
-**Algorithm** (`frontend/src/App.tsx:238-349`):
-- Calculate visual line numbers for each character (accounting for word wrap)
-- Group comments by 2-line blocks: `blockIndex = Math.floor(visualLineNumber / 2)`
-- Calculate max line width for the 2-line block
-- Position comment at vertical center: `centerY = (visualLineStart + 1) * lineHeight`
-- Create unique group key per cell: `${cell.id}-${blockIndex}`
+#### 1. EditorEngine (`frontend/src/engine/EditorEngine.ts`)
 
-**Why 2-row blocks?** Keeps comments aligned with natural reading flow without overwhelming the right margin.
+**Purpose**: Single source of truth for editor state. Manages cells, commentors, energy accumulation.
 
-### 5. Comment Box Dynamic Width (Latest Change)
+**Key patterns**:
+- **Weight function** (`computeWeight`): CJK chars = 2, sentence endings = 4, Chinese comma = 0, other = 1
+- **Energy accumulation**: `delta = max(0, currentWeight - lastWeight)`, only positive deltas add energy
+- **Collision detection**: Before applying comment, check if phrase overlaps with existing highlights
+- **Cells system**: Editor content is an array of cells (text cells + widget cells like chat)
 
-**Evolution**:
-- **Before**: Fixed `maxWidth: 400px`, `height: 54px`, ellipsis cutoff after 3 lines
-- **Now** (`frontend/src/App.tsx:145-244`):
-  - `maxWidth: 600px` - wider expansion before wrapping
-  - `minHeight: 54px` - vertical expansion allowed
-  - `WebkitLineClamp: 3` - show up to 3 full lines
-  - `wordWrap: 'break-word'` - wrap instead of ellipsis
+**@@@ Critical**: When programmatically inserting text (e.g., quoting a comment), you MUST update the baseline weight to prevent false energy accumulation:
 
 ```typescript
-<div style={{
-  minWidth: '200px',
-  maxWidth: '600px',  // @@@ Increased from 400px
-  minHeight: '54px',  // @@@ Changed from fixed height
-  // ... other styles
-}}>
-  <div style={{
-    flex: 1,
-    wordWrap: 'break-word',
-    overflowWrap: 'break-word',
-    display: '-webkit-box',
-    WebkitLineClamp: 3,  // @@@ Show up to 3 lines
-    WebkitBoxOrient: 'vertical',
-    overflow: 'hidden'
-  }}>
-    <strong>{voice}:</strong> {comment}
-  </div>
-</div>
+setTimeout(() => {
+  lastPollWeightRef.current = getWeightedLength(currentTextRef.current);
+}, 0);
 ```
 
-### 6. Energy Pool Trigger System
+#### 2. Voice Analysis System (`backend/stateless_analyzer.py`)
 
-**Location**: `frontend/src/App.tsx` (useEffect polling logic)
+**Stateless design**: Receives applied comments, returns ONE new comment (gradual accumulation).
 
-**How it works**:
-1. Poll every 5 seconds
-2. Calculate weighted character count: `getWeightedLength(text)`
-3. Compare with previous poll: `weightChange = currentWeight - lastWeight`
-4. If `weightChange > 0`: accumulate energy
-5. If `energy >= 40`: trigger backend analysis, consume 40 energy
-6. Preserve remainder energy for next trigger
+**Key features**:
+- **Explicit overlap avoidance**: Prompt shows LLM all existing highlighted phrases + rejected phrases
+- **Voice ID system**: LLM returns `voice_id` (e.g., "holder"), backend auto-fills display name from config
+- **Language matching**: LLM writes comments in same language as input text
+- **Structured output**: Uses Pydantic schema for reliable JSON parsing
 
-**Weighting System**:
-```typescript
-function getWeightedLength(text: string): number {
-  let weight = 0;
-  for (let i = 0; i < text.length; i++) {
-    const char = text[i];
-    const code = char.charCodeAt(0);
-
-    // CJK characters: 2 weight
-    if ((code >= 0x4E00 && code <= 0x9FFF) ||
-        (code >= 0x3400 && code <= 0x4DBF) ||
-        (code >= 0x3040 && code <= 0x309F) ||
-        (code >= 0x30A0 && code <= 0x30FF)) {
-      weight += 2;
-    }
-    // Sentence endings: 4 weight
-    else if ('.!?ã€‚ï¼ï¼Ÿ\n'.includes(char)) {
-      weight += 4;
-    }
-    // Chinese comma: 0 weight (ignored)
-    else if (char === 'ï¼Œ') {
-      weight += 0;
-    }
-    // Other characters: 1 weight
-    else {
-      weight += 1;
-    }
-  }
-  return weight;
-}
-```
+**@@@ Important**: The prompt explicitly tells LLM to extract phrases ONLY from "TEXT TO ANALYZE" section, NOT from conversation context.
 
-**@@@ Quote Weight Hack (CRITICAL NON-OBVIOUS PATTERN)**:
+#### 3. Authentication & Database (`backend/auth.py`, `backend/database.py`)
 
-When user quotes a voice comment, the quoted text gets inserted into editor. Without special handling, this would count as "new text" and accumulate energy, triggering unwanted analysis.
+**JWT-based auth**:
+- Users register/login â†’ receive JWT token
+- Frontend stores token in localStorage
+- All API calls to `/polycli/api/trigger-sync` include `Authorization: Bearer <token>` header
+- PolyCLI middleware extracts user_id from token, injects into session params
 
-**Solution** (must be called after quote insertion):
-```typescript
-setTimeout(() => {
-  lastPollWeightRef.current = getWeightedLength(currentTextRef.current);
-  console.log(`ğŸ“ Quote inserted, updated baseline weight to ${lastPollWeightRef.current}`);
-}, 0);
-```
+**Database schema**:
+- `users` - email, password_hash, display_name
+- `sessions` - editor_state (JSON), user_id, session_id
+- `daily_pictures` - base64 images, thumbnails, prompts
+- `preferences` - voice_configs, meta_prompt, state_config, selected_state
+- `analysis_reports` - echoes/traits/patterns analysis results
 
-This "moves the baseline forward" so next poll sees zero weight change from the quote.
+**@@@ Migration system**: First-time login shows migration dialog to import localStorage data to database.
 
-**Why `setTimeout(..., 0)`?** Ensures we wait for editor's `handleTextChange` to update `currentTextRef.current` first (event loop microtask ordering).
+#### 4. PolyCLI Integration
 
-### 7. LLM Prompt for Comment Generation
+**Session definitions** (`@session_def` in `backend/server.py`):
 
-**Location**: `backend/stateless_analyzer.py:19-137`
+```python
+@session_def(name="Analyze Voices", params={...})
+def analyze_text(text: str, session_id: str, user_id: int, applied_comments: list, ...):
+    # user_id injected by auth middleware
+    # Loads voice configs from database using user_id
+    prefs = database.get_preferences(user_id)
+    voices = prefs['voice_configs'] or config.VOICE_ARCHETYPES
+    # ...
+```
 
-**CRITICAL: Explicit Overlap Avoidance** (added after user request):
+**Frontend calls**:
+```typescript
+fetch(`${API_BASE}/polycli/api/trigger-sync`, {
+  method: 'POST',
+  headers: {
+    'Authorization': `Bearer ${token}`
+  },
+  body: JSON.stringify({
+    session_id: 'analyze_voices',  // Matches @session_def name
+    params: { text, session_id, applied_comments, ... },
+    timeout: 60
+  })
+})
+```
 
-The prompt now explicitly shows already highlighted phrases and instructs LLM not to overlap:
+**Response format**: `{success: true, result: {...}}` or `{success: false, error: "..."}`
 
-```python
-# Build list of applied comments with their phrases
-existing_summary = ""
-highlighted_phrases = []
-if applied_comments:
-    existing_summary = "\n\nALREADY APPLIED COMMENTS (do not repeat or overlap with these):\n"
-    for c in applied_comments:
-        phrase = c.get('phrase', '')
-        highlighted_phrases.append(phrase)
-        existing_summary += f"- {c.get('voice', 'Unknown')} on \"{phrase}\": {c.get('comment', '')}\n"
-    existing_summary += f"\nğŸ‘‰ These phrases are already highlighted: {highlighted_phrases}\n"
-    existing_summary += "ğŸ‘‰ Choose a DIFFERENT phrase that does NOT overlap with any of these!\n"
-
-prompt = f"""You are analyzing internal dialogue as distinct inner voice personas.
-
-Analyze this text and identify ONE NEW voice that wants to comment:
-
-"{text}"
-
-Available voice personas (ONLY use these):
-{voice_list}
-{existing_summary}
-
-Find ONE NEW voice to comment:
-1. Extract a SHORT phrase (2-6 words) that triggered it - MUST be EXACT text from above
-2. Choose a voice persona from the available list
-3. Write what this voice is saying (1-2 sentences)
-
-RULES:
-- Return ONLY ONE comment
-- DO NOT repeat any applied comments
-- DO NOT choose phrases that overlap or intersect with already highlighted phrases
-- Your chosen phrase must be completely separate from existing highlights
-- DO NOT CREATE NEW VOICE NAMES - Only use from the available list
-- Return null if nothing is worth commenting on
-- Phrase MUST be EXACT substring from text
-- Only comment on complete sentences (ending with .!?ã€‚ï¼ï¼Ÿ)
-- Write in the SAME LANGUAGE as the text"""
-```
+---
 
-**Why explicit list matters**: LLMs need upfront context to avoid overlapping. Showing the exact list of highlighted phrases prevents collisions.
+## Key Implementation Patterns
 
-### 8. Collision Detection in Engine
+### Pattern 1: Energy Pool System
 
-**Location**: `frontend/src/engine/EditorEngine.ts` (applyVoiceComment method)
+**Problem**: How to trigger LLM analysis without constant polling waste?
 
-The engine filters out comments whose phrases overlap with existing highlights:
+**Solution**: Track weight changes over time, accumulate only positive deltas as energy:
 
 ```typescript
-applyVoiceComment(comment: Commentor) {
-  // Check for collision with existing highlights
-  const text = this.getFullText();
-  const existingHighlights = this.state.commentors
-    .filter(c => c.appliedAt)
-    .map(c => {
-      const index = text.toLowerCase().indexOf(c.phrase.toLowerCase());
-      return { start: index, end: index + c.phrase.length };
-    })
-    .filter(h => h.start !== -1);
-
-  const newIndex = text.toLowerCase().indexOf(comment.phrase.toLowerCase());
-  if (newIndex === -1) return;
-
-  const newStart = newIndex;
-  const newEnd = newIndex + comment.phrase.length;
-
-  // Check for overlap
-  const hasCollision = existingHighlights.some(h =>
-    (newStart >= h.start && newStart < h.end) ||
-    (newEnd > h.start && newEnd <= h.end) ||
-    (newStart <= h.start && newEnd >= h.end)
-  );
-
-  if (hasCollision) {
-    console.log(`âš ï¸ Collision detected for "${comment.phrase}", skipping`);
-    return;
-  }
-
-  // Apply comment...
+// In App.tsx, every 5 seconds:
+const currentWeight = computeWeight(allText);
+const delta = Math.max(0, currentWeight - lastPollWeightRef.current);
+energyRef.current += delta;
+
+if (energyRef.current >= 40 && !isAnalyzing) {
+  // Trigger backend analysis
+  energyRef.current -= 40;  // Consume energy, preserve remainder
 }
+
+lastPollWeightRef.current = currentWeight;
 ```
 
-### 9. Font Loading Strategy (FOIT Prevention)
+**@@@ Quote weight hack**: When quoting a voice comment, the quoted text gets inserted but should NOT count as "new writing". Solution: immediately update baseline after insertion.
 
-**Problem**: Flash of Invisible Text while fonts load.
+### Pattern 2: Collision Detection (Two-Layer Defense)
 
-**Solution** (`frontend/index.html` + `frontend/src/App.css`):
+**Layer 1 (Backend LLM prompt)**: Show LLM all existing highlighted phrases + rejected phrases
 
-```html
-<!-- index.html: Preload critical fonts -->
-<link rel="preload" href="/Excalifont-Regular.woff2" as="font" type="font/woff2" crossorigin />
-<link rel="preload" href="/Xiaolai-Regular.ttf" as="font" type="font/ttf" crossorigin />
+```python
+conversation_context += f"âš ï¸ Already highlighted: {highlighted_phrases}\n"
+rejected_section += f"âœ— '{phrase}' - REJECTED, do NOT suggest again\n"
 ```
 
-```css
-/* App.css: Use font-display: swap */
-@font-face {
-  font-family: 'Excalifont';
-  src: url('/Excalifont-Regular.woff2') format('woff2');
-  font-display: swap;  /* Show fallback immediately, swap when loaded */
-  unicode-range: U+0000-00FF, U+0100-017F, U+0180-024F, U+1E00-1EFF, U+2000-206F, U+20A0-20CF, U+2100-214F;
-}
+**Layer 2 (Frontend engine)**: Before applying comment, check for overlap:
 
-@font-face {
-  font-family: 'Xiaolai';
-  src: url('/Xiaolai-Regular.ttf') format('truetype');
-  font-display: swap;
-  unicode-range: U+4E00-9FFF, U+3400-4DBF, U+20000-2A6DF, U+F900-FAFF, U+3000-303F;
+```typescript
+const hasCollision = existingHighlights.some(h =>
+  (newStart >= h.start && newStart < h.end) ||
+  (newEnd > h.start && newEnd <= h.end) ||
+  (newStart <= h.start && newEnd >= h.end)
+);
+
+if (hasCollision) {
+  // Add to overlappedPhrases, send as feedback on next analysis
+  return;
 }
 ```
 
-**Why unicode-range?** Browser only downloads font if page uses characters in that range. Excalifont for Latin, Xiaolai for CJK.
-
-### 10. Per-Cell Text State Management (IME Composition)
+**Why two layers?** LLMs are not 100% reliable, so frontend provides safety net.
 
-**Problem**: Chinese/Japanese IME composition causing flickering and incorrect state updates.
+### Pattern 3: Per-Cell State Management
 
-**Solution** (`frontend/src/App.tsx:449-513`):
+**Why?** Multi-cell editor with IME composition (Chinese/Japanese input) requires careful state isolation.
 
 ```typescript
 // Track local text per cell ID
 const [localTexts, setLocalTexts] = useState<Map<string, string>>(new Map());
 const [composingCells, setComposingCells] = useState<Set<string>>(new Set());
 
-const handleTextChange = useCallback((cellId: string, newText: string) => {
+const handleTextChange = (cellId: string, newText: string) => {
   setLocalTexts(prev => {
     const next = new Map(prev);
     next.set(cellId, newText);
@@ -469,450 +218,373 @@ const handleTextChange = useCallback((cellId: string, newText: string) => {
   });
 
   // Only update engine if NOT composing
-  if (!composingCells.has(cellId) && engineRef.current) {
+  if (!composingCells.has(cellId)) {
     engineRef.current.updateTextCell(cellId, newText);
   }
-}, [composingCells]);
+};
 
-const handleCompositionStart = useCallback((cellId: string) => {
-  setComposingCells(prev => new Set(prev).add(cellId));
-}, []);
+const handleCompositionEnd = (cellId: string, e: CompositionEvent) => {
+  // Commit to engine only after composition finishes
+  engineRef.current.updateTextCell(cellId, e.currentTarget.value);
+};
+```
 
-const handleCompositionEnd = useCallback((cellId: string, e: React.CompositionEvent<HTMLTextAreaElement>) => {
-  setComposingCells(prev => {
-    const next = new Set(prev);
-    next.delete(cellId);
-    return next;
-  });
+**@@@ Critical**: Never use array indices to track cells. Always use cell IDs (UUIDs).
 
-  const newText = e.currentTarget.value;
-  setLocalTexts(prev => {
-    const next = new Map(prev);
-    next.set(cellId, newText);
-    return next;
-  });
+### Pattern 4: Voice Configuration Hierarchy
 
-  if (engineRef.current) {
-    engineRef.current.updateTextCell(cellId, newText);
-  }
-}, []);
+**Three sources** (in priority order):
+
+1. **User's custom configs** (stored in database `preferences` table)
+2. **Default archetypes** (`backend/config.py` â†’ `VOICE_ARCHETYPES`)
+3. **Fallback** (if voice_id not found)
+
+```python
+# Backend loads from database
+prefs = database.get_preferences(user_id)
+voice_configs = prefs['voice_configs'] if prefs else None
+
+# Lookup specific voice
+if voice_id in voice_configs:
+    voice_config = voice_configs[voice_id]
+else:
+    # Fall back to default
+    voice_config = config.VOICE_ARCHETYPES.get(voice_id, {...})
 ```
 
-**Why separate local state?** During IME composition, we don't want to trigger engine updates (which would cause re-render and lose composition state). Only commit to engine on composition end.
+**Frontend never sends voice configs** - backend loads from database using `user_id` from JWT.
 
-### 11. Cursor-Based Comment Navigation
+### Pattern 5: Scroll-Independent Positioning
 
-**Desktop**: Show comment in right margin when cursor is in highlighted phrase (`frontend/src/App.tsx:392-447`)
+**Problem**: Comments were shifting when user scrolled then clicked.
 
-**Mobile**: Show popup at bottom when cursor is in highlighted phrase (`frontend/src/App.tsx:1044-1084`)
+**Solution**: Use `offsetTop` (document-relative) instead of `getBoundingClientRect()` (viewport-relative):
 
 ```typescript
-useEffect(() => {
-  if (!state || !cursorCellId) return;
-
-  const cell = state.cells.find(c => c.id === cursorCellId);
-  if (!cell || cell.type !== 'text') return;
-
-  const cellText = (cell as TextCell).content;
-  const appliedComments = state.commentors.filter(c => c.appliedAt);
-
-  // Find comment at cursor position
-  let foundComment: Commentor | null = null;
-  for (const comment of appliedComments) {
-    const index = cellText.toLowerCase().indexOf(comment.phrase.toLowerCase());
-    if (index !== -1) {
-      const start = index;
-      const end = index + comment.phrase.length;
-
-      if (cursorPosition >= start && cursorPosition <= end) {
-        foundComment = comment;
-        break;
-      }
-    }
-  }
-
-  // Mobile: Set active comment for popup
-  if (isMobile) {
-    setMobileActiveComment(foundComment);
-  }
+const cellWrapper = cellTextarea.parentElement; // The div with position: relative
+const cellOffsetTop = cellWrapper.offsetTop;
 
-  // Desktop: Navigate to comment in group
-  if (!isMobile && foundComment) {
-    commentGroups.forEach((group, groupKey) => {
-      if (group.cellId !== cursorCellId) return;
-
-      const commentIndex = group.comments.findIndex(c => c.id === foundComment!.id);
-      if (commentIndex !== -1) {
-        setGroupPages(prev => {
-          const next = new Map(prev);
-          if (next.get(groupKey) !== commentIndex) {
-            next.set(groupKey, commentIndex);
-          }
-          return next;
-        });
-      }
-    });
-  }
-}, [cursorPosition, cursorCellId, state, commentGroups, isMobile]);
+// Position using offsetTop (scroll-independent)
+const topPosition = cellOffsetTop + group.centerY + containerPadding + stateChooserHeight - (lineHeight * 0.7);
 ```
 
-### 12. Agent Chat Widget System
+**Why 0.7 lineHeight?** Iteratively tested: 1.0 = too far up, 0.5 = too far down, 0.7 = perfect alignment.
 
-**Trigger**: Type `@` in text â†’ dropdown appears
+---
 
-**Components**:
-- `AgentDropdown` (`frontend/src/components/AgentDropdown.tsx`) - voice selection dropdown
-- `ChatWidget` (`frontend/src/engine/ChatWidget.ts`) - data model for chat widget
-- `ChatWidgetUI` (`frontend/src/components/ChatWidgetUI.tsx`) - UI component
+## Database-First Architecture (Recent Refactor)
 
-**Flow**:
-1. User types `@` â†’ dropdown shows available voices
-2. User selects voice â†’ `ChatWidget` created and inserted as cell
-3. User sends message â†’ backend `/api/chat` endpoint called with:
-   - Voice config
-   - Conversation history
-   - Current message
-   - **All text from all text cells** (unified context)
-   - Meta prompt (optional)
-   - State prompt (optional, from StateChooser)
-4. Response displayed in chat widget
+**Before**: Frontend sent voice configs in every API call, used localStorage
 
-**Key Code** (`frontend/src/App.tsx:630-684`):
-```typescript
-const handleChatSend = useCallback(async (widgetId: string, message: string) => {
-  const widgetCell = state.cells.find(c => c.type === 'widget' && c.id === widgetId);
-  const widgetData = widgetCell.data as ChatWidgetData;
-  const chatWidget = ChatWidget.fromData(widgetData);
-
-  // Add user message optimistically
-  chatWidget.addUserMessage(message);
-  engineRef.current.updateWidgetData(widgetId, chatWidget.getData());
-
-  setChatProcessing(prev => new Set(prev).add(widgetId));
-
-  try {
-    // Get ALL text from all text cells as unified context
-    const allText = state.cells
-      .filter(c => c.type === 'text')
-      .map(c => (c as TextCell).content)
-      .join('');
-
-    const metaPrompt = getMetaPrompt();
-    const statePrompt = selectedState && stateConfig.states[selectedState]
-      ? stateConfig.states[selectedState].prompt
-      : '';
-
-    const response = await chatWithVoice(
-      widgetData.voiceConfig.name,  // Use display name, not key
-      widgetData.voiceConfig,
-      chatWidget.getConversationHistory().slice(0, -1),
-      message,
-      allText,
-      metaPrompt,
-      statePrompt
-    );
-
-    chatWidget.addAssistantMessage(response);
-    engineRef.current.updateWidgetData(widgetId, chatWidget.getData());
-  } catch (error) {
-    console.error('Chat failed:', error);
-    chatWidget.addAssistantMessage('Sorry, I encountered an error.');
-    engineRef.current.updateWidgetData(widgetId, chatWidget.getData());
-  } finally {
-    setChatProcessing(prev => {
-      const next = new Set(prev);
-      next.delete(widgetId);
-      return next;
-    });
-  }
-}, [state, selectedState, stateConfig]);
-```
+**After**:
+- Voice configs stored in database `preferences.voice_configs`
+- Backend loads configs using `user_id` from JWT token
+- Frontend only sends `voice_id` (e.g., "holder"), backend looks up full config
+- localStorage only used for unauthenticated draft mode
 
-### 13. State Chooser System
+**Migration path**:
+1. User logs in for first time
+2. Frontend shows migration dialog
+3. Calls `/api/import-local-data` with localStorage export
+4. Backend imports sessions/pictures/preferences/reports to database
+5. Sets `first_login_completed` flag
 
-**Purpose**: User selects emotional state â†’ influences LLM analysis
+---
 
-**Components**:
-- `StateChooser` (`frontend/src/components/StateChooser.tsx`) - UI component
-- State config stored in localStorage (`state-config` key)
-- Selected state stored in localStorage (`selected-state` key)
+## File Organization
+
+```
+ink-and-memory/
+â”œâ”€â”€ backend/
+â”‚   â”œâ”€â”€ server.py              # FastAPI app + PolyCLI session definitions
+â”‚   â”œâ”€â”€ stateless_analyzer.py  # LLM prompt + analysis logic
+â”‚   â”œâ”€â”€ config.py              # Voice archetypes + model config
+â”‚   â”œâ”€â”€ auth.py                # JWT token creation/verification
+â”‚   â”œâ”€â”€ database.py            # SQLite operations
+â”‚   â”œâ”€â”€ proxy_config.py        # GFW bypass for API calls
+â”‚   â””â”€â”€ prompts/               # Voice persona system prompts
+â”‚       â”œâ”€â”€ holder.md
+â”‚       â”œâ”€â”€ unpacker.md
+â”‚       â””â”€â”€ ...
+â”‚
+â””â”€â”€ frontend/
+    â”œâ”€â”€ src/
+    â”‚   â”œâ”€â”€ App.tsx            # Main application component
+    â”‚   â”‚                      # - Energy polling system
+    â”‚   â”‚                      # - Comment positioning logic
+    â”‚   â”‚                      # - Per-cell state management
+    â”‚   â”‚
+    â”‚   â”œâ”€â”€ engine/
+    â”‚   â”‚   â”œâ”€â”€ EditorEngine.ts    # Core state management + collision detection
+    â”‚   â”‚   â””â”€â”€ ChatWidget.ts      # Chat widget data model
+    â”‚   â”‚
+    â”‚   â”œâ”€â”€ components/
+    â”‚   â”‚   â”œâ”€â”€ VoiceSettings.tsx  # Voice persona CRUD
+    â”‚   â”‚   â”œâ”€â”€ StateChooser.tsx   # Emotional state selector
+    â”‚   â”‚   â”œâ”€â”€ AgentDropdown.tsx  # @ voice selection dropdown
+    â”‚   â”‚   â”œâ”€â”€ ChatWidgetUI.tsx   # Chat widget UI
+    â”‚   â”‚   â”œâ”€â”€ CalendarPopup.tsx  # Calendar for saving/loading entries
+    â”‚   â”‚   â”œâ”€â”€ AnalysisView.tsx   # Echoes/traits/patterns analysis
+    â”‚   â”‚   â””â”€â”€ ...
+    â”‚   â”‚
+    â”‚   â”œâ”€â”€ api/
+    â”‚   â”‚   â””â”€â”€ voiceApi.ts        # Backend API calls
+    â”‚   â”‚
+    â”‚   â”œâ”€â”€ contexts/
+    â”‚   â”‚   â””â”€â”€ AuthContext.tsx    # JWT token management
+    â”‚   â”‚
+    â”‚   â””â”€â”€ utils/
+    â”‚       â”œâ”€â”€ voiceStorage.ts    # localStorage utilities
+    â”‚       â”œâ”€â”€ calendarStorage.ts # Calendar entry management
+    â”‚       â””â”€â”€ textNormalize.ts   # Case-insensitive phrase matching
+    â”‚
+    â””â”€â”€ vite.config.ts         # CRITICAL: base: '/ink-and-memory/'
+```
 
-**Integration Points**:
-1. **Voice comment analysis**: State prompt appended to LLM prompt
-2. **Chat widget**: State prompt included in context
+---
 
-**Key Code** (`frontend/src/App.tsx:530-533`):
+## Common Development Tasks
+
+### Adding a New Voice Persona
+
+1. Create prompt file: `backend/prompts/new_voice.md`
+2. Add to `backend/config.py`:
+   ```python
+   VOICE_ARCHETYPES = {
+       "new_voice": {
+           "name": "Display Name",
+           "tagline": _load_prompt("new_voice.md"),
+           "icon": "brain",  # Must be from icon list
+           "color": "blue"   # Must be from color list
+       }
+   }
+   ```
+3. Icon options: brain, heart, question, cloud, masks, eye, fist, lightbulb, shield, wind, fire, compass
+4. Color options: blue, pink, yellow, green, purple
+
+### Adding a New PolyCLI Session
+
+1. Define in `backend/server.py`:
+   ```python
+   @session_def(
+       name="Your Session Name",
+       description="What it does",
+       params={"param1": {"type": "str"}, ...},
+       category="Category"
+   )
+   def your_function(param1: str, user_id: int):
+       # user_id is auto-injected by auth middleware
+       # ...
+       return {"result": "..."}
+   ```
+
+2. Call from frontend:
+   ```typescript
+   const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
+
+   const response = await fetch(`${API_BASE}/polycli/api/trigger-sync`, {
+     method: 'POST',
+     headers: {
+       'Authorization': `Bearer ${token}`,
+       'Content-Type': 'application/json'
+     },
+     body: JSON.stringify({
+       session_id: 'your_session_name',  // Lowercase snake_case
+       params: { param1: "value" },
+       timeout: 60
+     })
+   });
+
+   const data = await response.json();
+   if (data.success) {
+     // Use data.result
+   }
+   ```
+
+### Debugging Energy System
+
+Check energy accumulation in browser console:
+```
+Energy accumulated: +5 (total: 12/40)
+```
+
+Check weight calculation:
 ```typescript
-const handleStateChoose = useCallback((stateId: string) => {
-  setSelectedState(stateId);
-  localStorage.setItem('selected-state', stateId);
-}, []);
+console.log('Weight:', computeWeight(text));
+console.log('Delta:', currentWeight - lastWeight);
 ```
 
-### 14. Mobile Optimizations
+Check backend logs for LLM calls:
+```
+ğŸ¯ Stateless analyze_text() called
+   Text: ...
+   Applied comments: 3
+```
 
-**Differences from desktop**:
-1. **No left sidebar** - hidden on mobile
-2. **Floating toolbar** - top right corner (Start Fresh + Insert Agent)
-3. **Comment popup** - bottom of screen instead of right margin
-4. **No horizontal scroll** - `overflowX: 'hidden'`, `touchAction: 'pan-y'`
+### Testing Collision Detection
 
-**Detection** (`frontend/src/utils/mobileDetect.ts`):
-```typescript
-export function useMobile(): boolean {
-  const [isMobile, setIsMobile] = useState(false);
+1. Write text with multiple distinct phrases
+2. Wait for first comment to appear (energy >= 40)
+3. Continue writing
+4. Check if new comments avoid overlapping with existing highlights
+5. Check console for:
+   ```
+   âš ï¸ Collision detected for "phrase", skipping
+   ```
 
-  useEffect(() => {
-    const checkMobile = () => {
-      setIsMobile(window.innerWidth < 768);
-    };
+---
 
-    checkMobile();
-    window.addEventListener('resize', checkMobile);
-    return () => window.removeEventListener('resize', checkMobile);
-  }, []);
+## Important Patterns to Remember
 
-  return isMobile;
-}
-```
+### @@@ Comment Format
+Use `@@@title - explanation` format for tricky code sections to enable easy navigation:
 
-### 15. Voice Settings System
+```typescript
+// @@@ Quote Weight Hack - prevent false energy accumulation
+setTimeout(() => {
+  lastPollWeightRef.current = getWeightedLength(currentTextRef.current);
+}, 0);
+```
 
-**Location**: `frontend/src/components/VoiceSettings.tsx`
+### Minimal Implementation Principle
+- Code is expensive (buys features with complexity)
+- Prefer simple solutions over defensive edge cases
+- Show what's there, don't guess (print-based debugging)
 
-**Features**:
-- Add/Edit/Delete voice personas
-- Import/Export JSON configuration
-- Reset to defaults (from backend)
-- Text-based icon/color selection (not emoji/hex pickers)
+### Authentication Headers
+All `/polycli/api/trigger-sync` calls MUST include:
+```typescript
+headers: {
+  'Authorization': `Bearer ${token}`
+}
+```
 
-**Storage**: localStorage (`voice-configs` key)
+### Response Format Pattern
+PolyCLI always returns:
+```typescript
+{
+  success: true,
+  result: {...}  // Your data here
+}
+// or
+{
+  success: false,
+  error: "Error message"
+}
+```
 
-**Icon Options**: brain, heart, question, cloud, masks, eye, fist, lightbulb, shield, wind, fire, compass
+Always check `data.success` before accessing `data.result`.
 
-**Color Options**: blue, pink, yellow, green, purple
+---
 
-**Integration**: Voice configs passed to EditorEngine and used in backend API calls
+## Deployment to Production
 
----
+**Server**: Alibaba Cloud (101.201.227.31)
+**SSH Key**: `~/Codebase/serverManagement/keys/Jeffry.pem`
+**Live URL**: https://lexicalmathical.com/ink-and-memory/
 
-## ğŸ› Known Issues & Troubleshooting
+### Full Deployment Process
 
-### Frontend not updating after deployment
 ```bash
-# Clear browser cache (Cmd+Shift+R on Mac)
-# OR rebuild from scratch:
-cd frontend
-rm -rf dist/
+# 1. Build frontend
+cd ~/Codebase/ink-and-memory/frontend
 npm run build
-# Redeploy...
-```
 
-### Backend API returns 502 Bad Gateway
-```bash
-# Check if backend is running
-ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
-  "lsof -i :8765"
+# 2. Deploy frontend
+scp -i ~/Codebase/serverManagement/keys/Jeffry.pem -r dist/* \
+  root@101.201.227.31:/var/www/lexicalmathical.com/ink-and-memory/
 
-# View backend logs
+# 3. Fix permissions
 ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
-  "tmux attach -t ink-and-memory:0"
+  "chown -R www-data:www-data /var/www/lexicalmathical.com/ink-and-memory/"
 
-# Restart backend (see deployment commands above)
-```
+# 4. Deploy backend
+cd ~/Codebase/ink-and-memory/backend
+scp -i ~/Codebase/serverManagement/keys/Jeffry.pem *.py \
+  root@101.201.227.31:/root/ink-and-memory/backend/
 
-### PolyCLI updates not taking effect
-```bash
-# Ensure you're updating the correct virtual environment
-# Redeploy PolyCLI and restart backend completely
+# 5. Restart backend (running in tmux session 'ink-and-memory')
+ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 "
+  tmux send-keys -t ink-and-memory:0 C-c
+  sleep 2
+  tmux send-keys -t ink-and-memory:0 'cd /root/ink-and-memory/backend && source .venv/bin/activate && python server.py' Enter
+"
 ```
 
-### Comments not appearing
-1. Check backend logs for LLM errors
-2. Verify energy >= 40 (see stats bar at bottom)
-3. Check if text has complete sentences (ends with .!?ã€‚ï¼ï¼Ÿ)
-4. Verify voice configs are enabled in settings
-
-### Highlights overlapping
-- LLM prompt explicitly shows existing phrases
-- Engine has collision detection as backup
-- If still happening: check LLM model quality
-
----
-
-## ğŸ“Š Monitoring
-
-### Check Backend Logs
+**Verification**:
 ```bash
+# Check backend is running
 ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
-  "tmux capture-pane -t ink-and-memory:0 -p | tail -50"
-```
+  "lsof -i :8765"
 
-### Check Active Sessions
-```bash
+# Test live API
 curl -s https://lexicalmathical.com/ink-and-memory/api/sessions | jq
 ```
 
-### Check Server Status
-```bash
-ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 "
-  echo '=== Backend Process ==='
-  lsof -i :8765
-
-  echo -e '\n=== nginx Status ==='
-  systemctl status nginx --no-pager | head -5
-
-  echo -e '\n=== Disk Usage ==='
-  df -h /var/www
-"
-```
-
----
-
-## ğŸ” Security Notes
-
-- **API Key**: Stored in environment variable on server (not in code)
-- **File Permissions**:
-  - Frontend: `www-data:www-data` (nginx user)
-  - Backend: `root:root` (not web-accessible)
-- **HTTPS**: All traffic encrypted via Let's Encrypt
-- **Session Isolation**: UUID-based with TTL cleanup
+**CRITICAL**: `vite.config.ts` must have `base: '/ink-and-memory/'` to match deployment path.
 
 ---
 
-## ğŸ“š File Structure Reference
+## Known Issues & Quirks
 
-### Frontend Key Files
+### IME Composition
+Chinese/Japanese input requires special handling. Never update state during composition, only on `compositionend` event.
 
-```
-frontend/
-â”œâ”€â”€ src/
-â”‚   â”œâ”€â”€ App.tsx                    # Main application component
-â”‚   â”‚                              # - Comment positioning logic (lines 998-1042)
-â”‚   â”‚                              # - Energy pool system (useEffect polling)
-â”‚   â”‚                              # - Per-cell text management
-â”‚   â”‚                              # - Comment grouping algorithm
-â”‚   â”‚                              # - Mobile/desktop responsiveness
-â”‚   â”‚
-â”‚   â”œâ”€â”€ App.css                    # Styles + font loading
-â”‚   â”‚                              # - Font-display: swap for FOIT prevention
-â”‚   â”‚                              # - Watercolor highlight effects
-â”‚   â”‚                              # - Animations
-â”‚   â”‚
-â”‚   â”œâ”€â”€ engine/
-â”‚   â”‚   â”œâ”€â”€ EditorEngine.ts        # Core state management
-â”‚   â”‚   â”‚                          # - Collision detection
-â”‚   â”‚   â”‚                          # - Cell management
-â”‚   â”‚   â”‚                          # - Comment application
-â”‚   â”‚   â”‚
-â”‚   â”‚   â”œâ”€â”€ ChatWidget.ts          # Chat widget data model
-â”‚   â”‚   â””â”€â”€ ChatWidget.tsx         # (unused, logic in App.tsx)
-â”‚   â”‚
-â”‚   â”œâ”€â”€ components/
-â”‚   â”‚   â”œâ”€â”€ VoiceSettings.tsx      # Voice persona CRUD
-â”‚   â”‚   â”œâ”€â”€ StateChooser.tsx       # Emotional state selector
-â”‚   â”‚   â”œâ”€â”€ AgentDropdown.tsx      # @ voice selection dropdown
-â”‚   â”‚   â”œâ”€â”€ ChatWidgetUI.tsx       # Chat widget UI
-â”‚   â”‚   â”œâ”€â”€ CalendarView.tsx       # Memory calendar (localStorage-based)
-â”‚   â”‚   â”œâ”€â”€ AnalysisView.tsx       # Session analysis
-â”‚   â”‚   â”œâ”€â”€ AboutView.tsx          # About page
-â”‚   â”‚   â””â”€â”€ LeftSidebar.tsx        # Navigation sidebar
-â”‚   â”‚
-â”‚   â”œâ”€â”€ api/
-â”‚   â”‚   â””â”€â”€ voiceApi.ts            # Backend API calls
-â”‚   â”‚                              # - /api/analyze (voice comments)
-â”‚   â”‚                              # - /api/chat (agent chat)
-â”‚   â”‚                              # - /api/voices (voice configs)
-â”‚   â”‚
-â”‚   â”œâ”€â”€ utils/
-â”‚   â”‚   â”œâ”€â”€ voiceStorage.ts        # localStorage utilities
-â”‚   â”‚   â””â”€â”€ mobileDetect.ts        # Mobile detection hook
-â”‚   â”‚
-â”‚   â””â”€â”€ types/
-â”‚       â””â”€â”€ voice.ts               # TypeScript interfaces
-â”‚
-â”œâ”€â”€ index.html                     # Font preloading
-â”œâ”€â”€ vite.config.ts                 # Build config (base path!)
-â””â”€â”€ package.json                   # Dependencies
-```
+### Font Loading
+Uses `font-display: swap` to prevent FOIT (Flash of Invisible Text). Fonts are preloaded in `index.html`.
 
-### Backend Key Files
+### Mobile Differences
+- No left sidebar (hidden)
+- Floating toolbar in top right
+- Comment popup at bottom instead of right margin
+- Detection: `useMobile()` hook checks `window.innerWidth < 768`
 
-```
-backend/
-â”œâ”€â”€ server.py                      # Main server (currently unused?)
-â”œâ”€â”€ server_stateless.py            # Stateless server (NOT USED - ignore this)
-â”œâ”€â”€ stateless_analyzer.py          # LLM prompt + analysis logic
-â”‚                                  # - Explicit overlap avoidance
-â”‚                                  # - Voice selection
-â”‚                                  # - Phrase extraction
-â”‚
-â”œâ”€â”€ config.py                      # Voice archetypes + model config
-â”œâ”€â”€ models.json                    # API credentials (gitignored)
-â””â”€â”€ .venv/                         # Python virtual environment
+### Browser Auto-Scroll
+Prevent browser from scrolling element into view on focus:
+```typescript
+onFocus={(e) => {
+  e.preventDefault();
+}}
 ```
 
 ---
 
-## ğŸ¯ Critical Patterns to Remember
-
-### Pattern 1: Scroll-Independent Positioning
-Always use `offsetTop` for absolute positioning in scrollable containers. Never use `getBoundingClientRect()` unless you specifically need viewport-relative coordinates.
-
-### Pattern 2: Quote Weight Hack
-When inserting text programmatically that should NOT count toward energy accumulation, immediately update the baseline weight reference:
-```typescript
-setTimeout(() => {
-  lastPollWeightRef.current = getWeightedLength(currentTextRef.current);
-}, 0);
-```
-
-### Pattern 3: IME Composition Handling
-Never update state during composition. Track composing cells separately and only commit on composition end.
+## Testing Checklist
 
-### Pattern 4: Collision Detection
-Always check for overlapping highlights both in LLM prompt (upfront) and in engine (backup). LLMs are not 100% reliable.
+Before deploying:
+- [ ] Backend starts without errors on :8765
+- [ ] Frontend builds without errors
+- [ ] Voice comment analysis works (energy >= 40 triggers LLM)
+- [ ] Chat widget works (can chat with voice personas)
+- [ ] Authentication works (login/register/JWT)
+- [ ] Calendar saves/loads entries correctly
+- [ ] Voice settings CRUD works
+- [ ] Mobile layout renders correctly
+- [ ] No collision between highlighted phrases
+- [ ] Image generation works (daily pictures)
 
-### Pattern 5: Per-Cell State Management
-In multi-cell editors, always track state per cell ID. Never use array indices (they change when cells are added/deleted).
+---
 
-### Pattern 6: Mobile-First Responsiveness
-Use `useMobile()` hook to detect screen size, then conditionally render different layouts (not just CSS media queries).
+## Dependencies
 
-### Pattern 7: Energy Pool Polling
-Poll state at fixed intervals, calculate deltas, accumulate energy only on positive changes. Ignore deletions.
+### Backend
+- **PolyCLI** (local development): `~/Codebase/PolyCLI`
+- **FastAPI**: Web server
+- **Pillow**: Image conversion (PNG â†’ JPEG + thumbnails)
+- **PyJWT**: JWT token handling
+- **httpx[socks]**: Proxy support for GFW bypass
 
-### Pattern 8: Font Loading Strategy
-Preload critical fonts in HTML, use `font-display: swap` in CSS, specify unicode-range to avoid downloading unused fonts.
+### Frontend
+- **React 19**: UI framework
+- **Vite**: Build tool
+- **TypeScript**: Type safety
+- **react-icons**: Icon library
 
 ---
 
-## ğŸ“š Related Documentation
+## Related Documentation
 
 - **Server Infrastructure**: `~/Codebase/serverManagement/CLAUDE.md`
-- **README**: `README.md` (user-facing documentation)
 - **PolyCLI**: `~/Codebase/PolyCLI/README.md`
-
----
-
-## ğŸ”„ Recent Changes (Last Session)
-
-### Comment Box Width Expansion
-- **Changed**: `maxWidth` from 400px to 600px
-- **Changed**: `height: 54px` to `minHeight: 54px`
-- **Changed**: Removed ellipsis cutoff, added 3-line clamp
-- **Result**: Comments now expand horizontally before wrapping, show up to 3 full lines
-
-### LLM Prompt Overlap Avoidance
-- **Added**: Explicit list of already highlighted phrases in prompt
-- **Added**: Instructions to avoid overlapping with existing highlights
-- **Result**: LLM now receives upfront context about existing highlights
-
-### Comment Positioning Fine-Tuning
-- **Iteratively adjusted**: Vertical offset from 1.0 â†’ 0.5 â†’ 0.7 lineHeight
-- **Result**: Perfect alignment with highlighted text
-
----
-
-*Last updated: 2025-01-XX*
-*Version: v1.3.0-dynamic-width*
+- **User Guide**: `README.md`
+- **Refactor Status**: `/tmp/ink-and-memory-refactor-status.md` (recent changes)
diff --git a/backend/LOCALSTORAGE_AUDIT.md b/backend/LOCALSTORAGE_AUDIT.md
deleted file mode 100644
index c2a6b0c..0000000
--- a/backend/LOCALSTORAGE_AUDIT.md
+++ /dev/null
@@ -1,157 +0,0 @@
-# localStorage Audit - Complete Data Inventory
-
-## All localStorage Keys Currently Used
-
-### 1. **Editor State** (CRITICAL)
-- **Key**: `ink_memory_state`
-- **Location**: `App.tsx`
-- **Content**: Full EditorState (cells, commentors, current session)
-- **Size**: ~50-200KB per session
-- **Migration**: âœ… Save to `user_sessions` table
-
-### 2. **Calendar Entries** (CRITICAL)
-- **Key**: `calendar-entries`
-- **Location**: `calendarStorage.ts`
-- **Content**: `{ "YYYY-MM-DD": [{ id, timestamp, state, firstLine }] }`
-- **Size**: Can be LARGE (multiple full EditorStates)
-- **Migration**: âœ… Extract each entry and save as separate session in `user_sessions`
-
-### 3. **Daily Pictures** (CRITICAL - QUOTA PROBLEM!)
-- **Key**: `daily-pictures`
-- **Location**: `CollectionsView.tsx`
-- **Content**: `[{ date, base64, prompt }]`
-- **Size**: **1.5MB per image** â† This is why we need database!
-- **Migration**: âœ… Save to `daily_pictures` table
-
-### 4. **Voice Customizations**
-- **Key**: `voice-customizations`
-- **Location**: `voiceStorage.ts`
-- **Content**: `{ [voiceKey]: { name, tagline, icon, color, enabled } }`
-- **Size**: ~5-20KB
-- **Migration**: âœ… Save to `user_preferences.voice_configs_json`
-
-### 5. **Meta Prompt**
-- **Key**: `meta-prompt`
-- **Location**: `voiceStorage.ts`
-- **Content**: String (global instructions for all voices)
-- **Size**: ~1-5KB
-- **Migration**: âœ… Save to `user_preferences.meta_prompt`
-
-### 6. **State Config**
-- **Key**: `state-config`
-- **Location**: `voiceStorage.ts`
-- **Content**: `{ greeting, states: { happy: {name, prompt}, ... } }`
-- **Size**: ~2-10KB
-- **Migration**: âœ… Save to `user_preferences.state_config_json`
-
-### 7. **Selected State**
-- **Key**: `selected-state`
-- **Location**: `App.tsx`
-- **Content**: String (e.g., "happy", "ok", "unhappy")
-- **Size**: ~10 bytes
-- **Migration**: âœ… Save to `user_preferences.selected_state`
-
-### 8. **Analysis Reports History**
-- **Key**: `analysis-reports-history`
-- **Location**: `AnalysisView.tsx`
-- **Content**: `[{ timestamp, type, data, allNotes }]`
-- **Size**: ~10-50KB (limited to 10 reports)
-- **Migration**: âš ï¸ **MISSING FROM DATABASE!** Need new table
-
-### 9. **Document Storage** (OLD SYSTEM - probably unused?)
-- **Key**: `ink_and_memory_document`
-- **Location**: `documentStorage.ts`
-- **Content**: `{ document, conversations, lastModified }`
-- **Size**: Unknown
-- **Migration**: âš ï¸ **Check if this is still used** - might be deprecated
-
-## Database Schema Gaps Found
-
-### âŒ Missing Table: `analysis_reports`
-```sql
-CREATE TABLE analysis_reports (
-  id INTEGER PRIMARY KEY AUTOINCREMENT,
-  user_id INTEGER NOT NULL,
-  report_type TEXT NOT NULL,  -- 'echoes', 'traits', 'patterns'
-  report_data_json TEXT NOT NULL,
-  all_notes_text TEXT,  -- The text that was analyzed
-  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
-  FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
-);
-```
-
-### âŒ Missing: Calendar Entry Handling
-- Calendar entries contain full EditorStates
-- Need to extract each calendar entry as a separate session
-- Need to preserve `date` and `timestamp` metadata
-
-## Migration Strategy
-
-### Phase 1: On First Login (Auto-Migration)
-```javascript
-async function migrateLocalStorageToServer() {
-  const migrationData = {
-    // Current session
-    currentSession: localStorage.getItem('ink_memory_state'),
-
-    // Calendar entries (extract as separate sessions)
-    calendarEntries: localStorage.getItem('calendar-entries'),
-
-    // Pictures (THE BIG ONE!)
-    dailyPictures: localStorage.getItem('daily-pictures'),
-
-    // Preferences
-    voiceCustomizations: localStorage.getItem('voice-customizations'),
-    metaPrompt: localStorage.getItem('meta-prompt'),
-    stateConfig: localStorage.getItem('state-config'),
-    selectedState: localStorage.getItem('selected-state'),
-
-    // Reports
-    analysisReports: localStorage.getItem('analysis-reports-history'),
-
-    // Old document storage (check if used)
-    oldDocument: localStorage.getItem('ink_and_memory_document')
-  };
-
-  // POST to /api/import-local-data
-  await fetch('/api/import-local-data', {
-    method: 'POST',
-    headers: { 'Authorization': `Bearer ${token}` },
-    body: JSON.stringify(migrationData)
-  });
-
-  // Clear localStorage (keep only auth token)
-  clearLocalStorage();
-}
-```
-
-### Phase 2: Server-First Operation
-After migration:
-- localStorage only stores: auth token
-- All data fetched from server on load
-- Auto-save to server every 30s
-
-## Size Estimates
-
-**Typical user localStorage usage:**
-- Current session: ~100KB
-- Calendar entries (30 days): ~3MB (30 sessions Ã— 100KB)
-- Daily pictures (7 days): **10.5MB** â† EXCEEDS QUOTA!
-- Preferences: ~30KB
-- Reports: ~50KB
-- **TOTAL: ~13.7MB** â† Way over 5-10MB limit!
-
-**With database:**
-- localStorage: ~1KB (just token)
-- SQLite: Unlimited (file-based)
-
-## Action Items
-
-1. âœ… Add `analysis_reports` table to database schema
-2. âœ… Update `import_user_data()` to handle:
-   - Calendar entries extraction
-   - Analysis reports
-   - Old document storage check
-3. âœ… Create comprehensive migration endpoint `/api/import-local-data`
-4. âš ï¸ Test migration with real localStorage data
-5. âš ï¸ Add data validation (check JSON parsing before import)
diff --git a/backend/MIGRATION_SUMMARY.md b/backend/MIGRATION_SUMMARY.md
deleted file mode 100644
index c8505d3..0000000
--- a/backend/MIGRATION_SUMMARY.md
+++ /dev/null
@@ -1,216 +0,0 @@
-# localStorage Migration - Complete Picture
-
-## ğŸš¨ Critical Discovery
-
-**Current localStorage usage: ~13.7MB per typical user**
-- localStorage limit: 5-10MB
-- **You've been living on borrowed time!**
-
-### The Quota Bomb:
-```
-Current session:      100 KB
-Calendar (30 days):  3000 KB  (30 sessions)
-Pictures (7 days):  10500 KB  â† THE PROBLEM!
-Preferences:           30 KB
-Reports:               50 KB
-â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-TOTAL:             ~13680 KB  â† 13.7 MB!
-```
-
-**This explains the QuotaExceededError!**
-
----
-
-## âœ… Complete Data Inventory
-
-### 9 localStorage Keys Found:
-
-1. âœ… `ink_memory_state` â†’ `user_sessions` table
-2. âœ… `calendar-entries` â†’ Extract each entry as separate session
-3. âœ… `daily-pictures` â†’ `daily_pictures` table
-4. âœ… `voice-customizations` â†’ `user_preferences.voice_configs_json`
-5. âœ… `meta-prompt` â†’ `user_preferences.meta_prompt`
-6. âœ… `state-config` â†’ `user_preferences.state_config_json`
-7. âœ… `selected-state` â†’ `user_preferences.selected_state`
-8. âœ… `analysis-reports-history` â†’ `analysis_reports` table (NEW!)
-9. âš ï¸ `ink_and_memory_document` â†’ Check if still used (might be old)
-
----
-
-## ğŸ“¦ Database Schema (Complete)
-
-### Tables Created:
-```sql
-users                -- Email, password, display name
-user_sessions        -- Editor states (replaces localStorage sessions)
-daily_pictures       -- Images (solves quota problem!)
-user_preferences     -- Voice configs, meta prompt, state config
-analysis_reports     -- Echoes, traits, patterns (NEW!)
-auth_sessions        -- Session tokens
-schema_version       -- Migration tracking
-```
-
-### Key Features:
-- âœ… WAL mode enabled (concurrent reads + 1 write)
-- âœ… Foreign keys enforced (CASCADE DELETE)
-- âœ… Indexes on user_id for fast queries
-- âœ… JSON columns for flexibility (no schema migrations needed)
-
----
-
-## ğŸ”„ Migration Plan
-
-### On First Login:
-```javascript
-// 1. Detect localStorage data
-if (hasLocalStorageData()) {
-  // 2. Show banner
-  <Banner>
-    ğŸ’¾ Migrating your local data to your account...
-  </Banner>
-
-  // 3. Extract all data
-  const migrationData = extractAllLocalStorageData();
-
-  // 4. POST to server
-  await fetch('/api/import-local-data', {
-    method: 'POST',
-    headers: { 'Authorization': `Bearer ${token}` },
-    body: JSON.stringify(migrationData)
-  });
-
-  // 5. Verify migration
-  const verify = await fetch('/api/verify-migration');
-
-  // 6. Clear localStorage (keep only token)
-  if (verify.ok) {
-    clearLocalStorage();
-    localStorage.setItem('auth-token', token);
-  }
-}
-```
-
-### Special Cases:
-
-**Calendar Entries (Complex!):**
-```javascript
-// calendar-entries: { "2025-11-01": [entry1, entry2], "2025-11-02": [...] }
-// Each entry contains full EditorState
-
-function extractCalendarEntries(calendarData) {
-  const sessions = [];
-
-  for (const [date, entries] of Object.entries(calendarData)) {
-    for (const entry of entries) {
-      sessions.push({
-        id: entry.id,
-        name: `${date} - ${entry.firstLine}`,
-        editor_state: entry.state,
-        // Preserve original timestamp
-        created_at: new Date(entry.timestamp).toISOString()
-      });
-    }
-  }
-
-  return sessions;
-}
-```
-
-**Pictures (The Big One!):**
-```javascript
-// pictures: [{ date, base64, prompt }]
-// Each base64 string is ~1.5MB!
-
-function extractPictures(picturesData) {
-  return picturesData.map(p => ({
-    date: p.date,
-    image_base64: p.base64,  // Goes straight to SQLite (unlimited)
-    prompt: p.prompt
-  }));
-}
-```
-
----
-
-## ğŸ¯ Guest Mode Strategy
-
-### Before Login:
-```javascript
-// localStorage works normally
-localStorage.setItem('ink_memory_state', state);
-localStorage.setItem('daily-pictures', pictures);
-
-// âŒ But blocks image generation if >5MB used
-if (getLocalStorageSize() > 5 * 1024 * 1024) {
-  alert('âš ï¸ Storage full! Create account to generate images.');
-  return;
-}
-```
-
-### After Login:
-```javascript
-// Server becomes primary
-await fetch('/api/save-session', { body: state });
-
-// localStorage only stores token
-localStorage.clear();
-localStorage.setItem('auth-token', token);
-```
-
-### Image Generation Gate:
-```javascript
-async function generateImage() {
-  if (!isLoggedIn()) {
-    showLoginPrompt('ğŸ¨ Create a free account to generate images');
-    return;
-  }
-
-  // Logged in users: unlimited images!
-  const image = await fetch('/api/generate-image', ...);
-}
-```
-
----
-
-## ğŸ“Š Storage Comparison
-
-### Before (localStorage):
-- Max: 10MB (hard limit)
-- Current usage: ~13.7MB (OVER LIMIT!)
-- Pictures: 7 max before quota error
-- Sync: None (single device only)
-- Backup: None (data lost if browser cache cleared)
-
-### After (SQLite):
-- Max: Unlimited (file-based)
-- Current usage: Irrelevant
-- Pictures: Unlimited
-- Sync: Across devices
-- Backup: Daily automated backups
-
----
-
-## ğŸš€ Next Steps
-
-1. [x] Database schema complete
-2. [x] Migration functions ready
-3. [ ] Create auth module (JWT, bcrypt)
-4. [ ] Add auth endpoints to FastAPI
-5. [ ] Create frontend login/register UI
-6. [ ] Implement auto-migration on first login
-7. [ ] Add image generation gate
-8. [ ] Test with real localStorage data
-9. [ ] Deploy to production
-
----
-
-## âš ï¸ Important Notes
-
-1. **No data loss**: Migration keeps localStorage until verified
-2. **Rollback safe**: Can revert to localStorage if migration fails
-3. **Incremental**: Users can keep using app during migration
-4. **Guest mode works**: Anonymous users can still use app (limited)
-
----
-
-**Ready to proceed with auth implementation!**
diff --git a/backend/config.py b/backend/config.py
index 8028a66..f16fd39 100644
--- a/backend/config.py
+++ b/backend/config.py
@@ -38,37 +38,37 @@ def _load_prompt(filename):
 VOICE_ARCHETYPES = {
     "holder": {
         "name": "æ¥çº³è€… (The Holder)",
-        "tagline": _load_prompt("holder.md"),
+        "systemPrompt": _load_prompt("holder.md"),
         "icon": "heart",
         "color": "pink"
     },
     "unpacker": {
         "name": "æ‹†è§£è€… (The Unpacker)",
-        "tagline": _load_prompt("unpacker.md"),
+        "systemPrompt": _load_prompt("unpacker.md"),
         "icon": "brain",
         "color": "blue"
     },
     "starter": {
         "name": "å¯åŠ¨è€… (The Starter)",
-        "tagline": _load_prompt("starter.md"),
+        "systemPrompt": _load_prompt("starter.md"),
         "icon": "fist",
         "color": "yellow"
     },
     "mirror": {
         "name": "ç…§é•œè€… (The Mirror)",
-        "tagline": _load_prompt("mirror.md"),
+        "systemPrompt": _load_prompt("mirror.md"),
         "icon": "eye",
         "color": "green"
     },
     "weaver": {
         "name": "è¿æ¥è€… (The Weaver)",
-        "tagline": _load_prompt("weaver.md"),
+        "systemPrompt": _load_prompt("weaver.md"),
         "icon": "compass",
         "color": "purple"
     },
     "absurdist": {
         "name": "å¹½é»˜è€… (The Absurdist)",
-        "tagline": _load_prompt("absurdist.md"),
+        "systemPrompt": _load_prompt("absurdist.md"),
         "icon": "masks",
         "color": "pink"
     }
diff --git a/backend/server.py b/backend/server.py
index ff3c8c3..25e5275 100644
--- a/backend/server.py
+++ b/backend/server.py
@@ -24,12 +24,13 @@ import auth
     description="Get AI-powered writing inspiration from a voice persona",
     params={
         "text": {"type": "str"},
+        "user_id": {"type": "int"},
         "meta_prompt": {"type": "str"},
         "state_prompt": {"type": "str"}
     },
     category="Writing"
 )
-def get_writing_suggestion(text: str, meta_prompt: str = "", state_prompt: str = ""):
+def get_writing_suggestion(text: str, user_id: int, meta_prompt: str = "", state_prompt: str = ""):
     """Generate writing inspiration from a random voice persona."""
     print(f"\n{'='*60}")
     print(f"âœï¸  get_writing_suggestion() called")
@@ -52,7 +53,7 @@ def get_writing_suggestion(text: str, meta_prompt: str = "", state_prompt: str =
 
     # Build system prompt - voice gives inspiration, not continuation
     system_prompt = f"""You are {voice_info['name']}, an inner voice persona.
-Your role: {voice_info['tagline']}
+Your role: {voice_info.get('systemPrompt', '')}
 
 Read the user's writing and offer a brief, inspiring comment to help them continue.
 Be encouraging, insightful, or thought-provoking (1-2 sentences).
@@ -96,8 +97,8 @@ Offer a brief, inspiring comment to help them continue writing (1-2 sentences)."
     name="Chat with Voice",
     description="Have a conversation with a specific inner voice persona",
     params={
-        "voice_name": {"type": "str"},
-        "voice_config": {"type": "dict"},
+        "voice_id": {"type": "str"},
+        "user_id": {"type": "int"},
         "conversation_history": {"type": "list"},
         "user_message": {"type": "str"},
         "original_text": {"type": "str"},
@@ -106,28 +107,47 @@ Offer a brief, inspiring comment to help them continue writing (1-2 sentences)."
     },
     category="Chat"
 )
-def chat_with_voice(voice_name: str, voice_config: dict, conversation_history: list, user_message: str, original_text: str = "", meta_prompt: str = "", state_prompt: str = ""):
+def chat_with_voice(voice_id: str, user_id: int, conversation_history: list, user_message: str, original_text: str = "", meta_prompt: str = "", state_prompt: str = ""):
     """Chat with a specific voice persona."""
     print(f"\n{'='*60}")
     print(f"ğŸ’¬ chat_with_voice() called")
-    print(f"   Voice: {voice_name}")
+    print(f"   Voice ID: {voice_id}")
+    print(f"   User ID: {user_id}")
     print(f"   User message: {user_message}")
     print(f"   History length: {len(conversation_history)}")
     print(f"   Meta prompt: {repr(meta_prompt)[:100]}")
     print(f"   State prompt: {repr(state_prompt)[:100]}")
     print(f"{'='*60}\n")
 
-    agent = PolyAgent(id=f"voice-chat-{voice_name.lower()}")
+    # @@@ Load user's voice configs from database
+    prefs = database.get_preferences(user_id)
+    voice_configs = prefs['voice_configs'] if prefs and prefs['voice_configs'] else {}
+
+    # @@@ Get voice config for this specific voice
+    if voice_id in voice_configs:
+        voice_config = voice_configs[voice_id]
+        voice_name = voice_config.get('name', voice_id)
+        print(f"ğŸ“š Loaded voice config from database for {voice_id}: {voice_name}")
+    else:
+        # Fallback: use default from config.VOICE_ARCHETYPES
+        import config
+        if voice_id in config.VOICE_ARCHETYPES:
+            default_voice = config.VOICE_ARCHETYPES[voice_id]
+            voice_name = default_voice['name']
+            voice_config = {"systemPrompt": default_voice['systemPrompt']}
+            print(f"ğŸ“š Using default voice config for {voice_id}: {voice_name}")
+        else:
+            # Ultimate fallback
+            voice_name = voice_id
+            voice_config = {"systemPrompt": f"{voice_name} voice"}
+            print(f"âš ï¸  Voice {voice_id} not found, using fallback")
 
-    # Ensure voice_config is a dict
-    if not isinstance(voice_config, dict):
-        print(f"âš ï¸  voice_config is not a dict: {type(voice_config)}, using default")
-        voice_config = {"tagline": f"{voice_name} voice from Disco Elysium"}
+    agent = PolyAgent(id=f"voice-chat-{voice_name.lower()}")
 
     # Build system prompt for this voice
     system_prompt = f"""You are {voice_name}, an inner voice archetype from Disco Elysium.
 
-Your character: {voice_config.get('tagline', '')}
+Your character: {voice_config.get('systemPrompt', '')}
 
 Respond in character as {voice_name}. Be concise (1-3 sentences). Stay true to your archetype.
 Use the conversation context but focus on your unique perspective."""
@@ -188,18 +208,20 @@ User's current state:
     description="Get one new voice comment for text",
     params={
         "text": {"type": "str"},
-        "session_id": {"type": "str"},
-        "voices": {"type": "dict"},
+        "editor_session_id": {"type": "str"},
+        "user_id": {"type": "int"},
         "applied_comments": {"type": "list"},
         "meta_prompt": {"type": "str"},
-        "state_prompt": {"type": "str"}
+        "state_prompt": {"type": "str"},
+        "overlapped_phrases": {"type": "list"}
     },
     category="Analysis"
 )
-def analyze_text(text: str, session_id: str, voices: dict = None, applied_comments: list = None, meta_prompt: str = "", state_prompt: str = "", overlapped_phrases: list = None):
+def analyze_text(text: str, editor_session_id: str, user_id: int, applied_comments: list = None, meta_prompt: str = "", state_prompt: str = "", overlapped_phrases: list = None):
     """Stateless analysis - returns ONE new comment based on text and applied comments."""
     print(f"\n{'='*60}")
     print(f"ğŸ¯ Stateless analyze_text() called")
+    print(f"   User ID: {user_id}")
     print(f"   Text: {text[:100]}...")
     print(f"   Applied comments: {len(applied_comments or [])}")
     print(f"   Overlapped phrases: {len(overlapped_phrases or [])}")
@@ -207,6 +229,11 @@ def analyze_text(text: str, session_id: str, voices: dict = None, applied_commen
     print(f"   State prompt: {repr(state_prompt)[:100]}")
     print(f"{'='*60}\n")
 
+    # @@@ Load user's voice configs from database
+    prefs = database.get_preferences(user_id)
+    voices = prefs['voice_configs'] if prefs and prefs['voice_configs'] else None
+    print(f"ğŸ“š Loaded voice configs from database: {list(voices.keys()) if voices else 'None (will use defaults)'}")
+
     agent = PolyAgent(id="voice-analyzer")
 
     # Get voices from stateless analyzer
@@ -224,11 +251,12 @@ def analyze_text(text: str, session_id: str, voices: dict = None, applied_commen
     name="Analyze Echoes",
     description="Find recurring themes and topics in all user notes",
     params={
-        "all_notes": {"type": "str"}
+        "all_notes": {"type": "str"},
+        "user_id": {"type": "int"}
     },
     category="Analysis"
 )
-def analyze_echoes(all_notes: str):
+def analyze_echoes(all_notes: str, user_id: int):
     """Analyze recurring themes and topics across all notes."""
     print(f"\n{'='*60}")
     print(f"ğŸ”„ analyze_echoes() called")
@@ -273,11 +301,12 @@ Return ONLY the JSON array, no other text."""
     name="Analyze Traits",
     description="Identify personality traits and characteristics from user notes",
     params={
-        "all_notes": {"type": "str"}
+        "all_notes": {"type": "str"},
+        "user_id": {"type": "int"}
     },
     category="Analysis"
 )
-def analyze_traits(all_notes: str):
+def analyze_traits(all_notes: str, user_id: int):
     """Analyze personality traits from all notes."""
     print(f"\n{'='*60}")
     print(f"ğŸ‘¤ analyze_traits() called")
@@ -322,11 +351,12 @@ Return ONLY the JSON array, no other text."""
     name="Analyze Patterns",
     description="Identify behavioral patterns and habits from user notes",
     params={
-        "all_notes": {"type": "str"}
+        "all_notes": {"type": "str"},
+        "user_id": {"type": "int"}
     },
     category="Analysis"
 )
-def analyze_patterns(all_notes: str):
+def analyze_patterns(all_notes: str, user_id: int):
     """Analyze behavioral patterns from all notes."""
     print(f"\n{'='*60}")
     print(f"ğŸ” analyze_patterns() called")
@@ -371,11 +401,12 @@ Return ONLY the JSON array, no other text."""
     name="Generate Daily Picture",
     description="Generate an artistic image based on user's daily notes",
     params={
-        "all_notes": {"type": "str"}
+        "all_notes": {"type": "str"},
+        "user_id": {"type": "int"}
     },
     category="Creative"
 )
-def generate_daily_picture(all_notes: str):
+def generate_daily_picture(all_notes: str, user_id: int):
     """Generate an image based on the essence of user's daily notes."""
     print(f"\n{'='*60}")
     print(f"ğŸ¨ generate_daily_picture() called")
@@ -1043,24 +1074,7 @@ def save_preferences_endpoint(
 
     return {"success": True}
 
-@app.post("/api/suggest")
-async def suggest_api(request_data: dict):
-    """
-    @@@ Get writing continuation suggestions (sync API).
-
-    Uses PolyCLI's sync API internally - no polling needed!
-    """
-    async with httpx.AsyncClient() as client:
-        response = await client.post(
-            "http://localhost:8765/polycli/api/trigger-sync",
-            json={
-                "session_id": "get_writing_suggestion",
-                "params": request_data,
-                "timeout": 30.0
-            },
-            timeout=35.0
-        )
-        return response.json()
+# @@@ Removed /api/suggest wrapper - frontend now calls /polycli/api/trigger-sync directly
 
 @app.post("/api/mark-first-login-completed")
 def mark_first_login_completed(current_user: dict = Depends(get_current_user)):
@@ -1115,112 +1129,20 @@ def get_default_voices():
     """Get default voice configurations"""
     return config.VOICE_ARCHETYPES
 
-@app.post("/api/analyze")
-async def analyze_api(request_data: dict):
-    """
-    @@@ Analyze text and return ONE new voice comment (sync API).
-
-    Uses PolyCLI's sync API internally - no polling needed!
-    """
-    async with httpx.AsyncClient() as client:
-        response = await client.post(
-            "http://localhost:8765/polycli/api/trigger-sync",
-            json={
-                "session_id": "analyze_text",
-                "params": request_data,
-                "timeout": 30.0
-            },
-            timeout=35.0
-        )
-        return response.json()
-
-@app.post("/api/chat")
-async def chat_api(request_data: dict):
-    """
-    @@@ Chat with a voice persona (sync API).
+# @@@ Removed /api/analyze wrapper - frontend now calls /polycli/api/trigger-sync directly
 
-    Uses PolyCLI's sync API internally - no polling needed!
-    """
-    async with httpx.AsyncClient() as client:
-        response = await client.post(
-            "http://localhost:8765/polycli/api/trigger-sync",
-            json={
-                "session_id": "chat_with_voice",
-                "params": request_data,
-                "timeout": 30.0
-            },
-            timeout=35.0
-        )
-        return response.json()
-
-@app.post("/api/generate-image")
-async def generate_image_api(request_data: dict):
-    """
-    @@@ Generate artistic image from notes (sync API).
+# @@@ Removed /api/chat wrapper - frontend now calls /polycli/api/trigger-sync directly
 
-    This may take longer (120s timeout) due to image generation.
-    """
-    async with httpx.AsyncClient() as client:
-        response = await client.post(
-            "http://localhost:8765/polycli/api/trigger-sync",
-            json={
-                "session_id": "generate_daily_picture",
-                "params": request_data,
-                "timeout": 120.0  # Image generation takes ~90s without proxy
-            },
-            timeout=125.0
-        )
-        return response.json()
-
-@app.post("/api/analyze-echoes")
-async def analyze_echoes_api(request_data: dict):
-    """Analyze recurring themes in notes (sync API)."""
-    async with httpx.AsyncClient() as client:
-        response = await client.post(
-            "http://localhost:8765/polycli/api/trigger-sync",
-            json={
-                "session_id": "analyze_echoes",
-                "params": request_data,
-                "timeout": 30.0
-            },
-            timeout=35.0
-        )
-        return response.json()
-
-@app.post("/api/analyze-traits")
-async def analyze_traits_api(request_data: dict):
-    """Analyze personality traits from notes (sync API)."""
-    async with httpx.AsyncClient() as client:
-        response = await client.post(
-            "http://localhost:8765/polycli/api/trigger-sync",
-            json={
-                "session_id": "analyze_traits",
-                "params": request_data,
-                "timeout": 30.0
-            },
-            timeout=35.0
-        )
-        return response.json()
-
-@app.post("/api/analyze-patterns")
-async def analyze_patterns_api(request_data: dict):
-    """Analyze behavioral patterns from notes (sync API)."""
-    async with httpx.AsyncClient() as client:
-        response = await client.post(
-            "http://localhost:8765/polycli/api/trigger-sync",
-            json={
-                "session_id": "analyze_patterns",
-                "params": request_data,
-                "timeout": 30.0
-            },
-            timeout=35.0
-        )
-        return response.json()
+# @@@ Removed /api/generate-image wrapper - frontend now calls /polycli/api/trigger-sync directly
+# @@@ Removed /api/analyze-echoes wrapper - frontend now calls /polycli/api/trigger-sync directly
+# @@@ Removed /api/analyze-traits wrapper - frontend now calls /polycli/api/trigger-sync directly
+# @@@ Removed /api/analyze-patterns wrapper - frontend now calls /polycli/api/trigger-sync directly
 
 # ========== Mount PolyCLI Control Panel ==========
 
 registry = get_registry()
-mount_control_panel(app, registry, prefix="/polycli")
+# @@@ Pass auth_callback to enable authentication for /polycli/api/trigger-sync
+mount_control_panel(app, registry, prefix="/polycli", auth_callback=auth.verify_access_token)
 
 # ========== Main ==========
 
@@ -1231,18 +1153,30 @@ if __name__ == "__main__":
     print("ğŸ­ Ink & Memory FastAPI Server")
     print("="*60)
     print("\nğŸ“š API Endpoints:")
-    print("  Clean API:")
-    print("    POST /api/analyze         - Analyze text (sync)")
-    print("    POST /api/chat            - Chat with voice (sync)")
-    print("    POST /api/generate-image  - Generate image (sync)")
-    print("    POST /api/analyze-echoes  - Find themes (sync)")
-    print("    POST /api/analyze-traits  - Identify traits (sync)")
-    print("    POST /api/analyze-patterns - Find patterns (sync)")
-    print("    POST /api/suggest         - Get writing suggestions (sync)")
-    print("    GET  /api/default-voices  - Get voice configs")
-    print("\n  PolyCLI Control Panel:")
+    print("  Auth & User:")
+    print("    POST /api/register        - Register new user")
+    print("    POST /api/login           - Login")
+    print("    GET  /api/me              - Get current user")
+    print("  Data Storage:")
+    print("    POST /api/sessions        - Save session")
+    print("    GET  /api/sessions        - List sessions")
+    print("    GET  /api/sessions/{id}   - Get session")
+    print("    DELETE /api/sessions/{id} - Delete session")
+    print("    POST /api/pictures        - Save daily picture")
+    print("    GET  /api/pictures        - List pictures")
+    print("    GET  /api/preferences     - Get user preferences")
+    print("    POST /api/preferences     - Save preferences")
+    print("    GET  /api/reports         - Get analysis reports")
+    print("    POST /api/reports         - Save report")
+    print("  Configuration:")
+    print("    GET  /api/default-voices  - Get default voice configs")
+    print("\n  PolyCLI (AI Functions):")
     print("    /polycli                  - Control panel UI")
     print("    /polycli/api/trigger-sync - Direct sync API")
+    print("       Sessions: analyze_text, chat_with_voice,")
+    print("                 get_writing_suggestion, analyze_echoes,")
+    print("                 analyze_traits, analyze_patterns,")
+    print("                 generate_daily_picture")
     print("\n  Documentation:")
     print("    /docs                     - Auto-generated API docs")
     print("="*60 + "\n")
diff --git a/backend/stateless_analyzer.py b/backend/stateless_analyzer.py
index e7c83fa..54a24b2 100644
--- a/backend/stateless_analyzer.py
+++ b/backend/stateless_analyzer.py
@@ -8,7 +8,8 @@ import config
 
 class VoiceTrigger(BaseModel):
     phrase: str = Field(description="Exact trigger phrase from text (verbatim, 2-4 words, avoid punctuation)")
-    voice: str = Field(description="Voice archetype name from the available list")
+    voice_id: str = Field(description="Voice ID from the available list (e.g., 'holder', 'mirror', 'unpacker')")
+    voice_name: str = Field(description="Voice display name (will be auto-filled, LLM should not generate this)")
     comment: str = Field(description="What this voice is saying (as if speaking)")
     icon: str = Field(description="Icon identifier")
     color: str = Field(description="Color identifier")
@@ -44,8 +45,8 @@ def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict],
 
     # Build voice list for prompt
     voice_list = "\n".join([
-        f"- {v.get('name', name)} ({v['icon']}, {v['color']}): {v['tagline']}"
-        for name, v in voice_archetypes.items()
+        f"- ID: {key} | Name: {v.get('name', key)} | ({v['icon']}, {v['color']})\n  {v.get('systemPrompt', '')}"
+        for key, v in voice_archetypes.items()
     ])
 
     # Build existing conversation context
@@ -100,7 +101,9 @@ Find ONE NEW voice to comment:
    - Do NOT extract from the conversation context or rejected phrases
    - Verify character-by-character that your phrase exists in the text
 
-2. Choose a voice persona from the available list
+2. Choose a voice ID from the available list above
+   - Use the ID field (e.g., 'holder', 'mirror'), NOT the name
+   - Return ONLY the ID in the voice_id field
 
 3. Write what this voice is saying (1-2 sentences)
 
@@ -112,7 +115,9 @@ CRITICAL RULES:
 - DO NOT suggest any rejected phrases: {overlapped_phrases}
 - DO NOT CREATE NEW VOICE NAMES - Only use from the available list
 - Return null if nothing is worth commenting on
-- Write in the SAME LANGUAGE as the text"""
+- Write in the SAME LANGUAGE as the text
+
+IMPORTANT: Return voice_id only (e.g., "holder"). Do NOT fill voice_name - it will be auto-filled."""
 
     # @@@ Add meta prompt if available
     if meta_prompt and meta_prompt.strip():
@@ -145,23 +150,28 @@ User's current state:
     voice = result.data.get("voice")
 
     if voice:
-        print(f"âœ… Got 1 new comment: {voice.get('voice', 'Unknown')}")
-
-        # Map user-defined names back to get correct icon/color
-        name_to_key = {}
-        for key, v in voice_archetypes.items():
-            user_name = v.get("name", key)
-            name_to_key[user_name] = key
-
-        # @@@ Map LLM's name back to key for frontend voiceConfigs[key] lookup
-        llm_voice_name = voice.get("voice")
-        archetype_key = name_to_key.get(llm_voice_name)
-        if archetype_key and archetype_key in voice_archetypes:
-            voice["icon"] = voice_archetypes[archetype_key]["icon"]
-            voice["color"] = voice_archetypes[archetype_key]["color"]
-            voice["voice"] = archetype_key  # Return key, not name
-
-        return {"voices": [voice], "new_voices_added": 1}
+        # @@@ Validate LLM returned a valid voice ID
+        voice_id = voice.get("voice_id")
+
+        if not voice_id or voice_id not in voice_archetypes:
+            print(f"âš ï¸ Invalid voice ID: {voice_id}, skipping")
+            return {"voices": [], "new_voices_added": 0}
+
+        # Get archetype info
+        archetype = voice_archetypes[voice_id]
+
+        # Build return object with both ID and name
+        result_voice = {
+            "phrase": voice.get("phrase"),
+            "voice_id": voice_id,                    # NEW: ID for lookup
+            "voice": archetype.get("name", voice_id), # KEEP: Name for display
+            "comment": voice.get("comment"),
+            "icon": archetype["icon"],               # Ensure correct icon
+            "color": archetype["color"]              # Ensure correct color
+        }
+
+        print(f"âœ… Got 1 new comment: {voice_id} ({result_voice['voice']})")
+        return {"voices": [result_voice], "new_voices_added": 1}
     else:
         print("ğŸ“­ No new comment")
         return {"voices": [], "new_voices_added": 0}
diff --git a/frontend/src/App.tsx b/frontend/src/App.tsx
index 3b0bc37..c1411e2 100644
--- a/frontend/src/App.tsx
+++ b/frontend/src/App.tsx
@@ -10,7 +10,7 @@ import {
   FaFistRaised, FaLightbulb, FaShieldAlt, FaWind, FaFire, FaCompass,
   FaAlignRight
 } from 'react-icons/fa';
-import LeftSidebar from './components/LeftSidebar';
+import TopNavBar from './components/TopNavBar';
 import VoiceSettings from './components/VoiceSettings';
 import CalendarPopup from './components/CalendarPopup';
 import { saveEntryToToday, type CalendarEntry } from './utils/calendarStorage';
@@ -285,8 +285,8 @@ export default function App() {
 
   // @@@ Writing suggestion state
   const [currentInspiration, setCurrentInspiration] = useState<VoiceInspiration | null>(null);
-  const [suggestionSnapshot, setSuggestionSnapshot] = useState<string>('');
-  const suggestionTimerRef = useRef<NodeJS.Timeout | null>(null);
+  const [_suggestionSnapshot, setSuggestionSnapshot] = useState<string>('');  // Not used yet
+  const suggestionTimerRef = useRef<number | null>(null);
 
   // @@@ Trigger re-render when returning to writing view to recalculate comment positions
   useEffect(() => {
@@ -1332,12 +1332,6 @@ export default function App() {
         .map(c => (c as TextCell).content)
         .join('');
 
-      // Get the voice config for this comment
-      const voiceConfig = voiceConfigs[comment.voice];
-      if (!voiceConfig) {
-        throw new Error(`Voice config not found for ${comment.voice}`);
-      }
-
       // Get conversation history (excluding the message we just added)
       const chatHistory = comment.chatHistory?.slice(0, -1) || [];
 
@@ -1346,9 +1340,12 @@ export default function App() {
         ? stateConfig.states[selectedState].prompt
         : '';
 
+      // @@@ Use voiceId if available (new comments), fall back to voice name (old comments)
+      // Backend loads voice config from database using user_id from JWT
+      const voiceId = comment.voiceId || comment.voice;
+
       const response = await chatWithVoice(
-        comment.voice,
-        voiceConfig,
+        voiceId,
         chatHistory,
         message,
         allText,
@@ -1451,14 +1448,15 @@ export default function App() {
         .map(c => (c as TextCell).content)
         .join('');
 
-      // Call backend - use voiceConfig.name as the voice name for the prompt
       const metaPrompt = getMetaPrompt();
       const statePrompt = selectedState && stateConfig.states[selectedState]
         ? stateConfig.states[selectedState].prompt
         : '';
+
+      // @@@ Use voiceName (which is the voice ID/key) for backend lookup
+      // Backend loads voice config from database using user_id from JWT
       const response = await chatWithVoice(
-        widgetData.voiceConfig.name,  // Use the display name, not the key
-        widgetData.voiceConfig,
+        widgetData.voiceName,  // This is the voice ID (key like "holder", "mirror")
         chatWidget.getConversationHistory().slice(0, -1), // Exclude last message (just added)
         message,
         allText,
@@ -1723,8 +1721,8 @@ export default function App() {
         </div>
       )}
 
-      {/* @@@ Hide sidebar on mobile */}
-      {!isMobile && <LeftSidebar currentView={currentView} onViewChange={setCurrentView} />}
+      {/* @@@ Hide top nav on mobile */}
+      {!isMobile && <TopNavBar currentView={currentView} onViewChange={setCurrentView} />}
 
       {currentView === 'writing' && (
         <div style={{
diff --git a/frontend/src/api/voiceApi.ts b/frontend/src/api/voiceApi.ts
index 2b3506f..f31a13c 100644
--- a/frontend/src/api/voiceApi.ts
+++ b/frontend/src/api/voiceApi.ts
@@ -34,7 +34,8 @@ interface SyncResponse {
   result?: {
     voices?: Array<{
       phrase: string;
-      voice: string;
+      voice_id: string;  // NEW: Voice ID for lookup
+      voice: string;     // Display name
       comment: string;
       icon: string;
       color: string;
@@ -55,26 +56,36 @@ interface SyncResponse {
 }
 
 /**
- * Analyze text and return voices with metadata (sync API - no polling!)
+ * Analyze text and return voices with metadata (PolyCLI direct call)
+ * Backend loads voice configs from database using user_id from JWT token
  */
-export async function analyzeText(text: string, sessionId: string, voices?: any, appliedComments?: any[], metaPrompt?: string, statePrompt?: string, overlappedPhrases?: string[]) {
-  const response = await fetch(`${API_BASE}/api/analyze`, {
+export async function analyzeText(text: string, sessionId: string, appliedComments?: any[], metaPrompt?: string, statePrompt?: string, overlappedPhrases?: string[]) {
+  const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
+
+  const response = await fetch(`${API_BASE}/polycli/api/trigger-sync`, {
     method: 'POST',
-    headers: { 'Content-Type': 'application/json' },
+    headers: {
+      'Content-Type': 'application/json',
+      'Authorization': `Bearer ${token}`
+    },
     body: JSON.stringify({
-      text,
-      session_id: sessionId,
-      voices,
-      applied_comments: appliedComments || [],
-      meta_prompt: metaPrompt || '',
-      state_prompt: statePrompt || '',
-      overlapped_phrases: overlappedPhrases || []
+      session_id: 'analyze_text',  // Maps to function name in backend (NOT the display name)
+      params: {
+        text,
+        editor_session_id: sessionId,  // Renamed to avoid conflict with PolyCLI routing session_id
+        applied_comments: appliedComments || [],
+        meta_prompt: metaPrompt || '',
+        state_prompt: statePrompt || '',
+        overlapped_phrases: overlappedPhrases || []
+      },
+      timeout: 60
     })
   });
 
   const data: SyncResponse = await response.json();
 
   if (!data.success) {
+    console.error('âŒ Analysis failed:', data);
     throw new Error(data.error || 'Analysis failed');
   }
 
@@ -86,28 +97,36 @@ export async function analyzeText(text: string, sessionId: string, voices?: any,
 }
 
 /**
- * Chat with a voice persona (sync API - no polling!)
+ * Chat with a voice persona (PolyCLI direct call)
+ * Backend loads voice config from database using voice_id and user_id from JWT
  */
 export async function chatWithVoice(
-  voiceName: string,
-  voiceConfig: any,
+  voiceId: string,  // Voice ID for database lookup (e.g., "holder", "mirror")
   conversationHistory: Array<{ role: string; content: string }>,
   userMessage: string,
   originalText?: string,
   metaPrompt?: string,
   statePrompt?: string
 ): Promise<string> {
-  const response = await fetch(`${API_BASE}/api/chat`, {
+  const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
+
+  const response = await fetch(`${API_BASE}/polycli/api/trigger-sync`, {
     method: 'POST',
-    headers: { 'Content-Type': 'application/json' },
+    headers: {
+      'Content-Type': 'application/json',
+      'Authorization': `Bearer ${token}`
+    },
     body: JSON.stringify({
-      voice_name: voiceName,
-      voice_config: voiceConfig,
-      conversation_history: conversationHistory,
-      user_message: userMessage,
-      original_text: originalText || '',
-      meta_prompt: metaPrompt || '',
-      state_prompt: statePrompt || ''
+      session_id: 'chat_with_voice',
+      params: {
+        voice_id: voiceId,
+        conversation_history: conversationHistory,
+        user_message: userMessage,
+        original_text: originalText || '',
+        meta_prompt: metaPrompt || '',
+        state_prompt: statePrompt || ''
+      },
+      timeout: 60
     })
   });
 
@@ -121,13 +140,22 @@ export async function chatWithVoice(
 }
 
 /**
- * Analyze echoes (recurring themes) from all notes (sync API - no polling!)
+ * Analyze echoes (recurring themes) from all notes (PolyCLI direct call)
  */
 export async function analyzeEchoes(allNotes: string): Promise<any[]> {
-  const response = await fetch(`${API_BASE}/api/analyze-echoes`, {
+  const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
+
+  const response = await fetch(`${API_BASE}/polycli/api/trigger-sync`, {
     method: 'POST',
-    headers: { 'Content-Type': 'application/json' },
-    body: JSON.stringify({ all_notes: allNotes })
+    headers: {
+      'Content-Type': 'application/json',
+      'Authorization': `Bearer ${token}`
+    },
+    body: JSON.stringify({
+      session_id: 'analyze_echoes',
+      params: { all_notes: allNotes },
+      timeout: 60
+    })
   });
 
   const data: SyncResponse = await response.json();
@@ -140,13 +168,22 @@ export async function analyzeEchoes(allNotes: string): Promise<any[]> {
 }
 
 /**
- * Analyze traits (personality characteristics) from all notes (sync API - no polling!)
+ * Analyze traits (personality characteristics) from all notes (PolyCLI direct call)
  */
 export async function analyzeTraits(allNotes: string): Promise<any[]> {
-  const response = await fetch(`${API_BASE}/api/analyze-traits`, {
+  const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
+
+  const response = await fetch(`${API_BASE}/polycli/api/trigger-sync`, {
     method: 'POST',
-    headers: { 'Content-Type': 'application/json' },
-    body: JSON.stringify({ all_notes: allNotes })
+    headers: {
+      'Content-Type': 'application/json',
+      'Authorization': `Bearer ${token}`
+    },
+    body: JSON.stringify({
+      session_id: 'analyze_traits',
+      params: { all_notes: allNotes },
+      timeout: 60
+    })
   });
 
   const data: SyncResponse = await response.json();
@@ -159,13 +196,22 @@ export async function analyzeTraits(allNotes: string): Promise<any[]> {
 }
 
 /**
- * Analyze patterns (behavioral patterns) from all notes (sync API - no polling!)
+ * Analyze patterns (behavioral patterns) from all notes (PolyCLI direct call)
  */
 export async function analyzePatterns(allNotes: string): Promise<any[]> {
-  const response = await fetch(`${API_BASE}/api/analyze-patterns`, {
+  const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
+
+  const response = await fetch(`${API_BASE}/polycli/api/trigger-sync`, {
     method: 'POST',
-    headers: { 'Content-Type': 'application/json' },
-    body: JSON.stringify({ all_notes: allNotes })
+    headers: {
+      'Content-Type': 'application/json',
+      'Authorization': `Bearer ${token}`
+    },
+    body: JSON.stringify({
+      session_id: 'analyze_patterns',
+      params: { all_notes: allNotes },
+      timeout: 60
+    })
   });
 
   const data: SyncResponse = await response.json();
@@ -178,13 +224,22 @@ export async function analyzePatterns(allNotes: string): Promise<any[]> {
 }
 
 /**
- * Generate a daily picture based on user's notes (sync API - no polling!)
+ * Generate a daily picture based on user's notes (PolyCLI direct call)
  */
 export async function generateDailyPicture(allNotes: string): Promise<{ image_base64: string; thumbnail_base64?: string; prompt: string }> {
-  const response = await fetch(`${API_BASE}/api/generate-image`, {
+  const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
+
+  const response = await fetch(`${API_BASE}/polycli/api/trigger-sync`, {
     method: 'POST',
-    headers: { 'Content-Type': 'application/json' },
-    body: JSON.stringify({ all_notes: allNotes })
+    headers: {
+      'Content-Type': 'application/json',
+      'Authorization': `Bearer ${token}`
+    },
+    body: JSON.stringify({
+      session_id: 'generate_daily_picture',
+      params: { all_notes: allNotes },
+      timeout: 60
+    })
   });
 
   const data: SyncResponse = await response.json();
@@ -417,13 +472,22 @@ export interface VoiceInspiration {
 }
 
 export async function getSuggestion(text: string, metaPrompt?: string, statePrompt?: string): Promise<VoiceInspiration | null> {
-  const response = await fetch(`${API_BASE}/api/suggest`, {
+  const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
+
+  const response = await fetch(`${API_BASE}/polycli/api/trigger-sync`, {
     method: 'POST',
-    headers: { 'Content-Type': 'application/json' },
+    headers: {
+      'Content-Type': 'application/json',
+      'Authorization': `Bearer ${token}`
+    },
     body: JSON.stringify({
-      text,
-      meta_prompt: metaPrompt || '',
-      state_prompt: statePrompt || ''
+      session_id: 'get_writing_suggestion',
+      params: {
+        text,
+        meta_prompt: metaPrompt || '',
+        state_prompt: statePrompt || ''
+      },
+      timeout: 60
     })
   });
 
@@ -434,8 +498,8 @@ export async function getSuggestion(text: string, metaPrompt?: string, stateProm
 
   const data = await response.json();
 
-  // @@@ PolyCLI trigger-sync wraps the session result in data.result
-  if (data.result && data.result.success && data.result.inspiration) {
+  // PolyCLI returns {success: true, result: {...}}
+  if (data.success && data.result?.inspiration) {
     return {
       inspiration: data.result.inspiration,
       voice: data.result.voice,
diff --git a/frontend/src/components/StateChooser.tsx b/frontend/src/components/StateChooser.tsx
index c6d9cc1..2700837 100644
--- a/frontend/src/components/StateChooser.tsx
+++ b/frontend/src/components/StateChooser.tsx
@@ -11,6 +11,7 @@ interface Props {
 export default function StateChooser({ stateConfig, selectedState, onChoose }: Props) {
   const [isExpanded, setIsExpanded] = useState(!selectedState);
   const [shouldAnimate, setShouldAnimate] = useState(false);
+  const [isFadingOut, setIsFadingOut] = useState(false);
   const indicatorRef = useRef<HTMLDivElement>(null);
 
   // @@@ Collapse when selectedState is set externally
@@ -35,8 +36,15 @@ export default function StateChooser({ stateConfig, selectedState, onChoose }: P
   });
 
   const handleStateSelect = (stateId: string) => {
-    onChoose(stateId);
-    setIsExpanded(false);
+    // Trigger fade-out animation
+    setIsFadingOut(true);
+
+    // Wait for animation, then collapse and notify parent
+    setTimeout(() => {
+      setIsExpanded(false);
+      setIsFadingOut(false);
+      onChoose(stateId);
+    }, 800); // Match animation duration
   };
 
   // @@@ Mini icon generator for collapsed state (24px version)
@@ -161,53 +169,62 @@ export default function StateChooser({ stateConfig, selectedState, onChoose }: P
           </div>
         </div>
       ) : (
-        /* Expanded view - cube centered on entire screen */
-        <>
-          {/* Date header - stays in place */}
-          <div style={{
-            fontSize: 13,
-            color: '#666',
-            fontWeight: 400
+        /* Expanded view - full-screen white overlay */
+        <div style={{
+          position: 'fixed',
+          top: 0,
+          left: 0,
+          right: 0,
+          bottom: 0,
+          backgroundColor: '#ffffff',
+          display: 'flex',
+          flexDirection: 'column',
+          justifyContent: 'center',
+          alignItems: 'center',
+          zIndex: 9999,
+          opacity: isFadingOut ? 0 : 1,
+          transition: 'opacity 0.8s ease-out',
+          pointerEvents: isFadingOut ? 'none' : 'auto'
+        }}>
+          {/* Header text */}
+          <h1 style={{
+            fontSize: 48,
+            fontWeight: 300,
+            color: '#333',
+            marginBottom: 60,
+            textAlign: 'center',
+            letterSpacing: '0.05em',
+            opacity: isFadingOut ? 0 : 1,
+            transform: isFadingOut ? 'translateY(-20px)' : 'translateY(0)',
+            transition: 'all 0.8s ease-out'
           }}>
-            {dateString}
-          </div>
+            {stateConfig.greeting || "What's your emotion today?"}
+          </h1>
 
-          {/* Fixed overlay - cube centered on viewport */}
+          {/* 3D Cube */}
           <div style={{
-            position: 'fixed',
-            top: 0,
-            left: 0,
-            right: 0,
-            bottom: 0,
-            display: 'flex',
-            alignItems: 'center',
-            justifyContent: 'center',
-            zIndex: 1000,
-            pointerEvents: 'none'
+            opacity: isFadingOut ? 0 : 1,
+            transform: isFadingOut ? 'scale(0.9)' : 'scale(1)',
+            transition: 'all 0.8s ease-out'
           }}>
-            <div style={{
-              display: 'flex',
-              flexDirection: 'column',
-              alignItems: 'center',
-              gap: 20,
-              pointerEvents: 'auto'
-            }}>
-              <StateCube
-                stateConfig={stateConfig}
-                onStateSelect={handleStateSelect}
-              />
-
-              {/* Helper text */}
-              <div style={{
-                fontSize: 12,
-                color: '#999',
-                textAlign: 'center'
-              }}>
-                Click a state to select
-              </div>
-            </div>
+            <StateCube
+              stateConfig={stateConfig}
+              onStateSelect={handleStateSelect}
+            />
           </div>
-        </>
+
+          {/* Helper text */}
+          <p style={{
+            marginTop: 40,
+            fontSize: 14,
+            color: '#999',
+            textAlign: 'center',
+            opacity: isFadingOut ? 0 : 1,
+            transition: 'opacity 0.8s ease-out'
+          }}>
+            Click a state to begin writing
+          </p>
+        </div>
       )}
       </div>
     </>
diff --git a/frontend/src/components/LeftSidebar.tsx b/frontend/src/components/TopNavBar.tsx
similarity index 100%
rename from frontend/src/components/LeftSidebar.tsx
rename to frontend/src/components/TopNavBar.tsx
diff --git a/frontend/src/engine/EditorEngine.ts b/frontend/src/engine/EditorEngine.ts
index 3988019..9adad8c 100644
--- a/frontend/src/engine/EditorEngine.ts
+++ b/frontend/src/engine/EditorEngine.ts
@@ -42,7 +42,8 @@ export interface Commentor {
   id: string;
   phrase: string;       // Highlighted phrase
   comment: string;      // The comment
-  voice: string;        // Voice key (for voiceConfigs[key] lookup)
+  voiceId?: string;     // NEW: Voice ID for voiceConfigs lookup (e.g., "mirror")
+  voice: string;        // Voice display name (e.g., "ç…§é•œè€…") - immutable snapshot
   icon: string;         // Icon identifier
   color: string;        // Color identifier
   appliedAt?: number;   // Timestamp when applied (if applied)
@@ -120,7 +121,6 @@ export class EditorEngine {
   private sentCache: Map<string, string> = new Map(); // Track sent sentences -> commentor hash
   private onStateChange?: (state: EditorState) => void;
   private isRequesting: boolean = false; // Track if request in progress
-  private voiceConfigs: Record<string, any> = {}; // Voice configurations from settings
 
   constructor(sessionId: string) {
     this.state = {
@@ -135,8 +135,9 @@ export class EditorEngine {
   }
 
   // @@@ Update voice configurations from settings
-  setVoiceConfigs(configs: Record<string, any>) {
-    this.voiceConfigs = configs;
+  // No-op: Backend now loads voice configs from database, not from frontend
+  setVoiceConfigs(_configs: Record<string, any>) {
+    // Kept for backward compatibility, but does nothing
   }
 
   // @@@ Update a specific text cell by ID
@@ -357,23 +358,10 @@ export class EditorEngine {
 
     try {
       // Call backend (returns ONLY ONE comment at a time)
+      // Backend loads voice configs from database using user_id from JWT token
       const { analyzeText } = await import('../api/voiceApi');
       const { getMetaPrompt, getStateConfig } = await import('../utils/voiceStorage');
 
-      // Convert voiceConfigs to backend format
-      const backendVoices: Record<string, any> = {};
-      for (const [name, cfg] of Object.entries(this.voiceConfigs)) {
-        if (cfg.enabled) {
-          backendVoices[name] = {
-            name: cfg.name,
-            tagline: cfg.systemPrompt,
-            icon: cfg.icon,
-            color: cfg.color
-          };
-        }
-      }
-      console.log('ğŸ” EditorEngine: Sending to backend, enabled voices:', Object.keys(backendVoices));
-
       // Send only APPLIED commentors to backend
       const appliedCommentors = this.state.commentors.filter(c => c.appliedAt);
       const metaPrompt = getMetaPrompt();
@@ -385,7 +373,7 @@ export class EditorEngine {
         ? stateConfig.states[selectedState].prompt
         : '';
 
-      const result = await analyzeText(text, this.state.sessionId, backendVoices, appliedCommentors, metaPrompt, statePrompt, this.state.overlappedPhrases);
+      const result = await analyzeText(text, this.state.sessionId, appliedCommentors, metaPrompt, statePrompt, this.state.overlappedPhrases);
 
       // Backend returns at most ONE voice
       if (result.voices.length > 0) {
@@ -394,7 +382,8 @@ export class EditorEngine {
           id: generateId(),
           phrase: voice.phrase,
           comment: voice.comment,
-          voice: voice.voice,
+          voiceId: voice.voice_id,     // NEW: Store ID for config lookup
+          voice: voice.voice,           // KEEP: Store name for display
           icon: voice.icon,
           color: voice.color,
           computedAt: Date.now(),
diff --git a/frontend/vite.config.ts b/frontend/vite.config.ts
index 5014455..0b6debb 100644
--- a/frontend/vite.config.ts
+++ b/frontend/vite.config.ts
@@ -11,6 +11,11 @@ export default defineConfig({
         target: 'http://localhost:8765',
         changeOrigin: true,
         rewrite: (path) => path.replace(/^\/ink-and-memory/, '')
+      },
+      '/ink-and-memory/polycli': {
+        target: 'http://localhost:8765',
+        changeOrigin: true,
+        rewrite: (path) => path.replace(/^\/ink-and-memory/, '')
       }
     }
   }
