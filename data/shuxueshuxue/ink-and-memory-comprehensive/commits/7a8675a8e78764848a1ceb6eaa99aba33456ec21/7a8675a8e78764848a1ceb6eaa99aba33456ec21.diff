commit 7a8675a8e78764848a1ceb6eaa99aba33456ec21
Author: lexicalmathical <lexicalmathical@gmail.com>
Date:   Mon Nov 17 22:41:40 2025 +0800

    Integrate deck system into all voice-related features
    
    All AI voice features now use deck system instead of old preferences:
    - Voice analysis (analyze_text): Uses load_voices_from_user_decks()
    - Writing suggestions (get_writing_suggestion): Random from enabled decks
    - Chat with voices (chat_with_voice): Looks up voice in enabled decks
    
    Benefits:
    - Users control which voices are active via Deck enable/disable toggles
    - Consistent voice source across all features
    - Cleaner architecture (deck system is single source of truth)
    
    Changes:
    - backend/server.py: Update all 3 session functions to use deck system
    - backend/database.py: load_voices_from_user_decks() returns enabled voices
    - frontend/src/components/DeckManager.tsx: Toggle UI integration
    - frontend/src/api/voiceApi.ts: API client for deck sync
    
    Related: Auto-fork system, sync functionality already implemented

diff --git a/backend/database.py b/backend/database.py
index 8326b41..c2820c8 100644
--- a/backend/database.py
+++ b/backend/database.py
@@ -541,6 +541,133 @@ def fork_deck(user_id: int, deck_id: str) -> str:
     finally:
         db.close()
 
+def sync_deck_with_parent(user_id: int, deck_id: str, force: bool = False) -> dict:
+    """
+    Sync user's forked deck with parent template (complete reset).
+
+    Deletes all user's voices and re-creates from parent template.
+    This ensures deleted voices reappear and new parent voices are added.
+
+    Returns: {"success": True, "synced_voices": N}
+    Raises ValueError if deck not found, no parent, or parent missing
+    """
+    import uuid
+
+    db = get_db()
+    try:
+        # Get user's deck
+        deck = db.execute(
+            "SELECT * FROM decks WHERE id = ? AND owner_id = ?",
+            (deck_id, user_id)
+        ).fetchone()
+
+        if not deck:
+            raise ValueError("Deck not found or permission denied")
+
+        if not deck['parent_id']:
+            raise ValueError("Deck is not a fork (no parent)")
+
+        # Get parent deck
+        parent = db.execute(
+            "SELECT * FROM decks WHERE id = ?",
+            (deck['parent_id'],)
+        ).fetchone()
+
+        if not parent:
+            raise ValueError("Parent deck not found")
+
+        # @@@ Step 1: Sync deck metadata (preserve user preferences like enabled/order)
+        db.execute("""
+        UPDATE decks SET
+            name = ?, name_zh = ?, name_en = ?,
+            description = ?, description_zh = ?, description_en = ?,
+            icon = ?, color = ?,
+            has_local_changes = 0,
+            updated_at = CURRENT_TIMESTAMP
+        WHERE id = ?
+        """, (parent['name'], parent['name_zh'], parent['name_en'],
+              parent['description'], parent['description_zh'], parent['description_en'],
+              parent['icon'], parent['color'],
+              deck_id))
+
+        # @@@ Step 2: Delete ALL user's voices in this deck
+        db.execute("DELETE FROM voices WHERE deck_id = ?", (deck_id,))
+
+        # @@@ Step 3: Re-create all voices from parent (fresh copy)
+        parent_voices = db.execute(
+            "SELECT * FROM voices WHERE deck_id = ? ORDER BY order_index",
+            (deck['parent_id'],)
+        ).fetchall()
+
+        synced_count = 0
+        for parent_voice in parent_voices:
+            new_voice_id = str(uuid.uuid4())
+            db.execute("""
+            INSERT INTO voices (id, deck_id, name, name_zh, name_en, system_prompt,
+                              icon, color, is_system, parent_id, owner_id, enabled, has_local_changes, order_index)
+            VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?, 1, 0, ?)
+            """, (new_voice_id,
+                  deck_id,  # User's deck
+                  parent_voice['name'],
+                  parent_voice['name_zh'],
+                  parent_voice['name_en'],
+                  parent_voice['system_prompt'],
+                  parent_voice['icon'],
+                  parent_voice['color'],
+                  parent_voice['id'],  # parent_id tracks original
+                  user_id,
+                  parent_voice['order_index']))
+            synced_count += 1
+
+        db.commit()
+        return {"success": True, "synced_voices": synced_count}
+    finally:
+        db.close()
+
+def load_voices_from_user_decks(user_id: int) -> dict:
+    """
+    Load all enabled voices from user's enabled decks for LLM analysis.
+
+    Returns dict format: {voice_id: {name, systemPrompt, icon, color}}
+    Compatible with analyze_stateless() expectations.
+    """
+    db = get_db()
+    try:
+        # Get all user's enabled decks
+        enabled_decks = db.execute("""
+        SELECT id FROM decks
+        WHERE owner_id = ? AND enabled = 1
+        ORDER BY order_index, created_at
+        """, (user_id,)).fetchall()
+
+        if not enabled_decks:
+            return {}
+
+        deck_ids = [deck['id'] for deck in enabled_decks]
+
+        # Get all enabled voices from these decks
+        placeholders = ','.join('?' * len(deck_ids))
+        voices = db.execute(f"""
+        SELECT id, name, system_prompt, icon, color
+        FROM voices
+        WHERE deck_id IN ({placeholders}) AND enabled = 1
+        ORDER BY order_index, created_at
+        """, deck_ids).fetchall()
+
+        # Convert to expected format
+        voice_dict = {}
+        for voice in voices:
+            voice_dict[voice['id']] = {
+                'name': voice['name'],
+                'systemPrompt': voice['system_prompt'],
+                'icon': voice['icon'],
+                'color': voice['color']
+            }
+
+        return voice_dict
+    finally:
+        db.close()
+
 # ========== Voice CRUD ==========
 
 def create_voice(user_id: int, deck_id: str, name: str, system_prompt: str,
diff --git a/backend/server.py b/backend/server.py
index 4a2d3e9..992d88a 100644
--- a/backend/server.py
+++ b/backend/server.py
@@ -40,14 +40,20 @@ def get_writing_suggestion(text: str, user_id: int, meta_prompt: str = "", state
     if not text or len(text.strip()) < 10:
         return {"success": False, "error": "Text too short"}
 
-    # @@@ Pick a random voice persona to deliver inspiration
+    # @@@ Load voices from user's enabled decks (deck system)
     import random
-    from config import VOICE_ARCHETYPES
 
-    voice_key = random.choice(list(VOICE_ARCHETYPES.keys()))
-    voice_info = VOICE_ARCHETYPES[voice_key]
+    voices = database.load_voices_from_user_decks(user_id)
+
+    if not voices:
+        return {"success": False, "error": "No enabled voices found in your decks"}
+
+    # Pick a random enabled voice
+    voice_key = random.choice(list(voices.keys()))
+    voice_info = voices[voice_key]
 
     print(f"üé≠ Selected voice: {voice_info['name']} ({voice_key})")
+    print(f"üìö Selected from {len(voices)} enabled voices")
 
     agent = PolyAgent(id="writing-suggester")
 
@@ -139,28 +145,20 @@ def chat_with_voice(voice_id: str, user_id: int, conversation_history: list, use
     print(f"   State prompt: {repr(state_prompt)[:100]}")
     print(f"{'='*60}\n")
 
-    # @@@ Load user's voice configs from database
-    prefs = database.get_preferences(user_id)
-    voice_configs = prefs['voice_configs'] if prefs and prefs['voice_configs'] else {}
+    # @@@ Load voices from user's enabled decks (deck system)
+    voices = database.load_voices_from_user_decks(user_id)
 
     # @@@ Get voice config for this specific voice
-    if voice_id in voice_configs:
-        voice_config = voice_configs[voice_id]
+    if voice_id in voices:
+        voice_config = voices[voice_id]
         voice_name = voice_config.get('name', voice_id)
-        print(f"üìö Loaded voice config from database for {voice_id}: {voice_name}")
+        print(f"üìö Loaded voice from deck system: {voice_id} ({voice_name})")
     else:
-        # Fallback: use default from config.VOICE_ARCHETYPES
-        import config
-        if voice_id in config.VOICE_ARCHETYPES:
-            default_voice = config.VOICE_ARCHETYPES[voice_id]
-            voice_name = default_voice['name']
-            voice_config = {"systemPrompt": default_voice['systemPrompt']}
-            print(f"üìö Using default voice config for {voice_id}: {voice_name}")
-        else:
-            # Ultimate fallback
-            voice_name = voice_id
-            voice_config = {"systemPrompt": f"{voice_name} voice"}
-            print(f"‚ö†Ô∏è  Voice {voice_id} not found, using fallback")
+        # Fallback: voice might be disabled or not in user's decks
+        return {
+            "success": False,
+            "error": f"Voice {voice_id} not found in your enabled decks. Please enable it in the Decks tab."
+        }
 
     agent = PolyAgent(id=f"voice-chat-{voice_name.lower()}")
 
@@ -249,10 +247,9 @@ def analyze_text(text: str, editor_session_id: str, user_id: int, applied_commen
     print(f"   State prompt: {repr(state_prompt)[:100]}")
     print(f"{'='*60}\n")
 
-    # @@@ Load user's voice configs from database
-    prefs = database.get_preferences(user_id)
-    voices = prefs['voice_configs'] if prefs and prefs['voice_configs'] else None
-    print(f"üìö Loaded voice configs from database: {list(voices.keys()) if voices else 'None (will use defaults)'}")
+    # @@@ Load voices from user's enabled decks (deck system)
+    voices = database.load_voices_from_user_decks(user_id)
+    print(f"üìö Loaded {len(voices)} enabled voices from deck system: {list(voices.keys()) if voices else 'None (will use defaults)'}")
 
     agent = PolyAgent(id="voice-analyzer")
 
@@ -1307,6 +1304,16 @@ def fork_deck(deck_id: str, current_user: dict = Depends(get_current_user)):
     except ValueError as e:
         raise HTTPException(status_code=404, detail=str(e))
 
+@app.post("/api/decks/{deck_id}/sync")
+def sync_deck(deck_id: str, current_user: dict = Depends(get_current_user)):
+    """Sync user's forked deck with parent template (force overwrites local changes)"""
+    user_id = current_user['user_id']
+    try:
+        result = database.sync_deck_with_parent(user_id, deck_id, force=True)
+        return result
+    except ValueError as e:
+        raise HTTPException(status_code=400, detail=str(e))
+
 @app.post("/api/voices")
 def create_voice(request: VoiceCreateRequest, current_user: dict = Depends(get_current_user)):
     """Create a new voice in a user deck"""
diff --git a/frontend/src/api/voiceApi.ts b/frontend/src/api/voiceApi.ts
index 731fe23..a5c8575 100644
--- a/frontend/src/api/voiceApi.ts
+++ b/frontend/src/api/voiceApi.ts
@@ -742,6 +742,23 @@ export async function forkDeck(deckId: string): Promise<{ deck_id: string }> {
   return await response.json();
 }
 
+/**
+ * Sync deck with parent template (force overwrites local changes)
+ */
+export async function syncDeck(deckId: string): Promise<{ success: boolean; synced_voices: number }> {
+  const response = await fetch(`${API_BASE}/api/decks/${deckId}/sync`, {
+    method: 'POST',
+    headers: getAuthHeaders()
+  });
+
+  if (!response.ok) {
+    const error = await response.json();
+    throw new Error(error.detail || 'Sync deck failed');
+  }
+
+  return await response.json();
+}
+
 /**
  * Create a new voice in a deck
  */
diff --git a/frontend/src/components/DeckManager.tsx b/frontend/src/components/DeckManager.tsx
index f33003e..8bb55e6 100644
--- a/frontend/src/components/DeckManager.tsx
+++ b/frontend/src/components/DeckManager.tsx
@@ -6,6 +6,7 @@ import {
   updateDeck,
   deleteDeck,
   forkDeck,
+  syncDeck,
   createVoice,
   updateVoice,
   deleteVoice,
@@ -146,6 +147,19 @@ export default function DeckManager({ onUpdate }: Props) {
     }
   }
 
+  async function handleSyncDeck(deckId: string) {
+    if (!confirm('Sync with original template? This will overwrite any changes you made to this deck.')) return;
+
+    try {
+      const result = await syncDeck(deckId);
+      alert(`‚úÖ Synced ${result.synced_voices} voices with original template`);
+      await loadDecks();
+      onUpdate?.();
+    } catch (err: any) {
+      alert(`Failed to sync deck: ${err.message}`);
+    }
+  }
+
   async function handleToggleVoice(voiceId: string, currentEnabled: boolean) {
     try {
       await updateVoice(voiceId, { enabled: !currentEnabled });
@@ -320,6 +334,7 @@ export default function DeckManager({ onUpdate }: Props) {
                       color: '#2c2c2c',
                       marginBottom: 4
                     }}>
+                      {console.log('üîç Rendering deck:', deck.name, 'order_index:', deck.order_index, 'full deck:', deck)}
                       {deck.name}
                       {isSystem && (
                         <span style={{
@@ -406,30 +421,59 @@ export default function DeckManager({ onUpdate }: Props) {
                         Fork to My Collection
                       </button>
                     ) : (
-                      <button
-                        onClick={() => handleDeleteDeck(deck.id)}
-                        style={{
-                          padding: '8px 16px',
-                          background: '#e74c3c',
-                          color: '#fff',
-                          border: 'none',
-                          borderRadius: 6,
-                          cursor: 'pointer',
-                          fontSize: 13,
-                          fontWeight: 600,
-                          transition: 'all 0.2s'
-                        }}
-                        onMouseEnter={(e) => {
-                          e.currentTarget.style.transform = 'translateY(-1px)';
-                          e.currentTarget.style.boxShadow = '0 4px 12px rgba(231, 76, 60, 0.4)';
-                        }}
-                        onMouseLeave={(e) => {
-                          e.currentTarget.style.transform = 'translateY(0)';
-                          e.currentTarget.style.boxShadow = 'none';
-                        }}
-                      >
-                        Delete Deck
-                      </button>
+                      <>
+                        {/* @@@ Show sync button if deck has a parent */}
+                        {deck.parent_id && (
+                          <button
+                            onClick={() => handleSyncDeck(deck.id)}
+                            style={{
+                              padding: '8px 16px',
+                              background: '#3498db',
+                              color: '#fff',
+                              border: 'none',
+                              borderRadius: 6,
+                              cursor: 'pointer',
+                              fontSize: 13,
+                              fontWeight: 600,
+                              transition: 'all 0.2s'
+                            }}
+                            onMouseEnter={(e) => {
+                              e.currentTarget.style.transform = 'translateY(-1px)';
+                              e.currentTarget.style.boxShadow = '0 4px 12px rgba(52, 152, 219, 0.4)';
+                            }}
+                            onMouseLeave={(e) => {
+                              e.currentTarget.style.transform = 'translateY(0)';
+                              e.currentTarget.style.boxShadow = 'none';
+                            }}
+                          >
+                            Sync with Original
+                          </button>
+                        )}
+                        <button
+                          onClick={() => handleDeleteDeck(deck.id)}
+                          style={{
+                            padding: '8px 16px',
+                            background: '#e74c3c',
+                            color: '#fff',
+                            border: 'none',
+                            borderRadius: 6,
+                            cursor: 'pointer',
+                            fontSize: 13,
+                            fontWeight: 600,
+                            transition: 'all 0.2s'
+                          }}
+                          onMouseEnter={(e) => {
+                            e.currentTarget.style.transform = 'translateY(-1px)';
+                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(231, 76, 60, 0.4)';
+                          }}
+                          onMouseLeave={(e) => {
+                            e.currentTarget.style.transform = 'translateY(0)';
+                            e.currentTarget.style.boxShadow = 'none';
+                          }}
+                        >
+                          Delete Deck
+                        </button>
+                      </>
                     )}
                   </div>
                 </div>
