{
  "sha": "06b7c9539721d80431b5f072591f13ab241be5c9",
  "node_id": "C_kwDOP2Zrm9oAKDA2YjdjOTUzOTcyMWQ4MDQzMWI1ZjA3MjU5MWYxM2FiMjQxYmU1Yzk",
  "commit": {
    "author": {
      "name": "shuxueshuxue",
      "email": "shuxue@protonmail.com",
      "date": "2025-12-28T12:41:59Z"
    },
    "committer": {
      "name": "shuxueshuxue",
      "email": "shuxue@protonmail.com",
      "date": "2025-12-28T12:41:59Z"
    },
    "message": "Refactor model role config",
    "tree": {
      "sha": "0121c9c4c192720c03b117e1d6fd3d616b05a2bd",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/0121c9c4c192720c03b117e1d6fd3d616b05a2bd"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/06b7c9539721d80431b5f072591f13ab241be5c9",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/06b7c9539721d80431b5f072591f13ab241be5c9",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/06b7c9539721d80431b5f072591f13ab241be5c9",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/06b7c9539721d80431b5f072591f13ab241be5c9/comments",
  "author": {
    "login": "shuxueshuxue",
    "id": 98064968,
    "node_id": "U_kgDOBdhaSA",
    "avatar_url": "https://avatars.githubusercontent.com/u/98064968?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/shuxueshuxue",
    "html_url": "https://github.com/shuxueshuxue",
    "followers_url": "https://api.github.com/users/shuxueshuxue/followers",
    "following_url": "https://api.github.com/users/shuxueshuxue/following{/other_user}",
    "gists_url": "https://api.github.com/users/shuxueshuxue/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/shuxueshuxue/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/shuxueshuxue/subscriptions",
    "organizations_url": "https://api.github.com/users/shuxueshuxue/orgs",
    "repos_url": "https://api.github.com/users/shuxueshuxue/repos",
    "events_url": "https://api.github.com/users/shuxueshuxue/events{/privacy}",
    "received_events_url": "https://api.github.com/users/shuxueshuxue/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "committer": {
    "login": "shuxueshuxue",
    "id": 98064968,
    "node_id": "U_kgDOBdhaSA",
    "avatar_url": "https://avatars.githubusercontent.com/u/98064968?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/shuxueshuxue",
    "html_url": "https://github.com/shuxueshuxue",
    "followers_url": "https://api.github.com/users/shuxueshuxue/followers",
    "following_url": "https://api.github.com/users/shuxueshuxue/following{/other_user}",
    "gists_url": "https://api.github.com/users/shuxueshuxue/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/shuxueshuxue/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/shuxueshuxue/subscriptions",
    "organizations_url": "https://api.github.com/users/shuxueshuxue/orgs",
    "repos_url": "https://api.github.com/users/shuxueshuxue/repos",
    "events_url": "https://api.github.com/users/shuxueshuxue/events{/privacy}",
    "received_events_url": "https://api.github.com/users/shuxueshuxue/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "ef86eae3a0b76d40b623db81076277c87b8192cd",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/ef86eae3a0b76d40b623db81076277c87b8192cd",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/ef86eae3a0b76d40b623db81076277c87b8192cd"
    }
  ],
  "stats": {
    "total": 207,
    "additions": 138,
    "deletions": 69
  },
  "files": [
    {
      "sha": "de616bd36a452f7132ff63367c8c7853d049caba",
      "filename": "README.md",
      "status": "modified",
      "additions": 9,
      "deletions": 3,
      "changes": 12,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/06b7c9539721d80431b5f072591f13ab241be5c9/README.md",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/06b7c9539721d80431b5f072591f13ab241be5c9/README.md",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/README.md?ref=06b7c9539721d80431b5f072591f13ab241be5c9",
      "patch": "@@ -95,15 +95,21 @@ Create a `models.json` file for your LLM:\n ```json\n {\n   \"models\": {\n-    \"default\": {\n-      \"endpoint\": \"https://api.your-provider.com/v1\",\n+    \"gemini-3-flash-preview\": {\n+      \"endpoint\": \"https://openrouter.ai/api/v1\",\n       \"api_key\": \"your-key-here\",\n-      \"model\": \"gpt-4o\"\n+      \"model\": \"google/gemini-3-flash-preview\"\n     }\n+  },\n+  \"roles\": {\n+    \"voice_analysis\": \"gemini-3-flash-preview\",\n+    \"voice_chat\": \"gemini-3-flash-preview\"\n   }\n }\n ```\n \n+See `backend/models.json.example` for the full set of roles and image settings.\n+\n Then start the server:\n \n ```bash"
    },
    {
      "sha": "c9316dec22949ec68bbb2aedcf92658f412ba90a",
      "filename": "README.zh.md",
      "status": "modified",
      "additions": 9,
      "deletions": 3,
      "changes": 12,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/06b7c9539721d80431b5f072591f13ab241be5c9/README.zh.md",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/06b7c9539721d80431b5f072591f13ab241be5c9/README.zh.md",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/README.zh.md?ref=06b7c9539721d80431b5f072591f13ab241be5c9",
      "patch": "@@ -95,15 +95,21 @@ uv pip install -r requirements.txt\n ```json\n {\n   \"models\": {\n-    \"default\": {\n-      \"endpoint\": \"https://api.your-provider.com/v1\",\n+    \"gemini-3-flash-preview\": {\n+      \"endpoint\": \"https://openrouter.ai/api/v1\",\n       \"api_key\": \"your-key-here\",\n-      \"model\": \"gpt-4o\"\n+      \"model\": \"google/gemini-3-flash-preview\"\n     }\n+  },\n+  \"roles\": {\n+    \"voice_analysis\": \"gemini-3-flash-preview\",\n+    \"voice_chat\": \"gemini-3-flash-preview\"\n   }\n }\n ```\n \n+\u5b8c\u6574\u914d\u7f6e\u9009\u9879\uff08\u5305\u62ec\u56fe\u7247\u751f\u6210\u8bbe\u7f6e\uff09\u8bf7\u53c2\u8003 `backend/models.json.example`\u3002\n+\n \u7136\u540e\u542f\u52a8\u670d\u52a1\u5668\uff1a\n \n ```bash"
    },
    {
      "sha": "8703025d804b34d55523ec0b392db4d8cde9d28b",
      "filename": "backend/config.py",
      "status": "modified",
      "additions": 80,
      "deletions": 63,
      "changes": 143,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/06b7c9539721d80431b5f072591f13ab241be5c9/backend%2Fconfig.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/06b7c9539721d80431b5f072591f13ab241be5c9/backend%2Fconfig.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fconfig.py?ref=06b7c9539721d80431b5f072591f13ab241be5c9",
      "patch": "@@ -2,84 +2,101 @@\n \n import json\n import os\n+from typing import Any, Dict\n \n-# VOICE_ANALYSIS_MODEL = \"claude-haiku-4.5\"\n-# VOICE_ANALYSIS_MODEL = \"deepseek-v3.2\"\n-# VOICE_ANALYSIS_MODEL = \"gemini-3-pro-preview\"\n-# VOICE_ANALYSIS_MODEL = \"mistral-small-creative\"\n-# VOICE_ANALYSIS_MODEL = \"claude-sonnet-4.5\"\n-VOICE_ANALYSIS_MODEL = \"gemini-3-flash-preview\"\n+CONFIG_PATH = os.path.join(os.path.dirname(__file__), \"models.json\")\n \n-# VOICE_INSPIRATION_MODEL = \"claude-sonnet-4.5\"\n-VOICE_INSPIRATION_MODEL = \"gemini-3-flash-preview\"\n \n-# VOICE_CHAT_MODEL = \"claude-sonnet-4.5\"\n-VOICE_CHAT_MODEL = \"gemini-3-flash-preview\"\n+def _load_models_config() -> Dict[str, Any]:\n+    \"\"\"Load configuration from models.json.\"\"\"\n+    if not os.path.exists(CONFIG_PATH):\n+        raise RuntimeError(\n+            \"models.json not found; copy backend/models.json.example and fill in your keys\"\n+        )\n+    with open(CONFIG_PATH, \"r\", encoding=\"utf-8\") as f:\n+        data = json.load(f)\n+    if not isinstance(data, dict):\n+        raise RuntimeError(\"models.json must contain a JSON object at the top level\")\n+    return data\n \n-# ECHO_ANALYSIS_MODEL = \"claude-sonnet-4.5\"\n-ECHO_ANALYSIS_MODEL = \"gemini-3-flash-preview\"\n \n-# TRAIT_ANALYSIS_MODEL = \"claude-sonnet-4.5\"\n-TRAIT_ANALYSIS_MODEL = \"gemini-3-flash-preview\"\n+_CONFIG = _load_models_config()\n \n-# PATTERN_ANALYSIS_MODEL = \"claude-sonnet-4.5\"\n-PATTERN_ANALYSIS_MODEL = \"gemini-3-flash-preview\"\n \n-# @@@ Sparsity control\n-MAX_VOICES = 5\n-MIN_TEXT_LENGTH = 20\n-SINGLE_COMMENT_MODE = (\n-    True  # If True, only add 1 comment per request (gradual accumulation)\n-)\n+def _get_roles() -> Dict[str, str]:\n+    roles = _CONFIG.get(\"roles\")\n+    if not isinstance(roles, dict) or not roles:\n+        raise RuntimeError('models.json must define a \"roles\" object with model names')\n+    return roles\n \n \n-# @@@ Image generation configuration\n-def _load_image_api_key() -> str:\n-    \"\"\"\n-    Load image API key from backend/models.json; fail loudly if missing.\n-\n-    Expected shape:\n-    {\n-      \"models\": {\n-        \"gpt-5\": {\n-          \"endpoint\": \"...\",\n-          \"api_key\": \"...\",\n-          \"model\": \"...\"\n-        },\n-        ...\n-      }\n-    }\n-    \"\"\"\n-    models_path = os.path.join(os.path.dirname(__file__), \"models.json\")\n-    if not os.path.exists(models_path):\n-        raise RuntimeError(\"models.json not found; image API key unavailable\")\n-\n-    with open(models_path, \"r\", encoding=\"utf-8\") as f:\n-        data = json.load(f)\n+_ROLES = _get_roles()\n \n-    models = data.get(\"models\") or {}\n-    for _, cfg in models.items():\n-        key = cfg.get(\"api_key\")\n-        if key:\n-            return key\n \n-    raise RuntimeError(\"No api_key found under models.* in models.json\")\n+def _role_model(role: str) -> str:\n+    try:\n+        model_name = _ROLES[role]\n+    except KeyError as exc:\n+        raise RuntimeError(f'model role \"{role}\" missing in models.json \"roles\"') from exc\n+    if not isinstance(model_name, str) or not model_name.strip():\n+        raise RuntimeError(f'model role \"{role}\" must map to a non-empty model name string')\n+    return model_name\n+\n+\n+def _resolve_model_config(model_name: str) -> Dict[str, Any]:\n+    models = _CONFIG.get(\"models\")\n+    if not isinstance(models, dict) or not models:\n+        raise RuntimeError('models.json must define a non-empty \"models\" object')\n+    entry = models.get(model_name)\n+    if not isinstance(entry, dict):\n+        raise RuntimeError(\n+            f'model \"{model_name}\" not found under \"models\" in models.json'\n+        )\n+    return entry\n+\n+\n+VOICE_ANALYSIS_MODEL = _role_model(\"voice_analysis\")\n+VOICE_INSPIRATION_MODEL = _role_model(\"voice_inspiration\")\n+VOICE_CHAT_MODEL = _role_model(\"voice_chat\")\n+ECHO_ANALYSIS_MODEL = _role_model(\"echo_analysis\")\n+TRAIT_ANALYSIS_MODEL = _role_model(\"trait_analysis\")\n+PATTERN_ANALYSIS_MODEL = _role_model(\"pattern_analysis\")\n+_IMAGE_DESCRIPTION_ROLE_KEY = _role_model(\"image_description\")\n+_IMAGE_DESCRIPTION_CONFIG = _resolve_model_config(_IMAGE_DESCRIPTION_ROLE_KEY)\n+IMAGE_DESCRIPTION_MODEL = _IMAGE_DESCRIPTION_CONFIG.get(\n+    \"model\", _IMAGE_DESCRIPTION_ROLE_KEY\n+)\n \n \n-IMAGE_API_KEY = _load_image_api_key()\n-IMAGE_API_ENDPOINT = \"https://api.dou.chat/v1\"\n-IMAGE_DESCRIPTION_MODEL = \"anthropic/claude-haiku-4.5\"\n-# IMAGE_GENERATION_MODEL = \"google/gemini-2.5-flash-image-preview\"\n-IMAGE_GENERATION_MODEL = \"google/gemini-2.5-flash-image-preview\"\n+# @@@ Image role resolution - tie model selection to the credentials used for HTTP calls\n+IMAGE_GENERATION_MODEL = _role_model(\"image_generation\")\n+_IMAGE_MODEL_CONFIG = _resolve_model_config(IMAGE_GENERATION_MODEL)\n+IMAGE_GENERATION_MODEL = _IMAGE_MODEL_CONFIG.get(\"model\", IMAGE_GENERATION_MODEL)\n+IMAGE_API_KEY = _IMAGE_MODEL_CONFIG.get(\"api_key\")\n+if not IMAGE_API_KEY:\n+    raise RuntimeError(\n+        f'api_key missing for image generation model \"{IMAGE_GENERATION_MODEL}\" in models.json'\n+    )\n+_IMAGE_API_SECTION = _CONFIG.get(\"image_api\") or {}\n+IMAGE_API_ENDPOINT = _IMAGE_MODEL_CONFIG.get(\"endpoint\") or _IMAGE_API_SECTION.get(\n+    \"endpoint\"\n+)\n+if not IMAGE_API_ENDPOINT:\n+    raise RuntimeError(\n+        f'endpoint missing for image generation model \"{IMAGE_GENERATION_MODEL}\" '\n+        'and no \"image_api.endpoint\" fallback provided'\n+    )\n \n # Retry configuration for image generation\n-IMAGE_RETRY_MAX_ATTEMPTS = 3\n-IMAGE_RETRY_BASE_TIMEOUT = 90  # First attempt: 90s, then +30s per retry\n-IMAGE_RETRY_TIMEOUT_INCREMENT = 30\n-IMAGE_MAX_TOKENS = 1000\n-IMAGE_DESCRIPTION_MAX_TOKENS = 500\n-IMAGE_DESCRIPTION_TIMEOUT = 120\n-\n+_IMAGE_RETRY = _CONFIG.get(\"image_retry\") or {}\n+IMAGE_RETRY_MAX_ATTEMPTS = _IMAGE_RETRY.get(\"max_attempts\", 3)\n+IMAGE_RETRY_BASE_TIMEOUT = _IMAGE_RETRY.get(\n+    \"base_timeout\", 90\n+)  # First attempt: 90s, then +30s per retry\n+IMAGE_RETRY_TIMEOUT_INCREMENT = _IMAGE_RETRY.get(\"timeout_increment\", 30)\n+IMAGE_MAX_TOKENS = _IMAGE_RETRY.get(\"max_tokens\", 1000)\n+IMAGE_DESCRIPTION_MAX_TOKENS = _IMAGE_RETRY.get(\"description_max_tokens\", 500)\n+IMAGE_DESCRIPTION_TIMEOUT = _IMAGE_RETRY.get(\"description_timeout\", 120)\n \n # @@@ Helper function to load voice prompts from files\n def _load_prompt(filename):"
    },
    {
      "sha": "39801cc467f120ad2bc64c352d2d714bb098d1fe",
      "filename": "backend/models.json.example",
      "status": "added",
      "additions": 40,
      "deletions": 0,
      "changes": 40,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/06b7c9539721d80431b5f072591f13ab241be5c9/backend%2Fmodels.json.example",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/06b7c9539721d80431b5f072591f13ab241be5c9/backend%2Fmodels.json.example",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fmodels.json.example?ref=06b7c9539721d80431b5f072591f13ab241be5c9",
      "patch": "@@ -0,0 +1,40 @@\n+{\n+  \"models\": {\n+    \"gemini-3-flash-preview\": {\n+      \"endpoint\": \"https://openrouter.ai/api/v1\",\n+      \"api_key\": \"sk-or-your-key\",\n+      \"model\": \"google/gemini-3-flash-preview\"\n+    },\n+    \"claude-haiku-4.5\": {\n+      \"endpoint\": \"https://api.your-provider.com/v1\",\n+      \"api_key\": \"sk-your-key\",\n+      \"model\": \"anthropic/claude-haiku-4.5\"\n+    },\n+    \"gemini-2.5-flash-image-preview\": {\n+      \"endpoint\": \"https://api.your-provider.com/v1\",\n+      \"api_key\": \"sk-your-key\",\n+      \"model\": \"google/gemini-2.5-flash-image-preview\"\n+    }\n+  },\n+  \"roles\": {\n+    \"voice_analysis\": \"gemini-3-flash-preview\",\n+    \"voice_inspiration\": \"gemini-3-flash-preview\",\n+    \"voice_chat\": \"gemini-3-flash-preview\",\n+    \"echo_analysis\": \"gemini-3-flash-preview\",\n+    \"trait_analysis\": \"gemini-3-flash-preview\",\n+    \"pattern_analysis\": \"gemini-3-flash-preview\",\n+    \"image_description\": \"claude-haiku-4.5\",\n+    \"image_generation\": \"gemini-2.5-flash-image-preview\"\n+  },\n+  \"image_api\": {\n+    \"endpoint\": \"https://api.your-provider.com/v1\"\n+  },\n+  \"image_retry\": {\n+    \"max_attempts\": 3,\n+    \"base_timeout\": 90,\n+    \"timeout_increment\": 30,\n+    \"max_tokens\": 1000,\n+    \"description_max_tokens\": 500,\n+    \"description_timeout\": 120\n+  }\n+}"
    }
  ]
}