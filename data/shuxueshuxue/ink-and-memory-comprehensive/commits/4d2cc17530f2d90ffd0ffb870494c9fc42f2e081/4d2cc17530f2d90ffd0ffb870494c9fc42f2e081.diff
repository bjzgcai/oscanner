commit 4d2cc17530f2d90ffd0ffb870494c9fc42f2e081
Author: lexicalmathical <lexicalmathical@gmail.com>
Date:   Sun Nov 2 14:02:13 2025 +0800

    Fix image generation and timeline centering for authenticated users
    
    - Make getAllNotesFromSessions() async and database-aware
    - Load notes from database for authenticated users
    - Fix timeline scroll centering by waiting for data load
    - Change useEffect dependency from [] to [initialLoading]
    - Use triple RAF for better timing guarantee

diff --git a/frontend/src/components/CollectionsView.tsx b/frontend/src/components/CollectionsView.tsx
index 3bfb80a..f7a9074 100644
--- a/frontend/src/components/CollectionsView.tsx
+++ b/frontend/src/components/CollectionsView.tsx
@@ -156,26 +156,54 @@ function getPlaceholderText(daysOffset: number): string {
   return placeholders[daysOffset.toString()] || (daysOffset < 0 ? 'what was has passed' : 'yet to be written');
 }
 
-// @@@ Get all notes from all sessions in localStorage
-function getAllNotesFromSessions(): string {
+// @@@ Get all notes from all sessions (localStorage for guest, database for authenticated)
+async function getAllNotesFromSessions(isAuthenticated: boolean): Promise<string> {
   const allText: string[] = [];
-  const keys = Object.keys(localStorage);
-
-  for (const key of keys) {
-    if (key === 'ink_memory_state' || key.startsWith('ink_memory_state_')) {
-      try {
-        const state = JSON.parse(localStorage.getItem(key) || '{}');
-        if (state.cells) {
-          const text = state.cells
-            .filter((c: any) => c.type === 'text')
-            .map((c: any) => c.content)
-            .join('\n\n');
-          if (text.trim()) {
-            allText.push(text);
+
+  if (isAuthenticated) {
+    // @@@ Load from database for authenticated users
+    try {
+      const { listSessions, getSession } = await import('../api/voiceApi');
+      const sessions = await listSessions();
+
+      for (const session of sessions) {
+        try {
+          const fullSession = await getSession(session.id);
+          if (fullSession.editor_state?.cells) {
+            const text = fullSession.editor_state.cells
+              .filter((c: any) => c.type === 'text')
+              .map((c: any) => c.content)
+              .join('\n\n');
+            if (text.trim()) {
+              allText.push(text);
+            }
+          }
+        } catch (err) {
+          console.error(`Failed to load session ${session.id}:`, err);
+        }
+      }
+    } catch (error) {
+      console.error('Failed to load sessions from database:', error);
+    }
+  } else {
+    // @@@ Load from localStorage for guests
+    const keys = Object.keys(localStorage);
+    for (const key of keys) {
+      if (key === 'ink_memory_state' || key.startsWith('ink_memory_state_')) {
+        try {
+          const state = JSON.parse(localStorage.getItem(key) || '{}');
+          if (state.cells) {
+            const text = state.cells
+              .filter((c: any) => c.type === 'text')
+              .map((c: any) => c.content)
+              .join('\n\n');
+            if (text.trim()) {
+              allText.push(text);
+            }
           }
+        } catch (e) {
+          console.error('Failed to parse session:', key, e);
         }
-      } catch (e) {
-        console.error('Failed to parse session:', key, e);
       }
     }
   }
@@ -270,25 +298,30 @@ function TimelinePage() {
 
   // @@@ Set initial scroll position to center on today's card
   useEffect(() => {
-    // Double RAF to ensure layout is complete
+    // @@@ Only center after data has loaded
+    if (initialLoading) return;
+
+    // Triple RAF to ensure layout is complete AND data is rendered
     requestAnimationFrame(() => {
       requestAnimationFrame(() => {
-        if (scrollContainerRef.current) {
-          // Today is at index 7 (after 7 past days)
-          // Each card is 500px + 4rem gap (64px) = 564px
-          // Plus left padding of 4rem (64px)
-          const cardWidth = 500 + 64;
-          const todayIndex = 7;
-          const leftPadding = 64;
-          const containerWidth = scrollContainerRef.current.clientWidth;
-
-          // Center today's card
-          const scrollLeft = leftPadding + (todayIndex * cardWidth) - (containerWidth / 2) + (250);
-          scrollContainerRef.current.scrollLeft = scrollLeft;
-        }
+        requestAnimationFrame(() => {
+          if (scrollContainerRef.current) {
+            // Today is at index 7 (after 7 past days)
+            // Each card is 500px + 4rem gap (64px) = 564px
+            // Plus left padding of 4rem (64px)
+            const cardWidth = 500 + 64;
+            const todayIndex = 7;
+            const leftPadding = 64;
+            const containerWidth = scrollContainerRef.current.clientWidth;
+
+            // Center today's card
+            const scrollLeft = leftPadding + (todayIndex * cardWidth) - (containerWidth / 2) + (250);
+            scrollContainerRef.current.scrollLeft = scrollLeft;
+          }
+        });
       });
     });
-  }, []);
+  }, [initialLoading]);
 
   const handleGenerateForDate = async (dateStr: string) => {
     // @@@ Block image generation for guests
@@ -300,7 +333,7 @@ function TimelinePage() {
     setGeneratingForDate(dateStr);
 
     try {
-      const allNotes = getAllNotesFromSessions();
+      const allNotes = await getAllNotesFromSessions(isAuthenticated);
       if (!allNotes.trim()) {
         alert('Write some notes first to generate an image!');
         return;
