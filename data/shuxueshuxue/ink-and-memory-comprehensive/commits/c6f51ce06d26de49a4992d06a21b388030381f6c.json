{
  "sha": "c6f51ce06d26de49a4992d06a21b388030381f6c",
  "node_id": "C_kwDOP2Zrm9oAKGM2ZjUxY2UwNmQyNmRlNDlhNDk5MmQwNmEyMWIzODgwMzAzODFmNmM",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-12-18T13:23:08Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-12-18T13:23:08Z"
    },
    "message": "bug fix, move hardcoded models to config",
    "tree": {
      "sha": "91443f432789fc60b479676bf75a66e42722863d",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/91443f432789fc60b479676bf75a66e42722863d"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/c6f51ce06d26de49a4992d06a21b388030381f6c",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/c6f51ce06d26de49a4992d06a21b388030381f6c",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/c6f51ce06d26de49a4992d06a21b388030381f6c",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/c6f51ce06d26de49a4992d06a21b388030381f6c/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "2e6ed85f2926c129097536d0d482bd5483682374",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/2e6ed85f2926c129097536d0d482bd5483682374",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/2e6ed85f2926c129097536d0d482bd5483682374"
    }
  ],
  "stats": {
    "total": 322,
    "additions": 193,
    "deletions": 129
  },
  "files": [
    {
      "sha": "c67aeeb4fd9997fe42a2f8d0e430f2d674543e5c",
      "filename": "backend/config.py",
      "status": "modified",
      "additions": 12,
      "deletions": 7,
      "changes": 19,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/c6f51ce06d26de49a4992d06a21b388030381f6c/backend%2Fconfig.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/c6f51ce06d26de49a4992d06a21b388030381f6c/backend%2Fconfig.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fconfig.py?ref=c6f51ce06d26de49a4992d06a21b388030381f6c",
      "patch": "@@ -3,13 +3,18 @@\n import json\n import os\n \n-# Model to use for voice analysis\n-MODEL = \"claude-haiku-4.5\"\n-MODEL = \"deepseek-v3.2\"\n-MODEL = \"gemini-3-pro-preview\"\n-MODEL = \"mistral-small-creative\"\n-MODEL = \"claude-sonnet-4.5\"\n-MODEL = \"gemini-3-flash-preview\"\n+# VOICE_ANALYSIS_MODEL = \"claude-haiku-4.5\"\n+# VOICE_ANALYSIS_MODEL = \"deepseek-v3.2\"\n+# VOICE_ANALYSIS_MODEL = \"gemini-3-pro-preview\"\n+# VOICE_ANALYSIS_MODEL = \"mistral-small-creative\"\n+# VOICE_ANALYSIS_MODEL = \"claude-sonnet-4.5\"\n+VOICE_ANALYSIS_MODEL = \"gemini-3-flash-preview\"\n+\n+VOICE_INSPIRATION_MODEL = \"gemini-3-flash-preview\"\n+VOICE_CHAT_MODEL = \"gemini-3-flash-preview\"\n+ECHO_ANALYSIS_MODEL = \"gemini-3-flash-preview\"\n+TRAIT_ANALYSIS_MODEL = \"gemini-3-flash-preview\"\n+PATTERN_ANALYSIS_MODEL = \"gemini-3-flash-preview\"\n \n # @@@ Sparsity control\n MAX_VOICES = 5"
    },
    {
      "sha": "793f61d5ebf41cb13802c7ec926e56edaa9834d2",
      "filename": "backend/server.py",
      "status": "modified",
      "additions": 6,
      "deletions": 6,
      "changes": 12,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/c6f51ce06d26de49a4992d06a21b388030381f6c/backend%2Fserver.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/c6f51ce06d26de49a4992d06a21b388030381f6c/backend%2Fserver.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fserver.py?ref=c6f51ce06d26de49a4992d06a21b388030381f6c",
      "patch": "@@ -167,11 +167,11 @@ def get_writing_suggestion(\n Give them ONE very short, gentle nudge about what to write next (max 15 words).\"\"\"\n \n     # Generate inspiration\n-    print(f\"\ud83d\udce4 Calling agent.run() with model='claude-haiku-4.5'...\")\n+    print(f\"\ud83d\udce4 Calling agent.run() with model='{config.VOICE_INSPIRATION_MODEL}'...\")\n     result = agent.run(\n         user_prompt,\n         system_prompt=system_prompt,\n-        model=\"claude-haiku-4.5\",\n+        model=config.VOICE_INSPIRATION_MODEL,\n         cli=\"no-tools\",\n         tracked=True,\n     )\n@@ -291,7 +291,7 @@ def chat_with_voice(\n     prompt += f\"\\n\\nUser: {user_message}\\n\\n{voice_name}:\"\n \n     # Get response from LLM\n-    result = agent.run(prompt, model=\"gpt-4o-dou\", cli=\"no-tools\", tracked=True)\n+    result = agent.run(prompt, model=config.VOICE_CHAT_MODEL, cli=\"no-tools\", tracked=True)\n \n     if not result.is_success or not result.content:\n         response = \"...\"\n@@ -408,7 +408,7 @@ def analyze_echoes(user_id: int, language: str = \"en\"):\n Return ONLY the JSON array, no other text.\"\"\"\n     prompt += f\"\\n\\n{language_instruction(language_code, 'All titles, descriptions, and examples should use this language. Keep the JSON keys the same.')}\"\n \n-    result = agent.run(prompt, model=\"gpt-4o-dou\", cli=\"no-tools\", tracked=True)\n+    result = agent.run(prompt, model=config.ECHO_ANALYSIS_MODEL, cli=\"no-tools\", tracked=True)\n \n     if not result.is_success or not result.content:\n         return {\"echoes\": []}\n@@ -465,7 +465,7 @@ def analyze_traits(user_id: int, language: str = \"en\"):\n Return ONLY the JSON array, no other text.\"\"\"\n     prompt += f\"\\n\\n{language_instruction(language_code, 'Use this language for trait names, explanations, and evidence (JSON keys stay in English).')}\"\n \n-    result = agent.run(prompt, model=\"gpt-4o-dou\", cli=\"no-tools\", tracked=True)\n+    result = agent.run(prompt, model=config.TRAIT_ANALYSIS_MODEL, cli=\"no-tools\", tracked=True)\n \n     if not result.is_success or not result.content:\n         return {\"traits\": []}\n@@ -524,7 +524,7 @@ def analyze_patterns(\n Return ONLY the JSON array, no other text.\"\"\"\n     prompt += f\"\\n\\n{language_instruction(language_code, 'Use this language for pattern names, descriptions, and frequency notes (JSON keys stay in English).')}\"\n \n-    result = agent.run(prompt, model=\"gpt-4o-dou\", cli=\"no-tools\", tracked=True)\n+    result = agent.run(prompt, model=config.PATTERN_ANALYSIS_MODEL, cli=\"no-tools\", tracked=True)\n \n     if not result.is_success or not result.content:\n         return {\"patterns\": []}"
    },
    {
      "sha": "181dd7f82ad95e074ca11634d8a56295bae45c3d",
      "filename": "backend/stateless_analyzer.py",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/c6f51ce06d26de49a4992d06a21b388030381f6c/backend%2Fstateless_analyzer.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/c6f51ce06d26de49a4992d06a21b388030381f6c/backend%2Fstateless_analyzer.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fstateless_analyzer.py?ref=c6f51ce06d26de49a4992d06a21b388030381f6c",
      "patch": "@@ -175,7 +175,7 @@ def analyze_stateless(\n \n     result = agent.run(\n         prompt,\n-        model=config.MODEL,\n+        model=config.VOICE_ANALYSIS_MODEL,\n         cli=\"no-tools\",\n         schema_cls=SingleVoiceAnalysis,\n         tracked=True,"
    },
    {
      "sha": "c0c94fe2634ae5f75f89934971ea4b29316887c4",
      "filename": "frontend/src/App.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/c6f51ce06d26de49a4992d06a21b388030381f6c/frontend%2Fsrc%2FApp.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/c6f51ce06d26de49a4992d06a21b388030381f6c/frontend%2Fsrc%2FApp.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2FApp.tsx?ref=c6f51ce06d26de49a4992d06a21b388030381f6c",
      "patch": "@@ -122,6 +122,7 @@ export default function App() {\n     setState,\n     selectedState,\n     setSelectedState,\n+    selectedStateLoading,\n     userTimezone,\n     ensureStateForPersistence,\n     getFirstLineFromState,\n@@ -1197,6 +1198,7 @@ export default function App() {\n                     <StateChooser\n                       stateConfig={stateConfig}\n                       selectedState={state?.selectedState ?? selectedState}\n+                      selectedStateLoading={selectedStateLoading}\n                       createdAt={state?.createdAt}\n                       onChoose={handleStateChoose}\n                     />"
    },
    {
      "sha": "428d54bc56641d78e6b21bbee7d654eef4bf0b84",
      "filename": "frontend/src/components/StateChooser.tsx",
      "status": "modified",
      "additions": 18,
      "deletions": 4,
      "changes": 22,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/c6f51ce06d26de49a4992d06a21b388030381f6c/frontend%2Fsrc%2Fcomponents%2FStateChooser.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/c6f51ce06d26de49a4992d06a21b388030381f6c/frontend%2Fsrc%2Fcomponents%2FStateChooser.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FStateChooser.tsx?ref=c6f51ce06d26de49a4992d06a21b388030381f6c",
      "patch": "@@ -8,26 +8,36 @@ import { parseFlexibleTimestamp } from '../utils/timezone';\n interface Props {\n   stateConfig: StateConfig;\n   selectedState: string | null;\n+  selectedStateLoading?: boolean;\n   createdAt?: string;  // ISO timestamp recorded when the session was created\n   onChoose: (stateId: string) => void;\n }\n \n-export default function StateChooser({ stateConfig, selectedState, createdAt, onChoose }: Props) {\n+export default function StateChooser({\n+  stateConfig,\n+  selectedState,\n+  selectedStateLoading = false,\n+  createdAt,\n+  onChoose\n+}: Props) {\n   const { i18n } = useTranslation();\n-  const [isExpanded, setIsExpanded] = useState(!selectedState);\n+  const [isExpanded, setIsExpanded] = useState(false);\n   const [shouldAnimate, setShouldAnimate] = useState(false);\n   const [isFadingOut, setIsFadingOut] = useState(false);\n   const indicatorRef = useRef<HTMLDivElement>(null);\n \n-  // @@@ Collapse when selectedState is set externally\n+  // @@@ Collapse when selectedState is set externally (skip while loading)\n   useEffect(() => {\n+    if (selectedStateLoading) return;\n     if (selectedState) {\n       setIsExpanded(false);\n       // Trigger highlight animation\n       setShouldAnimate(true);\n       setTimeout(() => setShouldAnimate(false), 600);\n+    } else {\n+      setIsExpanded(true);\n     }\n-  }, [selectedState]);\n+  }, [selectedState, selectedStateLoading]);\n \n   const selectedStateData = selectedState ? stateConfig.states[selectedState] : null;\n \n@@ -96,6 +106,10 @@ export default function StateChooser({ stateConfig, selectedState, createdAt, on\n     }\n   };\n \n+  if (selectedStateLoading) {\n+    return <div style={{ height: '32px' }} />;\n+  }\n+\n   return (\n     <>\n       {/* @@@ Keyframe animation for highlight effect */}"
    },
    {
      "sha": "36086c237026a9091dd56bec22dd3d3fe97f5ac2",
      "filename": "frontend/src/hooks/useComments.ts",
      "status": "modified",
      "additions": 16,
      "deletions": 4,
      "changes": 20,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/c6f51ce06d26de49a4992d06a21b388030381f6c/frontend%2Fsrc%2Fhooks%2FuseComments.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/c6f51ce06d26de49a4992d06a21b388030381f6c/frontend%2Fsrc%2Fhooks%2FuseComments.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fhooks%2FuseComments.ts?ref=c6f51ce06d26de49a4992d06a21b388030381f6c",
      "patch": "@@ -1,4 +1,4 @@\n-import { useState, useEffect, useMemo, useCallback } from 'react';\n+import { useState, useEffect, useMemo, useCallback, useRef } from 'react';\n import type { MutableRefObject, Dispatch, SetStateAction, SyntheticEvent } from 'react';\n import type { EditorState, Commentor, TextCell, EditorEngine } from '../engine/EditorEngine';\n import { findNormalizedPhrase } from '../utils/textNormalize';\n@@ -52,6 +52,7 @@ export function useComments({\n   engineRef,\n }: UseCommentsOptions): UseCommentsReturn {\n   const [groupPages, setGroupPages] = useState<Map<string, number>>(new Map());\n+  const prevCommentCounts = useRef<Map<string, number>>(new Map());\n   const [cursorPosition, setCursorPosition] = useState<number>(0);\n   const [cursorCellId, setCursorCellId] = useState<string | null>(null);\n   const [mobileActiveComment, setMobileActiveComment] = useState<Commentor | null>(null);\n@@ -156,8 +157,12 @@ export function useComments({\n     return groups;\n   }, [state?.commentors, state, refsReady, selectedState]);\n \n+  // @@@ Preserve manual selection - only jump to newest when a group gains comments\n   useEffect(() => {\n-    if (!commentGroups) return;\n+    const currentCounts = new Map<string, number>();\n+    commentGroups.forEach((group, groupKey) => {\n+      currentCounts.set(groupKey, group.comments.length);\n+    });\n \n     setGroupPages(prev => {\n       const next = new Map(prev);\n@@ -168,10 +173,15 @@ export function useComments({\n           return;\n         }\n \n-        const currentPage = prev.get(groupKey) || 0;\n+        const currentPage = prev.get(groupKey) ?? 0;\n         const maxPage = group.comments.length - 1;\n+        const prevCount = prevCommentCounts.current.get(groupKey) ?? 0;\n+        const currentCount = group.comments.length;\n+        const isNewGroup = !prev.has(groupKey);\n \n-        if (group.comments.length > 1 && currentPage < maxPage) {\n+        if (isNewGroup) {\n+          next.set(groupKey, maxPage);\n+        } else if (currentCount > prevCount) {\n           next.set(groupKey, maxPage);\n         } else if (currentPage > maxPage) {\n           next.set(groupKey, maxPage);\n@@ -186,6 +196,8 @@ export function useComments({\n \n       return next;\n     });\n+\n+    prevCommentCounts.current = currentCounts;\n   }, [commentGroups]);\n \n   const handleGroupNavigate = useCallback((groupKey: string, newIndex: number) => {"
    },
    {
      "sha": "1a23a6138b1c2d72fabcc7a7c9e91862bc26c558",
      "filename": "frontend/src/hooks/useSessionLifecycle.ts",
      "status": "modified",
      "additions": 138,
      "deletions": 107,
      "changes": 245,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/c6f51ce06d26de49a4992d06a21b388030381f6c/frontend%2Fsrc%2Fhooks%2FuseSessionLifecycle.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/c6f51ce06d26de49a4992d06a21b388030381f6c/frontend%2Fsrc%2Fhooks%2FuseSessionLifecycle.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fhooks%2FuseSessionLifecycle.ts?ref=c6f51ce06d26de49a4992d06a21b388030381f6c",
      "patch": "@@ -33,6 +33,7 @@ export function useSessionLifecycle({\n   const [state, setState] = useState<EditorState | null>(null);\n   const [localTexts, setLocalTexts] = useState<Map<string, string>>(new Map());\n   const [selectedState, setSelectedState] = useState<string | null>(null);\n+  const [selectedStateLoading, setSelectedStateLoading] = useState(true);\n   const [userTimezone, setUserTimezone] = useState(browserTimezone);\n \n   const ensuredSessionForDayRef = useRef<string | null>(null);\n@@ -302,127 +303,156 @@ export function useSessionLifecycle({\n \n   useEffect(() => {\n     const loadInitialState = async () => {\n-      if (isAuthenticated) {\n-        try {\n-          const { listSessions, getSession, getPreferences } = await import('../api/voiceApi');\n-\n-          const sessions = await listSessions(userTimezoneRef.current);\n-\n-          let sessionToLoad = null;\n-          let loadedSessionId: string | undefined = undefined;\n-          const currentSessionId = 'current-session';\n-          const currentSession = sessions.find(s => s.id === currentSessionId);\n-\n-          if (currentSession) {\n-            const fullSession = await getSession(currentSessionId);\n-            sessionToLoad = fullSession.editor_state;\n-            loadedSessionId = currentSessionId;\n-          } else if (sessions.length > 0) {\n-            const mostRecent = sessions.sort((a, b) =>\n-              new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime()\n-            )[0];\n-\n-            const timezoneForDay = userTimezoneRef.current || 'UTC';\n-            const today = getTodayKeyInTimezone(timezoneForDay);\n-            const sessionDate = getLocalDayKey(mostRecent.updated_at, timezoneForDay);\n-\n-            if (sessionDate === today) {\n-              const fullSession = await getSession(mostRecent.id);\n-              sessionToLoad = fullSession.editor_state;\n-              loadedSessionId = mostRecent.id;\n-            } else {\n-              console.log(`\ud83d\udcc5 New day detected. Last session was from ${sessionDate}, today is ${today}. Starting fresh.`);\n-              sessionToLoad = null;\n-              loadedSessionId = undefined;\n-            }\n-          }\n+      setSelectedStateLoading(true);\n+      try {\n+        if (isAuthenticated) {\n+          try {\n+            const { listSessions, getSession, getPreferences } = await import('../api/voiceApi');\n \n-          if (sessionToLoad && loadedSessionId) {\n-            const normalizedState: EditorState = {\n-              ...sessionToLoad,\n-              id: sessionToLoad.id || (sessionToLoad as any)?.currentEntryId || (sessionToLoad as any)?.sessionId || loadedSessionId\n-            };\n-            engineRef.current?.loadState(normalizedState);\n-            setState(engineRef.current?.getState() || normalizedState);\n-\n-            const texts = new Map<string, string>();\n-            sessionToLoad.cells?.filter((c: any) => c.type === 'text').forEach((c: any) => {\n-              texts.set(c.id, c.content || '');\n-            });\n-            setLocalTexts(texts);\n-          } else {\n-            setState(engineRef.current?.getState() || null);\n-          }\n+            const sessions = await listSessions(userTimezoneRef.current);\n \n-          try {\n-            const prefs = await getPreferences();\n-            if (prefs.voice_configs) {\n-              setVoiceConfigs(prefs.voice_configs);\n-            }\n-            if (prefs.meta_prompt) {\n-              saveMetaPrompt(prefs.meta_prompt);\n-            }\n-            if (prefs.state_config) {\n-              setStateConfig(prefs.state_config);\n-            }\n-            if (prefs.timezone) {\n-              setUserTimezone(prefs.timezone);\n-            }\n+            let sessionToLoad = null;\n+            let loadedSessionId: string | undefined = undefined;\n+            let startedFreshForToday = false;\n+            const currentSessionId = 'current-session';\n+            const currentSession = sessions.find(s => s.id === currentSessionId);\n+\n+            if (currentSession) {\n+              const fullSession = await getSession(currentSessionId);\n+              sessionToLoad = fullSession.editor_state;\n+              loadedSessionId = currentSessionId;\n+            } else if (sessions.length > 0) {\n+              const mostRecent = sessions.sort((a, b) =>\n+                new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime()\n+              )[0];\n \n-            if (prefs.selected_state !== undefined && prefs.selected_state !== null) {\n               const timezoneForDay = userTimezoneRef.current || 'UTC';\n               const today = getTodayKeyInTimezone(timezoneForDay);\n-              const updatedAtDate = prefs.updated_at\n-                ? getLocalDayKey(prefs.updated_at, timezoneForDay)\n-                : null;\n+              const sessionDate = getLocalDayKey(mostRecent.updated_at, timezoneForDay);\n \n-              if (updatedAtDate === today) {\n-                setSelectedState(prefs.selected_state);\n+              if (sessionDate === today) {\n+                const fullSession = await getSession(mostRecent.id);\n+                sessionToLoad = fullSession.editor_state;\n+                loadedSessionId = mostRecent.id;\n               } else {\n-                setSelectedState(null);\n+                console.log(`\ud83d\udcc5 New day detected. Last session was from ${sessionDate}, today is ${today}. Starting fresh.`);\n+                if (engineRef.current) {\n+                  // @@@ New Day Reset - force blank state so the chooser saves to today\n+                  const blankState: EditorState = {\n+                    cells: [{ id: Math.random().toString(36).slice(2), type: 'text', content: '' }],\n+                    commentors: [],\n+                    tasks: [],\n+                    weightPath: [],\n+                    overlappedPhrases: [],\n+                    id: createSessionId(),\n+                    selectedState: undefined,\n+                    createdAt: new Date().toISOString()\n+                  };\n+\n+                  engineRef.current.loadState(blankState);\n+                  setState(blankState);\n+                  setLocalTexts(new Map());\n+                  ensuredSessionForDayRef.current = today;\n+                  startedFreshForToday = true;\n+\n+                  await persistSessionImmediately(blankState);\n+                } else {\n+                  console.error('Engine not ready when starting fresh for new day');\n+                }\n               }\n             }\n-          } catch (err) {\n-            console.log('No preferences found, using defaults');\n-          }\n-        } catch (error) {\n-          console.error('Failed to load from database:', error);\n-          setState(engineRef.current?.getState() || null);\n-        }\n-      } else {\n-        const saved = localStorage.getItem(STORAGE_KEYS.EDITOR_STATE);\n-        if (saved) {\n-          try {\n-            const parsed = JSON.parse(saved);\n-            engineRef.current?.loadState(parsed);\n-            setState(engineRef.current?.getState() || parsed);\n-\n-            const texts = new Map<string, string>();\n-            parsed.cells?.filter((c: any) => c.type === 'text').forEach((c: any) => {\n-              texts.set(c.id, c.content || '');\n-            });\n-            setLocalTexts(texts);\n-          } catch (e) {\n-            console.error('Failed to load saved state:', e);\n+\n+            if (sessionToLoad && loadedSessionId) {\n+              const normalizedState: EditorState = {\n+                ...sessionToLoad,\n+                id: sessionToLoad.id || (sessionToLoad as any)?.currentEntryId || (sessionToLoad as any)?.sessionId || loadedSessionId\n+              };\n+              engineRef.current?.loadState(normalizedState);\n+              setState(engineRef.current?.getState() || normalizedState);\n+\n+              const texts = new Map<string, string>();\n+              sessionToLoad.cells?.filter((c: any) => c.type === 'text').forEach((c: any) => {\n+                texts.set(c.id, c.content || '');\n+              });\n+              setLocalTexts(texts);\n+            } else if (!startedFreshForToday) {\n+              setState(engineRef.current?.getState() || null);\n+            }\n+\n+            try {\n+              const prefs = await getPreferences();\n+              if (prefs.voice_configs) {\n+                setVoiceConfigs(prefs.voice_configs);\n+              }\n+              if (prefs.meta_prompt) {\n+                saveMetaPrompt(prefs.meta_prompt);\n+              }\n+              if (prefs.state_config) {\n+                setStateConfig(prefs.state_config);\n+              }\n+              if (prefs.timezone) {\n+                setUserTimezone(prefs.timezone);\n+              }\n+\n+              if (prefs.selected_state !== undefined && prefs.selected_state !== null) {\n+                const timezoneForDay = userTimezoneRef.current || 'UTC';\n+                const today = getTodayKeyInTimezone(timezoneForDay);\n+                const updatedAtDate = prefs.updated_at\n+                  ? getLocalDayKey(prefs.updated_at, timezoneForDay)\n+                  : null;\n+\n+                if (updatedAtDate === today) {\n+                  setSelectedState(prefs.selected_state);\n+                } else {\n+                  setSelectedState(null);\n+                }\n+              }\n+            } catch (err) {\n+              console.log('No preferences found, using defaults');\n+            }\n+          } catch (error) {\n+            console.error('Failed to load from database:', error);\n+            setState(engineRef.current?.getState() || null);\n           }\n         } else {\n-          setState(engineRef.current?.getState() || null);\n-        }\n+          const saved = localStorage.getItem(STORAGE_KEYS.EDITOR_STATE);\n+          if (saved) {\n+            try {\n+              const parsed = JSON.parse(saved);\n+              engineRef.current?.loadState(parsed);\n+              setState(engineRef.current?.getState() || parsed);\n+\n+              const texts = new Map<string, string>();\n+              parsed.cells?.filter((c: any) => c.type === 'text').forEach((c: any) => {\n+                texts.set(c.id, c.content || '');\n+              });\n+              setLocalTexts(texts);\n+            } catch (e) {\n+              console.error('Failed to load saved state:', e);\n+            }\n+          } else {\n+            setState(engineRef.current?.getState() || null);\n+          }\n \n-        const savedState = localStorage.getItem(STORAGE_KEYS.SELECTED_STATE);\n-        const savedDate = localStorage.getItem('selected-state-date');\n-        const today = getTodayKeyInTimezone(userTimezoneRef.current || browserTimezone);\n+          const savedState = localStorage.getItem(STORAGE_KEYS.SELECTED_STATE);\n+          const savedDate = localStorage.getItem('selected-state-date');\n+          const today = getTodayKeyInTimezone(userTimezoneRef.current || browserTimezone);\n \n-        if (savedState && savedDate === today) {\n-          setSelectedState(savedState);\n-        } else {\n-          localStorage.removeItem(STORAGE_KEYS.SELECTED_STATE);\n-          localStorage.removeItem('selected-state-date');\n-          setSelectedState(null);\n+          if (savedState && savedDate === today) {\n+            setSelectedState(savedState);\n+          } else {\n+            localStorage.removeItem(STORAGE_KEYS.SELECTED_STATE);\n+            localStorage.removeItem('selected-state-date');\n+            setSelectedState(null);\n+          }\n         }\n-      }\n-      if (!isAuthenticated) {\n-        setUserTimezone(browserTimezone);\n+        if (!isAuthenticated) {\n+          setUserTimezone(browserTimezone);\n+        }\n+      } catch (error) {\n+        console.error('Failed to initialize session lifecycle:', error);\n+      } finally {\n+        setSelectedStateLoading(false);\n       }\n     };\n \n@@ -493,6 +523,7 @@ export function useSessionLifecycle({\n     setLocalTexts,\n     selectedState,\n     setSelectedState,\n+    selectedStateLoading,\n     userTimezone,\n     setUserTimezone,\n     ensureStateForPersistence,"
    }
  ]
}