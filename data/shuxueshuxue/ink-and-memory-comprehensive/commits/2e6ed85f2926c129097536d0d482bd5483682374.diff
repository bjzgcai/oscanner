*** FILE: backend/stateless_analyzer.py ***
@@ -6,18 +6,37 @@
 from polycli import PolyAgent
 import config
 
+
 class VoiceTrigger(BaseModel):
-    phrase: str = Field(description="Exact trigger phrase from text (verbatim, 2-4 words, avoid punctuation)")
-    voice_id: str = Field(description="Voice ID from the available list (e.g., 'holder', 'mirror', 'starter')")
-    voice_name: str = Field(description="Voice display name (will be auto-filled, LLM should not generate this)")
+    phrase: str = Field(
+        description="Exact trigger phrase from text (verbatim, 2-4 words, avoid punctuation)"
+    )
+    voice_id: str = Field(
+        description="Voice ID from the available list (e.g., 'holder', 'mirror', 'starter')"
+    )
+    voice_name: str = Field(
+        description="Voice display name (will be auto-filled, LLM should not generate this)"
+    )
     comment: str = Field(description="What this voice is saying (as if speaking)")
     icon: str = Field(description="Icon identifier")
     color: str = Field(description="Color identifier")
 
+
 class SingleVoiceAnalysis(BaseModel):
-    voice: Optional[VoiceTrigger] = Field(description="Single voice trigger, or None if nothing to comment")
+    voice: Optional[VoiceTrigger] = Field(
+        description="Single voice trigger, or None if nothing to comment"
+    )
 
-def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict], voices: dict = None, meta_prompt: str = "", state_prompt: str = "", overlapped_phrases: List[str] = None) -> dict:
+
+def analyze_stateless(
+    agent: PolyAgent,
+    text: str,
+    applied_comments: List[dict],
+    voices: dict = None,
+    meta_prompt: str = "",
+    state_prompt: str = "",
+    overlapped_phrases: List[str] = None,
+) -> dict:
     """
     Stateless analysis - receives applied comments, returns ONE new comment.
 
@@ -34,44 +53,60 @@ def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict],
         Dict with single new voice (or empty list if none)
     """
     overlapped_phrases = overlapped_phrases or []
-    print(f"\n{'='*60}")
+    print(f"\n{'=' * 60}")
     print(f"ğŸ“Š Stateless Analysis")
     print(f"   Text: {text[:100]}...")
     print(f"   Applied comments: {len(applied_comments)}")
-    print(f"{'='*60}\n")
+    print(f"{'=' * 60}\n")
 
     # Use provided voices or defaults
     voice_archetypes = voices or config.VOICE_ARCHETYPES
 
     # Build voice list for prompt
-    voice_list = "\n".join([
-        f"- ID: {key} | Name: {v.get('name', key)} | ({v['icon']}, {v['color']})\n  {v.get('systemPrompt', '')}"
-        for key, v in voice_archetypes.items()
-    ])
+    voice_list = "\n".join(
+        [
+            f"- ID: {key} | Name: {v.get('name', key)} | ({v['icon']}, {v['color']})\n  {v.get('systemPrompt', '')}"
+            for key, v in voice_archetypes.items()
+        ]
+    )
 
     # Build existing conversation context
     conversation_context = ""
     highlighted_phrases = []
     if applied_comments:
-        conversation_context = "\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
-        conversation_context += "EXISTING CONVERSATION (for context - do NOT extract phrases from here):\n"
-        conversation_context += "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
+        conversation_context = (
+            "\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
+        )
+        conversation_context += (
+            "EXISTING CONVERSATION (for context - do NOT extract phrases from here):\n"
+        )
+        conversation_context += (
+            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
+        )
         for c in applied_comments:
-            phrase = c.get('phrase', '')
+            phrase = c.get("phrase", "")
             highlighted_phrases.append(phrase)
-            conversation_context += f"\n{c.get('voice', 'Unknown')} commented on \"{phrase}\":\n"
+            conversation_context += (
+                f'\n{c.get("voice", "Unknown")} commented on "{phrase}":\n'
+            )
             conversation_context += f"  â†’ {c.get('comment', '')}\n"
 
-        conversation_context += f"\nâš ï¸ Already highlighted phrases (do NOT overlap): {highlighted_phrases}\n"
+        conversation_context += (
+            f"\nâš ï¸ Already highlighted phrases (do NOT overlap): {highlighted_phrases}\n"
+        )
 
     # @@@ Add overlapped phrases feedback (phrases that were rejected due to overlap)
     rejected_section = ""
     if overlapped_phrases:
-        rejected_section = "\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
+        rejected_section = (
+            "\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
+        )
         rejected_section += "REJECTED PHRASES (these were tried but overlapped):\n"
-        rejected_section += "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
+        rejected_section += (
+            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
+        )
         for phrase in overlapped_phrases:
-            rejected_section += f"  âœ— \"{phrase}\" - REJECTED, do NOT suggest again\n"
+            rejected_section += f'  âœ— "{phrase}" - REJECTED, do NOT suggest again\n'
         rejected_section += f"\nâš ï¸ Do NOT suggest any variation of these phrases!\n"
 
     prompt = f"""You are analyzing internal dialogue as distinct inner voice personas.
@@ -102,7 +137,7 @@ def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict],
    - Verify character-by-character that your phrase exists in the text
 
 2. Choose a voice ID from the available list above
-   - Use the ID field (e.g., 'holder', 'mirror'), NOT the name
+   - Use the ID field (which might be a complex, nonsensical string), NOT the name
    - Return ONLY the ID in the voice_id field
 
 3. Write what this voice is saying (1-2 sentences)
@@ -143,7 +178,7 @@ def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict],
         model=config.MODEL,
         cli="no-tools",
         schema_cls=SingleVoiceAnalysis,
-        tracked=True
+        tracked=True,
     )
 
     if not result.is_success or not result.has_data():
@@ -166,11 +201,11 @@ def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict],
         # Build return object with both ID and name
         result_voice = {
             "phrase": voice.get("phrase"),
-            "voice_id": voice_id,                    # NEW: ID for lookup
-            "voice": archetype.get("name", voice_id), # KEEP: Name for display
+            "voice_id": voice_id,  # NEW: ID for lookup
+            "voice": archetype.get("name", voice_id),  # KEEP: Name for display
             "comment": voice.get("comment"),
-            "icon": archetype["icon"],               # Ensure correct icon
-            "color": archetype["color"]              # Ensure correct color
+            "icon": archetype["icon"],  # Ensure correct icon
+            "color": archetype["color"],  # Ensure correct color
         }
 
         print(f"âœ… Got 1 new comment: {voice_id} ({result_voice['voice']})")

