commit 5f3ec4a902b5399f2eedb1160903048361e1d299
Author: lexicalmathical <lexicalmathical@gmail.com>
Date:   Thu Oct 9 19:12:40 2025 +0800

    Add multi-user support with session isolation and TTL cleanup
    
    Backend:
    - Replace global analyzer with session-based storage (_user_analyzers dict)
    - Add session_id parameter to analyze_text() API
    - Implement automatic cleanup of sessions inactive >1 hour
    - Track last access time per session to prevent memory leaks
    
    Frontend:
    - Generate unique session_id on mount using crypto.randomUUID()
    - Pass session_id in all API requests
    - Each browser tab gets isolated voice comment state
    
    Additional improvements:
    - Increase icon diversity (lightbulb, masks, shield, compass, eye, fist, fire, wind)
    - Add cursor-based auto-scroll to focused voice comment
    - Fix text overflow with word-wrap
    - Hide scrollbar while maintaining scroll functionality
    
    ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
    
    Co-Authored-By: Claude <noreply@anthropic.com>

diff --git a/backend/config.py b/backend/config.py
index a7fde02..b1e9776 100644
--- a/backend/config.py
+++ b/backend/config.py
@@ -17,12 +17,12 @@ VOICE_ARCHETYPES = {
     },
     "Rhetoric": {
         "tagline": "Practice the art of persuasion. Enjoy rigorous intellectual discourse.",
-        "icon": "brain",
+        "icon": "lightbulb",
         "color": "purple"
     },
     "Drama": {
         "tagline": "Play the actor. Lie and detect lies.",
-        "icon": "question",
+        "icon": "masks",
         "color": "pink"
     },
     "Conceptualization": {
@@ -32,12 +32,12 @@ VOICE_ARCHETYPES = {
     },
     "Volition": {
         "tagline": "Hold yourself together. Keep your Morale up.",
-        "icon": "brain",
+        "icon": "shield",
         "color": "green"
     },
     "Inland Empire": {
         "tagline": "Hunches and gut feelings. Dreams in waking life.",
-        "icon": "cloud",
+        "icon": "compass",
         "color": "purple"
     },
     "Empathy": {
@@ -47,17 +47,17 @@ VOICE_ARCHETYPES = {
     },
     "Authority": {
         "tagline": "Intimidate the public. Assert yourself.",
-        "icon": "brain",
+        "icon": "fist",
         "color": "yellow"
     },
     "Electrochemistry": {
         "tagline": "Go to party planet. Love and be loved by drugs.",
-        "icon": "heart",
+        "icon": "fire",
         "color": "pink"
     },
     "Shivers": {
         "tagline": "Raise the hair on your neck. Tune in to the city.",
-        "icon": "cloud",
+        "icon": "wind",
         "color": "blue"
     },
     "Half Light": {
@@ -67,12 +67,12 @@ VOICE_ARCHETYPES = {
     },
     "Perception": {
         "tagline": "See, hear and smell everything. Let no detail go unnoticed.",
-        "icon": "brain",
+        "icon": "eye",
         "color": "green"
     },
     "Composure": {
         "tagline": "Straighten your back. Keep your poker face.",
-        "icon": "brain",
+        "icon": "shield",
         "color": "blue"
     }
 }
diff --git a/backend/server.py b/backend/server.py
index 3c834c2..d7c7a94 100644
--- a/backend/server.py
+++ b/backend/server.py
@@ -9,10 +9,10 @@ from stateful_analyzer import analyze_stateful
 @session_def(
     name="Analyze Voices",
     description="Detect inner voices in text using Disco Elysium archetypes",
-    params={"text": str},
+    params={"text": str, "session_id": str},
     category="Analysis"
 )
-def analyze_text(text: str):
+def analyze_text(text: str, session_id: str):
     """
     Analyze text and detect inner voice triggers.
 
@@ -24,6 +24,7 @@ def analyze_text(text: str):
     """
     print(f"\n{'='*60}")
     print(f"üéØ analyze_text() called")
+    print(f"   Session ID: {session_id}")
     print(f"   Text length: {len(text)}")
     print(f"   Text preview: {text[:100]}...")
     print(f"{'='*60}\n")
@@ -32,7 +33,7 @@ def analyze_text(text: str):
     agent = PolyAgent(id="voice-analyzer")
 
     print("Calling analyze_stateful pattern...")
-    voices = analyze_stateful(agent, text)
+    voices = analyze_stateful(agent, text, session_id)
 
     print(f"‚úÖ Got {len(voices)} voices")
     for i, v in enumerate(voices):
diff --git a/backend/stateful_analyzer.py b/backend/stateful_analyzer.py
index 45eb560..45831e2 100644
--- a/backend/stateful_analyzer.py
+++ b/backend/stateful_analyzer.py
@@ -7,12 +7,13 @@ from polycli import PolyAgent
 from polycli.orchestration import pattern
 import config
 import re
+import time
 
 class VoiceTrigger(BaseModel):
     phrase: str = Field(description="Exact trigger phrase from text (verbatim)")
     voice: str = Field(description="Voice archetype name from the available list")
     comment: str = Field(description="What this voice is saying (as if speaking)")
-    icon: str = Field(description="Icon: brain, heart, question, cloud")
+    icon: str = Field(description="Icon: brain, heart, question, cloud, masks, eye, fist, lightbulb, shield, wind, fire, compass")
     color: str = Field(description="Color: blue, pink, yellow, green, purple")
 
 class VoiceAnalysis(BaseModel):
@@ -252,9 +253,45 @@ IMPORTANT:
 
         return self.comments
 
-# Global instance (shared across all session calls)
-global_analyzer = StatefulVoiceAnalyzer()
+# @@@ Multi-user support - Session-based storage
+# Each user gets their own analyzer instance, keyed by session_id
+_user_analyzers = {}  # session_id -> StatefulVoiceAnalyzer
+_last_access = {}     # session_id -> timestamp
 
-def analyze_stateful(agent: PolyAgent, text: str) -> list[dict]:
-    """Wrapper function that uses global analyzer instance."""
-    return global_analyzer.analyze(agent, text)
+# @@@ Session cleanup config
+SESSION_TTL = 3600  # 1 hour - sessions inactive for this long will be cleaned up
+
+def cleanup_stale_sessions():
+    """Remove sessions that haven't been accessed in SESSION_TTL seconds."""
+    now = time.time()
+    stale_sessions = [
+        sid for sid, last_time in _last_access.items()
+        if now - last_time > SESSION_TTL
+    ]
+
+    for sid in stale_sessions:
+        print(f"üóëÔ∏è  Cleaning up stale session: {sid} (inactive for {SESSION_TTL}s)")
+        del _user_analyzers[sid]
+        del _last_access[sid]
+
+    if stale_sessions:
+        print(f"üìä Active sessions: {len(_user_analyzers)}")
+
+def get_analyzer(session_id: str) -> StatefulVoiceAnalyzer:
+    """Get or create analyzer for this user session."""
+    if session_id not in _user_analyzers:
+        print(f"üÜï Creating new analyzer for session: {session_id}")
+        _user_analyzers[session_id] = StatefulVoiceAnalyzer()
+
+    # Update last access time
+    _last_access[session_id] = time.time()
+
+    return _user_analyzers[session_id]
+
+def analyze_stateful(agent: PolyAgent, text: str, session_id: str) -> list[dict]:
+    """Analyze text using session-isolated analyzer."""
+    # Cleanup stale sessions before processing
+    cleanup_stale_sessions()
+
+    analyzer = get_analyzer(session_id)
+    return analyzer.analyze(agent, text)
diff --git a/frontend/src/App.css b/frontend/src/App.css
index a079566..73ea2ce 100644
--- a/frontend/src/App.css
+++ b/frontend/src/App.css
@@ -44,27 +44,22 @@
 
 .book-page.right-page {
   flex-direction: column;
+  gap: 1rem;
   padding: 2rem;
   overflow-y: auto;
-  overflow-x: visible;
+  overflow-x: hidden;
+  scrollbar-width: none; /* Firefox */
+  -ms-overflow-style: none; /* IE/Edge */
 }
 
-/* @@@ Two-box layout for stacked vs latest cards */
-.voices-container {
-  display: flex;
-  flex-direction: column;
-  gap: 4rem;
-  margin-left: 2rem;
-}
-
-.voice-stack {
-  position: relative;
-  width: 100%;
+.book-page.right-page::-webkit-scrollbar {
+  display: none; /* Chrome/Safari */
 }
 
-.latest-card-container {
-  position: relative;
-  min-height: 100px;
+.book-page.right-page > * {
+  margin-left: 2rem;
+  word-wrap: break-word;
+  overflow-wrap: break-word;
 }
 
 /* Editable text area overlay */
@@ -111,7 +106,6 @@
 }
 
 .voice-comment {
-  position: relative;
   padding: 1rem;
   border-left: 4px solid;
   border-radius: 4px;
@@ -120,22 +114,9 @@
   line-height: 1.6;
   color: #333;
   animation: fadeIn 0.5s ease-in;
-  transition: all 0.3s ease;
-  cursor: pointer;
-  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
-}
-
-/* @@@ Stacking: latest card on top, older cards stack below */
-/* Only non-top cards can pop to top layer on hover (position stays same) */
-.voice-comment:not(.top-card):hover {
-  z-index: 1000 !important;
-  box-shadow: 0 8px 16px rgba(0,0,0,0.15);
-}
-
-.top-card {
-  cursor: default;
-  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
-  transform: scale(1.02) rotate(-1deg);
+  word-wrap: break-word;
+  overflow-wrap: break-word;
+  max-width: 100%;
 }
 
 .voice-header {
diff --git a/frontend/src/App.tsx b/frontend/src/App.tsx
index 6f8319c..9fee64c 100644
--- a/frontend/src/App.tsx
+++ b/frontend/src/App.tsx
@@ -16,9 +16,14 @@ interface Voice {
 }
 
 function App() {
+  // @@@ Multi-user support - Generate unique session ID on mount
+  const sessionId = useRef(crypto.randomUUID()).current;
+
   const [voices, setVoices] = useState<Voice[]>([]);
   const [voiceTriggers, setVoiceTriggers] = useState<VoiceTrigger[]>([]);
   const [currentText, setCurrentText] = useState<string>('');
+  const [cursorPosition, setCursorPosition] = useState<number>(0);
+  const [focusedVoiceIndex, setFocusedVoiceIndex] = useState<number | undefined>(undefined);
   const currentTextRef = useRef<string>('');
   const lastAnalyzedTextRef = useRef<string>('');
   const isAnalyzingRef = useRef<boolean>(false);
@@ -40,6 +45,28 @@ function App() {
     setVoices(newVoices);
   };
 
+  // @@@ Track which voice comment to focus based on cursor position
+  useEffect(() => {
+    if (voices.length === 0) {
+      setFocusedVoiceIndex(undefined);
+      return;
+    }
+
+    // Find the comment whose trigger phrase is closest to cursor
+    let closestIndex = 0;
+    let closestDistance = Math.abs(voices[0].position - cursorPosition);
+
+    for (let i = 1; i < voices.length; i++) {
+      const distance = Math.abs(voices[i].position - cursorPosition);
+      if (distance < closestDistance) {
+        closestDistance = distance;
+        closestIndex = i;
+      }
+    }
+
+    setFocusedVoiceIndex(closestIndex);
+  }, [cursorPosition, voices]);
+
   const analyzeIfNeeded = async () => {
     // Skip if already analyzing
     if (isAnalyzingRef.current) {
@@ -59,7 +86,7 @@ function App() {
 
     try {
       console.log(`üîç Calling backend analysis (${textDiff} chars changed)...`);
-      const backendVoices = await analyzeText(currentTextValue);
+      const backendVoices = await analyzeText(currentTextValue, sessionId);
       console.log(`‚úÖ Got ${backendVoices.length} voices from backend`);
 
       setVoiceTriggers(backendVoices);
@@ -90,44 +117,21 @@ function App() {
     detectVoices(currentText, voiceTriggers);
   }, [voiceTriggers]);
 
-  const stackedVoices = voices.slice(0, -1);
-  const latestVoice = voices[voices.length - 1];
-
   return (
     <div className="book-interface">
-      <WritingArea onChange={handleTextChange} triggers={voiceTriggers} />
-      <VoicesPanel
-        stackedCards={stackedVoices.map((voice, index) => (
-          <VoiceComment
-            key={index}
-            voice={voice.name}
-            text={voice.text}
-            icon={voice.icon}
-            color={voice.color}
-            isTopCard={false}
-            style={{
-              zIndex: index + 1,
-              marginTop: index === 0 ? 0 : '-45%',
-            }}
-          />
-        ))}
-        latestCard={latestVoice && (
-          <VoiceComment
-            voice={latestVoice.name}
-            text={latestVoice.text}
-            icon={latestVoice.icon}
-            color={latestVoice.color}
-            isTopCard={true}
-            style={{
-              zIndex: voices.length,
-            }}
-          />
-        )}
-        stackedCount={stackedVoices.length}
+      <WritingArea
+        onChange={handleTextChange}
+        triggers={voiceTriggers}
+        onCursorChange={setCursorPosition}
       />
+      <VoicesPanel focusedVoiceIndex={focusedVoiceIndex}>
+        {voices.map((voice, index) => (
+          <VoiceComment key={index} voice={voice.name} text={voice.text} icon={voice.icon} color={voice.color} />
+        ))}
+      </VoicesPanel>
       <BinderRings />
     </div>
   );
 }
 
-export default App
+export default App
\ No newline at end of file
diff --git a/frontend/src/api/voiceApi.ts b/frontend/src/api/voiceApi.ts
index ce9b9d3..e690802 100644
--- a/frontend/src/api/voiceApi.ts
+++ b/frontend/src/api/voiceApi.ts
@@ -28,13 +28,13 @@ interface StatusResponse {
 /**
  * Trigger voice analysis session
  */
-export async function triggerAnalysis(text: string): Promise<string> {
+export async function triggerAnalysis(text: string, sessionId: string): Promise<string> {
   const response = await fetch(`${API_BASE}/api/trigger`, {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       session_id: 'analyze_text',
-      params: { text }
+      params: { text, session_id: sessionId }
     })
   });
 
@@ -77,8 +77,8 @@ export async function getAnalysisResult(exec_id: string): Promise<StatusResponse
 /**
  * Analyze text and return voices (all-in-one)
  */
-export async function analyzeText(text: string) {
-  const exec_id = await triggerAnalysis(text);
+export async function analyzeText(text: string, sessionId: string) {
+  const exec_id = await triggerAnalysis(text, sessionId);
   const result = await getAnalysisResult(exec_id);
   return result?.voices || [];
 }
diff --git a/frontend/src/components/BookPage.tsx b/frontend/src/components/BookPage.tsx
index 8fa2cc2..540c45a 100644
--- a/frontend/src/components/BookPage.tsx
+++ b/frontend/src/components/BookPage.tsx
@@ -1,14 +1,18 @@
-import { ReactNode } from 'react';
+import { ReactNode, forwardRef } from 'react';
 
 interface BookPageProps {
   children?: ReactNode;
   side: 'left' | 'right';
 }
 
-export default function BookPage({ children, side }: BookPageProps) {
+const BookPage = forwardRef<HTMLDivElement, BookPageProps>(({ children, side }, ref) => {
   return (
-    <div className={`book-page ${side}-page`}>
+    <div className={`book-page ${side}-page`} ref={ref}>
       {children}
     </div>
   );
-}
\ No newline at end of file
+});
+
+BookPage.displayName = 'BookPage';
+
+export default BookPage;
\ No newline at end of file
diff --git a/frontend/src/components/EditableTextArea.tsx b/frontend/src/components/EditableTextArea.tsx
index c7a9cc7..fd53152 100644
--- a/frontend/src/components/EditableTextArea.tsx
+++ b/frontend/src/components/EditableTextArea.tsx
@@ -6,15 +6,22 @@ import { VoiceHighlight, type VoiceTrigger } from '../extensions/VoiceHighlight'
 interface EditableTextAreaProps {
   onChange: (text: string) => void;
   triggers: VoiceTrigger[];
+  onCursorChange?: (position: number) => void;
 }
 
-export default function EditableTextArea({ onChange, triggers }: EditableTextAreaProps) {
+export default function EditableTextArea({ onChange, triggers, onCursorChange }: EditableTextAreaProps) {
   const editor = useEditor({
     extensions: [
       StarterKit,
       VoiceHighlight.configure({ triggers })
     ],
-    onUpdate: ({ editor }) => onChange(editor.getText()),
+    onUpdate: ({ editor }) => {
+      onChange(editor.getText());
+      onCursorChange?.(editor.state.selection.from);
+    },
+    onSelectionUpdate: ({ editor }) => {
+      onCursorChange?.(editor.state.selection.from);
+    },
     autofocus: true,
   });
 
diff --git a/frontend/src/components/VoiceComment.tsx b/frontend/src/components/VoiceComment.tsx
index 70011d5..d2fc127 100644
--- a/frontend/src/components/VoiceComment.tsx
+++ b/frontend/src/components/VoiceComment.tsx
@@ -1,13 +1,10 @@
-import { FaBrain, FaHeart, FaQuestion, FaCloud } from 'react-icons/fa';
-import { CSSProperties } from 'react';
+import { FaBrain, FaHeart, FaQuestion, FaCloud, FaTheaterMasks, FaEye, FaFistRaised, FaLightbulb, FaShieldAlt, FaWind, FaFire, FaCompass } from 'react-icons/fa';
 
 interface VoiceCommentProps {
   voice: string;
   text: string;
   icon: string;
   color: string;
-  isTopCard: boolean;
-  style?: CSSProperties;
 }
 
 const iconMap = {
@@ -15,6 +12,14 @@ const iconMap = {
   heart: FaHeart,
   question: FaQuestion,
   cloud: FaCloud,
+  masks: FaTheaterMasks,
+  eye: FaEye,
+  fist: FaFistRaised,
+  lightbulb: FaLightbulb,
+  shield: FaShieldAlt,
+  wind: FaWind,
+  fire: FaFire,
+  compass: FaCompass,
 };
 
 const colorMap: Record<string, { background: string; border: string }> = {
@@ -25,17 +30,16 @@ const colorMap: Record<string, { background: string; border: string }> = {
   purple: { background: '#f3e6ff', border: '#b366ff' },
 };
 
-export default function VoiceComment({ voice, text, icon, color, isTopCard, style }: VoiceCommentProps) {
+export default function VoiceComment({ voice, text, icon, color }: VoiceCommentProps) {
   const Icon = iconMap[icon as keyof typeof iconMap];
   const colors = colorMap[color] || { background: '#f0f0f0', border: '#ccc' };
 
   return (
     <div
-      className={`voice-comment ${isTopCard ? 'top-card' : ''}`}
+      className="voice-comment"
       style={{
         backgroundColor: colors.background,
         borderColor: colors.border,
-        ...style,
       }}
     >
       <div className="voice-header">
diff --git a/frontend/src/components/VoicesPanel.tsx b/frontend/src/components/VoicesPanel.tsx
index 651f990..ff32586 100644
--- a/frontend/src/components/VoicesPanel.tsx
+++ b/frontend/src/components/VoicesPanel.tsx
@@ -1,25 +1,29 @@
-import { ReactNode } from 'react';
+import { ReactNode, useRef, useEffect } from 'react';
 import BookPage from './BookPage';
 
 interface VoicesPanelProps {
-  stackedCards: ReactNode;
-  latestCard: ReactNode;
-  stackedCount: number;
+  children: ReactNode;
+  focusedVoiceIndex?: number;
 }
 
-export default function VoicesPanel({ stackedCards, latestCard, stackedCount }: VoicesPanelProps) {
+export default function VoicesPanel({ children, focusedVoiceIndex }: VoicesPanelProps) {
+  const panelRef = useRef<HTMLDivElement>(null);
+
+  // @@@ Auto-scroll to focused comment with margin
+  useEffect(() => {
+    if (focusedVoiceIndex !== undefined && panelRef.current) {
+      const comments = panelRef.current.querySelectorAll('.voice-comment');
+      const targetComment = comments[focusedVoiceIndex] as HTMLElement;
+
+      if (targetComment) {
+        targetComment.scrollIntoView({ behavior: 'smooth', block: 'center' });
+      }
+    }
+  }, [focusedVoiceIndex]);
+
   return (
-    <BookPage side="right">
-      <div className="voices-container">
-        {stackedCount > 0 && (
-          <div className="voice-stack">
-            {stackedCards}
-          </div>
-        )}
-        <div className="latest-card-container">
-          {latestCard}
-        </div>
-      </div>
+    <BookPage side="right" ref={panelRef}>
+      {children}
     </BookPage>
   );
 }
\ No newline at end of file
diff --git a/frontend/src/components/WritingArea.tsx b/frontend/src/components/WritingArea.tsx
index f4fbe1a..a969dc2 100644
--- a/frontend/src/components/WritingArea.tsx
+++ b/frontend/src/components/WritingArea.tsx
@@ -5,12 +5,13 @@ import type { VoiceTrigger } from '../extensions/VoiceHighlight';
 interface WritingAreaProps {
   onChange: (text: string) => void;
   triggers: VoiceTrigger[];
+  onCursorChange?: (position: number) => void;
 }
 
-export default function WritingArea({ onChange, triggers }: WritingAreaProps) {
+export default function WritingArea({ onChange, triggers, onCursorChange }: WritingAreaProps) {
   return (
     <BookPage side="left">
-      <EditableTextArea onChange={onChange} triggers={triggers} />
+      <EditableTextArea onChange={onChange} triggers={triggers} onCursorChange={onCursorChange} />
     </BookPage>
   );
 }
\ No newline at end of file
