{
  "sha": "078091538c4ef33b52a1c0be4d44c6450236b9ca",
  "node_id": "C_kwDOP2Zrm9oAKDA3ODA5MTUzOGM0ZWYzM2I1MmExYzBiZTRkNDRjNjQ1MDIzNmI5Y2E",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-12-10T08:01:19Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-12-10T08:01:19Z"
    },
    "message": "stable image generation",
    "tree": {
      "sha": "2073f2c7212920a7583c31bd0124010330e65bee",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/2073f2c7212920a7583c31bd0124010330e65bee"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/078091538c4ef33b52a1c0be4d44c6450236b9ca",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/078091538c4ef33b52a1c0be4d44c6450236b9ca",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/078091538c4ef33b52a1c0be4d44c6450236b9ca",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/078091538c4ef33b52a1c0be4d44c6450236b9ca/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "f46210f5b1c27927c85ddb8fdac7d62ed694be6c",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/f46210f5b1c27927c85ddb8fdac7d62ed694be6c",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/f46210f5b1c27927c85ddb8fdac7d62ed694be6c"
    }
  ],
  "stats": {
    "total": 339,
    "additions": 258,
    "deletions": 81
  },
  "files": [
    {
      "sha": "2722bc4a2ee9d6ec21c30c61a19a3ac05eec7884",
      "filename": "backend/scheduler.py",
      "status": "modified",
      "additions": 10,
      "deletions": 9,
      "changes": 19,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/078091538c4ef33b52a1c0be4d44c6450236b9ca/backend%2Fscheduler.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/078091538c4ef33b52a1c0be4d44c6450236b9ca/backend%2Fscheduler.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fscheduler.py?ref=078091538c4ef33b52a1c0be4d44c6450236b9ca",
      "patch": "@@ -21,7 +21,7 @@\n from server import generate_daily_picture\n \n \n-async def generate_for_user(user_id: int, text: str, date: str) -> dict:\n+async def generate_for_user(user_id: int, text: str, date: str, timezone: str) -> dict:\n     \"\"\"\n     Generate timeline image for a single user (async wrapper).\n \n@@ -34,18 +34,19 @@ async def generate_for_user(user_id: int, text: str, date: str) -> dict:\n         dict with success status and metadata\n     \"\"\"\n     try:\n-        # @@@ Check if image already exists for this date (avoid duplicates)\n-        existing_pictures = database.get_daily_pictures(user_id, limit=1000)\n-        if any(p['date'] == date for p in existing_pictures):\n-            print(f\"\u23ed\ufe0f  User {user_id}: Image already exists for {date}, skipping\")\n-            return {\"success\": True, \"skipped\": True, \"user_id\": user_id, \"date\": date}\n-\n         # Call the existing PolyCLI session function (runs in thread pool)\n         print(f\"\ud83c\udfa8 User {user_id}: Generating image for {date} ({len(text)} chars)\")\n         loop = asyncio.get_event_loop()\n         result = await loop.run_in_executor(\n             None,\n-            lambda: generate_daily_picture(text, user_id, target_date=date)\n+            lambda: generate_daily_picture(\n+                user_id=user_id,\n+                target_date=date,\n+                timezone=timezone,\n+                notes_override=text,\n+                skip_if_exists=True,\n+                dry_run=False,\n+            )\n         )\n \n         if result and 'image_base64' in result:\n@@ -102,7 +103,7 @@ async def generate_timeline_images_for_date(target_date: str, timezone: str = 'A\n                 text = database.extract_text_from_sessions_on_date(user_id, target_date, timezone)\n                 if text.strip():\n                     # Create async task with semaphore for rate limiting\n-                    task = generate_for_user(user_id, text, target_date)\n+                    task = generate_for_user(user_id, text, target_date, timezone)\n                     tasks.append(task)\n                 else:\n                     print(f\"\u23ed\ufe0f  User {user_id}: No text content, skipping\")"
    },
    {
      "sha": "f0ad8cabde6a12f58e05fe0e87cfd5c5a3c243c2",
      "filename": "backend/server.py",
      "status": "modified",
      "additions": 161,
      "deletions": 63,
      "changes": 224,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/078091538c4ef33b52a1c0be4d44c6450236b9ca/backend%2Fserver.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/078091538c4ef33b52a1c0be4d44c6450236b9ca/backend%2Fserver.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fserver.py?ref=078091538c4ef33b52a1c0be4d44c6450236b9ca",
      "patch": "@@ -538,30 +538,55 @@ def analyze_patterns(\n         return {\"patterns\": []}\n \n \n-@session_def(\n-    name=\"Generate Daily Picture\",\n-    description=\"Generate an artistic image based on user's daily notes\",\n-    params={\n-        \"user_id\": {\"type\": \"int\"},\n-        \"target_date\": {\"type\": \"str\"},  # Optional: YYYY-MM-DD format\n-    },\n-    category=\"Creative\",\n-)\n-def generate_daily_picture(user_id: int, target_date: str = None):\n-    \"\"\"Generate an image based on the essence of user's daily notes.\n+def _today_in_tz(tz_name: str) -> str:\n+    from zoneinfo import ZoneInfo\n+    now = datetime.now(ZoneInfo(tz_name))\n+    return now.strftime(\"%Y-%m-%d\")\n \n-    Args:\n-        user_id: User ID\n-        target_date: Optional date string (YYYY-MM-DD). If None, uses today.\n-    \"\"\"\n-    from datetime import datetime\n \n-    notes = _load_all_notes_text(user_id)\n-    if not notes.strip():\n-        return {\"image_base64\": \"\", \"thumbnail_base64\": \"\", \"prompt\": \"\"}\n+def _generate_picture_for_date(\n+    user_id: int,\n+    target_date: Optional[str] = None,\n+    *,\n+    timezone: str = \"Asia/Shanghai\",\n+    notes_override: Optional[str] = None,\n+    skip_if_exists: bool = False,\n+    dry_run: bool = False,\n+):\n+    \"\"\"\n+    Shared generator for daily pictures.\n \n-    if target_date is None:\n-        target_date = datetime.now().strftime(\"%Y-%m-%d\")\n+    - Extracts notes for the given date (or uses override).\n+    - Generates description + image.\n+    - Saves to DB unless dry_run=True.\n+    \"\"\"\n+    target_date = target_date or _today_in_tz(timezone)\n+    target_date = target_date.strip()\n+\n+    if skip_if_exists and not dry_run:\n+        existing = database.get_daily_pictures_range(user_id, target_date, target_date, limit=1)\n+        if existing:\n+            return {\n+                \"skipped\": True,\n+                \"reason\": \"already exists\",\n+                \"date\": target_date,\n+                \"image_base64\": existing[0][\"base64\"],\n+                \"thumbnail_base64\": existing[0][\"base64\"],\n+                \"prompt\": existing[0].get(\"prompt\") or \"\",\n+            }\n+\n+    notes = notes_override if notes_override is not None else database.extract_text_from_sessions_on_date(\n+        user_id, target_date, timezone\n+    )\n+    if not (notes or \"\").strip():\n+        return {\n+            \"skipped\": True,\n+            \"reason\": \"no notes for date\",\n+            \"date\": target_date,\n+            \"image_base64\": \"\",\n+            \"thumbnail_base64\": \"\",\n+            \"prompt\": \"\",\n+        }\n \n     print(f\"\\n{'=' * 60}\")\n     print(f\"\ud83c\udfa8 generate_daily_picture() called\")\n@@ -589,9 +614,7 @@ def generate_daily_picture(user_id: int, target_date: str = None):\n                 recent_prompts_text += \"\\n\u26a0\ufe0f IMPORTANT: Create something COMPLETELY DIFFERENT from all previous descriptions above!\\n\"\n                 recent_prompts_text += \"\u26a0\ufe0f Use different: setting, objects, style, mood, time of day, colors, composition.\\n\"\n                 recent_prompts_text += \"\u26a0\ufe0f Be creative and avoid repetition!\\n\"\n-                print(\n-                    f\"\ud83d\udccb Found {len(recent_prompts_list)} recent prompts to avoid duplication\"\n-                )\n+                print(f\"\ud83d\udccb Found {len(recent_prompts_list)} recent prompts to avoid duplication\")\n     except Exception as e:\n         print(f\"\u26a0\ufe0f Could not fetch recent prompts: {e}\")\n \n@@ -646,7 +669,7 @@ def generate_daily_picture(user_id: int, target_date: str = None):\n     )\n \n     if claude_response.status_code != 200:\n-        return {\"image_base64\": None, \"error\": \"Failed to create image description\"}\n+        return {\"image_base64\": None, \"error\": \"Failed to create image description\", \"date\": target_date}\n \n     claude_data = claude_response.json()\n     image_description = (\n@@ -657,7 +680,7 @@ def generate_daily_picture(user_id: int, target_date: str = None):\n     )\n \n     if not image_description:\n-        return {\"image_base64\": None, \"error\": \"Failed to create image description\"}\n+        return {\"image_base64\": None, \"error\": \"Failed to create image description\", \"date\": target_date}\n \n     print(f\"\ud83d\udcdd Image description: {image_description}\")\n \n@@ -681,9 +704,7 @@ def generate_daily_picture(user_id: int, target_date: str = None):\n                 config.IMAGE_RETRY_BASE_TIMEOUT\n                 + (attempt - 1) * config.IMAGE_RETRY_TIMEOUT_INCREMENT\n             )\n-            print(\n-                f\"\ud83c\udfa8 Generating image (attempt {attempt}/{config.IMAGE_RETRY_MAX_ATTEMPTS}, timeout={timeout_seconds}s)...\"\n-            )\n+            print(f\"\ud83c\udfa8 Generating image (attempt {attempt}/{config.IMAGE_RETRY_MAX_ATTEMPTS}, timeout={timeout_seconds}s)...\")\n             response = requests.post(\n                 url,\n                 headers=headers,\n@@ -694,12 +715,12 @@ def generate_daily_picture(user_id: int, target_date: str = None):\n             if response.status_code != 200:\n                 print(f\"\u274c Error: {response.status_code}\")\n                 if attempt < config.IMAGE_RETRY_MAX_ATTEMPTS:\n-                    print(f\"\u23f3 Retrying in 2 seconds...\")\n+                    print(\"\u23f3 Retrying in 2 seconds...\")\n                     import time\n \n                     time.sleep(2)\n                     continue\n-                return {\"image_base64\": None, \"error\": \"Image generation failed\"}\n+                return {\"image_base64\": None, \"error\": \"Image generation failed\", \"date\": target_date}\n \n             data = response.json()\n \n@@ -736,69 +757,116 @@ def generate_daily_picture(user_id: int, target_date: str = None):\n \n                             # Full JPEG (quality 85)\n                             full_output = BytesIO()\n-                            img.save(\n-                                full_output, format=\"JPEG\", quality=85, optimize=True\n-                            )\n-                            full_jpeg = base64.b64encode(full_output.getvalue()).decode(\n-                                \"utf-8\"\n-                            )\n+                            img.save(full_output, format=\"JPEG\", quality=85, optimize=True)\n+                            full_jpeg = base64.b64encode(full_output.getvalue()).decode(\"utf-8\")\n \n                             # Thumbnail JPEG (400px width, quality 60)\n                             thumb_width = 400\n                             thumb_height = int(img.height * (thumb_width / img.width))\n-                            thumb_img = img.resize(\n-                                (thumb_width, thumb_height), Image.Resampling.LANCZOS\n-                            )\n+                            thumb_img = img.resize((thumb_width, thumb_height), Image.Resampling.LANCZOS)\n \n                             thumb_output = BytesIO()\n-                            thumb_img.save(\n-                                thumb_output, format=\"JPEG\", quality=60, optimize=True\n-                            )\n-                            thumb_jpeg = base64.b64encode(\n-                                thumb_output.getvalue()\n-                            ).decode(\"utf-8\")\n-\n-                            print(f\"\u2705 Image generated successfully\")\n+                            thumb_img.save(thumb_output, format=\"JPEG\", quality=60, optimize=True)\n+                            thumb_jpeg = base64.b64encode(thumb_output.getvalue()).decode(\"utf-8\")\n+\n+                            print(\"\u2705 Image generated successfully\")\n                             print(f\"   Original PNG: {len(base64_data)} chars\")\n-                            print(\n-                                f\"   Full JPEG: {len(full_jpeg)} chars ({100 * len(full_jpeg) / len(base64_data):.1f}%)\"\n-                            )\n-                            print(\n-                                f\"   Thumbnail: {len(thumb_jpeg)} chars ({100 * len(thumb_jpeg) / len(base64_data):.1f}%)\"\n-                            )\n-\n-                            return {\n+                            print(f\"   Full JPEG: {len(full_jpeg)} chars ({100 * len(full_jpeg) / len(base64_data):.1f}%)\")\n+                            print(f\"   Thumbnail: {len(thumb_jpeg)} chars ({100 * len(thumb_jpeg) / len(base64_data):.1f}%)\")\n+\n+                            result = {\n                                 \"image_base64\": full_jpeg,\n                                 \"thumbnail_base64\": thumb_jpeg,\n                                 \"prompt\": image_description,\n+                                \"date\": target_date,\n                             }\n+                            if not dry_run:\n+                                database.save_daily_picture(\n+                                    user_id=user_id,\n+                                    date=target_date,\n+                                    image_base64=full_jpeg,\n+                                    prompt=image_description,\n+                                    thumbnail_base64=thumb_jpeg,\n+                                )\n+                            return result\n                         except Exception as e:\n                             print(f\"\u26a0\ufe0f JPEG conversion failed: {e}, using original PNG\")\n-                            return {\n+                            result = {\n                                 \"image_base64\": base64_data,\n                                 \"thumbnail_base64\": base64_data,  # Fallback to full image\n                                 \"prompt\": image_description,\n+                                \"date\": target_date,\n                             }\n+                            if not dry_run:\n+                                database.save_daily_picture(\n+                                    user_id=user_id,\n+                                    date=target_date,\n+                                    image_base64=base64_data,\n+                                    prompt=image_description,\n+                                    thumbnail_base64=base64_data,\n+                                )\n+                            return result\n \n             if attempt < config.IMAGE_RETRY_MAX_ATTEMPTS:\n-                print(f\"\u26a0\ufe0f No image in response, retrying...\")\n+                print(\"\u26a0\ufe0f No image in response, retrying...\")\n                 import time\n \n                 time.sleep(2)\n                 continue\n-            return {\"image_base64\": None, \"error\": \"No image in response\"}\n+            return {\"image_base64\": None, \"error\": \"No image in response\", \"date\": target_date}\n \n         except Exception as e:\n             print(f\"\u274c Exception on attempt {attempt}: {e}\")\n             if attempt < config.IMAGE_RETRY_MAX_ATTEMPTS:\n-                print(f\"\u23f3 Retrying in 2 seconds...\")\n+                print(\"\u23f3 Retrying in 2 seconds...\")\n                 import time\n \n                 time.sleep(2)\n                 continue\n-            return {\"image_base64\": None, \"error\": str(e)}\n+            return {\"image_base64\": None, \"error\": str(e), \"date\": target_date}\n \n-    return {\"image_base64\": None, \"error\": \"All retry attempts failed\"}\n+    return {\"image_base64\": None, \"error\": \"All retry attempts failed\", \"date\": target_date}\n+\n+\n+@session_def(\n+    name=\"Generate Daily Picture\",\n+    description=\"Generate an artistic image based on user's daily notes\",\n+    params={\n+        \"user_id\": {\"type\": \"int\"},\n+        \"target_date\": {\"type\": \"str\"},  # Optional: YYYY-MM-DD format\n+        \"notes_override\": {\"type\": \"str\"},\n+        \"dry_run\": {\"type\": \"bool\"},\n+        \"skip_if_exists\": {\"type\": \"bool\"},\n+    },\n+    category=\"Creative\",\n+)\n+def generate_daily_picture(\n+    user_id: int,\n+    target_date: str = None,\n+    notes_override: str = None,\n+    dry_run: bool = True,\n+    skip_if_exists: bool = False,\n+    timezone: str = \"Asia/Shanghai\",\n+):\n+    \"\"\"\n+    Generate an image for a specific date.\n+\n+    Defaults to dry_run=True so the caller decides whether to persist.\n+    \"\"\"\n+    result = _generate_picture_for_date(\n+        user_id=user_id,\n+        target_date=target_date,\n+        timezone=timezone,\n+        notes_override=notes_override,\n+        skip_if_exists=skip_if_exists,\n+        dry_run=dry_run,\n+    )\n+    # PolyCLI sessions should fail loudly if no image produced\n+    if result.get(\"skipped\"):\n+        raise ValueError(result.get(\"reason\") or \"Generation skipped\")\n+    if not result.get(\"image_base64\"):\n+        raise ValueError(result.get(\"error\") or \"Generation returned no image\")\n+    return result\n \n \n # ========== FastAPI Application ==========\n@@ -878,7 +946,14 @@ class LoginRequest(BaseModel):\n \n class TokenResponse(BaseModel):\n     token: str\n-    user: dict\n+\n+\n+class GeneratePictureRequest(BaseModel):\n+    target_date: Optional[str] = None\n+    notes_override: Optional[str] = None\n+    dry_run: bool = False\n+    skip_if_exists: bool = False\n+    timezone: Optional[str] = \"Asia/Shanghai\"\n \n \n class ImportDataRequest(BaseModel):\n@@ -1448,6 +1523,29 @@ def get_pictures(limit: int = 30, current_user: dict = Depends(get_current_user)\n     pictures = database.get_daily_pictures(user_id, limit)\n     return {\"pictures\": pictures}\n \n+\n+@app.post(\"/api/pictures/generate\")\n+def generate_picture_endpoint(\n+    request: GeneratePictureRequest,\n+    current_user: dict = Depends(get_current_user)\n+):\n+    \"\"\"\n+    Generate a picture for a specific date.\n+    - If dry_run=True, returns the image but does not save.\n+    - If skip_if_exists=True, returns existing image without regenerating.\n+    \"\"\"\n+    user_id = current_user[\"user_id\"]\n+    tz = request.timezone or \"Asia/Shanghai\"\n+    result = _generate_picture_for_date(\n+        user_id=user_id,\n+        target_date=request.target_date,\n+        timezone=tz,\n+        notes_override=request.notes_override,\n+        skip_if_exists=request.skip_if_exists,\n+        dry_run=request.dry_run,\n+    )\n+    return result\n+\n @app.get(\"/api/pictures/range\")\n def get_pictures_range(\n     start_date: Optional[str] = None,"
    },
    {
      "sha": "07fe4c9bd8dcecbac6f2997aef472a5195b2d3c2",
      "filename": "backend/tests/picture_dry_run.py",
      "status": "added",
      "additions": 72,
      "deletions": 0,
      "changes": 72,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/078091538c4ef33b52a1c0be4d44c6450236b9ca/backend%2Ftests%2Fpicture_dry_run.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/078091538c4ef33b52a1c0be4d44c6450236b9ca/backend%2Ftests%2Fpicture_dry_run.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Ftests%2Fpicture_dry_run.py?ref=078091538c4ef33b52a1c0be4d44c6450236b9ca",
      "patch": "@@ -0,0 +1,72 @@\n+#!/usr/bin/env python3\n+\"\"\"\n+Standalone dry-run tester for daily picture generation.\n+\n+Usage:\n+  python backend/tests/picture_dry_run.py --token TOKEN [--base-url http://127.0.0.1:8765] [--date YYYY-MM-DD] [--notes \"smoke\"]\n+\n+Does not write to DB (uses dry_run=true). Exits non-zero on failure.\n+\"\"\"\n+\n+import argparse\n+import json\n+import sys\n+import urllib.request\n+import urllib.error\n+\n+\n+def main():\n+    parser = argparse.ArgumentParser(description=\"Dry-run picture generation (no DB write).\")\n+    parser.add_argument(\"--base-url\", default=\"http://127.0.0.1:8765\", help=\"Backend base URL\")\n+    parser.add_argument(\"--token\", required=True, help=\"Bearer token for auth\")\n+    parser.add_argument(\"--date\", dest=\"target_date\", help=\"Target date YYYY-MM-DD (default: today)\")\n+    parser.add_argument(\"--notes\", dest=\"notes_override\", default=\"smoke test\", help=\"Override notes text for generation\")\n+    parser.add_argument(\"--timeout\", type=int, default=60, help=\"Request timeout seconds\")\n+    args = parser.parse_args()\n+\n+    url = f\"{args.base_url.rstrip('/')}/api/pictures/generate\"\n+    payload = {\n+        \"target_date\": args.target_date,\n+        \"notes_override\": args.notes_override,\n+        \"dry_run\": True,\n+        \"skip_if_exists\": False,\n+    }\n+\n+    data = json.dumps(payload).encode(\"utf-8\")\n+    req = urllib.request.Request(\n+        url,\n+        data=data,\n+        headers={\n+            \"Content-Type\": \"application/json\",\n+            \"Authorization\": f\"Bearer {args.token}\",\n+        },\n+    )\n+\n+    try:\n+        with urllib.request.urlopen(req, timeout=args.timeout) as resp:\n+            body = resp.read().decode(\"utf-8\")\n+            result = json.loads(body)\n+    except urllib.error.HTTPError as e:\n+        body = e.read().decode(\"utf-8\", errors=\"ignore\")\n+        sys.stderr.write(f\"HTTP error: {e.code} {e.reason}\\n\")\n+        if body:\n+            sys.stderr.write(f\"Body: {body}\\n\")\n+        sys.exit(1)\n+    except Exception as e:\n+        sys.stderr.write(f\"Request failed: {e}\\n\")\n+        sys.exit(1)\n+\n+    image_b64 = result.get(\"image_base64\")\n+    if not image_b64:\n+        sys.stderr.write(f\"No image_base64 in response: {result}\\n\")\n+        sys.exit(1)\n+\n+    thumb_len = len(result.get(\"thumbnail_base64\") or image_b64)\n+    prompt = (result.get(\"prompt\") or \"\").strip()\n+    print(f\"\u2705 Dry-run generated image (base64 length: {len(image_b64)}, thumb length: {thumb_len})\")\n+    if prompt:\n+        print(f\"Prompt: {prompt[:120]}{'...' if len(prompt) > 120 else ''}\")\n+\n+\n+if __name__ == \"__main__\":\n+    main()"
    },
    {
      "sha": "ec8746f988d7f6a5e9e111d12496e731182e290e",
      "filename": "frontend/src/api/voiceApi.ts",
      "status": "modified",
      "additions": 12,
      "deletions": 7,
      "changes": 19,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/078091538c4ef33b52a1c0be4d44c6450236b9ca/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/078091538c4ef33b52a1c0be4d44c6450236b9ca/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fapi%2FvoiceApi.ts?ref=078091538c4ef33b52a1c0be4d44c6450236b9ca",
      "patch": "@@ -295,8 +295,11 @@ export async function analyzePatterns(): Promise<any[]> {\n /**\n  * Generate a daily picture based on user's notes (PolyCLI direct call)\n  */\n-export async function generateDailyPicture(): Promise<{ image_base64: string; thumbnail_base64?: string; prompt: string }> {\n+export async function generateDailyPicture(targetDate?: string, timezone?: string): Promise<{ image_base64: string; thumbnail_base64?: string; prompt: string; date?: string }> {\n   const token = localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);\n+  const params: Record<string, any> = {};\n+  if (targetDate) params.target_date = targetDate;\n+  if (timezone) params.timezone = timezone;\n \n   const response = await fetch(`${API_BASE}/polycli/api/trigger-sync`, {\n     method: 'POST',\n@@ -306,7 +309,7 @@ export async function generateDailyPicture(): Promise<{ image_base64: string; th\n     },\n     body: JSON.stringify({\n       session_id: 'generate_daily_picture',\n-      params: { },\n+      params,\n       timeout: 60\n     })\n   });\n@@ -317,15 +320,17 @@ export async function generateDailyPicture(): Promise<{ image_base64: string; th\n     throw new Error(data.error || 'Image generation failed');\n   }\n \n-  if (data.result?.image_base64) {\n+  const res: any = data.result || {};\n+  if (res.image_base64) {\n     return {\n-      image_base64: data.result.image_base64,\n-      thumbnail_base64: data.result.thumbnail_base64,\n-      prompt: data.result.prompt || 'Generated from your notes'\n+      image_base64: res.image_base64,\n+      thumbnail_base64: res.thumbnail_base64,\n+      prompt: res.prompt || 'Generated from your notes',\n+      date: res.date\n     };\n   }\n \n-  throw new Error('Image generation failed - no image in response');\n+  throw new Error(res.error || res.reason || 'Image generation failed - no image in response');\n }\n \n // ========== Authenticated Endpoints (require login) =========="
    },
    {
      "sha": "70ac52ad62d8a708cecc46babfb7cc8af4e70bdb",
      "filename": "frontend/src/components/CollectionsView.tsx",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/078091538c4ef33b52a1c0be4d44c6450236b9ca/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/078091538c4ef33b52a1c0be4d44c6450236b9ca/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx?ref=078091538c4ef33b52a1c0be4d44c6450236b9ca",
      "patch": "@@ -783,7 +783,7 @@ function TimelinePage({ isVisible, voiceConfigs, dateLocale, timezone }: Timelin\n \n     try {\n       const { generateDailyPicture, saveDailyPicture } = await import('../api/voiceApi');\n-      const { image_base64, thumbnail_base64, prompt } = await generateDailyPicture();\n+      const { image_base64, thumbnail_base64, prompt } = await generateDailyPicture(dateStr, timezone);\n \n       if (!image_base64) {\n         alert('No notes found to generate an image. Please write and save entries first.');\n@@ -807,7 +807,8 @@ function TimelinePage({ isVisible, voiceConfigs, dateLocale, timezone }: Timelin\n       });\n     } catch (error) {\n       console.error('Image generation failed:', error);\n-      alert('Failed to generate image. Please try again.');\n+      const message = error instanceof Error ? error.message : 'Failed to generate image. Please try again.';\n+      alert(message);\n     } finally {\n       setGeneratingForDate(null);\n     }"
    }
  ]
}