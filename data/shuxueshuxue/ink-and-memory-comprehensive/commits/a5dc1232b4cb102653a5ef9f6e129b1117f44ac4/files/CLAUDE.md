# Ink & Memory - Development & Deployment Guide

## üöÄ Deployment to Production

### Prerequisites
- SSH access to Alibaba Cloud server (101.201.227.31)
- SSH key at `~/Codebase/serverManagement/keys/Jeffry.pem`
- Local development environment with Node.js and Python

### Complete Deployment Process

Run these commands from your local machine to deploy both frontend and backend:

```bash
# 1. Build Frontend
cd /Users/lexicalmathical/Codebase/ink-and-memory/frontend
npm run build

# 2. Deploy Frontend
scp -i ~/Codebase/serverManagement/keys/Jeffry.pem -r dist/* \
  root@101.201.227.31:/var/www/lexicalmathical.com/ink-and-memory/

# Fix permissions
ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
  "chown -R www-data:www-data /var/www/lexicalmathical.com/ink-and-memory/"

# 3. Update PolyCLI (if needed)
cd ~/Codebase/PolyCLI
tar czf /tmp/polycli.tar.gz src/ pyproject.toml README.md

scp -i ~/Codebase/serverManagement/keys/Jeffry.pem /tmp/polycli.tar.gz \
  root@101.201.227.31:/tmp/

ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 "
  mkdir -p /tmp/PolyCLI &&
  cd /tmp && tar xzf polycli.tar.gz -C /tmp/PolyCLI &&
  cd /root/ink-and-memory/backend && source .venv/bin/activate &&
  pip install --upgrade /tmp/PolyCLI/
"

# 4. Deploy Backend
cd ~/Codebase/ink-and-memory/backend
scp -i ~/Codebase/serverManagement/keys/Jeffry.pem *.py \
  root@101.201.227.31:/root/ink-and-memory/backend/

# 5. Restart Backend Server
ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 "
  tmux send-keys -t ink-and-memory:0 C-c
  sleep 2
  tmux send-keys -t ink-and-memory:0 'cd /root/ink-and-memory/backend && source .venv/bin/activate && python server.py' Enter
"
```

### Verify Deployment

```bash
# Check backend is running
ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
  "lsof -i :8765"

# Check frontend files
ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
  "ls -lh /var/www/lexicalmathical.com/ink-and-memory/"

# Test live URLs
curl -I https://lexicalmathical.com/ink-and-memory/
curl -s https://lexicalmathical.com/ink-and-memory/api/sessions | jq
```

### Production URLs
- **App**: https://lexicalmathical.com/ink-and-memory/
- **API**: https://lexicalmathical.com/ink-and-memory/api/
- **Control Panel**: https://lexicalmathical.com/ink-and-memory/control-panel

## üèóÔ∏è Architecture

### Frontend (React + TypeScript + Vite)
- **Location**: `/Users/lexicalmathical/Codebase/ink-and-memory/frontend/`
- **Build Output**: `dist/` (generated by `npm run build`)
- **Deployment**: Static files served by nginx from `/var/www/lexicalmathical.com/ink-and-memory/`
- **Base Path**: `/ink-and-memory/` (configured in `vite.config.ts`)

### Backend (Python + PolyCLI)
- **Location**: `/Users/lexicalmathical/Codebase/ink-and-memory/backend/`
- **Server Location**: `/root/ink-and-memory/backend/` on Alibaba Cloud
- **Port**: 8765 (proxied through nginx)
- **Environment**: Python virtual environment at `.venv/`
- **Managed by**: tmux session `ink-and-memory:0`

### Key Configuration Files

**Frontend - `vite.config.ts`:**
```typescript
export default defineConfig({
  plugins: [react()],
  base: '/ink-and-memory/',  // CRITICAL: Must match deployment path
  server: {
    proxy: {
      '/ink-and-memory/api': {
        target: 'http://localhost:8765',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/ink-and-memory/, '')
      }
    }
  }
})
```

**Frontend - `src/api/voiceApi.ts`:**
```typescript
const API_BASE = '/ink-and-memory';  // Production: nginx proxies to backend
```

**Backend - `server.py`:**
```python
# Uses PolyCLI session registry
# Runs on port 8765
# Models configured via models.json
```

## üîß Development

### Local Development Setup

**Frontend:**
```bash
cd frontend
npm install
npm run dev
# Runs on http://localhost:5173
```

**Backend:**
```bash
cd backend
uv venv
source .venv/bin/activate  # or .venv/Scripts/activate on Windows

# Install PolyCLI
cd ~/Codebase/PolyCLI
uv pip install -e .

cd ~/Codebase/ink-and-memory/backend
uv pip install beautifulsoup4 requests 'httpx[socks]'

# Create models.json with API config
python server.py
# Runs on http://localhost:8765
```

### API Configuration

Create `backend/models.json` with your API configuration.
The backend uses PolyCLI's model configuration system.

## üìù Key Features & Implementation

### Energy Pool Trigger System (v1.2.0)
- **Location**: `frontend/src/App.tsx`
- **How it works**:
  - Tracks weighted character count between polling intervals (every 5 seconds)
  - Accumulates energy when text increases
  - Triggers backend analysis when energy >= 40
  - Consumes 40 energy per request, preserves remainder
  - Ignores deletions (negative weight changes)

**Weighting System:**
- CJK characters (Chinese/Japanese/Korean): 2 weight
- Sentence punctuation (.!?„ÄÇÔºÅÔºü\n): 4 weight
- Chinese comma (Ôºå): 0 weight (ignored)
- Other characters: 1 weight

**@@@ Quote Weight Hack (non-obvious):**
When a user quotes a voice comment (via the quote button), the quoted text gets inserted into the editor and would normally be counted as new text, triggering unwanted energy accumulation.

**Solution** (`App.tsx:241-244`):
```typescript
setTimeout(() => {
  lastPollWeightRef.current = getWeightedLength(currentTextRef.current);
  console.log(`üìù Quote inserted, updated baseline weight to ${lastPollWeightRef.current}`);
}, 0);
```

After inserting a quote, we immediately update `lastPollWeightRef` to include the quote's weight. This "moves the baseline forward" so the next polling cycle sees no weight change from the quote. The `setTimeout(..., 0)` ensures we wait for the editor's `handleTextChange` to update `currentTextRef.current` first.

Without this hack: Quote inserted ‚Üí next poll sees +50 weight ‚Üí accumulates 50 energy ‚Üí unwanted analysis
With this hack: Quote inserted ‚Üí baseline updated ‚Üí next poll sees 0 weight change ‚Üí no energy accumulated ‚úÖ

### Stateful Voice Analysis
- **Location**: `backend/stateful_analyzer.py`
- **Features**:
  - Session-based state management (UUID isolation)
  - Pruning of deleted comments
  - Density enforcement (1 comment per sentence)
  - No debouncing (allows multiple LLM calls on same text)
  - Removed "one persona only once" restriction

### Voice Customization
- **Location**: `frontend/src/components/VoiceSettings.tsx`
- **Features**:
  - Full CRUD for voice personas
  - Import/Export JSON configurations
  - Text-based icon/color selection (not emoji/hex)
  - localStorage persistence
  - Reset to defaults

## üêõ Troubleshooting

### Frontend not updating after deployment
```bash
# Clear browser cache (Cmd+Shift+R on Mac)
# OR rebuild from scratch:
cd frontend
rm -rf dist/
npm run build
# Redeploy...
```

### Backend API returns 502 Bad Gateway
```bash
# Check if backend is running
ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
  "lsof -i :8765"

# View backend logs
ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
  "tmux attach -t ink-and-memory:0"

# Restart backend (see deployment commands above)
```

### PolyCLI updates not taking effect
```bash
# Ensure you're updating the correct virtual environment
# Redeploy PolyCLI and restart backend completely
```

## üìä Monitoring

### Check Backend Logs
```bash
ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 \
  "tmux capture-pane -t ink-and-memory:0 -p | tail -50"
```

### Check Active Sessions
```bash
curl -s https://lexicalmathical.com/ink-and-memory/api/sessions | jq
```

### Check Server Status
```bash
ssh -i ~/Codebase/serverManagement/keys/Jeffry.pem root@101.201.227.31 "
  echo '=== Backend Process ==='
  lsof -i :8765

  echo -e '\n=== nginx Status ==='
  systemctl status nginx --no-pager | head -5

  echo -e '\n=== Disk Usage ==='
  df -h /var/www
"
```

## üîê Security Notes

- **API Key**: Stored in environment variable on server (not in code)
- **File Permissions**:
  - Frontend: `www-data:www-data` (nginx user)
  - Backend: `root:root` (not web-accessible)
- **HTTPS**: All traffic encrypted via Let's Encrypt
- **Session Isolation**: UUID-based with TTL cleanup

## üìö Related Documentation

- **Server Infrastructure**: `~/Codebase/serverManagement/CLAUDE.md`
- **README**: `README.md` (user-facing documentation)
- **PolyCLI**: `~/Codebase/PolyCLI/README.md`

---
*Last updated: 2025-10-21*
*Version: v1.2.0-energy-pool*
