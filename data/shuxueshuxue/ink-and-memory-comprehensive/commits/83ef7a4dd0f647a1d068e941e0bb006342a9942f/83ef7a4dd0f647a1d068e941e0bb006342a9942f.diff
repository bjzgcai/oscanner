commit 83ef7a4dd0f647a1d068e941e0bb006342a9942f
Author: lexicalmathical <lexicalmathical@gmail.com>
Date:   Sun Nov 2 15:28:05 2025 +0800

    Fix comment positioning bug on page refresh
    
    Root cause: When page loads, textarea ref callbacks adjust heights
    (el.scrollHeight) which triggers browser reflow. The first ref triggers
    setRefsReady, but subsequent textareas also adjust heights WITHOUT
    triggering another state update. This means commentGroups useMemo
    calculates positions using offsetTop values from BEFORE all height
    adjustments complete.
    
    Solution: Added useLayoutEffect that triggers one more setRefsReady
    increment AFTER the initial refs are set. This forces commentGroups
    to recalculate positions after browser completes layout with all
    adjusted textarea heights.
    
    Why useLayoutEffect: Runs synchronously after DOM mutations but before
    paint, ensuring positions are correct before user sees them.
    
    Symptom: Comments appeared "a bit lower" on refresh, fixed by clicking
    (which triggered re-render with correct layout values).
    
    ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
    
    Co-Authored-By: Claude <noreply@anthropic.com>

diff --git a/frontend/src/App.tsx b/frontend/src/App.tsx
index 1606b8a..c3be0b2 100644
--- a/frontend/src/App.tsx
+++ b/frontend/src/App.tsx
@@ -1,4 +1,4 @@
-import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
+import React, { useState, useEffect, useLayoutEffect, useRef, useCallback, useMemo } from 'react';
 import { EditorEngine } from './engine/EditorEngine';
 import type { EditorState, Commentor, TextCell } from './engine/EditorEngine';
 import { ChatWidget } from './engine/ChatWidget';
@@ -301,6 +301,7 @@ export default function App() {
   // @@@ Force re-render when refs are ready
   const [refsReady, setRefsReady] = useState(0);
   const refsReadyTriggered = useRef(false);
+  const layoutStableTriggered = useRef(false);
 
   // @@@ Comment alignment state
   const [commentsAligned, setCommentsAligned] = useState(false);
@@ -309,6 +310,16 @@ export default function App() {
   const [expandedCommentId, setExpandedCommentId] = useState<string | null>(null);
   const [commentChatProcessing, setCommentChatProcessing] = useState<Set<string>>(new Set());
 
+  // @@@ Force position recalculation after layout settles (fixes refresh bug)
+  useLayoutEffect(() => {
+    if (refsReady > 0 && !layoutStableTriggered.current) {
+      layoutStableTriggered.current = true;
+      // Trigger another increment after layout completes
+      // This ensures positions are calculated AFTER all textarea heights are adjusted
+      setRefsReady(prev => prev + 1);
+    }
+  }, [refsReady]);
+
   // @@@ Trigger re-render when returning to writing view to recalculate comment positions
   useEffect(() => {
     if (currentView === 'writing') {
