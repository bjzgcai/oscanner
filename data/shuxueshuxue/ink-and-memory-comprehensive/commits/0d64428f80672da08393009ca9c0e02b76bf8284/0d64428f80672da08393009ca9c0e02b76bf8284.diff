commit 0d64428f80672da08393009ca9c0e02b76bf8284
Author: lexicalmathical <lexicalmathical@gmail.com>
Date:   Sun Oct 19 23:27:13 2025 +0800

    Add deployment support and voice customization design
    
    Deployment Changes:
    - Configure Vite base path for /ink-and-memory/ subdirectory
    - Update API_BASE to use relative path for nginx proxying
    - Enable production deployment at lexicalmathical.com/ink-and-memory
    
    Features:
    - Add weighted character counting (CJK = 3x, Latin = 1x)
    - Threshold: 40 weight units (~40 English OR ~13 Chinese chars)
    - Version logging for cache debugging (v1.1.0-weighted-40)
    
    Documentation:
    - Add voice customization design doc
    - Define localStorage-based customization system
    - Document no-merge rule and upload/download pattern
    - Specify TypeScript/Python type contract
    
    ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
    
    Co-Authored-By: Claude <noreply@anthropic.com>

diff --git a/docs/voice-customization.md b/docs/voice-customization.md
new file mode 100644
index 0000000..da125ad
--- /dev/null
+++ b/docs/voice-customization.md
@@ -0,0 +1,277 @@
+# Voice Customization System
+
+## Architecture
+
+### Source of Truth
+- **Server**: Owns default voice configurations
+- **localStorage**: Stores user customizations (complete replacement, not merge)
+
+### Rule: No Merging
+- User either uses server defaults OR their own customizations
+- Never merge the two
+- Clear ownership prevents conflicts
+
+## Data Flow
+
+```
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ 1. App Init: GET /api/sessions/analyze_text            â”‚
+â”‚    Server returns default voices                        â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                 â”‚
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ 2. Check localStorage['voice-customizations']          â”‚
+â”‚    EXISTS    â†’ Use customizations (ignore server)       â”‚
+â”‚    NOT EXIST â†’ Use server defaults                      â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+                 â”‚
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ 3. User edits in Settings Panel                        â”‚
+â”‚    [Save]        â†’ Write to localStorage                â”‚
+â”‚    [Use Default] â†’ Delete from localStorage             â”‚
+â”‚    [Export]      â†’ Download JSON file                   â”‚
+â”‚    [Import]      â†’ Read JSON â†’ Write to localStorage    â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+```
+
+## API Contract
+
+### GET /api/sessions/{session_id}
+
+**Response:**
+```json
+{
+  "id": "analyze_text",
+  "name": "Analyze Voices",
+  "description": "Detect inner voices in writing",
+  "defaultVoices": {
+    "logic": {
+      "name": "Logic",
+      "systemPrompt": "You are Logic. Analyze for patterns and inconsistencies...",
+      "icon": "ğŸ§ ",
+      "color": "#4a5568",
+      "highlightColor": "blue"
+    },
+    "empathy": {
+      "name": "Empathy",
+      "systemPrompt": "You are Empathy. Focus on emotional depth...",
+      "icon": "â¤ï¸",
+      "color": "#e53e3e",
+      "highlightColor": "pink"
+    },
+    "creativity": { /* ... */ },
+    "criticism": { /* ... */ }
+  }
+}
+```
+
+### POST /api/trigger
+
+**Request:**
+```json
+{
+  "text": "The protagonist walked slowly...",
+  "voices": {
+    "logic": {
+      "name": "Logic",
+      "systemPrompt": "You are Logic...",
+      "enabled": true,
+      "icon": "ğŸ§ ",
+      "color": "#4a5568",
+      "highlightColor": "blue"
+    }
+  }
+}
+```
+
+**Notes:**
+- Frontend sends complete voice configs (not IDs)
+- Backend uses provided systemPrompt (doesn't look up)
+- Only enabled voices are sent
+
+## Type Definitions
+
+### TypeScript
+```typescript
+// src/types/voice.ts
+export interface VoiceConfig {
+  name: string;
+  systemPrompt: string;
+  enabled: boolean;
+  icon: string;
+  color: string;
+  highlightColor: string;
+}
+
+export type VoicesPayload = Record<string, VoiceConfig>;
+```
+
+### Python
+```python
+# backend/types.py
+from pydantic import BaseModel
+
+class VoiceConfig(BaseModel):
+    name: str
+    systemPrompt: str
+    enabled: bool
+    icon: str
+    color: str
+    highlightColor: str
+```
+
+## localStorage Schema
+
+**Key:** `voice-customizations`
+
+**Value:**
+```json
+{
+  "version": "1.0.0",
+  "voices": {
+    "logic": {
+      "name": "My Logic",
+      "systemPrompt": "Custom prompt...",
+      "enabled": true,
+      "icon": "ğŸ§ ",
+      "color": "#4a5568",
+      "highlightColor": "blue"
+    }
+  }
+}
+```
+
+**Important:** If key exists, use it completely. Don't merge with server defaults.
+
+## Settings Panel UI
+
+```
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚ Voice Settings              [Close]â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚                                    â”‚
+â”‚ [Import] [Export] [Use Default]    â”‚
+â”‚                                    â”‚
+â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
+â”‚ â”‚ â˜‘ ğŸ§  Logic                   â”‚  â”‚
+â”‚ â”‚ System Prompt:                â”‚  â”‚
+â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
+â”‚ â”‚ â”‚You are Logic. Analyze... â”‚ â”‚  â”‚
+â”‚ â”‚ â”‚                          â”‚ â”‚  â”‚
+â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
+â”‚ â”‚ Color: [#4a5568 â–¼]           â”‚  â”‚
+â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
+â”‚                                    â”‚
+â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
+â”‚ â”‚ â˜‘ â¤ï¸ Empathy                  â”‚  â”‚
+â”‚ â”‚ ...                           â”‚  â”‚
+â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
+â”‚                                    â”‚
+â”‚              [Save Changes]        â”‚
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+```
+
+### Buttons
+
+**[Import]**
+- Opens file picker
+- Reads JSON file
+- Validates schema
+- Writes to localStorage
+- Reloads app state
+
+**[Export]**
+- Reads current voices (from state, not localStorage)
+- Downloads as `voice-config-{timestamp}.json`
+- No server interaction
+
+**[Use Default]**
+- Deletes `voice-customizations` from localStorage
+- Fetches server defaults again
+- Reloads app state
+
+**[Save Changes]**
+- Writes current form state to localStorage
+- No server interaction
+- Shows confirmation toast
+
+## Implementation Checklist
+
+### Backend
+- [ ] Add `defaultVoices` to session response
+- [ ] Update `/api/trigger` to accept `voices` parameter
+- [ ] Remove hardcoded voice lookups
+
+### Frontend
+- [ ] Create `VoiceConfig` type
+- [ ] Create `SettingsPanel` component
+- [ ] Create `VoiceEditor` component
+- [ ] Implement localStorage manager
+- [ ] Add import/export functions
+- [ ] Update API calls to send voices
+- [ ] Add settings toggle button
+
+### Testing
+- [ ] Test: Use server defaults (no localStorage)
+- [ ] Test: Save customizations
+- [ ] Test: Export â†’ Import
+- [ ] Test: Use Default (clears localStorage)
+- [ ] Test: Invalid import JSON (error handling)
+
+## Edge Cases
+
+### Server defaults change
+- User has old customizations in localStorage
+- **Decision:** User customizations take precedence
+- User must manually "Use Default" to get new server voices
+- Alternative: Show notification "Server voices updated" with option to review
+
+### Invalid localStorage data
+- Corrupted JSON
+- Missing required fields
+- **Decision:** Delete and fall back to server defaults
+- Log error to console for debugging
+
+### Voice disabled mid-analysis
+- User disables voice while analysis running
+- **Decision:** Let current analysis finish
+- Next trigger respects new enabled state
+
+## Migration Plan
+
+### Phase 1: Backend changes
+1. Add `defaultVoices` to session endpoint
+2. Accept `voices` in trigger endpoint
+3. Deploy backend
+
+### Phase 2: Frontend changes (compatible)
+1. Add Settings Panel UI (hidden behind flag)
+2. Add localStorage logic
+3. Update trigger to send voices
+4. Deploy frontend
+
+### Phase 3: Enable feature
+1. Remove feature flag
+2. Show Settings button
+3. Add onboarding tooltip
+
+## Future Enhancements
+
+### Voice Templates
+- Share voice configs via URL
+- Community voice library
+- One-click install presets
+
+### Validation
+- Max prompt length (prevent token overflow)
+- Required fields validation
+- Color format validation
+
+### Analytics
+- Track which voices are most used
+- Track customization adoption rate
+- Track default vs custom usage
+
+---
+
+**Last Updated:** 2025-10-16
diff --git a/frontend/src/App.tsx b/frontend/src/App.tsx
index 1e7238f..26c4b87 100644
--- a/frontend/src/App.tsx
+++ b/frontend/src/App.tsx
@@ -32,6 +32,12 @@ function App() {
       : generateUUID()
   ).current;
 
+  // @@@ Version logging for cache debugging
+  useEffect(() => {
+    console.log('ğŸ­ Ink & Memory - Version: v1.1.0-weighted-40');
+    console.log('ğŸ“Š Analysis trigger threshold: 40 weight units (~40 English chars OR ~13 Chinese chars)');
+  }, []);
+
   const [voices, setVoices] = useState<Voice[]>([]);
   const [voiceTriggers, setVoiceTriggers] = useState<VoiceTrigger[]>([]);
   const [currentText, setCurrentText] = useState<string>('');
@@ -80,6 +86,23 @@ function App() {
     setFocusedVoiceIndex(closestIndex);
   }, [cursorPosition, voices]);
 
+  // @@@ weighted-character-counting - English chars = 1 weight, CJK chars = 3 weight
+  // This elegantly balances both languages: ~30 English chars OR ~10 Chinese chars to trigger
+  const getWeightedLength = (text: string): number => {
+    let weight = 0;
+
+    for (const char of text) {
+      // CJK characters (Chinese, Japanese, Korean)
+      if (/[\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff]/.test(char)) {
+        weight += 3;  // Chinese character = 3 weight
+      } else {
+        weight += 1;  // English/other = 1 weight
+      }
+    }
+
+    return weight;
+  };
+
   const analyzeIfNeeded = async () => {
     // Skip if already analyzing
     if (isAnalyzingRef.current) {
@@ -87,10 +110,15 @@ function App() {
     }
 
     const currentTextValue = currentTextRef.current;
-    const textDiff = Math.abs(currentTextValue.length - lastAnalyzedTextRef.current.length);
+    const lastTextValue = lastAnalyzedTextRef.current;
+
+    const currentWeight = getWeightedLength(currentTextValue);
+    const lastWeight = getWeightedLength(lastTextValue);
+    const weightDiff = Math.abs(currentWeight - lastWeight);
 
-    // Only analyze if text changed by >10 characters
-    if (textDiff <= 10) {
+    // Only analyze if text changed by >40 weight
+    // (~40 English chars OR ~13 Chinese chars OR mixed)
+    if (weightDiff <= 40) {
       return;
     }
 
@@ -98,7 +126,7 @@ function App() {
     lastAnalyzedTextRef.current = currentTextValue;
 
     try {
-      console.log(`ğŸ” Calling backend analysis (${textDiff} chars changed)...`);
+      console.log(`ğŸ” Calling backend analysis (${weightDiff} weight units changed)...`);
       const backendVoices = await analyzeText(currentTextValue, sessionId);
       console.log(`âœ… Got ${backendVoices.length} voices from backend`);
 
diff --git a/frontend/src/api/voiceApi.ts b/frontend/src/api/voiceApi.ts
index c0a8ba3..76ba8ab 100644
--- a/frontend/src/api/voiceApi.ts
+++ b/frontend/src/api/voiceApi.ts
@@ -2,7 +2,8 @@
  * API client for voice analysis backend
  */
 
-const API_BASE = 'http://101.201.227.31:8765';
+// nginx proxies /ink-and-memory/api/* to backend (8765)
+const API_BASE = '/ink-and-memory';
 
 interface TriggerResponse {
   success: boolean;
diff --git a/frontend/vite.config.ts b/frontend/vite.config.ts
index 8b0f57b..b12451a 100644
--- a/frontend/vite.config.ts
+++ b/frontend/vite.config.ts
@@ -4,4 +4,5 @@ import react from '@vitejs/plugin-react'
 // https://vite.dev/config/
 export default defineConfig({
   plugins: [react()],
+  base: '/ink-and-memory/',  // Deploy at lexicalmathical.com/ink-and-memory/
 })
