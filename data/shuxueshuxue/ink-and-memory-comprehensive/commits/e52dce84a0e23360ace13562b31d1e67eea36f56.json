{
  "sha": "e52dce84a0e23360ace13562b31d1e67eea36f56",
  "node_id": "C_kwDOP2Zrm9oAKGU1MmRjZTg0YTBlMjMzNjBhY2UxMzU2MmIzMWQxZTY3ZWVhMzZmNTY",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-12-10T09:32:18Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-12-10T09:32:18Z"
    },
    "message": "new layout for deck manager",
    "tree": {
      "sha": "d1cd1b00ab70d22c95923477bdde971ac799f306",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/d1cd1b00ab70d22c95923477bdde971ac799f306"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/e52dce84a0e23360ace13562b31d1e67eea36f56",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/e52dce84a0e23360ace13562b31d1e67eea36f56",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/e52dce84a0e23360ace13562b31d1e67eea36f56",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/e52dce84a0e23360ace13562b31d1e67eea36f56/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "f803659ce6307c43c299013aa89674519a1428a3",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/f803659ce6307c43c299013aa89674519a1428a3",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/f803659ce6307c43c299013aa89674519a1428a3"
    }
  ],
  "stats": {
    "total": 1667,
    "additions": 765,
    "deletions": 902
  },
  "files": [
    {
      "sha": "a3f61d79883150cb50d523bf91acbb4028d5e21c",
      "filename": "frontend/src/components/DeckEditorModal.tsx",
      "status": "added",
      "additions": 569,
      "deletions": 0,
      "changes": 569,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/e52dce84a0e23360ace13562b31d1e67eea36f56/frontend%2Fsrc%2Fcomponents%2FDeckEditorModal.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/e52dce84a0e23360ace13562b31d1e67eea36f56/frontend%2Fsrc%2Fcomponents%2FDeckEditorModal.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FDeckEditorModal.tsx?ref=e52dce84a0e23360ace13562b31d1e67eea36f56",
      "patch": "@@ -0,0 +1,569 @@\n+import { useMemo } from 'react';\n+import type { Deck, Voice } from '../api/voiceApi';\n+import { COLORS, iconMap } from './deckVisuals';\n+\n+interface Props {\n+  deck: Deck;\n+  isSystem: boolean;\n+  selectedVoiceId: string | null;\n+  onSelectVoice: (voiceId: string | null) => void;\n+  onClose: () => void;\n+  creatingVoiceId: string | null;\n+  onAddVoice: (deckId: string) => Promise<void>;\n+  onUpdateDeck: (deckId: string, data: Partial<Deck>) => Promise<void>;\n+  onUpdateVoice: (voiceId: string, data: Partial<Voice>) => Promise<void>;\n+  onToggleVoice: (voiceId: string, currentEnabled: boolean) => Promise<void>;\n+  onDeleteVoice: (voiceId: string) => Promise<void>;\n+}\n+\n+export default function DeckEditorModal({\n+  deck,\n+  isSystem,\n+  selectedVoiceId,\n+  onSelectVoice,\n+  onClose,\n+  creatingVoiceId,\n+  onAddVoice,\n+  onUpdateDeck,\n+  onUpdateVoice,\n+  onToggleVoice,\n+  onDeleteVoice\n+}: Props) {\n+  const voices = deck.voices || [];\n+  const selectedVoice = useMemo(\n+    () => voices.find(v => v.id === selectedVoiceId) || null,\n+    [voices, selectedVoiceId]\n+  );\n+\n+  return (\n+    <div\n+      style={{\n+        position: 'fixed',\n+        top: 0,\n+        left: 0,\n+        right: 0,\n+        bottom: 0,\n+        background: 'rgba(0,0,0,0.45)',\n+        display: 'flex',\n+        alignItems: 'center',\n+        justifyContent: 'center',\n+        zIndex: 9998,\n+        padding: 16,\n+        boxSizing: 'border-box'\n+      }}\n+      onClick={onClose}\n+    >\n+      <div\n+        onClick={(e) => e.stopPropagation()}\n+        style={{\n+          width: 'min(1200px, 100%)',\n+          height: '85vh',\n+          maxHeight: '85vh',\n+          background: '#f8f0e6',\n+          borderRadius: 14,\n+          overflow: 'hidden',\n+          border: '2px solid #d0c4b0',\n+          boxShadow: '0 16px 36px rgba(0,0,0,0.25)',\n+          display: 'flex',\n+          flexDirection: 'column'\n+        }}\n+      >\n+        <div style={{\n+          display: 'flex',\n+          justifyContent: 'space-between',\n+          alignItems: 'center',\n+          padding: '16px 18px',\n+          borderBottom: '1px solid #d0c4b0',\n+          background: '#fff'\n+        }}>\n+          <div style={{ fontSize: 18, fontWeight: 700, color: '#2c2c2c', letterSpacing: -0.3 }}>\n+            Deck Editor\n+          </div>\n+          <button\n+            onClick={onClose}\n+            style={{\n+              background: '#f7f3ed',\n+              border: '1px solid #d0c4b0',\n+              borderRadius: 10,\n+              padding: '8px 14px',\n+              cursor: 'pointer',\n+              fontSize: 13,\n+              fontWeight: 600,\n+              color: '#2c2c2c',\n+              boxShadow: '0 2px 6px rgba(0,0,0,0.08)',\n+              transition: 'all 0.15s'\n+            }}\n+            onMouseEnter={(e) => {\n+              e.currentTarget.style.transform = 'translateY(-1px)';\n+              e.currentTarget.style.boxShadow = '0 4px 10px rgba(0,0,0,0.12)';\n+            }}\n+            onMouseLeave={(e) => {\n+              e.currentTarget.style.transform = 'translateY(0)';\n+              e.currentTarget.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';\n+            }}\n+          >\n+            Close\n+          </button>\n+        </div>\n+\n+        <div style={{ padding: 16, display: 'flex', flexDirection: 'column', gap: 16, flex: 1, overflow: 'hidden' }}>\n+          {/* Deck metadata: name + description left, prompt right */}\n+          <div style={{\n+            display: 'flex',\n+            gap: 12,\n+            flexWrap: 'wrap'\n+          }}>\n+            <div style={{\n+              flex: '0 1 360px',\n+              minWidth: 260,\n+              background: '#fff',\n+              border: '2px solid #e0e0e0',\n+              borderRadius: 12,\n+              padding: 16,\n+              boxShadow: '0 2px 6px rgba(0,0,0,0.05)',\n+              display: 'flex',\n+              flexDirection: 'column',\n+              gap: 10,\n+              boxSizing: 'border-box'\n+            }}>\n+              <div style={{\n+                fontSize: 11,\n+                fontWeight: 600,\n+                color: '#666',\n+                letterSpacing: 0.5,\n+                textTransform: 'uppercase'\n+              }}>\n+                Deck Name\n+              </div>\n+              <input\n+                key={`${deck.id}-${deck.name}`}\n+                type=\"text\"\n+                defaultValue={deck.name}\n+                disabled={isSystem}\n+                onBlur={(e) => {\n+                  if (!isSystem && e.target.value !== deck.name) {\n+                    onUpdateDeck(deck.id, { name: e.target.value });\n+                  }\n+                }}\n+                style={{\n+                  width: '100%',\n+                  padding: '10px 12px',\n+                  fontSize: 15,\n+                  fontWeight: 600,\n+                  border: '2px solid #e0e0e0',\n+                  borderRadius: 8,\n+                  background: isSystem ? '#f5f5f5' : '#fff',\n+                  color: '#2c2c2c',\n+                  boxSizing: 'border-box'\n+                }}\n+              />\n+              <div style={{\n+                fontSize: 11,\n+                fontWeight: 600,\n+                color: '#666',\n+                letterSpacing: 0.5,\n+                textTransform: 'uppercase'\n+              }}>\n+                Deck Description\n+              </div>\n+              <textarea\n+                key={`${deck.id}-desc-${deck.description || ''}`}\n+                defaultValue={deck.description || ''}\n+                disabled={isSystem}\n+                onBlur={(e) => {\n+                  if (!isSystem && e.target.value !== (deck.description || '')) {\n+                    onUpdateDeck(deck.id, { description: e.target.value });\n+                  }\n+                }}\n+                style={{\n+                  width: '100%',\n+                  minHeight: 90,\n+                  padding: '10px 12px',\n+                  fontSize: 13,\n+                  fontFamily: 'monospace',\n+                  border: '2px solid #e0e0e0',\n+                  borderRadius: 8,\n+                  background: isSystem ? '#f5f5f5' : '#fff',\n+                  resize: 'vertical',\n+                  boxSizing: 'border-box',\n+                  lineHeight: 1.5\n+                }}\n+              />\n+            </div>\n+\n+            <div style={{\n+              flex: '1 1 320px',\n+              minWidth: 260,\n+              background: '#fff',\n+              border: '2px solid #e0e0e0',\n+              borderRadius: 12,\n+              padding: 16,\n+              boxShadow: '0 2px 6px rgba(0,0,0,0.05)',\n+              display: 'flex',\n+              flexDirection: 'column',\n+              gap: 8,\n+              boxSizing: 'border-box'\n+            }}>\n+              <div style={{\n+                fontSize: 11,\n+                fontWeight: 600,\n+                color: '#666',\n+                letterSpacing: 0.5,\n+                textTransform: 'uppercase'\n+              }}>\n+                Deck Prompt (shared)\n+              </div>\n+              <textarea\n+                key={`${deck.id}-prompt-${deck.description || ''}`}\n+                defaultValue={deck.description || ''}\n+                disabled={isSystem}\n+                onBlur={(e) => {\n+                  if (!isSystem && e.target.value !== (deck.description || '')) {\n+                    onUpdateDeck(deck.id, { description: e.target.value });\n+                  }\n+                }}\n+                style={{\n+                  width: '100%',\n+                  minHeight: 140,\n+                  padding: '10px 12px',\n+                  fontSize: 13,\n+                  fontFamily: 'monospace',\n+                  border: '2px solid #e0e0e0',\n+                  borderRadius: 8,\n+                  background: isSystem ? '#f5f5f5' : '#fff',\n+                  resize: 'vertical',\n+                  boxSizing: 'border-box',\n+                  lineHeight: 1.6\n+                }}\n+              />\n+            </div>\n+          </div>\n+\n+          <div style={{ height: 1, background: '#dcd4c5', width: '100%' }} />\n+\n+          <div style={{\n+            display: 'flex',\n+            gap: 16,\n+            alignItems: 'stretch',\n+            flexWrap: 'wrap',\n+            flex: 1,\n+            minHeight: 0\n+          }}>\n+            {/* Left column: voice list */}\n+            <div style={{\n+              width: 320,\n+              flexShrink: 0,\n+              flexGrow: 0,\n+              minWidth: 260,\n+              maxHeight: '100%',\n+              display: 'flex',\n+              flexDirection: 'column',\n+              gap: 12\n+            }}>\n+              <div style={{\n+                background: '#fff',\n+                border: '2px solid #e0e0e0',\n+                borderRadius: 10,\n+                padding: 14,\n+                boxShadow: '0 2px 6px rgba(0,0,0,0.05)',\n+                display: 'flex',\n+                flexDirection: 'column',\n+                gap: 10,\n+                flex: 1,\n+                minHeight: 200,\n+                overflowY: 'auto'\n+              }}>\n+                <div style={{\n+                  display: 'flex',\n+                  alignItems: 'center',\n+                  justifyContent: 'space-between'\n+                }}>\n+                  <div style={{\n+                    fontSize: 11,\n+                    fontWeight: 600,\n+                    color: '#666',\n+                    letterSpacing: 0.5,\n+                    textTransform: 'uppercase'\n+                  }}>\n+                    Agents\n+                  </div>\n+                  {!isSystem && (\n+                    <button\n+                      onClick={() => onAddVoice(deck.id)}\n+                      disabled={creatingVoiceId === deck.id}\n+                      style={{\n+                        border: '1px dashed #4a90e2',\n+                        background: 'transparent',\n+                        color: '#4a90e2',\n+                        padding: '6px 10px',\n+                        borderRadius: 6,\n+                        cursor: creatingVoiceId === deck.id ? 'not-allowed' : 'pointer',\n+                        fontSize: 12\n+                      }}\n+                    >\n+                      {creatingVoiceId === deck.id ? 'Adding\u2026' : '+ Add'}\n+                    </button>\n+                  )}\n+                </div>\n+\n+                <div style={{ display: 'flex', flexDirection: 'column', gap: 6, overflowY: 'auto' }}>\n+                  {voices.length === 0 && (\n+                    <div style={{ color: '#999', fontSize: 13, fontStyle: 'italic' }}>\n+                      No voices in this deck yet\n+                    </div>\n+                  )}\n+                  {voices.map(voice => {\n+                    const VoiceIcon = iconMap[voice.icon as keyof typeof iconMap] || iconMap.brain;\n+                    const voiceColor = COLORS[voice.color as keyof typeof COLORS]?.hex || '#4a90e2';\n+                    const isSelected = selectedVoiceId === voice.id;\n+\n+                    return (\n+                      <div\n+                        key={voice.id}\n+                        onClick={() => onSelectVoice(voice.id)}\n+                        style={{\n+                          display: 'flex',\n+                          alignItems: 'center',\n+                          gap: 10,\n+                          padding: '10px 12px',\n+                          borderRadius: 8,\n+                          cursor: 'pointer',\n+                          border: isSelected ? `2px solid ${voiceColor}` : '2px solid transparent',\n+                          background: isSelected ? `${voiceColor}15` : '#fafafa',\n+                          transition: 'all 0.15s',\n+                          opacity: voice.enabled ? 1 : 0.55\n+                        }}\n+                      >\n+                        <div style={{\n+                          width: 32,\n+                          height: 32,\n+                          borderRadius: 16,\n+                          background: voiceColor,\n+                          display: 'flex',\n+                          alignItems: 'center',\n+                          justifyContent: 'center',\n+                          color: '#fff',\n+                          flexShrink: 0,\n+                          boxShadow: '0 2px 6px rgba(0,0,0,0.15)'\n+                        }}>\n+                          <VoiceIcon size={16} />\n+                        </div>\n+                        <div style={{\n+                          flex: 1,\n+                          minWidth: 0,\n+                          fontSize: 14,\n+                          fontWeight: isSelected ? 700 : 500,\n+                          color: '#2c2c2c',\n+                          overflow: 'hidden',\n+                          textOverflow: 'ellipsis',\n+                          whiteSpace: 'nowrap'\n+                        }}>\n+                          {voice.name}\n+                        </div>\n+                        <input\n+                          type=\"checkbox\"\n+                          checked={voice.enabled}\n+                          onClick={(e) => e.stopPropagation()}\n+                          onChange={() => onToggleVoice(voice.id, voice.enabled)}\n+                          disabled={isSystem}\n+                          style={{ cursor: 'pointer' }}\n+                        />\n+                      </div>\n+                    );\n+                  })}\n+                </div>\n+              </div>\n+            </div>\n+\n+            {/* Right column: selected voice editor */}\n+            <div style={{\n+              flex: 1,\n+              minWidth: 0,\n+              minHeight: 0,\n+              display: 'flex',\n+              flexDirection: 'column',\n+              gap: 12\n+            }}>\n+              {selectedVoice ? (() => {\n+                const voiceColor = COLORS[selectedVoice.color as keyof typeof COLORS]?.hex || '#4a90e2';\n+                const VoiceIcon = iconMap[selectedVoice.icon as keyof typeof iconMap] || iconMap.brain;\n+\n+                return (\n+                  <div\n+                    key={selectedVoice.id}\n+                    style={{\n+                      flex: 1,\n+                      minHeight: 0,\n+                      background: '#fff',\n+                      border: `2px solid ${voiceColor}`,\n+                      borderRadius: 12,\n+                      padding: 18,\n+                      boxShadow: `0 4px 10px ${voiceColor}25`,\n+                      display: 'flex',\n+                      flexDirection: 'column',\n+                      gap: 12\n+                    }}\n+                  >\n+                    <div style={{\n+                      display: 'flex',\n+                      alignItems: 'center',\n+                      gap: 12,\n+                      flexWrap: 'wrap'\n+                    }}>\n+                      <div style={{\n+                        width: 44,\n+                        height: 44,\n+                        borderRadius: 22,\n+                        background: voiceColor,\n+                        display: 'flex',\n+                        alignItems: 'center',\n+                        justifyContent: 'center',\n+                        color: '#fff',\n+                        boxShadow: `0 3px 8px ${voiceColor}40`\n+                      }}>\n+                        <VoiceIcon size={22} />\n+                      </div>\n+\n+                      <input\n+                        key={`${selectedVoice.id}-${selectedVoice.name}`}\n+                        type=\"text\"\n+                        defaultValue={selectedVoice.name}\n+                        disabled={isSystem}\n+                        onBlur={(e) => {\n+                          if (!isSystem && e.target.value !== selectedVoice.name) {\n+                            onUpdateVoice(selectedVoice.id, { name: e.target.value });\n+                          }\n+                        }}\n+                        style={{\n+                          flex: 1,\n+                          minWidth: 140,\n+                          border: 'none',\n+                          borderBottom: '2px solid #e0e0e0',\n+                          fontSize: 18,\n+                          fontWeight: 700,\n+                          padding: '6px 4px',\n+                          outline: 'none',\n+                          background: 'transparent'\n+                        }}\n+                      />\n+\n+                      <select\n+                        value={selectedVoice.icon}\n+                        disabled={isSystem}\n+                        onChange={(e) => onUpdateVoice(selectedVoice.id, { icon: e.target.value })}\n+                        style={{\n+                          padding: '8px 10px',\n+                          borderRadius: 6,\n+                          border: '1px solid #ddd',\n+                          background: '#fafafa',\n+                          fontSize: 12,\n+                          cursor: isSystem ? 'not-allowed' : 'pointer'\n+                        }}\n+                      >\n+                        {Object.keys(iconMap).map((iconName) => (\n+                          <option key={iconName} value={iconName}>{iconName}</option>\n+                        ))}\n+                      </select>\n+\n+                      <select\n+                        value={selectedVoice.color}\n+                        disabled={isSystem}\n+                        onChange={(e) => onUpdateVoice(selectedVoice.id, { color: e.target.value })}\n+                        style={{\n+                          padding: '8px 10px',\n+                          borderRadius: 6,\n+                          border: '1px solid #ddd',\n+                          background: '#fafafa',\n+                          fontSize: 12,\n+                          cursor: isSystem ? 'not-allowed' : 'pointer'\n+                        }}\n+                      >\n+                        {Object.entries(COLORS).map(([colorName, data]) => (\n+                          <option key={colorName} value={colorName}>{data.label}</option>\n+                        ))}\n+                      </select>\n+\n+                      <label style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 12, color: '#333' }}>\n+                        <input\n+                          type=\"checkbox\"\n+                          checked={selectedVoice.enabled}\n+                          disabled={isSystem}\n+                          onChange={() => onToggleVoice(selectedVoice.id, selectedVoice.enabled)}\n+                        />\n+                        Enabled\n+                      </label>\n+\n+                      {!isSystem && (\n+                        <button\n+                          onClick={() => onDeleteVoice(selectedVoice.id)}\n+                          style={{\n+                            padding: '8px 12px',\n+                            background: '#fff',\n+                            border: '1px solid #e0e0e0',\n+                            borderRadius: 6,\n+                            cursor: 'pointer',\n+                            fontSize: 12,\n+                            color: '#c00'\n+                          }}\n+                        >\n+                          Delete\n+                        </button>\n+                      )}\n+                    </div>\n+\n+                    <div style={{\n+                      fontSize: 11,\n+                      fontWeight: 600,\n+                      color: '#666',\n+                      letterSpacing: 0.5,\n+                      textTransform: 'uppercase'\n+                    }}>\n+                      Agent Prompt\n+                    </div>\n+                    <textarea\n+                      key={`${selectedVoice.id}-${selectedVoice.system_prompt}`}\n+                      defaultValue={selectedVoice.system_prompt}\n+                      disabled={isSystem}\n+                      onBlur={(e) => {\n+                        if (!isSystem && e.target.value !== selectedVoice.system_prompt) {\n+                          onUpdateVoice(selectedVoice.id, { system_prompt: e.target.value });\n+                        }\n+                      }}\n+                      style={{\n+                        flex: 1,\n+                        width: '100%',\n+                        minHeight: 0,\n+                        padding: 12,\n+                        fontSize: 13,\n+                        fontFamily: 'monospace',\n+                        border: '2px solid #e0e0e0',\n+                        borderRadius: 8,\n+                        background: isSystem ? '#f5f5f5' : '#fff',\n+                        resize: 'vertical',\n+                        boxSizing: 'border-box',\n+                        lineHeight: 1.6\n+                      }}\n+                    />\n+                  </div>\n+                );\n+              })() : (\n+                <div style={{\n+                  flex: 1,\n+                  background: '#fff',\n+                  border: '2px dashed #d0c4b0',\n+                  borderRadius: 12,\n+                  padding: 40,\n+                  color: '#888',\n+                  fontSize: 14,\n+                  textAlign: 'center'\n+                }}>\n+                  Select an agent from the list to edit\n+                </div>\n+              )}\n+            </div>\n+          </div>\n+        </div>\n+      </div>\n+    </div>\n+  );\n+}"
    },
    {
      "sha": "9dc93c05a3d9c39185d8dd6500979bbb27514709",
      "filename": "frontend/src/components/DeckManager.tsx",
      "status": "modified",
      "additions": 169,
      "deletions": 902,
      "changes": 1071,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/e52dce84a0e23360ace13562b31d1e67eea36f56/frontend%2Fsrc%2Fcomponents%2FDeckManager.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/e52dce84a0e23360ace13562b31d1e67eea36f56/frontend%2Fsrc%2Fcomponents%2FDeckManager.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FDeckManager.tsx?ref=e52dce84a0e23360ace13562b31d1e67eea36f56",
      "patch": "@@ -1,5 +1,4 @@\n import { useMemo, useState, useEffect, useRef } from 'react';\n-import { createPortal } from 'react-dom';\n import { useTranslation } from 'react-i18next';\n import {\n   listDecks,\n@@ -16,36 +15,8 @@ import {\n   type Deck,\n   type Voice\n } from '../api/voiceApi';\n-import {\n-  FaBrain, FaHeart, FaQuestion, FaCloud, FaTheaterMasks, FaEye,\n-  FaFistRaised, FaLightbulb, FaShieldAlt, FaWind, FaFire, FaCompass,\n-  FaChevronDown, FaChevronRight\n-} from 'react-icons/fa';\n-\n-// @@@ Display mappings (text name \u2192 visual)\n-const COLORS = {\n-  'blue': { hex: '#4a90e2', label: 'Blue' },\n-  'purple': { hex: '#9b59b6', label: 'Purple' },\n-  'pink': { hex: '#e91e63', label: 'Pink' },\n-  'green': { hex: '#27ae60', label: 'Green' },\n-  'yellow': { hex: '#f39c12', label: 'Yellow' }\n-};\n-\n-// @@@ Icon map with React Icons\n-const iconMap = {\n-  brain: FaBrain,\n-  heart: FaHeart,\n-  question: FaQuestion,\n-  cloud: FaCloud,\n-  masks: FaTheaterMasks,\n-  eye: FaEye,\n-  fist: FaFistRaised,\n-  lightbulb: FaLightbulb,\n-  shield: FaShieldAlt,\n-  wind: FaWind,\n-  fire: FaFire,\n-  compass: FaCompass,\n-};\n+import DeckEditorModal from './DeckEditorModal';\n+import { COLORS, iconMap } from './deckVisuals';\n \n interface Props {\n   onUpdate?: () => void;\n@@ -58,16 +29,14 @@ export default function DeckManager({ onUpdate }: Props) {\n   ), []);\n   const [decks, setDecks] = useState<Deck[]>([]);\n   const [communityDecks, setCommunityDecks] = useState<Deck[]>([]);\n-  const [expandedDecks, setExpandedDecks] = useState<Set<string>>(new Set());\n   const [loading, setLoading] = useState(true);\n   const [error, setError] = useState<string | null>(null);\n-  const [editingVoice, setEditingVoice] = useState<string | null>(null);\n-  const [editingField, setEditingField] = useState<'name' | 'prompt' | null>(null);\n-  const [iconPickerOpen, setIconPickerOpen] = useState<string | null>(null); // @@@ Track which voice's icon+color picker is open\n   const [deckIconPickerOpen, setDeckIconPickerOpen] = useState<string | null>(null); // @@@ Track which deck's icon+color picker is open\n   const [creatingDeck, setCreatingDeck] = useState(false);\n   const [creatingVoice, setCreatingVoice] = useState<string | null>(null);\n   const [publishWarning, setPublishWarning] = useState<string | null>(null);\n+  const [selectedVoiceByDeck, setSelectedVoiceByDeck] = useState<Record<string, string | null>>({});\n+  const [activeDeckId, setActiveDeckId] = useState<string | null>(null);\n \n   // @@@ Scroll position preservation\n   const scrollContainerRef = useRef<HTMLDivElement>(null);\n@@ -77,6 +46,33 @@ export default function DeckManager({ onUpdate }: Props) {\n     loadCommunityDecks();\n   }, []);\n \n+  useEffect(() => {\n+    setSelectedVoiceByDeck(prev => {\n+      let changed = false;\n+      const next = { ...prev };\n+\n+      decks.forEach((deck) => {\n+        const voiceIds = deck.voices?.map(v => v.id) || [];\n+        const currentSelection = next[deck.id];\n+\n+        if (voiceIds.length === 0) {\n+          if (currentSelection !== null) {\n+            next[deck.id] = null;\n+            changed = true;\n+          }\n+          return;\n+        }\n+\n+        if (!currentSelection || !voiceIds.includes(currentSelection)) {\n+          next[deck.id] = voiceIds[0];\n+          changed = true;\n+        }\n+      });\n+\n+      return changed ? next : prev;\n+    });\n+  }, [decks]);\n+\n   async function loadDecks(preserveScroll = false) {\n     // @@@ Save scroll position before reload\n     const savedScrollTop = preserveScroll && scrollContainerRef.current\n@@ -123,15 +119,7 @@ export default function DeckManager({ onUpdate }: Props) {\n   }\n \n   function toggleDeck(deckId: string) {\n-    setExpandedDecks(prev => {\n-      const next = new Set(prev);\n-      if (next.has(deckId)) {\n-        next.delete(deckId);\n-      } else {\n-        next.add(deckId);\n-      }\n-      return next;\n-    });\n+    setActiveDeckId(deckId);\n   }\n \n   async function handleForkDeck(deckId: string) {\n@@ -203,7 +191,6 @@ export default function DeckManager({ onUpdate }: Props) {\n     try {\n       await updateVoice(voiceId, data);\n       await loadDecks(true);\n-      setEditingVoice(null);\n       onUpdate?.();\n     } catch (err: any) {\n       alert(`Failed to update voice: ${err.message}`);\n@@ -241,7 +228,7 @@ export default function DeckManager({ onUpdate }: Props) {\n         color: 'blue'\n       });\n       await loadDecks(true);\n-      setExpandedDecks(prev => new Set([...prev, newDeck.deck_id]));\n+      setActiveDeckId(newDeck.deck_id);\n       onUpdate?.();\n     } catch (err: any) {\n       alert(`Failed to create deck: ${err.message}`);\n@@ -253,13 +240,14 @@ export default function DeckManager({ onUpdate }: Props) {\n   async function handleAddVoice(deckId: string) {\n     setCreatingVoice(deckId);\n     try {\n-      await createVoice({\n+      const { voice_id: newVoiceId } = await createVoice({\n         deck_id: deckId,\n         name: 'New Voice',\n         system_prompt: 'You are a helpful assistant.',\n         icon: 'brain',\n         color: 'blue'\n       });\n+      setSelectedVoiceByDeck(prev => ({ ...prev, [deckId]: newVoiceId }));\n       await loadDecks(true);\n       onUpdate?.();\n     } catch (err: any) {\n@@ -367,6 +355,8 @@ export default function DeckManager({ onUpdate }: Props) {\n     );\n   }\n \n+  const activeDeck = decks.find(d => d.id === activeDeckId) || null;\n+\n   return (\n     <div style={{ flex: 1, display: 'flex', flexDirection: 'column', background: '#f8f0e6', overflow: 'hidden' }}>\n       {/* Scrollable Content with embedded header */}\n@@ -442,278 +432,108 @@ export default function DeckManager({ onUpdate }: Props) {\n             {t('deck.sections.myDecks')}\n           </h3>\n \n-          {/* User's Decks */}\n-          {decks.map(deck => {\n-            const isExpanded = expandedDecks.has(deck.id);\n-            const isSystem = !!deck.is_system; // @@@ Convert to boolean to prevent React from rendering \"0\"\n-            const Icon = iconMap[deck.icon as keyof typeof iconMap] || FaBrain;\n-            const colorHex = COLORS[deck.color as keyof typeof COLORS]?.hex || '#4a90e2';\n-            const voiceCount = deck.voice_count || deck.voices?.length || 0;\n-            const voiceCountLabel = t('deck.labels.voiceCount', { count: voiceCount });\n-\n-            return (\n-              <div\n-                key={deck.id}\n-                style={{\n-                  background: '#fff',\n-                  border: `2px solid ${isSystem ? '#d0c4b0' : colorHex}`,\n-                  borderRadius: 12,\n-                  overflow: 'hidden',\n-                  boxShadow: '0 4px 12px rgba(0,0,0,0.1)',\n-                  transition: 'all 0.3s'\n-                }}\n-              >\n-                {/* Deck Header */}\n+          <div style={{\n+            display: 'grid',\n+            gridTemplateColumns: 'repeat(auto-fit, minmax(360px, 1fr))',\n+            gap: 14\n+          }}>\n+            {decks.map(deck => {\n+              const isSystem = !!deck.is_system;\n+              const Icon = iconMap[deck.icon as keyof typeof iconMap] || iconMap.brain;\n+              const colorHex = COLORS[deck.color as keyof typeof COLORS]?.hex || '#4a90e2';\n+              const voiceCount = deck.voice_count || deck.voices?.length || 0;\n+              const voiceCountLabel = t('deck.labels.voiceCount', { count: voiceCount });\n+\n+              return (\n                 <div\n+                  key={deck.id}\n                   onClick={() => toggleDeck(deck.id)}\n                   style={{\n-                    padding: 20,\n-                    background: isSystem ? '#f9f9f9' : '#fafafa',\n+                    background: '#fff',\n+                    border: `2px solid ${isSystem ? '#d0c4b0' : colorHex}`,\n+                    borderRadius: 10,\n+                    boxShadow: '0 3px 10px rgba(0,0,0,0.08)',\n+                    padding: 12,\n                     display: 'flex',\n-                    alignItems: 'center',\n-                    gap: 16,\n-                    transition: 'background 0.2s',\n-                    cursor: 'pointer'\n+                    flexDirection: 'column',\n+                    gap: 10,\n+                    cursor: 'pointer',\n+                    transition: 'transform 0.15s, box-shadow 0.15s'\n+                  }}\n+                  onMouseEnter={(e) => {\n+                    e.currentTarget.style.transform = 'translateY(-1px)';\n+                    e.currentTarget.style.boxShadow = '0 6px 14px rgba(0,0,0,0.12)';\n+                  }}\n+                  onMouseLeave={(e) => {\n+                    e.currentTarget.style.transform = 'translateY(0)';\n+                    e.currentTarget.style.boxShadow = '0 3px 10px rgba(0,0,0,0.08)';\n                   }}\n                 >\n-                  {/* Expand/Collapse Icon */}\n-                  <div\n-                    onClick={() => toggleDeck(deck.id)}\n-                    style={{ fontSize: 20, color: '#666', cursor: 'pointer' }}\n-                  >\n-                    {isExpanded ? <FaChevronDown /> : <FaChevronRight />}\n-                  </div>\n-\n-                  {/* Deck Icon with picker */}\n-                  <div\n-                    style={{ position: 'relative' }}\n-                    onClick={(e) => e.stopPropagation()}\n-                  >\n+                  <div style={{ display: 'flex', gap: 10, alignItems: 'center' }}>\n                     <div\n-                      data-deck-icon={deck.id}\n-                      onClick={(e) => {\n-                        e.stopPropagation();\n-                        if (!isSystem) {\n-                          setDeckIconPickerOpen(deckIconPickerOpen === deck.id ? null : deck.id);\n-                        }\n-                      }}\n-                      style={{\n-                        width: 56,\n-                        height: 56,\n-                        borderRadius: 28,\n-                        background: `linear-gradient(135deg, ${colorHex} 0%, ${colorHex}cc 100%)`,\n-                        display: 'flex',\n-                        alignItems: 'center',\n-                        justifyContent: 'center',\n-                        color: '#fff',\n-                        flexShrink: 0,\n-                        boxShadow: `0 3px 8px ${colorHex}40`,\n-                        cursor: isSystem ? 'default' : 'pointer',\n-                        transition: 'transform 0.2s, box-shadow 0.2s'\n-                      }}\n-                      onMouseEnter={(e) => {\n-                        if (!isSystem) {\n-                          e.currentTarget.style.transform = 'scale(1.1)';\n-                          e.currentTarget.style.boxShadow = `0 6px 16px ${colorHex}60`;\n-                        }\n-                      }}\n-                      onMouseLeave={(e) => {\n-                        if (!isSystem) {\n-                          e.currentTarget.style.transform = 'scale(1)';\n-                          e.currentTarget.style.boxShadow = `0 3px 8px ${colorHex}40`;\n-                        }\n-                      }}\n-                      title={isSystem ? '' : 'Click to change icon'}\n+                      style={{ position: 'relative' }}\n+                      onClick={(e) => e.stopPropagation()}\n                     >\n-                      <Icon size={28} />\n-                    </div>\n-\n-                    {/* Icon Picker Dropdown for Deck - Rendered at top level using portal */}\n-                    {deckIconPickerOpen === deck.id && (() => {\n-                      const iconBadge = document.querySelector(`[data-deck-icon=\"${deck.id}\"]`) as HTMLElement;\n-                      if (!iconBadge) return null;\n-                      const rect = iconBadge.getBoundingClientRect();\n-\n-                      return createPortal(\n-                        <>\n-                          {/* Transparent overlay to capture clicks outside */}\n-                          <div\n-                            onClick={() => setDeckIconPickerOpen(null)}\n-                            style={{\n-                              position: 'fixed',\n-                              top: 0,\n-                              left: 0,\n-                              right: 0,\n-                              bottom: 0,\n-                              zIndex: 9999\n-                            }}\n-                          />\n-                          {/* Icon & Color picker dropdown */}\n-                          <div\n-                            style={{\n-                              position: 'fixed',\n-                              top: rect.bottom + 4,\n-                              left: rect.left,\n-                              background: '#fff',\n-                              border: '2px solid #4a90e2',\n-                              borderRadius: 8,\n-                              padding: 8,\n-                              boxShadow: '0 4px 16px rgba(0,0,0,0.2)',\n-                              zIndex: 10000,\n-                              minWidth: 180\n-                            }}\n-                          >\n-                            {/* Icons Grid */}\n-                            <div style={{\n-                              display: 'grid',\n-                              gridTemplateColumns: 'repeat(4, 1fr)',\n-                              gap: 4,\n-                              marginBottom: 8\n-                            }}>\n-                              {Object.entries(iconMap).map(([iconName, IconComponent]) => {\n-                                const isSelected = deck.icon === iconName;\n-                                return (\n-                                  <div\n-                                    key={iconName}\n-                                    onClick={(e) => {\n-                                      e.stopPropagation();\n-                                      handleUpdateDeck(deck.id, { icon: iconName });\n-                                    }}\n-                                    style={{\n-                                      width: 40,\n-                                      height: 40,\n-                                      borderRadius: 8,\n-                                      background: isSelected ? colorHex : '#f0f0f0',\n-                                      display: 'flex',\n-                                      alignItems: 'center',\n-                                      justifyContent: 'center',\n-                                      color: isSelected ? '#fff' : '#666',\n-                                      cursor: 'pointer',\n-                                      transition: 'all 0.2s'\n-                                    }}\n-                                    onMouseEnter={(e) => {\n-                                      if (!isSelected) {\n-                                        e.currentTarget.style.background = '#e0e0e0';\n-                                        e.currentTarget.style.transform = 'scale(1.1)';\n-                                      }\n-                                    }}\n-                                    onMouseLeave={(e) => {\n-                                      if (!isSelected) {\n-                                        e.currentTarget.style.background = '#f0f0f0';\n-                                        e.currentTarget.style.transform = 'scale(1)';\n-                                      }\n-                                    }}\n-                                    title={iconName}\n-                                  >\n-                                    <IconComponent size={20} />\n-                                  </div>\n-                                );\n-                              })}\n-                            </div>\n-\n-                            {/* Divider */}\n-                            <div style={{\n-                              height: 1,\n-                              background: '#e0e0e0',\n-                              marginBottom: 8\n-                            }} />\n-\n-                            {/* Colors Row */}\n-                            <div style={{\n-                              display: 'flex',\n-                              gap: 6,\n-                              justifyContent: 'center'\n-                            }}>\n-                              {Object.entries(COLORS).map(([colorName, colorData]) => {\n-                                const isSelected = deck.color === colorName;\n-                                return (\n-                                  <div\n-                                    key={colorName}\n-                                    onClick={(e) => {\n-                                      e.stopPropagation();\n-                                      handleUpdateDeck(deck.id, { color: colorName });\n-                                    }}\n-                                    style={{\n-                                      width: 28,\n-                                      height: 28,\n-                                      borderRadius: 14,\n-                                      background: colorData.hex,\n-                                      cursor: 'pointer',\n-                                      border: isSelected ? '3px solid #2c2c2c' : '2px solid #ddd',\n-                                      transition: 'all 0.2s',\n-                                      boxSizing: 'border-box'\n-                                    }}\n-                                    onMouseEnter={(e) => {\n-                                      if (!isSelected) {\n-                                        e.currentTarget.style.transform = 'scale(1.15)';\n-                                      }\n-                                    }}\n-                                    onMouseLeave={(e) => {\n-                                      if (!isSelected) {\n-                                        e.currentTarget.style.transform = 'scale(1)';\n-                                      }\n-                                    }}\n-                                    title={colorData.label}\n-                                  />\n-                                );\n-                              })}\n-                            </div>\n-                          </div>\n-                        </>,\n-                        document.body\n-                      );\n-                    })()}\n-                  </div>\n-\n-                  {/* Deck Info - Display Only */}\n-                  <div style={{ flex: 1, minWidth: 0 }}>\n-                    <div style={{\n-                      fontSize: 20,\n-                      fontWeight: 700,\n-                      color: '#2c2c2c',\n-                      marginBottom: 4\n-                    }}>\n-                      {deck.name}\n-                      {isSystem && (\n-                        <span style={{\n-                          marginLeft: 12,\n-                          fontSize: 12,\n-                          fontWeight: 500,\n-                          color: '#888',\n-                          background: '#e0e0e0',\n-                          padding: '2px 8px',\n-                          borderRadius: 4\n-                        }}>\n-                          {t('deck.labels.system')}\n-                        </span>\n-                      )}\n-                    </div>\n-\n-                    <div style={{\n-                      fontSize: 14,\n-                      color: '#666'\n-                    }}>\n-                      {deck.description || t('deck.labels.noDescription')}\n+                      <div\n+                        data-deck-icon={deck.id}\n+                        onClick={(e) => {\n+                          e.stopPropagation();\n+                          if (!isSystem) {\n+                            setDeckIconPickerOpen(deckIconPickerOpen === deck.id ? null : deck.id);\n+                          }\n+                        }}\n+                        style={{\n+                          width: 46,\n+                          height: 46,\n+                          borderRadius: 23,\n+                          background: `linear-gradient(135deg, ${colorHex} 0%, ${colorHex}cc 100%)`,\n+                          display: 'flex',\n+                          alignItems: 'center',\n+                          justifyContent: 'center',\n+                          color: '#fff',\n+                          flexShrink: 0,\n+                          boxShadow: `0 3px 8px ${colorHex}40`,\n+                          cursor: isSystem ? 'default' : 'pointer',\n+                          transition: 'transform 0.2s, box-shadow 0.2s'\n+                        }}\n+                      >\n+                        <Icon size={22} />\n+                      </div>\n                     </div>\n \n-                    <div style={{\n-                      fontSize: 12,\n-                      color: '#999',\n-                      marginTop: 4\n-                    }}>\n-                      {voiceCountLabel}\n+                    <div style={{ flex: 1, minWidth: 0, display: 'flex', flexDirection: 'column', gap: 2 }}>\n+                      <div style={{ display: 'flex', alignItems: 'center', gap: 6, flexWrap: 'wrap' }}>\n+                        <div style={{ fontSize: 17, fontWeight: 700, color: '#2c2c2c', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>\n+                          {deck.name}\n+                        </div>\n+                        {isSystem && (\n+                          <span style={{\n+                            fontSize: 10,\n+                            fontWeight: 700,\n+                            color: '#777',\n+                            background: '#ededed',\n+                            padding: '2px 6px',\n+                            borderRadius: 6\n+                          }}>\n+                            System\n+                          </span>\n+                        )}\n+                      </div>\n+                      <div style={{ fontSize: 12, color: '#555', lineHeight: 1.4, maxHeight: 36, overflow: 'hidden', textOverflow: 'ellipsis' }}>\n+                        {deck.description || t('deck.labels.noDescription')}\n+                      </div>\n+                      <div style={{ fontSize: 11, color: '#888' }}>{voiceCountLabel}</div>\n                     </div>\n-                  </div>\n \n-                  {/* Actions */}\n-                  <div style={{ display: 'flex', alignItems: 'center', gap: 12 }} onClick={(e) => e.stopPropagation()}>\n-                    {/* @@@ Deck-level toggle switch */}\n                     <div\n-                      onClick={() => handleToggleDeck(deck.id, deck.enabled)}\n+                      onClick={(e) => {\n+                        e.stopPropagation();\n+                        handleToggleDeck(deck.id, deck.enabled);\n+                      }}\n                       style={{\n-                        width: 50,\n-                        height: 26,\n-                        borderRadius: 13,\n+                        width: 42,\n+                        height: 20,\n+                        borderRadius: 10,\n                         background: deck.enabled ? colorHex : '#ccc',\n                         position: 'relative',\n                         cursor: 'pointer',\n@@ -724,661 +544,91 @@ export default function DeckManager({ onUpdate }: Props) {\n                     >\n                       <div style={{\n                         position: 'absolute',\n-                        top: 3,\n-                        left: deck.enabled ? 26 : 3,\n-                        width: 20,\n-                        height: 20,\n-                        borderRadius: 10,\n+                        top: 2,\n+                        left: deck.enabled ? 22 : 2,\n+                        width: 16,\n+                        height: 16,\n+                        borderRadius: 8,\n                         background: '#fff',\n                         transition: 'left 0.3s',\n                         boxShadow: '0 2px 4px rgba(0,0,0,0.2)'\n                       }} />\n                     </div>\n+                  </div>\n \n+                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }} onClick={(e) => e.stopPropagation()}>\n                     {isSystem ? (\n                       <button\n                         onClick={() => handleForkDeck(deck.id)}\n                         style={{\n-                          padding: '8px 16px',\n+                          padding: '6px 10px',\n                           background: colorHex,\n                           color: '#fff',\n                           border: 'none',\n                           borderRadius: 6,\n                           cursor: 'pointer',\n-                          fontSize: 13,\n-                          fontWeight: 600,\n-                          transition: 'all 0.2s'\n-                        }}\n-                        onMouseEnter={(e) => {\n-                          e.currentTarget.style.transform = 'translateY(-1px)';\n-                          e.currentTarget.style.boxShadow = `0 4px 12px ${colorHex}60`;\n-                        }}\n-                        onMouseLeave={(e) => {\n-                          e.currentTarget.style.transform = 'translateY(0)';\n-                          e.currentTarget.style.boxShadow = 'none';\n+                          fontSize: 12,\n+                          fontWeight: 600\n                         }}\n                       >\n-                        Fork to My Collection\n+                        Fork\n                       </button>\n                     ) : (\n                       <>\n-                        {/* @@@ Show sync button if deck has a parent */}\n                         {deck.parent_id && (\n                           <button\n                             onClick={() => handleSyncDeck(deck.id)}\n                             style={{\n-                              padding: '8px 16px',\n+                              padding: '6px 10px',\n                               background: '#81b7d2',\n                               color: '#fff',\n                               border: 'none',\n                               borderRadius: 6,\n                               cursor: 'pointer',\n-                              fontSize: 13,\n-                              fontWeight: 600,\n-                              transition: 'all 0.2s'\n-                            }}\n-                            onMouseEnter={(e) => {\n-                              e.currentTarget.style.transform = 'translateY(-1px)';\n-                              e.currentTarget.style.boxShadow = '0 4px 12px rgba(129, 183, 210, 0.4)';\n-                            }}\n-                            onMouseLeave={(e) => {\n-                              e.currentTarget.style.transform = 'translateY(0)';\n-                              e.currentTarget.style.boxShadow = 'none';\n+                              fontSize: 12,\n+                              fontWeight: 600\n                             }}\n                           >\n-                            {t('deck.actions.sync')}\n+                            Sync\n                           </button>\n                         )}\n-                        {/* @@@ Publish button for user-owned decks */}\n                         <button\n                           onClick={() => handlePublishClick(deck)}\n                           style={{\n-                            padding: '8px 16px',\n+                            padding: '6px 10px',\n                             background: deck.published ? '#f39c7a' : '#b47ed7',\n                             color: '#fff',\n                             border: 'none',\n                             borderRadius: 6,\n                             cursor: 'pointer',\n-                            fontSize: 13,\n-                            fontWeight: 600,\n-                            transition: 'all 0.2s'\n-                          }}\n-                          onMouseEnter={(e) => {\n-                            e.currentTarget.style.transform = 'translateY(-1px)';\n-                            const color = deck.published ? 'rgba(243, 156, 122, 0.4)' : 'rgba(180, 126, 215, 0.4)';\n-                            e.currentTarget.style.boxShadow = `0 4px 12px ${color}`;\n-                          }}\n-                          onMouseLeave={(e) => {\n-                            e.currentTarget.style.transform = 'translateY(0)';\n-                            e.currentTarget.style.boxShadow = 'none';\n+                            fontSize: 12,\n+                            fontWeight: 600\n                           }}\n                         >\n-                          {deck.published ? t('deck.actions.unpublish') : t('deck.actions.publish')}\n+                          {deck.published ? 'Unpub' : 'Pub'}\n                         </button>\n                         <button\n                           onClick={() => handleDeleteDeck(deck.id)}\n                           style={{\n-                            padding: '8px 16px',\n+                            padding: '6px 10px',\n                             background: '#e8956c',\n                             color: '#fff',\n                             border: 'none',\n                             borderRadius: 6,\n                             cursor: 'pointer',\n-                            fontSize: 13,\n-                            fontWeight: 600,\n-                            transition: 'all 0.2s'\n-                          }}\n-                          onMouseEnter={(e) => {\n-                            e.currentTarget.style.transform = 'translateY(-1px)';\n-                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(232, 149, 108, 0.4)';\n-                          }}\n-                          onMouseLeave={(e) => {\n-                            e.currentTarget.style.transform = 'translateY(0)';\n-                            e.currentTarget.style.boxShadow = 'none';\n+                            fontSize: 12,\n+                            fontWeight: 600\n                           }}\n                         >\n-                          {t('deck.actions.delete')}\n+                          Delete\n                         </button>\n                       </>\n                     )}\n                   </div>\n                 </div>\n-\n-                {/* Voices List (Expanded) */}\n-                {isExpanded && (\n-                  <div style={{ padding: 20, background: '#fafafa' }}>\n-                    {/* @@@ Deck Edit Form (only for user-owned decks) */}\n-                    {!isSystem && (\n-                      <div style={{\n-                        background: '#fff',\n-                        border: '2px solid #e0e0e0',\n-                        borderRadius: 8,\n-                        padding: 16,\n-                        marginBottom: 16\n-                      }}>\n-                        <h4 style={{\n-                          margin: '0 0 12px 0',\n-                          fontSize: 14,\n-                          fontWeight: 600,\n-                          color: '#666'\n-                        }}>\n-                          Deck Settings\n-                        </h4>\n-\n-                        {/* Deck Name Field */}\n-                        <div style={{ marginBottom: 12 }}>\n-                          <label style={{\n-                            display: 'block',\n-                            fontSize: 12,\n-                            fontWeight: 500,\n-                            color: '#888',\n-                            marginBottom: 4\n-                          }}>\n-                            Name\n-                          </label>\n-                          <input\n-                            type=\"text\"\n-                            defaultValue={deck.name}\n-                            onBlur={(e) => {\n-                              if (e.target.value !== deck.name) {\n-                                handleUpdateDeck(deck.id, { name: e.target.value });\n-                              }\n-                            }}\n-                            onClick={(e) => e.stopPropagation()}\n-                            style={{\n-                              width: '100%',\n-                              padding: '8px 12px',\n-                              fontSize: 14,\n-                              border: '1px solid #ddd',\n-                              borderRadius: 6,\n-                              fontFamily: 'inherit',\n-                              boxSizing: 'border-box'\n-                            }}\n-                          />\n-                        </div>\n-\n-                        {/* Deck Description Field */}\n-                        <div>\n-                          <label style={{\n-                            display: 'block',\n-                            fontSize: 12,\n-                            fontWeight: 500,\n-                            color: '#888',\n-                            marginBottom: 4\n-                          }}>\n-                            Description\n-                          </label>\n-                          <textarea\n-                            defaultValue={deck.description || ''}\n-                            onBlur={(e) => {\n-                              if (e.target.value !== deck.description) {\n-                                handleUpdateDeck(deck.id, { description: e.target.value });\n-                              }\n-                            }}\n-                            onClick={(e) => e.stopPropagation()}\n-                            style={{\n-                              width: '100%',\n-                              minHeight: 80,\n-                              padding: '8px 12px',\n-                              fontSize: 14,\n-                              border: '1px solid #ddd',\n-                              borderRadius: 6,\n-                              fontFamily: 'inherit',\n-                              resize: 'vertical',\n-                              boxSizing: 'border-box'\n-                            }}\n-                          />\n-                        </div>\n-                      </div>\n-                    )}\n-\n-                    {deck.voices && deck.voices.length > 0 && (\n-                      <div style={{\n-                        display: 'grid',\n-                        gridTemplateColumns: 'repeat(auto-fill, minmax(340px, 1fr))',\n-                        gap: 16\n-                      }}>\n-                        {deck.voices.map(voice => {\n-                        const VoiceIcon = iconMap[voice.icon as keyof typeof iconMap] || FaBrain;\n-                        const voiceColor = COLORS[voice.color as keyof typeof COLORS]?.hex || '#4a90e2';\n-                        const isEditing = editingVoice === voice.id;\n-\n-                        return (\n-                          <div\n-                            key={voice.id}\n-                            style={{\n-                              background: '#fff',\n-                              border: `2px solid ${voice.enabled ? voiceColor : '#ddd'}`,\n-                              borderRadius: 8,\n-                              padding: 16,\n-                              position: 'relative',\n-                              boxShadow: '0 2px 6px rgba(0,0,0,0.08)',\n-                              transition: 'all 0.2s',\n-                              opacity: voice.enabled ? 1 : 0.6\n-                            }}\n-                          >\n-                            {/* Voice Header */}\n-                            <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>\n-                              {/* @@@ Icon badge with picker */}\n-                              <div style={{ position: 'relative' }}>\n-                                <div\n-                                  data-voice-icon={voice.id}\n-                                  onClick={() => {\n-                                    if (!isSystem) {\n-                                      setIconPickerOpen(iconPickerOpen === voice.id ? null : voice.id);\n-                                    }\n-                                  }}\n-                                  style={{\n-                                    width: 40,\n-                                    height: 40,\n-                                    borderRadius: 20,\n-                                    background: `linear-gradient(135deg, ${voiceColor} 0%, ${voiceColor}cc 100%)`,\n-                                    display: 'flex',\n-                                    alignItems: 'center',\n-                                    justifyContent: 'center',\n-                                    color: '#fff',\n-                                    flexShrink: 0,\n-                                    cursor: isSystem ? 'default' : 'pointer',\n-                                    transition: 'transform 0.2s, box-shadow 0.2s'\n-                                  }}\n-                                  onMouseEnter={(e) => {\n-                                    if (!isSystem) {\n-                                      e.currentTarget.style.transform = 'scale(1.1)';\n-                                      e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';\n-                                    }\n-                                  }}\n-                                  onMouseLeave={(e) => {\n-                                    if (!isSystem) {\n-                                      e.currentTarget.style.transform = 'scale(1)';\n-                                      e.currentTarget.style.boxShadow = 'none';\n-                                    }\n-                                  }}\n-                                  title={isSystem ? '' : 'Click to change icon'}\n-                                >\n-                                  <VoiceIcon size={20} />\n-                                </div>\n-\n-                                {/* Icon & Color Picker Dropdown - Rendered at top level using portal */}\n-                                {iconPickerOpen === voice.id && (() => {\n-                                  const iconBadge = document.querySelector(`[data-voice-icon=\"${voice.id}\"]`) as HTMLElement;\n-                                  if (!iconBadge) return null;\n-                                  const rect = iconBadge.getBoundingClientRect();\n-\n-                                  return createPortal(\n-                                    <>\n-                                      {/* Transparent overlay to capture clicks outside */}\n-                                      <div\n-                                        onClick={() => setIconPickerOpen(null)}\n-                                        style={{\n-                                          position: 'fixed',\n-                                          top: 0,\n-                                          left: 0,\n-                                          right: 0,\n-                                          bottom: 0,\n-                                          zIndex: 9999\n-                                        }}\n-                                      />\n-                                      {/* Icon & Color picker dropdown */}\n-                                      <div\n-                                        style={{\n-                                          position: 'fixed',\n-                                          top: rect.bottom + 4,\n-                                          left: rect.left,\n-                                          background: '#fff',\n-                                          border: '2px solid #4a90e2',\n-                                          borderRadius: 8,\n-                                          padding: 8,\n-                                          boxShadow: '0 4px 16px rgba(0,0,0,0.2)',\n-                                          zIndex: 10000,\n-                                          minWidth: 180\n-                                        }}\n-                                      >\n-                                        {/* Icons Grid */}\n-                                        <div style={{\n-                                          display: 'grid',\n-                                          gridTemplateColumns: 'repeat(4, 1fr)',\n-                                          gap: 4,\n-                                          marginBottom: 8\n-                                        }}>\n-                                          {Object.entries(iconMap).map(([iconName, IconComponent]) => {\n-                                            const isSelected = voice.icon === iconName;\n-                                            return (\n-                                              <div\n-                                                key={iconName}\n-                                                onClick={(e) => {\n-                                                  e.stopPropagation();\n-                                                  handleUpdateVoice(voice.id, { icon: iconName });\n-                                                }}\n-                                                style={{\n-                                                  width: 40,\n-                                                  height: 40,\n-                                                  borderRadius: 8,\n-                                                  background: isSelected ? voiceColor : '#f0f0f0',\n-                                                  display: 'flex',\n-                                                  alignItems: 'center',\n-                                                  justifyContent: 'center',\n-                                                  color: isSelected ? '#fff' : '#666',\n-                                                  cursor: 'pointer',\n-                                                  transition: 'all 0.2s'\n-                                                }}\n-                                                onMouseEnter={(e) => {\n-                                                  if (!isSelected) {\n-                                                    e.currentTarget.style.background = '#e0e0e0';\n-                                                    e.currentTarget.style.transform = 'scale(1.1)';\n-                                                  }\n-                                                }}\n-                                                onMouseLeave={(e) => {\n-                                                  if (!isSelected) {\n-                                                    e.currentTarget.style.background = '#f0f0f0';\n-                                                    e.currentTarget.style.transform = 'scale(1)';\n-                                                  }\n-                                                }}\n-                                                title={iconName}\n-                                              >\n-                                                <IconComponent size={20} />\n-                                              </div>\n-                                            );\n-                                          })}\n-                                        </div>\n-\n-                                        {/* Divider */}\n-                                        <div style={{\n-                                          height: 1,\n-                                          background: '#e0e0e0',\n-                                          marginBottom: 8\n-                                        }} />\n-\n-                                        {/* Colors Row */}\n-                                        <div style={{\n-                                          display: 'flex',\n-                                          gap: 6,\n-                                          justifyContent: 'center'\n-                                        }}>\n-                                          {Object.entries(COLORS).map(([colorName, colorData]) => {\n-                                            const isSelected = voice.color === colorName;\n-                                            return (\n-                                              <div\n-                                                key={colorName}\n-                                                onClick={(e) => {\n-                                                  e.stopPropagation();\n-                                                  handleUpdateVoice(voice.id, { color: colorName });\n-                                                }}\n-                                                style={{\n-                                                  width: 28,\n-                                                  height: 28,\n-                                                  borderRadius: 14,\n-                                                  background: colorData.hex,\n-                                                  cursor: 'pointer',\n-                                                  border: isSelected ? '3px solid #2c2c2c' : '2px solid #ddd',\n-                                                  transition: 'all 0.2s',\n-                                                  boxSizing: 'border-box'\n-                                                }}\n-                                                onMouseEnter={(e) => {\n-                                                  if (!isSelected) {\n-                                                    e.currentTarget.style.transform = 'scale(1.15)';\n-                                                  }\n-                                                }}\n-                                                onMouseLeave={(e) => {\n-                                                  if (!isSelected) {\n-                                                    e.currentTarget.style.transform = 'scale(1)';\n-                                                  }\n-                                                }}\n-                                                title={colorData.label}\n-                                              />\n-                                            );\n-                                          })}\n-                                        </div>\n-                                      </div>\n-                                    </>,\n-                                    document.body\n-                                  );\n-                                })()}\n-                              </div>\n-\n-                              <div style={{ flex: 1, minWidth: 0 }}>\n-                                {/* @@@ Inline editing for voice name */}\n-                                {!isEditing || editingField !== 'name' ? (\n-                                  <div\n-                                    onClick={() => {\n-                                      if (!isSystem) {\n-                                        setEditingVoice(voice.id);\n-                                        setEditingField('name');\n-                                      }\n-                                    }}\n-                                    style={{\n-                                      fontSize: 16,\n-                                      fontWeight: 600,\n-                                      color: '#2c2c2c',\n-                                      overflow: 'hidden',\n-                                      textOverflow: 'ellipsis',\n-                                      whiteSpace: 'nowrap',\n-                                      cursor: isSystem ? 'default' : 'pointer',\n-                                      transition: 'opacity 0.2s'\n-                                    }}\n-                                    onMouseEnter={(e) => {\n-                                      if (!isSystem) e.currentTarget.style.opacity = '0.7';\n-                                    }}\n-                                    onMouseLeave={(e) => {\n-                                      if (!isSystem) e.currentTarget.style.opacity = '1';\n-                                    }}\n-                                  >\n-                                    {voice.name}\n-                                  </div>\n-                                ) : (\n-                                  <input\n-                                    autoFocus\n-                                    defaultValue={voice.name}\n-                                    onBlur={(e) => {\n-                                      handleUpdateVoice(voice.id, { name: e.target.value });\n-                                      setEditingVoice(null);\n-                                      setEditingField(null);\n-                                    }}\n-                                    onKeyDown={(e) => {\n-                                      if (e.key === 'Enter') {\n-                                        e.currentTarget.blur();\n-                                      } else if (e.key === 'Escape') {\n-                                        setEditingVoice(null);\n-                                        setEditingField(null);\n-                                      }\n-                                    }}\n-                                    style={{\n-                                      width: '100%',\n-                                      fontSize: 16,\n-                                      fontWeight: 600,\n-                                      color: '#2c2c2c',\n-                                      padding: '4px 8px',\n-                                      border: '2px solid #4a90e2',\n-                                      borderRadius: 4,\n-                                      background: '#f0f8ff'\n-                                    }}\n-                                  />\n-                                )}\n-                              </div>\n-\n-                              {/* @@@ Voice-level toggle switch */}\n-                              <div\n-                                onClick={() => handleToggleVoice(voice.id, voice.enabled)}\n-                                style={{\n-                                  width: 40,\n-                                  height: 22,\n-                                  borderRadius: 11,\n-                                  background: voice.enabled ? voiceColor : '#ccc',\n-                                  position: 'relative',\n-                                  cursor: 'pointer',\n-                                  transition: 'background 0.3s',\n-                                  flexShrink: 0\n-                                }}\n-                                title={voice.enabled ? 'Disable voice' : 'Enable voice'}\n-                              >\n-                                <div style={{\n-                                  position: 'absolute',\n-                                  top: 3,\n-                                  left: voice.enabled ? 21 : 3,\n-                                  width: 16,\n-                                  height: 16,\n-                                  borderRadius: 8,\n-                                  background: '#fff',\n-                                  transition: 'left 0.3s',\n-                                  boxShadow: '0 2px 4px rgba(0,0,0,0.2)'\n-                                }} />\n-                              </div>\n-\n-                              {!isSystem && (\n-                                <button\n-                                  onClick={() => handleDeleteVoice(voice.id)}\n-                                  style={{\n-                                    background: 'rgba(255, 255, 255, 0.9)',\n-                                    border: '1px solid #ddd',\n-                                    borderRadius: 4,\n-                                    width: 24,\n-                                    height: 24,\n-                                    display: 'flex',\n-                                    alignItems: 'center',\n-                                    justifyContent: 'center',\n-                                    cursor: 'pointer',\n-                                    fontSize: 12,\n-                                    transition: 'all 0.2s'\n-                                  }}\n-                                  onMouseEnter={(e) => {\n-                                    e.currentTarget.style.background = '#fee';\n-                                    e.currentTarget.style.borderColor = '#fcc';\n-                                  }}\n-                                  onMouseLeave={(e) => {\n-                                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.9)';\n-                                    e.currentTarget.style.borderColor = '#ddd';\n-                                  }}\n-                                  title=\"Delete\"\n-                                >\n-                                  \u00d7\n-                                </button>\n-                              )}\n-                            </div>\n-\n-                            {/* Voice Prompt with inline editing */}\n-                            {!isEditing || editingField !== 'prompt' ? (\n-                              <div\n-                                onClick={() => {\n-                                  if (!isSystem) {\n-                                    setEditingVoice(voice.id);\n-                                    setEditingField('prompt');\n-                                  }\n-                                }}\n-                                style={{\n-                                  fontSize: 12,\n-                                  color: '#666',\n-                                  lineHeight: 1.6,\n-                                  overflow: 'hidden',\n-                                  textOverflow: 'ellipsis',\n-                                  display: '-webkit-box',\n-                                  WebkitLineClamp: 3,\n-                                  WebkitBoxOrient: 'vertical',\n-                                  cursor: isSystem ? 'default' : 'pointer',\n-                                  transition: 'opacity 0.2s'\n-                                }}\n-                                onMouseEnter={(e) => {\n-                                  if (!isSystem) e.currentTarget.style.opacity = '0.7';\n-                                }}\n-                                onMouseLeave={(e) => {\n-                                  if (!isSystem) e.currentTarget.style.opacity = '1';\n-                                }}\n-                              >\n-                                {voice.system_prompt}\n-                              </div>\n-                            ) : (\n-                              <>\n-                                <textarea\n-                                  autoFocus\n-                                  defaultValue={voice.system_prompt}\n-                                  onBlur={(e) => {\n-                                    handleUpdateVoice(voice.id, { system_prompt: e.target.value });\n-                                    setEditingVoice(null);\n-                                    setEditingField(null);\n-                                  }}\n-                                  onKeyDown={(e) => {\n-                                    if (e.key === 'Escape') {\n-                                      setEditingVoice(null);\n-                                      setEditingField(null);\n-                                    }\n-                                  }}\n-                                  style={{\n-                                    width: '100%',\n-                                    minHeight: '100px',\n-                                    fontSize: 12,\n-                                    color: '#2c2c2c',\n-                                    padding: '8px',\n-                                    border: '2px solid #4a90e2',\n-                                    borderRadius: 4,\n-                                    background: '#f0f8ff',\n-                                    fontFamily: 'inherit',\n-                                    lineHeight: 1.6,\n-                                    resize: 'vertical',\n-                                    boxSizing: 'border-box'\n-                                  }}\n-                                />\n-                                <div style={{\n-                                  fontSize: 11,\n-                                  color: '#999',\n-                                  marginTop: 4\n-                                }}>\n-                                  {voice.system_prompt.length} chars \u00b7 Press Esc to cancel\n-                                </div>\n-                              </>\n-                            )}\n-                          </div>\n-                        );\n-                        })}\n-                      </div>\n-                    )}\n-\n-                    {/* @@@ Add Voice button */}\n-                    {!isSystem && (\n-                      <button\n-                        onClick={() => handleAddVoice(deck.id)}\n-                        disabled={creatingVoice === deck.id}\n-                        style={{\n-                          padding: '8px 16px',\n-                          marginTop: '16px',\n-                          background: 'transparent',\n-                          color: '#4a90e2',\n-                          border: '1px dashed #4a90e2',\n-                          borderRadius: '4px',\n-                          cursor: creatingVoice === deck.id ? 'not-allowed' : 'pointer',\n-                          fontSize: '12px',\n-                          opacity: creatingVoice === deck.id ? 0.6 : 1,\n-                          transition: 'all 0.2s',\n-                          alignSelf: 'flex-start'\n-                        }}\n-                        onMouseEnter={(e) => {\n-                          if (creatingVoice !== deck.id) {\n-                            e.currentTarget.style.background = '#f0f8ff';\n-                          }\n-                        }}\n-                        onMouseLeave={(e) => {\n-                          if (creatingVoice !== deck.id) {\n-                            e.currentTarget.style.background = 'transparent';\n-                          }\n-                        }}\n-                      >\n-                        {creatingVoice === deck.id ? t('deck.actions.addingVoice') : t('deck.actions.addVoice')}\n-                      </button>\n-                    )}\n-\n-                    {/* Empty State */}\n-                    {(!deck.voices || deck.voices.length === 0) && (\n-                      <div style={{\n-                        padding: 32,\n-                        textAlign: 'center',\n-                        color: '#999',\n-                        fontStyle: 'italic'\n-                      }}>\n-                        No voices in this deck yet\n-                      </div>\n-                    )}\n-                  </div>\n-                )}\n-              </div>\n-            );\n-          })}\n+              );\n+            })}\n+          </div>\n \n           {/* @@@ Community Decks Section */}\n           <hr style={{ margin: '32px 0', border: '1px solid #d0c4b0' }} />\n@@ -1405,7 +655,7 @@ export default function DeckManager({ onUpdate }: Props) {\n           ) : (\n             <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\n               {communityDecks.map(deck => {\n-                const Icon = iconMap[deck.icon as keyof typeof iconMap] || FaBrain;\n+            const Icon = iconMap[deck.icon as keyof typeof iconMap] || iconMap.brain;\n                 const colorHex = COLORS[deck.color as keyof typeof COLORS]?.hex || '#4a90e2';\n \n                 return (\n@@ -1501,6 +751,23 @@ export default function DeckManager({ onUpdate }: Props) {\n         </div>\n       </div>\n \n+      {/* Deck editor modal */}\n+      {activeDeck && (\n+        <DeckEditorModal\n+          deck={activeDeck}\n+          isSystem={!!activeDeck.is_system}\n+          selectedVoiceId={selectedVoiceByDeck[activeDeck.id] || activeDeck.voices?.[0]?.id || null}\n+          onSelectVoice={(voiceId) => setSelectedVoiceByDeck(prev => ({ ...prev, [activeDeck.id]: voiceId }))}\n+          onClose={() => setActiveDeckId(null)}\n+          creatingVoiceId={creatingVoice}\n+          onAddVoice={handleAddVoice}\n+          onUpdateDeck={handleUpdateDeck}\n+          onUpdateVoice={handleUpdateVoice}\n+          onToggleVoice={handleToggleVoice}\n+          onDeleteVoice={handleDeleteVoice}\n+        />\n+      )}\n+\n       {/* @@@ Publish Warning Modal */}\n       {publishWarning && (\n         <div"
    },
    {
      "sha": "accc5d5bd4c2609e1b1231af0ce8586e35dd9ffe",
      "filename": "frontend/src/components/deckVisuals.ts",
      "status": "added",
      "additions": 27,
      "deletions": 0,
      "changes": 27,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/e52dce84a0e23360ace13562b31d1e67eea36f56/frontend%2Fsrc%2Fcomponents%2FdeckVisuals.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/e52dce84a0e23360ace13562b31d1e67eea36f56/frontend%2Fsrc%2Fcomponents%2FdeckVisuals.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FdeckVisuals.ts?ref=e52dce84a0e23360ace13562b31d1e67eea36f56",
      "patch": "@@ -0,0 +1,27 @@\n+import {\n+  FaBrain, FaHeart, FaQuestion, FaCloud, FaTheaterMasks, FaEye,\n+  FaFistRaised, FaLightbulb, FaShieldAlt, FaWind, FaFire, FaCompass\n+} from 'react-icons/fa';\n+\n+export const COLORS = {\n+  'blue': { hex: '#4a90e2', label: 'Blue' },\n+  'purple': { hex: '#9b59b6', label: 'Purple' },\n+  'pink': { hex: '#e91e63', label: 'Pink' },\n+  'green': { hex: '#27ae60', label: 'Green' },\n+  'yellow': { hex: '#f39c12', label: 'Yellow' }\n+};\n+\n+export const iconMap = {\n+  brain: FaBrain,\n+  heart: FaHeart,\n+  question: FaQuestion,\n+  cloud: FaCloud,\n+  masks: FaTheaterMasks,\n+  eye: FaEye,\n+  fist: FaFistRaised,\n+  lightbulb: FaLightbulb,\n+  shield: FaShieldAlt,\n+  wind: FaWind,\n+  fire: FaFire,\n+  compass: FaCompass,\n+};"
    }
  ]
}