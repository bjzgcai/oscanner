commit 6776609d2716fbc4dd2d1c5efc1e716136bfe507
Author: lexicalmathical <lexicalmathical@gmail.com>
Date:   Thu Oct 30 11:21:24 2025 +0800

    Restructure prompt to prevent LLM from extracting phrases from comments
    
    Problem: LLM was extracting phrases like "adorning it with transcendence"
    from existing comment text instead of from the user's original text,
    causing 25 PHRASE_NOT_FOUND errors.
    
    Solution: Restructure prompt with clear visual sections:
    - "TEXT TO ANALYZE" - explicitly marked as phrase source
    - "EXISTING CONVERSATION" - full comments for context, but with warning
    - "REJECTED PHRASES" - explicit list of overlapped phrases
    - "YOUR TASK" - step-by-step instructions
    
    Key changes:
    - Added visual separators (â•â•â•â•â•â•â•â•) between sections
    - Multiple explicit warnings: "Do NOT extract from conversation"
    - Comments still visible for context (so agents see what others said)
    - Instructions repeatedly emphasize extraction from TEXT ONLY
    
    This preserves conversational context while preventing confusion
    about where to extract phrases from.
    
    ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
    
    Co-Authored-By: Claude <noreply@anthropic.com>

diff --git a/backend/stateless_analyzer.py b/backend/stateless_analyzer.py
index efdce36..5b43f38 100644
--- a/backend/stateless_analyzer.py
+++ b/backend/stateless_analyzer.py
@@ -48,55 +48,73 @@ def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict],
         for name, v in voice_archetypes.items()
     ])
 
-    # Build list of applied comments with their phrases
-    existing_summary = ""
+    # Build existing conversation context
+    conversation_context = ""
     highlighted_phrases = []
     if applied_comments:
-        existing_summary = "\n\nALREADY APPLIED COMMENTS (do not repeat or overlap with these):\n"
+        conversation_context = "\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
+        conversation_context += "EXISTING CONVERSATION (for context - do NOT extract phrases from here):\n"
+        conversation_context += "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
         for c in applied_comments:
             phrase = c.get('phrase', '')
             highlighted_phrases.append(phrase)
-            existing_summary += f"- {c.get('voice', 'Unknown')} on \"{phrase}\": {c.get('comment', '')}\n"
-        existing_summary += f"\nğŸ‘‰ These phrases are already highlighted: {highlighted_phrases}\n"
-        existing_summary += "ğŸ‘‰ Choose a DIFFERENT phrase that does NOT overlap with any of these!\n"
+            conversation_context += f"\n{c.get('voice', 'Unknown')} commented on \"{phrase}\":\n"
+            conversation_context += f"  â†’ {c.get('comment', '')}\n"
+
+        conversation_context += f"\nâš ï¸ Already highlighted phrases (do NOT overlap): {highlighted_phrases}\n"
 
     # @@@ Add overlapped phrases feedback (phrases that were rejected due to overlap)
+    rejected_section = ""
     if overlapped_phrases:
-        existing_summary += f"\n\nREJECTED PHRASES (these overlapped with existing highlights):\n"
+        rejected_section = "\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
+        rejected_section += "REJECTED PHRASES (these were tried but overlapped):\n"
+        rejected_section += "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
         for phrase in overlapped_phrases:
-            existing_summary += f"- \"{phrase}\" (REJECTED - do NOT suggest this again)\n"
-        existing_summary += f"\nâš ï¸ AVOID these phrases: {overlapped_phrases}\n"
-        existing_summary += "âš ï¸ The system already tried these and rejected them - choose something completely different!\n"
+            rejected_section += f"  âœ— \"{phrase}\" - REJECTED, do NOT suggest again\n"
+        rejected_section += f"\nâš ï¸ Do NOT suggest any variation of these phrases!\n"
 
     prompt = f"""You are analyzing internal dialogue as distinct inner voice personas.
 
-Analyze this text and identify ONE NEW voice that wants to comment:
+â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
+TEXT TO ANALYZE (extract your phrase from THIS text ONLY):
+â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 
 "{text}"
 
-Available voice personas (ONLY use these):
+â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
+AVAILABLE VOICE PERSONAS (choose ONE from this list):
+â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
+
 {voice_list}
-{existing_summary}
+{conversation_context}
+{rejected_section}
+
+â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
+YOUR TASK:
+â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 
 Find ONE NEW voice to comment:
-1. Extract a SHORT phrase (2-4 words) that triggered it - MUST be EXACT text from above
+
+1. Extract a SHORT phrase (2-4 words) from the "TEXT TO ANALYZE" section above
+   - MUST be EXACT substring from the quoted text
+   - Do NOT extract from the conversation context or rejected phrases
+   - Verify character-by-character that your phrase exists in the text
+
 2. Choose a voice persona from the available list
+
 3. Write what this voice is saying (1-2 sentences)
 
 CRITICAL RULES:
 - Return ONLY ONE comment
-- DO NOT repeat any applied comments
-- DO NOT choose phrases that overlap or intersect with already highlighted phrases
-- Your chosen phrase must be completely separate from existing highlights
+- Phrase MUST come from "TEXT TO ANALYZE" section ONLY
+- DO NOT extract phrases from the "EXISTING CONVERSATION" section
+- DO NOT overlap with already highlighted phrases: {highlighted_phrases}
+- DO NOT suggest any rejected phrases: {overlapped_phrases}
 - DO NOT CREATE NEW VOICE NAMES - Only use from the available list
 - Return null if nothing is worth commenting on
-- Phrase MUST be EXACT substring from text - verify by checking character-by-character
 - IGNORE text inside quotation marks ("..." or '...') - only highlight the author's own words
-- DO NOT extract phrases from quoted responses, references, or examples
-- Only comment on what the AUTHOR wrote, not what they are quoting or citing
 - Only comment on complete sentences (ending with .!?ã€‚ï¼ï¼Ÿ)
 - Prefer SHORT highlights without punctuation (e.g., "feel anxious" not "I feel anxious.")
-- Keep highlights tight and focused - avoid including sentence endings
 - Write in the SAME LANGUAGE as the text"""
 
     # @@@ Add meta prompt if available
