{
  "sha": "06a05569509f9d8c6e80d920d8848c17faf0a489",
  "node_id": "C_kwDOP2Zrm9oAKDA2YTA1NTY5NTA5ZjlkOGM2ZTgwZDkyMGQ4ODQ4YzE3ZmFmMGE0ODk",
  "commit": {
    "author": {
      "name": "zhuchenyu2008",
      "email": "132262479+zhuchenyu2008@users.noreply.github.com",
      "date": "2026-01-01T04:42:17Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2026-01-01T04:42:17Z"
    },
    "message": "Delete App.tsx",
    "tree": {
      "sha": "d0aaa621604627614aa5c66395b97d13c99ad761",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/d0aaa621604627614aa5c66395b97d13c99ad761"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/06a05569509f9d8c6e80d920d8848c17faf0a489",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsFcBAABCAAQBQJpVfspCRC1aQ7uu5UhlAAAkV0QAF8fROe6AtsSoPEkEBuOdmpg\nYc5DSFec2Voo1QXEZeUl/NYCfpieJ0L02a1H2tPWAXTOVGVCLQ8KekMoUPhGpnc1\nJee27EJQUZqXmFJHy40Fk9B8ZqitcLx5QntjgqN0u/Iaayv+kKWbVuWOY0gGV/YH\nB2ZlEFhqeBCK5/Od3zQTFMLvvxvQdb3KFVI3ixnrLWS/hwTQ4ogC6R4dozwwI3Us\nxNIxBm1t3HhRZKi9wXRE+ILeyx8VW34XYEgAoSe+9SdtnGRmHS6VS2FHJCwkeXB7\nATaKq7WbOHcK1VHYJqkKyFPUlrTkm8vNMfcqKZrSfW6cq3QG31rk+rHGYPnDf5uo\n0JIbiomF5W7N1C5PYrn2uqPOobvA4ytpLokmzubNs62EpGhbPjBUfEegwz7y8ORM\nd2RkDXNLTKq52HUgVf+33lDfSEaeWxVelTUbXeCUDnD/KgjSYQO/KSZ8wVq7bYPK\n7QZoFGj7juX86BzhkctqTThBqyLuPuySxfCT7QWig1VxJjCpAXbwLXR4XaWreQfK\n+gndOVZaOnY0c5kOpzq/pcz2y6GTJIZcDFr54W0KAZtIeDiA8HnT37LeTiOWi05e\n1KVoDK8N360WDW+jlGGQuxxpEG22pblBd/usx2YCUMtK/q8oqgzSTqWB/mvuaalz\n+6UJe8DuWXyjWWaJjQJW\n=K1d6\n-----END PGP SIGNATURE-----\n",
      "payload": "tree d0aaa621604627614aa5c66395b97d13c99ad761\nparent 30342e323a3836d3f87753b06b83ec5c7b6e5bf2\nauthor zhuchenyu2008 <132262479+zhuchenyu2008@users.noreply.github.com> 1767242537 +0800\ncommitter GitHub <noreply@github.com> 1767242537 +0800\n\nDelete App.tsx",
      "verified_at": "2026-01-01T04:42:18Z"
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/06a05569509f9d8c6e80d920d8848c17faf0a489",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/06a05569509f9d8c6e80d920d8848c17faf0a489",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/06a05569509f9d8c6e80d920d8848c17faf0a489/comments",
  "author": {
    "login": "zhuchenyu2008",
    "id": 132262479,
    "node_id": "U_kgDOB-IqTw",
    "avatar_url": "https://avatars.githubusercontent.com/u/132262479?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zhuchenyu2008",
    "html_url": "https://github.com/zhuchenyu2008",
    "followers_url": "https://api.github.com/users/zhuchenyu2008/followers",
    "following_url": "https://api.github.com/users/zhuchenyu2008/following{/other_user}",
    "gists_url": "https://api.github.com/users/zhuchenyu2008/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zhuchenyu2008/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zhuchenyu2008/subscriptions",
    "organizations_url": "https://api.github.com/users/zhuchenyu2008/orgs",
    "repos_url": "https://api.github.com/users/zhuchenyu2008/repos",
    "events_url": "https://api.github.com/users/zhuchenyu2008/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zhuchenyu2008/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "30342e323a3836d3f87753b06b83ec5c7b6e5bf2",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/30342e323a3836d3f87753b06b83ec5c7b6e5bf2",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/30342e323a3836d3f87753b06b83ec5c7b6e5bf2"
    }
  ],
  "stats": {
    "total": 1859,
    "additions": 0,
    "deletions": 1859
  },
  "files": [
    {
      "sha": "0d07715e6a7df889277d0c279e4bab0727922376",
      "filename": "App.tsx",
      "status": "removed",
      "additions": 0,
      "deletions": 1859,
      "changes": 1859,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/30342e323a3836d3f87753b06b83ec5c7b6e5bf2/App.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/30342e323a3836d3f87753b06b83ec5c7b6e5bf2/App.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/App.tsx?ref=30342e323a3836d3f87753b06b83ec5c7b6e5bf2",
      "patch": "@@ -1,1859 +0,0 @@\n-// App.tsx\n-import React, { useState, useEffect, useLayoutEffect, useRef, useCallback, useMemo } from 'react';\n-import { useTranslation } from 'react-i18next';\n-import type { Commentor, EditorState, TextCell } from './engine/EditorEngine';\n-import { ChatWidget } from './engine/ChatWidget';\n-import type { ChatWidgetData } from './engine/ChatWidget';\n-import './App.css';\n-import {\n-  FaSync,\n-  FaBrain, FaHeart, FaQuestion, FaCloud, FaTheaterMasks, FaEye,\n-  FaFistRaised, FaLightbulb, FaShieldAlt, FaWind, FaFire, FaCompass,\n-} from 'react-icons/fa';\n-import TopNavBar from './components/TopNavBar';\n-import LeftToolbar from './components/LeftToolbar';\n-import DeckManager from './components/DeckManager';\n-import CalendarPopup from './components/CalendarPopup';\n-import { type CalendarEntry } from './utils/calendarStorage';\n-import CollectionsView from './components/CollectionsView';\n-import AnalysisView from './components/AnalysisView';\n-import AboutView from './components/AboutView';\n-import AgentDropdown from './components/AgentDropdown';\n-import ChatWidgetUI from './components/ChatWidgetUI';\n-import StateChooser from './components/StateChooser';\n-import type { VoiceConfig } from './api/voiceApi';\n-import { getVoices, getMetaPrompt, getStateConfig } from './utils/voiceStorage';\n-import { getDefaultVoices, chatWithVoice, importLocalData, loadVoicesFromDecks } from './api/voiceApi';\n-import { useMobile } from './utils/mobileDetect';\n-import { CommentGroupCard } from './components/CommentCard';\n-import { findNormalizedPhrase } from './utils/textNormalize';\n-import { useAuth } from './contexts/AuthContext';\n-import LoginForm from './components/Auth/LoginForm';\n-import RegisterForm from './components/Auth/RegisterForm';\n-import { STORAGE_KEYS } from './constants/storageKeys';\n-import { getLocalDayKey, getTodayKeyInTimezone } from './utils/timezone';\n-import { useSessionLifecycle } from './hooks/useSessionLifecycle';\n-import { useInspiration } from './hooks/useInspiration';\n-import { InspirationHint } from './components/Editor/InspirationHint';\n-import { useComments } from './hooks/useComments';\n-import { useTextCells } from './hooks/useTextCells';\n-import { useVoiceInput } from './hooks/useVoiceInput';\n-\n-// @@@ Icon map with React Icons\n-const iconMap = {\n-  brain: FaBrain,\n-  heart: FaHeart,\n-  question: FaQuestion,\n-  cloud: FaCloud,\n-  masks: FaTheaterMasks,\n-  eye: FaEye,\n-  fist: FaFistRaised,\n-  lightbulb: FaLightbulb,\n-  shield: FaShieldAlt,\n-  wind: FaWind,\n-  fire: FaFire,\n-  compass: FaCompass,\n-};\n-\n-const LANGUAGE_CODES: Array<'en' | 'zh'> = ['en', 'zh'];\n-\n-// @@@ Color map with gradient colors for watercolor effect\n-const colorMap: Record<string, { gradient: string; text: string; glow: string }> = {\n-  blue: {\n-    gradient: 'linear-gradient(90deg, rgba(77,159,255,0) 0%, rgba(77,159,255,0.05) 30%, rgba(77,159,255,0.12) 60%, rgba(77,159,255,0.25) 100%)',\n-    text: '#0066cc',\n-    glow: 'rgba(77,159,255,0.15)'\n-  },\n-  pink: {\n-    gradient: 'linear-gradient(90deg, rgba(255,102,179,0) 0%, rgba(255,102,179,0.05) 30%, rgba(255,102,179,0.12) 60%, rgba(255,102,179,0.25) 100%)',\n-    text: '#cc0066',\n-    glow: 'rgba(255,102,179,0.15)'\n-  },\n-  yellow: {\n-    gradient: 'linear-gradient(90deg, rgba(255,221,51,0) 0%, rgba(255,221,51,0.05) 30%, rgba(255,221,51,0.12) 60%, rgba(255,221,51,0.25) 100%)',\n-    text: '#996600',\n-    glow: 'rgba(255,221,51,0.15)'\n-  },\n-  green: {\n-    gradient: 'linear-gradient(90deg, rgba(102,255,102,0) 0%, rgba(102,255,102,0.05) 30%, rgba(102,255,102,0.12) 60%, rgba(102,255,102,0.25) 100%)',\n-    text: '#006600',\n-    glow: 'rgba(102,255,102,0.15)'\n-  },\n-  purple: {\n-    gradient: 'linear-gradient(90deg, rgba(179,102,255,0) 0%, rgba(179,102,255,0.05) 30%, rgba(179,102,255,0.12) 60%, rgba(179,102,255,0.25) 100%)',\n-    text: '#6600cc',\n-    glow: 'rgba(179,102,255,0.15)'\n-  },\n-};\n-\n-// @@@ Main App Component\n-export default function App() {\n-  const isMobile = useMobile();\n-  const { isAuthenticated, isLoading } = useAuth();\n-  const { t, i18n } = useTranslation();\n-\n-  // @@@ Auth screen state\n-  const [authScreen, setAuthScreen] = useState<'login' | 'register'>('login');\n-  const [showMigrationDialog, setShowMigrationDialog] = useState(false);\n-  const [isMigrating, setIsMigrating] = useState(false);\n-  const currentLanguage = (i18n.language || 'en').split('-')[0];\n-  const [showEnergyBar, setShowEnergyBar] = useState(() => {\n-    const stored = localStorage.getItem('show-energy-bar');\n-    return stored ? stored === 'true' : true;\n-  });\n-\n-  useEffect(() => {\n-    localStorage.setItem('show-energy-bar', String(showEnergyBar));\n-  }, [showEnergyBar]);\n-  const handleUILanguageChange = useCallback((code: string) => {\n-    if (code !== currentLanguage) {\n-      i18n.changeLanguage(code);\n-    }\n-  }, [currentLanguage, i18n]);\n-\n-  const [currentView, setCurrentView] = useState<'writing' | 'settings' | 'timeline' | 'analysis' | 'decks'>('writing');\n-  const [showCalendarPopup, setShowCalendarPopup] = useState(false);\n-  const [voiceConfigs, setVoiceConfigs] = useState<Record<string, VoiceConfig>>({});\n-\n-  const browserTimezone = useMemo(() => {\n-    try {\n-      return Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';\n-    } catch {\n-      return 'UTC';\n-    }\n-  }, []);\n-  const [stateConfig, setStateConfig] = useState(() => getStateConfig());\n-\n-  const {\n-    engineRef,\n-    state,\n-    setState,\n-    selectedState,\n-    setSelectedState,\n-    selectedStateLoading,\n-    userTimezone,\n-    ensureStateForPersistence,\n-    getFirstLineFromState,\n-    saveSessionToDatabase,\n-    startDetachedBlankSession,\n-    handleNewSession,\n-    confirmStartFresh\n-  } = useSessionLifecycle({\n-    isAuthenticated,\n-    browserTimezone,\n-    setVoiceConfigs,\n-    setStateConfig\n-  });\n-\n-  // @@@ Chat widget state\n-  const [dropdownVisible, setDropdownVisible] = useState(false);\n-  const [dropdownPosition, setDropdownPosition] = useState({ x: 0, y: 0 });\n-  const [dropdownTriggerCellId, setDropdownTriggerCellId] = useState<string | null>(null);\n-  const [chatProcessing, setChatProcessing] = useState<Set<string>>(new Set());\n-\n-  // @@@ Warning dialog state\n-  const [showWarning, setShowWarning] = useState(false);\n-\n-  const scrollContainerRef = useRef<HTMLDivElement>(null);  // @@@ Track scroll container for position preservation\n-  const savedScrollTop = useRef<number>(0);  // @@@ Save scroll position across re-renders\n-\n-  // @@@ Comment alignment state\n-  const [commentsAligned, setCommentsAligned] = useState(false);\n-\n-  // @@@ Writing inspiration/suggestion state\n-  const {\n-    currentInspiration,\n-    isDisappearing: inspirationDisappearing,\n-    isAppearing: inspirationAppearing,\n-    onTextChange: onInspirationTextChange,\n-    setTextGetter: setInspirationTextGetter,\n-  } = useInspiration();\n-\n-  // @@@ Provide text getter to inspiration hook for validation\n-  useEffect(() => {\n-    setInspirationTextGetter(() => {\n-      if (!engineRef.current) return '';\n-      const cells = engineRef.current.getState().cells;\n-      return cells\n-        .filter(c => c.type === 'text')\n-        .map(c => (c as TextCell).content)\n-        .join('');\n-    });\n-  }, [setInspirationTextGetter]);\n-\n-  // @@@ Text cell management (IME, refs, dropdown helpers)\n-  const {\n-    localTexts,\n-    composingCells,\n-    textareaRefs,\n-    refsReady,\n-    setRefsReady,\n-    handleTextChange,\n-    handleCompositionStart,\n-    handleCompositionEnd,\n-    handlePaste,\n-    handleKeyDown: handleTextCellKeyDown,\n-    createTextareaRef,\n-  } = useTextCells({\n-    engineRef,\n-    state,\n-    onInspirationTextChange,\n-    selectedState,\n-    dropdownVisible,\n-    dropdownTriggerCellId,\n-    onDropdownClose: () => {\n-      setDropdownVisible(false);\n-      setDropdownTriggerCellId(null);\n-    }\n-  });\n-\n-  const { userTalking, handleToggleTalking } = useVoiceInput({\n-    engineRef,\n-    textareaRefs,\n-    isAuthenticated,\n-  });\n-\n-  // @@@ Comment management (grouping, navigation, chat)\n-  const {\n-    commentGroups,\n-    groupPages,\n-    handleGroupNavigate,\n-    expandedCommentId,\n-    setExpandedCommentId,\n-    mobileActiveComment,\n-    handleCursorChange,\n-    handleCommentStar,\n-    handleCommentKill,\n-    handleCommentChatSend,\n-    commentChatProcessing,\n-  } = useComments({\n-    state,\n-    textareaRefs,\n-    refsReady,\n-    selectedState,\n-    stateConfig,\n-    isMobile,\n-    engineRef,\n-  });\n-\n-  const energyThreshold = 50;\n-  const appliedComments = state?.commentors.filter(c => c.appliedAt) ?? [];\n-  const lastEntry = state?.weightPath[state.weightPath.length - 1];\n-  const currentEnergy = lastEntry?.energy || 0;\n-  const usedEnergy = appliedComments.length * energyThreshold;\n-  const unusedEnergy = currentEnergy - usedEnergy;\n-  const safeUnusedEnergy = Math.max(unusedEnergy, 0);\n-  const energyLevel = Math.floor(safeUnusedEnergy / energyThreshold);\n-  const energyRemainder = safeUnusedEnergy % energyThreshold;\n-  const [energyPulseKey, setEnergyPulseKey] = useState(0);\n-  const energyLevelRef = useRef(0);\n-  const [showFullEnergy, setShowFullEnergy] = useState(false);\n-  const fullEnergyTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n-  const energyProgress = showFullEnergy ? 1 : energyRemainder / energyThreshold;\n-\n-  useEffect(() => {\n-    const prevLevel = energyLevelRef.current;\n-    if (energyLevel > prevLevel) {\n-      setEnergyPulseKey((key) => key + 1);\n-      setShowFullEnergy(true);\n-      if (fullEnergyTimeoutRef.current) {\n-        clearTimeout(fullEnergyTimeoutRef.current);\n-      }\n-      fullEnergyTimeoutRef.current = setTimeout(() => {\n-        setShowFullEnergy(false);\n-      }, 200);\n-    }\n-    energyLevelRef.current = energyLevel;\n-  }, [energyLevel]);\n-\n-  useEffect(() => {\n-    return () => {\n-      if (fullEnergyTimeoutRef.current) {\n-        clearTimeout(fullEnergyTimeoutRef.current);\n-      }\n-    };\n-  }, []);\n-\n-  // @@@ CRITICAL: Resize textareas then restore scroll position\n-  // Order matters: resize first (changes content height), then restore scroll\n-  // Triggers: on mount (refsReady) and when cells added/deleted (cells.length)\n-  useLayoutEffect(() => {\n-    // 1. Resize textareas first (if refs are ready)\n-    if (refsReady > 0) {\n-      textareaRefs.current.forEach((textarea) => {\n-        textarea.style.height = 'auto';\n-        textarea.style.height = textarea.scrollHeight + 'px';\n-      });\n-    }\n-\n-    // 2. Then restore scroll position (after heights are correct)\n-    if (scrollContainerRef.current && savedScrollTop.current > 0) {\n-      scrollContainerRef.current.scrollTop = savedScrollTop.current;\n-    }\n-  }, [refsReady, state?.cells.length]);\n-\n-  // @@@ Trigger re-render when returning to writing view to recalculate comment positions\n-  useEffect(() => {\n-    if (currentView === 'writing') {\n-      // Force re-render to recalculate comment positions\n-      setRefsReady(prev => prev + 1);\n-    }\n-  }, [currentView]);\n-\n-  // @@@ Force recalculation when selectedState changes (StateChooser height changes)\n-  useEffect(() => {\n-    if (selectedState) {\n-      // Small delay to ensure StateChooser has collapsed and DOM has settled\n-      const timer = setTimeout(() => {\n-        setRefsReady(prev => prev + 1);\n-      }, 50);\n-      return () => clearTimeout(timer);\n-    }\n-  }, [selectedState]);\n-\n-\n-  // @@@ Fetch default voices from backend and load from deck system\n-  useEffect(() => {\n-    getDefaultVoices().then(async backendVoices => {\n-      const converted: Record<string, VoiceConfig> = {};\n-      for (const [name, data] of Object.entries(backendVoices)) {\n-        const v = data as any;\n-        converted[name] = {\n-          name,\n-          systemPrompt: v.systemPrompt,  // @@@ Fixed: was v.tagline (wrong field name)\n-          enabled: true,\n-          icon: v.icon,\n-          color: v.color\n-        };\n-      }\n-\n-      // @@@ Try loading from deck system first, then localStorage, then defaults\n-      const deckVoices = await loadVoicesFromDecks();\n-      const hasDecks = Object.keys(deckVoices).length > 0;\n-      const configs = hasDecks ? deckVoices : (getVoices() || converted);\n-      setVoiceConfigs(configs);\n-\n-      console.log(`\ud83d\udcda Loaded voices from: ${hasDecks ? 'deck system' : 'localStorage or defaults'}`);\n-\n-      // Update engine with voice configs\n-      if (engineRef.current) {\n-        engineRef.current.setVoiceConfigs(configs);\n-      }\n-    });\n-  }, []);\n-\n-  // @@@ Update engine when voice configs change\n-  useEffect(() => {\n-    if (engineRef.current && Object.keys(voiceConfigs).length > 0) {\n-      engineRef.current.setVoiceConfigs(voiceConfigs);\n-    }\n-  }, [voiceConfigs]);\n-\n-  // @@@ Reload state config when returning to writing view\n-  useEffect(() => {\n-    if (currentView === 'writing') {\n-      setStateConfig(getStateConfig());\n-    }\n-  }, [currentView]);\n-\n-  // @@@ Check for localStorage migration after login\n-  useEffect(() => {\n-    const checkMigration = async () => {\n-      if (!isAuthenticated || isLoading) return;\n-\n-      try {\n-        // Get user preferences from database (includes first_login_completed)\n-        const { getPreferences } = await import('./api/voiceApi');\n-        const preferences = await getPreferences();\n-\n-        // If user has already completed first login, clear localStorage\n-        if (preferences?.first_login_completed) {\n-          // Clear all app data from localStorage (keep only auth token)\n-          Object.values(STORAGE_KEYS).forEach(key => {\n-            if (key !== STORAGE_KEYS.AUTH_TOKEN) {\n-              localStorage.removeItem(key);\n-            }\n-          });\n-          return;\n-        }\n-\n-        // First time login - check for localStorage data to migrate\n-        const hasLocalData =\n-          localStorage.getItem(STORAGE_KEYS.EDITOR_STATE) ||\n-          localStorage.getItem(STORAGE_KEYS.CALENDAR_ENTRIES) ||\n-          localStorage.getItem(STORAGE_KEYS.DAILY_PICTURES) ||\n-          localStorage.getItem(STORAGE_KEYS.VOICE_CONFIGS) ||\n-          localStorage.getItem(STORAGE_KEYS.META_PROMPT) ||\n-          localStorage.getItem(STORAGE_KEYS.STATE_CONFIG) ||\n-          localStorage.getItem(STORAGE_KEYS.SELECTED_STATE) ||\n-          localStorage.getItem(STORAGE_KEYS.ANALYSIS_REPORTS);\n-\n-        if (hasLocalData) {\n-          console.log('\ud83d\udd0d First login with localStorage data, showing migration dialog');\n-          setShowMigrationDialog(true);\n-        } else {\n-          // No localStorage data, just mark first login as completed\n-          console.log('\ud83d\udd0d First login without localStorage data, marking as completed');\n-          const { markFirstLoginCompleted } = await import('./api/voiceApi');\n-          await markFirstLoginCompleted();\n-        }\n-      } catch (error) {\n-        console.error('Failed to check migration status:', error);\n-      }\n-    };\n-\n-    checkMigration();\n-  }, [isAuthenticated, isLoading]);\n-\n-  // @@@ Keep focus on the lone blank text cell (after resets / clears)\n-  useEffect(() => {\n-    if (!state) return;\n-\n-    const textCells = state.cells.filter(c => c.type === 'text') as TextCell[];\n-    if (textCells.length !== 1) return;\n-\n-    const firstCell = textCells[0];\n-    if (firstCell.content.trim().length > 0) return;\n-\n-    const focusEditor = () => {\n-      const textarea = textareaRefs.current.get(firstCell.id);\n-      if (textarea && document.activeElement !== textarea) {\n-        textarea.focus();\n-        textarea.selectionStart = 0;\n-        textarea.selectionEnd = 0;\n-      }\n-    };\n-\n-    const textarea = textareaRefs.current.get(firstCell.id);\n-    if (textarea) {\n-      focusEditor();\n-      return;\n-    }\n-\n-    const timer = window.setTimeout(focusEditor, 0);\n-    return () => window.clearTimeout(timer);\n-  }, [state, refsReady]);\n-\n-  const handleStartFresh = useCallback(() => {\n-    setShowWarning(true);\n-  }, []);\n-\n-  const handleConfirmStartFresh = useCallback(() => {\n-    setShowWarning(false);\n-    confirmStartFresh();\n-  }, [confirmStartFresh]);\n-\n-  const handleNewSessionClick = useCallback(() => {\n-    handleNewSession(state);\n-  }, [handleNewSession, state]);\n-\n-  const handleSaveToday = useCallback(async () => {\n-    if (!engineRef.current) return;\n-    if (!isAuthenticated) {\n-      const toast = document.createElement('div');\n-      toast.textContent = 'Please sign in to save';\n-      toast.style.cssText = `\n-        position: fixed;\n-        top: 70px;\n-        right: 20px;\n-        background: #f44336;\n-        color: white;\n-        padding: 12px 20px;\n-        borderRadius: 6px;\n-        fontSize: 14px;\n-        fontFamily: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto;\n-        zIndex: 10000;\n-        boxShadow: 0 4px 12px rgba(0,0,0,0.15);\n-      `;\n-      document.body.appendChild(toast);\n-      setTimeout(() => {\n-        toast.style.opacity = '0';\n-        toast.style.transition = 'opacity 0.3s';\n-        setTimeout(() => document.body.removeChild(toast), 300);\n-      }, 2000);\n-      return;\n-    }\n-    const currentState = ensureStateForPersistence();\n-    if (!currentState) return;\n-\n-    try {\n-      const firstLine = getFirstLineFromState(currentState);\n-      const savedSessionId = await saveSessionToDatabase(currentState, firstLine);\n-      engineRef.current.setCurrentEntryId(savedSessionId);\n-\n-      const toast = document.createElement('div');\n-      toast.textContent = 'Saved';\n-      toast.style.cssText = `\n-        position: fixed;\n-        top: 70px;\n-        right: 20px;\n-        background: #4CAF50;\n-        color: white;\n-        padding: 12px 20px;\n-        borderRadius: 6px;\n-        fontSize: 14px;\n-        fontFamily: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto;\n-        zIndex: 10000;\n-        boxShadow: 0 4px 12px rgba(0,0,0,0.15);\n-    `;\n-      document.body.appendChild(toast);\n-      setTimeout(() => {\n-        toast.style.opacity = '0';\n-        toast.style.transition = 'opacity 0.3s';\n-        setTimeout(() => document.body.removeChild(toast), 300);\n-      }, 2000);\n-    } catch (error) {\n-      console.error('Failed to save:', error);\n-      // Show error toast\n-      const toast = document.createElement('div');\n-      toast.textContent = 'Save failed';\n-      toast.style.cssText = `\n-        position: fixed;\n-        top: 70px;\n-        right: 20px;\n-        background: #f44336;\n-        color: white;\n-        padding: 12px 20px;\n-        borderRadius: 6px;\n-        fontSize: 14px;\n-        fontFamily: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto;\n-        zIndex: 10000;\n-        boxShadow: 0 4px 12px rgba(0,0,0,0.15);\n-      `;\n-      document.body.appendChild(toast);\n-      setTimeout(() => {\n-        toast.style.opacity = '0';\n-        toast.style.transition = 'opacity 0.3s';\n-        setTimeout(() => document.body.removeChild(toast), 300);\n-      }, 2000);\n-    }\n-  }, [ensureStateForPersistence, getFirstLineFromState, isAuthenticated, saveSessionToDatabase]);\n-\n-  const handleLoadEntry = useCallback((entry: CalendarEntry) => {\n-    if (!engineRef.current) return;\n-\n-    const nextState: EditorState = {\n-      ...entry.state,\n-      id: entry.id,\n-      createdAt: entry.state.createdAt ?? new Date().toISOString()\n-    };\n-\n-    engineRef.current.loadState(nextState);\n-    if (nextState.selectedState !== undefined) {\n-      setSelectedState(nextState.selectedState);\n-    }\n-\n-    setRefsReady(prev => prev + 1);\n-    setShowCalendarPopup(false);\n-  }, []);\n-\n-  const handleCalendarEntryDeleted = useCallback((entryId: string) => {\n-    if (!entryId || !engineRef.current) return;\n-    const currentId = engineRef.current.getState().id;\n-    if (currentId === entryId) {\n-      startDetachedBlankSession();\n-    }\n-  }, [startDetachedBlankSession]);\n-\n-    const handleStateChoose = useCallback(async (stateId: string) => {\n-      const todayKey = getTodayKeyInTimezone(userTimezone);\n-\n-      if (engineRef.current) {\n-        const currentState = engineRef.current.getState();\n-        const sessionDate = currentState.createdAt\n-          ? getLocalDayKey(currentState.createdAt, userTimezone)\n-          : null;\n-\n-        if (sessionDate && sessionDate !== todayKey) {\n-          console.log(`\ud83d\udcc5 State chosen for old session (${sessionDate}). Starting fresh for ${todayKey}.`);\n-          await startDetachedBlankSession(true);\n-        }\n-\n-        const stateToUpdate = engineRef.current.getState();\n-        stateToUpdate.selectedState = stateId;\n-        if (!stateToUpdate.createdAt) {\n-          stateToUpdate.createdAt = new Date().toISOString();\n-        }\n-        setState(stateToUpdate);\n-      }\n-\n-      setSelectedState(stateId);\n-\n-      // @@@ KEEP: Also save to global preferences for daily reset check\n-      if (isAuthenticated) {\n-        try {\n-          const { savePreferences } = await import('./api/voiceApi');\n-          await savePreferences({ selected_state: stateId });\n-          // Database updated_at will be used for daily reset check\n-        } catch (error) {\n-          console.error('Failed to save state to database:', error);\n-        }\n-      } else {\n-        localStorage.setItem(STORAGE_KEYS.SELECTED_STATE, stateId);\n-        localStorage.setItem('selected-state-date', todayKey);\n-      }\n-    }, [isAuthenticated, startDetachedBlankSession, userTimezone]);\n-\n-  // @@@ Insert @ character at the end of last text cell\n-  const handleInsertAgent = useCallback(() => {\n-    if (!state || !engineRef.current) return;\n-\n-    // Find last text cell\n-    const lastTextCell = [...state.cells].reverse().find(c => c.type === 'text');\n-    if (!lastTextCell) return;\n-\n-    const textarea = textareaRefs.current.get(lastTextCell.id);\n-    if (!textarea) return;\n-\n-    // Insert @ character at the end\n-    const currentContent = (lastTextCell as TextCell).content;\n-    const newContent = currentContent + '@';\n-\n-    // Update the text\n-    engineRef.current.updateTextCell(lastTextCell.id, newContent);\n-\n-    // Focus the textarea and position cursor after @\n-    setTimeout(() => {\n-      textarea.focus();\n-      textarea.selectionStart = newContent.length;\n-      textarea.selectionEnd = newContent.length;\n-\n-      // Show dropdown\n-      const rect = textarea.getBoundingClientRect();\n-      const computedStyle = window.getComputedStyle(textarea);\n-      const lineHeight = parseFloat(computedStyle.lineHeight) || 32;\n-      const linesBefore = newContent.substring(0, newContent.length).split('\\n').length - 1;\n-\n-      setDropdownPosition({\n-        x: rect.left + 10,\n-        y: rect.top + (linesBefore * lineHeight) + lineHeight + 5\n-      });\n-      setDropdownTriggerCellId(lastTextCell.id);\n-      setDropdownVisible(true);\n-    }, 0);\n-  }, [state]);\n-\n-  // @@@ Toggle comment alignment\n-  const handleToggleAlign = useCallback(() => {\n-    setCommentsAligned(prev => !prev);\n-  }, []);\n-\n-  // @@@ Handle localStorage migration\n-  const handleMigrateData = useCallback(async () => {\n-    setIsMigrating(true);\n-    try {\n-      // Export all localStorage data (convert null to undefined)\n-      const migrationData = {\n-        currentSession: localStorage.getItem(STORAGE_KEYS.EDITOR_STATE) ?? undefined,\n-        calendarEntries: localStorage.getItem(STORAGE_KEYS.CALENDAR_ENTRIES) ?? undefined,\n-        dailyPictures: localStorage.getItem(STORAGE_KEYS.DAILY_PICTURES) ?? undefined,\n-        voiceCustomizations: localStorage.getItem(STORAGE_KEYS.VOICE_CONFIGS) ?? undefined,\n-        metaPrompt: localStorage.getItem(STORAGE_KEYS.META_PROMPT) ?? undefined,\n-        stateConfig: localStorage.getItem(STORAGE_KEYS.STATE_CONFIG) ?? undefined,\n-        selectedState: localStorage.getItem(STORAGE_KEYS.SELECTED_STATE) ?? undefined,\n-        analysisReports: localStorage.getItem(STORAGE_KEYS.ANALYSIS_REPORTS) ?? undefined,\n-        oldDocument: localStorage.getItem('document') ?? undefined\n-      };\n-\n-      // Log what we're about to send\n-      console.log('\ud83d\udce6 Migration data being sent:');\n-      console.log('  - currentSession:', migrationData.currentSession ? `${migrationData.currentSession.length} chars` : 'null');\n-      console.log('  - calendarEntries:', migrationData.calendarEntries ? `${migrationData.calendarEntries.length} chars` : 'null');\n-      console.log('  - dailyPictures:', migrationData.dailyPictures ? `${migrationData.dailyPictures.length} chars` : 'null');\n-\n-      // Call backend migration endpoint\n-      const result = await importLocalData(migrationData);\n-\n-      // Mark first login as completed in database\n-      const { markFirstLoginCompleted } = await import('./api/voiceApi');\n-      await markFirstLoginCompleted();\n-\n-      // Clear ALL localStorage data (keep only auth token)\n-      Object.values(STORAGE_KEYS).forEach(key => {\n-        if (key !== STORAGE_KEYS.AUTH_TOKEN) {\n-          localStorage.removeItem(key);\n-        }\n-      });\n-\n-      setShowMigrationDialog(false);\n-\n-      // Show success message\n-      alert(`Migration successful! Imported:\\n- ${result.imported.sessions} sessions\\n- ${result.imported.pictures} pictures\\n- ${result.imported.preferences} preferences\\n- ${result.imported.reports} reports`);\n-    } catch (error: any) {\n-      console.error('Migration failed:', error);\n-\n-      // Provide helpful error message based on error type\n-      let errorMsg = 'Migration failed: ';\n-      if (error.message?.includes('413') || error.message?.includes('too large')) {\n-        errorMsg += 'Your data is too large to migrate in one request.\\n\\n';\n-        errorMsg += 'This is a known issue that will be fixed soon.\\n';\n-        errorMsg += 'For now, you can:\\n';\n-        errorMsg += '1. Skip migration and start fresh, or\\n';\n-        errorMsg += '2. Wait for the fix and try again later';\n-      } else {\n-        errorMsg += error.message + '\\n\\nYou can try again later from Settings.';\n-      }\n-\n-      alert(errorMsg);\n-    } finally {\n-      setIsMigrating(false);\n-    }\n-  }, []);\n-\n-  const handleSkipMigration = useCallback(async () => {\n-    try {\n-      // Mark first login as completed in database\n-      const { markFirstLoginCompleted } = await import('./api/voiceApi');\n-      await markFirstLoginCompleted();\n-\n-      // Clear ALL localStorage data (keep only auth token)\n-      Object.values(STORAGE_KEYS).forEach(key => {\n-        if (key !== STORAGE_KEYS.AUTH_TOKEN) {\n-          localStorage.removeItem(key);\n-        }\n-      });\n-\n-      setShowMigrationDialog(false);\n-    } catch (error) {\n-      console.error('Failed to skip migration:', error);\n-      alert('Failed to skip migration. Please try again.');\n-    }\n-  }, []);\n-\n-  const handleAuthSuccess = useCallback(() => {\n-    // After successful login/register, check for migration\n-    // This is handled by the useEffect hook above\n-  }, []);\n-\n-  // @@@ Handle @ key press for agent dropdown\n-  const handleKeyDown = useCallback((cellId: string, e: React.KeyboardEvent<HTMLTextAreaElement>) => {\n-    handleTextCellKeyDown(cellId, e);\n-\n-    if (e.key === '@' && !composingCells.has(cellId)) {\n-      const textarea = e.currentTarget;\n-      setTimeout(() => {\n-        if (textarea) {\n-          const cursorPos = textarea.selectionStart;\n-          const textBeforeCursor = textarea.value.substring(0, cursorPos);\n-          const lines = textBeforeCursor.split('\\n');\n-          const linesBefore = lines.length - 1;\n-          const currentLineText = lines[lines.length - 1];\n-\n-          const computedStyle = window.getComputedStyle(textarea);\n-          const lineHeight = parseFloat(computedStyle.lineHeight) || 32;\n-          const fontSize = parseFloat(computedStyle.fontSize) || 18;\n-          const rect = textarea.getBoundingClientRect();\n-          const padding = parseFloat(computedStyle.paddingLeft) || 0;\n-\n-          const charWidth = fontSize * 0.6;\n-          const horizontalOffset = padding + (currentLineText.length * charWidth);\n-\n-          setDropdownPosition({\n-            x: rect.left + horizontalOffset,\n-            y: rect.top + (linesBefore * lineHeight) + lineHeight + 5\n-          });\n-          setDropdownTriggerCellId(cellId);\n-          setDropdownVisible(true);\n-        }\n-      }, 0);\n-    }\n-  }, [composingCells, handleTextCellKeyDown]);\n-\n-  // @@@ Handle agent selection from dropdown\n-  const handleAgentSelect = useCallback((voiceName: string, voiceConfig: VoiceConfig) => {\n-    setDropdownVisible(false);\n-\n-    if (!engineRef.current || !dropdownTriggerCellId) return;\n-\n-    const textarea = textareaRefs.current.get(dropdownTriggerCellId);\n-    if (!textarea) {\n-      setDropdownTriggerCellId(null);\n-      return;\n-    }\n-\n-    const cursorPos = textarea.selectionStart;\n-\n-    // Create chat widget\n-    const chatWidget = new ChatWidget(voiceName, voiceConfig);\n-\n-    // Insert widget at cursor (engine will handle @ removal)\n-    engineRef.current.insertWidgetAtCursor(dropdownTriggerCellId, cursorPos, 'chat', chatWidget.getData());\n-    setDropdownTriggerCellId(null);\n-  }, [dropdownTriggerCellId]);\n-\n-  // @@@ Handle sending chat message\n-  const handleChatSend = useCallback(async (widgetId: string, message: string) => {\n-    if (!engineRef.current || !state) return;\n-\n-    // Find widget\n-    const widgetCell = state.cells.find(c => c.type === 'widget' && c.id === widgetId);\n-    if (!widgetCell || widgetCell.type !== 'widget') return;\n-\n-    const widgetData = widgetCell.data as ChatWidgetData;\n-    const chatWidget = ChatWidget.fromData(widgetData);\n-\n-    // Add user message optimistically\n-    chatWidget.addUserMessage(message);\n-    engineRef.current.updateWidgetData(widgetId, chatWidget.getData());\n-\n-    // Mark as processing\n-    setChatProcessing(prev => new Set(prev).add(widgetId));\n-\n-    try {\n-      // Get ALL text from all text cells as unified context\n-      const allText = state.cells\n-        .filter(c => c.type === 'text')\n-        .map(c => (c as TextCell).content)\n-        .join('');\n-\n-      const metaPrompt = getMetaPrompt();\n-      const statePrompt = selectedState && stateConfig.states[selectedState]\n-        ? stateConfig.states[selectedState].prompt\n-        : '';\n-\n-      // @@@ Use voiceName (which is the voice ID/key) for backend lookup\n-      // Backend loads voice config from database using user_id from JWT\n-      const response = await chatWithVoice(\n-        widgetData.voiceName,  // This is the voice ID (key like \"holder\", \"mirror\")\n-        chatWidget.getConversationHistory().slice(0, -1), // Exclude last message (just added)\n-        message,\n-        allText,\n-        metaPrompt,\n-        statePrompt\n-      );\n-\n-      // Add assistant response\n-      chatWidget.addAssistantMessage(response);\n-      engineRef.current.updateWidgetData(widgetId, chatWidget.getData());\n-    } catch (error) {\n-      console.error('Chat failed:', error);\n-      chatWidget.addAssistantMessage('Sorry, I encountered an error.');\n-      engineRef.current.updateWidgetData(widgetId, chatWidget.getData());\n-    } finally {\n-      setChatProcessing(prev => {\n-        const next = new Set(prev);\n-        next.delete(widgetId);\n-        return next;\n-      });\n-    }\n-  }, [state, selectedState, stateConfig]);\n-\n-  // @@@ Handle deleting chat widget\n-  const handleChatDelete = useCallback((widgetId: string) => {\n-    if (!engineRef.current) return;\n-    engineRef.current.deleteCell(widgetId);\n-  }, []);\n-\n-  // @@@ Helper to get watercolor background\n-  const getWatercolorBg = (color: string) => {\n-    const brushes: Record<string, string> = {\n-      yellow: 'url(https://s2.svgbox.net/pen-brushes.svg?ic=brush-9&color=ffff43)',\n-      blue: 'url(https://s2.svgbox.net/pen-brushes.svg?ic=brush-7&color=a3d5ff)',\n-      pink: 'url(https://s2.svgbox.net/pen-brushes.svg?ic=brush-8&color=ffb3d9)',\n-      green: 'url(https://s2.svgbox.net/pen-brushes.svg?ic=brush-6&color=b3ffb3)',\n-      purple: 'url(https://s2.svgbox.net/pen-brushes.svg?ic=brush-5&color=ddb3ff)'\n-    };\n-    return brushes[color] || 'none';\n-  };\n-\n-  // @@@ Render highlighted text for a specific text content\n-  const renderHighlightedText = (text: string) => {\n-    if (!state) return null;\n-\n-    const appliedComments = state.commentors.filter(c => c.appliedAt);\n-\n-    if (appliedComments.length === 0) {\n-      return <div style={{ whiteSpace: 'pre-wrap' }}>{text}</div>;\n-    }\n-\n-    // Find highlights in this specific text\n-    const highlights: Array<{ start: number; end: number; comment: Commentor }> = [];\n-    appliedComments.forEach(comment => {\n-      const index = findNormalizedPhrase(text, comment.phrase);\n-      if (index !== -1) {\n-        highlights.push({\n-          start: index,\n-          end: index + comment.phrase.length,\n-          comment\n-        });\n-      }\n-    });\n-\n-    highlights.sort((a, b) => a.start - b.start);\n-\n-    const elements: React.ReactNode[] = [];\n-    let lastEnd = 0;\n-\n-    highlights.forEach((highlight, idx) => {\n-      if (highlight.start > lastEnd) {\n-        elements.push(\n-          <span key={`text-${idx}`}>\n-            {text.substring(lastEnd, highlight.start)}\n-          </span>\n-        );\n-      }\n-\n-      elements.push(\n-        <span\n-          key={`highlight-${idx}`}\n-          className=\"voice-highlight\"\n-          data-comment-id={highlight.comment.id}\n-          style={{\n-            margin: '-2px -6px',\n-            padding: '2px 6px',\n-            background: getWatercolorBg(highlight.comment.color),\n-            transition: 'all 0.2s ease'\n-          }}\n-        >\n-          {text.substring(highlight.start, highlight.end)}\n-        </span>\n-      );\n-\n-      lastEnd = highlight.end;\n-    });\n-\n-    if (lastEnd < text.length) {\n-      elements.push(\n-        <span key=\"text-final\">\n-          {text.substring(lastEnd)}\n-        </span>\n-      );\n-    }\n-\n-    return <div style={{ whiteSpace: 'pre-wrap' }}>{elements}</div>;\n-  };\n-\n-  // @@@ Show loading state while checking auth\n-  if (isLoading) {\n-    return (\n-      <div style={{\n-        display: 'flex',\n-        alignItems: 'center',\n-        justifyContent: 'center',\n-        height: '100vh',\n-        fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-        fontSize: '18px',\n-        color: '#666'\n-      }}>\n-        Loading...\n-      </div>\n-    );\n-  }\n-\n-  // @@@ Show auth screen if not authenticated\n-  const loginBannerUrl = `${import.meta.env.BASE_URL}login-banner.jpg`;\n-\n-  if (!isAuthenticated) {\n-    return (\n-      <div style={{\n-        display: 'flex',\n-        alignItems: 'center',\n-        justifyContent: 'center',\n-        minHeight: '100vh',\n-        background: `linear-gradient(135deg, rgba(245,240,232,0.8) 0%, rgba(232,220,200,0.9) 100%), url(${loginBannerUrl})`,\n-        backgroundSize: 'cover',\n-        backgroundPosition: 'center',\n-        backgroundRepeat: 'no-repeat',\n-        padding: '20px'\n-      }}>\n-        {authScreen === 'login' ? (\n-          <LoginForm\n-            onSuccess={handleAuthSuccess}\n-            onSwitchToRegister={() => setAuthScreen('register')}\n-          />\n-        ) : (\n-          <RegisterForm\n-            onSuccess={handleAuthSuccess}\n-            onSwitchToLogin={() => setAuthScreen('login')}\n-          />\n-        )}\n-      </div>\n-    );\n-  }\n-\n-  if (!state || !engineRef.current) {\n-    return <div>Loading...</div>;\n-  }\n-\n-\n-  return (\n-    <>\n-      {/* @@@ Migration dialog */}\n-      {showMigrationDialog && (\n-        <div style={{\n-          position: 'fixed',\n-          top: 0,\n-          left: 0,\n-          right: 0,\n-          bottom: 0,\n-          backgroundColor: 'rgba(0, 0, 0, 0.7)',\n-          display: 'flex',\n-          alignItems: 'center',\n-          justifyContent: 'center',\n-          zIndex: 10000,\n-          padding: '20px'\n-        }}>\n-          <div style={{\n-            backgroundColor: '#fffef9',\n-            border: '2px solid #d0c4b0',\n-            borderRadius: '12px',\n-            padding: '32px',\n-            maxWidth: '500px',\n-            boxShadow: '0 8px 24px rgba(0, 0, 0, 0.3)',\n-            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n-          }}>\n-            <h2 style={{\n-              margin: '0 0 16px 0',\n-              fontSize: '24px',\n-              color: '#333',\n-              fontWeight: 600\n-            }}>\n-              Migrate Your Data?\n-            </h2>\n-            <p style={{\n-              margin: '0 0 24px 0',\n-              fontSize: '16px',\n-              lineHeight: '1.6',\n-              color: '#555'\n-            }}>\n-              We found data in your browser. Would you like to migrate it to your account?\n-              This will move all your sessions, pictures, and preferences to the cloud.\n-            </p>\n-            <div style={{\n-              display: 'flex',\n-              gap: '12px',\n-              justifyContent: 'space-between'\n-            }}>\n-              <button\n-                onClick={handleMigrateData}\n-                disabled={isMigrating}\n-                style={{\n-                  flex: 1,\n-                  padding: '12px 20px',\n-                  border: 'none',\n-                  background: isMigrating ? '#ccc' : '#4a90e2',\n-                  borderRadius: '6px',\n-                  cursor: isMigrating ? 'not-allowed' : 'pointer',\n-                  fontSize: '16px',\n-                  fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-                  color: '#fff',\n-                  fontWeight: 600,\n-                  transition: 'all 0.2s'\n-                }}\n-                onMouseEnter={(e) => {\n-                  if (!isMigrating) e.currentTarget.style.backgroundColor = '#357abd';\n-                }}\n-                onMouseLeave={(e) => {\n-                  if (!isMigrating) e.currentTarget.style.backgroundColor = '#4a90e2';\n-                }}\n-              >\n-                {isMigrating ? 'Migrating...' : 'Migrate Data'}\n-              </button>\n-              <button\n-                onClick={handleSkipMigration}\n-                disabled={isMigrating}\n-                style={{\n-                  flex: 1,\n-                  padding: '12px 20px',\n-                  border: '1px solid #d0c4b0',\n-                  background: '#fff',\n-                  borderRadius: '6px',\n-                  cursor: isMigrating ? 'not-allowed' : 'pointer',\n-                  fontSize: '16px',\n-                  fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-                  color: '#666',\n-                  transition: 'all 0.2s'\n-                }}\n-                onMouseEnter={(e) => {\n-                  if (!isMigrating) e.currentTarget.style.backgroundColor = '#f5f5f5';\n-                }}\n-                onMouseLeave={(e) => {\n-                  if (!isMigrating) e.currentTarget.style.backgroundColor = '#fff';\n-                }}\n-              >\n-                Skip\n-              </button>\n-            </div>\n-          </div>\n-        </div>\n-      )}\n-\n-      {/* @@@ Hide top nav on mobile */}\n-      {!isMobile && <TopNavBar currentView={currentView} onViewChange={setCurrentView} />}\n-\n-      {currentView === 'writing' && (\n-        <div style={{\n-          display: 'flex',\n-          height: '100vh',\n-          paddingTop: isMobile ? '0' : '48px',\n-          paddingBottom: '41px',  // @@@ Space for fixed stats bar at bottom\n-          fontFamily: 'system-ui, -apple-system, sans-serif',\n-          boxSizing: 'border-box'\n-        }}>\n-          {/* New Session \"+\" button - top left (desktop only) */}\n-          {!isMobile && (\n-            <button\n-              onClick={handleNewSessionClick}\n-              title=\"New Session\"\n-              style={{\n-                position: 'fixed',\n-                left: '20px',\n-                top: '72px',\n-                zIndex: 101,\n-                width: '32px',\n-                height: '32px',\n-                border: 'none',\n-                borderRadius: '50%',\n-                backgroundColor: '#fff',\n-                cursor: 'pointer',\n-                display: 'flex',\n-                alignItems: 'center',\n-                justifyContent: 'center',\n-                boxShadow: '0 2px 6px rgba(0,0,0,0.15)',\n-                fontSize: '20px',\n-                fontWeight: '300',\n-                color: '#666',\n-                transition: 'all 0.2s ease'\n-              }}\n-              onMouseEnter={(e) => {\n-                e.currentTarget.style.backgroundColor = '#f8f8f8';\n-                e.currentTarget.style.transform = 'scale(1.1)';\n-              }}\n-              onMouseLeave={(e) => {\n-                e.currentTarget.style.backgroundColor = '#fff';\n-                e.currentTarget.style.transform = 'scale(1)';\n-              }}\n-            >\n-              +\n-            </button>\n-          )}\n-\n-          {/* Left toolbar - floating on top (desktop only) */}\n-          {!isMobile && (\n-            <div style={{\n-              position: 'fixed',\n-              left: '12px',\n-              top: '100px',\n-              zIndex: 100\n-            }}>\n-              <LeftToolbar\n-                onInsertAgent={handleInsertAgent}\n-                onToggleAlign={handleToggleAlign}\n-                onShowCalendar={() => setShowCalendarPopup(true)}\n-                onSaveToday={handleSaveToday}\n-                onToggleTalking={handleToggleTalking}\n-                isAligned={commentsAligned}\n-                isTalking={userTalking}\n-              />\n-            </div>\n-          )}\n-\n-          {/* @@@ Mobile floating toolbar - top right corner */}\n-          {isMobile && (\n-            <div style={{\n-              position: 'fixed',\n-              top: '10px',\n-              right: '10px',\n-              display: 'flex',\n-              gap: '8px',\n-              zIndex: 1000\n-            }}>\n-              <button\n-                onClick={handleStartFresh}\n-                title=\"Start Fresh\"\n-                style={{\n-                  width: '44px',\n-                  height: '44px',\n-                  border: 'none',\n-                  borderRadius: '50%',\n-                  backgroundColor: '#fff',\n-                  cursor: 'pointer',\n-                  display: 'flex',\n-                  alignItems: 'center',\n-                  justifyContent: 'center',\n-                  boxShadow: '0 2px 8px rgba(0,0,0,0.15)',\n-                  transition: 'all 0.2s ease'\n-                }}\n-              >\n-                <FaSync size={20} color=\"#333\" />\n-              </button>\n-              <button\n-                onClick={handleInsertAgent}\n-                title=\"Insert Agent Chat\"\n-                style={{\n-                  width: '44px',\n-                  height: '44px',\n-                  border: 'none',\n-                  borderRadius: '50%',\n-                  backgroundColor: '#fff',\n-                  cursor: 'pointer',\n-                  display: 'flex',\n-                  alignItems: 'center',\n-                  justifyContent: 'center',\n-                  boxShadow: '0 2px 8px rgba(0,0,0,0.15)',\n-                  transition: 'all 0.2s ease',\n-                  fontSize: '24px',\n-                  fontWeight: 600,\n-                  color: '#333',\n-                  fontFamily: 'monospace'\n-                }}\n-              >\n-                @\n-              </button>\n-            </div>\n-          )}\n-\n-          <div\n-            style={{\n-              flex: 1,\n-              position: 'relative',\n-              overflow: 'hidden',\n-              // @@@ Disable horizontal scrolling on mobile\n-              ...(isMobile ? { overflowX: 'hidden', touchAction: 'pan-y' } : {})\n-            }}\n-          >\n-            <div style={{\n-              height: '100%',\n-              display: 'flex',\n-              flexDirection: 'column',\n-              width: '100%',\n-              margin: '0 auto'\n-            }}>\n-              <div\n-                ref={scrollContainerRef}  // @@@ Track scroll container for position preservation\n-                className=\"notebook-lines\"\n-                onScroll={(e) => {\n-                  // @@@ Save scroll position whenever user scrolls manually\n-                  const target = e.currentTarget;\n-                  savedScrollTop.current = target.scrollTop;\n-                }}\n-                style={{\n-                  flex: 1,\n-                  position: 'relative',\n-                  overflow: 'auto',\n-                  padding: '20px',\n-                  paddingLeft: isMobile ? '20px' : '80px',  // @@@ Extra left padding for floating toolbar\n-                  paddingBottom: '80px',  // Extra space for smooth scrolling to bottom\n-                  backgroundColor: '#fffef9'  // @@@ Cream paper background for notebook lines\n-                }}>\n-                <div style={{\n-                  position: 'relative',\n-                  maxWidth: '600px'\n-                }}>\n-                  {/* State chooser widget - always shown, collapses when state selected */}\n-                  <div style={{\n-                    height: '32px',  // @@@ Fixed height to match one line interval\n-                    marginBottom: '10.8px'  // @@@ 1/3 line interval (32.4px / 3)\n-                  }}>\n-                    <StateChooser\n-                      stateConfig={stateConfig}\n-                      selectedState={state?.selectedState ?? selectedState}\n-                      selectedStateLoading={selectedStateLoading}\n-                      createdAt={state?.createdAt}\n-                      onChoose={handleStateChoose}\n-                    />\n-                  </div>\n-\n-                  {/* Render cells sequentially with per-cell highlights */}\n-                  {state.cells.map((cell, idx) => {\n-                    if (cell.type === 'text') {\n-                      const textCell = cell as TextCell;\n-                      // Use local text if available, otherwise use engine state\n-                      const content = localTexts.get(cell.id) ?? textCell.content;\n-\n-                      return (\n-                        <div key={cell.id} style={{\n-                          position: 'relative',\n-                          marginTop: idx === 0 ? '0.4px' : 0  // @@@ Align first line with 2nd notebook line\n-                        }}>\n-                          {/* Highlight layer for this cell */}\n-                          <div style={{\n-                            position: 'absolute',\n-                            top: 0,\n-                            left: 0,\n-                            right: 0,\n-                            pointerEvents: 'none',\n-                            fontSize: '18px',\n-                            lineHeight: '1.8',\n-                            color: 'transparent',\n-                            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-                            zIndex: 0\n-                          }}>\n-                            {renderHighlightedText(content)}\n-                          </div>\n-\n-                          {/* Textarea for this cell */}\n-                          <textarea\n-                            ref={createTextareaRef(cell.id)}\n-                            value={content}\n-                            onChange={(e) => handleTextChange(cell.id, e.target.value)}\n-                            onCompositionStart={() => handleCompositionStart(cell.id)}\n-                            onCompositionEnd={(e) => handleCompositionEnd(cell.id, e)}\n-                            onPaste={(e) => handlePaste(cell.id, e)}\n-                            onSelect={(e) => handleCursorChange(cell.id, e)}\n-                            onClick={(e) => handleCursorChange(cell.id, e)}\n-                            onKeyUp={(e) => handleCursorChange(cell.id, e)}\n-                            onKeyDown={(e) => handleKeyDown(cell.id, e)}\n-                            placeholder={idx === 0 ? \"Start writing...\" : \"Continue writing...\"}\n-                            style={{\n-                              width: '100%',\n-                              border: 'none',\n-                              outline: 'none',\n-                              resize: 'none',\n-                              fontSize: '18px',\n-                              lineHeight: '1.8',\n-                              fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-                              background: 'transparent',\n-                              color: '#333',\n-                              caretColor: '#333',\n-                              position: 'relative',\n-                              zIndex: 1,\n-                              marginBottom: '0px',\n-                              overflow: 'hidden',\n-                              overflowWrap: 'break-word',\n-                              wordWrap: 'break-word',\n-                              whiteSpace: 'pre-wrap',\n-                              minHeight: '32px',\n-                              height: 'auto'\n-                            }}\n-                          />\n-\n-                        </div>\n-                      );\n-                    } else if (cell.type === 'widget' && cell.widgetType === 'chat') {\n-                      return (\n-                        <ChatWidgetUI\n-                          key={cell.id}\n-                          data={cell.data as ChatWidgetData}\n-                          onSendMessage={(msg) => handleChatSend(cell.id, msg)}\n-                          onDelete={() => handleChatDelete(cell.id)}\n-                          isProcessing={chatProcessing.has(cell.id)}\n-                        />\n-                      );\n-                    }\n-                    return null;\n-                  })}\n-\n-                  {/* @@@ Inline Inspiration */}\n-                  <InspirationHint\n-                    inspiration={currentInspiration}\n-                    isDisappearing={inspirationDisappearing}\n-                    isAppearing={inspirationAppearing}\n-                  />\n-                </div>\n-\n-                {/* Comments layer (absolute positioned) - hide on mobile */}\n-                {!isMobile && (() => {\n-                  // @@@ Calculate global max line width across all groups for alignment\n-                  const globalMaxLineWidth = Math.max(\n-                    0,\n-                    ...Array.from(commentGroups.values()).map(g => g.maxLineWidth)\n-                  );\n-\n-                  return Array.from(commentGroups.entries()).map(([groupKey, group]) => {\n-                    const currentIndex = groupPages.get(groupKey) || 0;\n-\n-                    // @@@ Get the specific textarea for this group's cell\n-                    const cellTextarea = textareaRefs.current.get(group.cellId);\n-                    if (!cellTextarea) return null;\n-\n-                    // @@@ Use offsetTop relative to the content container (with maxWidth: 600px)\n-                    // This div is at line 1031 with position: relative\n-                    const cellWrapper = cellTextarea.parentElement; // The div with position: relative\n-                    if (!cellWrapper) return null;\n-\n-                    const cellOffsetTop = cellWrapper.offsetTop;\n-\n-                    // @@@ Calculate line height from textarea styles\n-                    const computedStyle = window.getComputedStyle(cellTextarea);\n-                    const fontSize = parseFloat(computedStyle.fontSize) || 18;\n-                    const lineHeightRatio = parseFloat(computedStyle.lineHeight) / fontSize || 1.8;\n-                    const lineHeight = fontSize * lineHeightRatio;\n-\n-                    const containerPadding = parseFloat(window.getComputedStyle(cellWrapper.parentElement || cellWrapper).paddingLeft) || 20;\n-                    const gap = Math.max(30, window.innerWidth * 0.02);\n-                    // @@@ Use global max width when aligned, otherwise use group's max width\n-                    const lineWidthToUse = commentsAligned ? globalMaxLineWidth : group.maxLineWidth;\n-                    const leftPosition = containerPadding + lineWidthToUse + gap + (lineHeight * 2);  // @@@ Move right 2 line heights\n-\n-                    // @@@ Position using offsetTop (scroll-independent)\n-                    // centerY is already relative to cell's top, so just add:\n-                    // - cellOffsetTop: position relative to content container\n-                    // - 20px: scroll container top padding\n-                    // - 32px: StateChooser fixed height\n-                    // - 10.8px: StateChooser marginBottom\n-                    // - subtract lineHeight * 2: move up to top of 2-line block\n-                    // - subtract lineHeight / 3: additional upward adjustment\n-                    const topPosition = cellOffsetTop + group.centerY + 20 + 32 + 10.8 - lineHeight * 2 - (lineHeight / 3);\n-\n-                    // @@@ If expanded, use the expanded comment ID (stable), otherwise use current index\n-                    const isExpanded = group.comments.some(c => c.id === expandedCommentId);\n-                    const displayedComment = isExpanded\n-                      ? group.comments.find(c => c.id === expandedCommentId)!\n-                      : group.comments[currentIndex];\n-                    const displayedIndex = isExpanded\n-                      ? group.comments.findIndex(c => c.id === expandedCommentId)\n-                      : currentIndex;\n-\n-                    if (!displayedComment) return null;\n-\n-                    return (\n-                      <CommentGroupCard\n-                        key={groupKey}\n-                        comments={group.comments}\n-                        currentIndex={displayedIndex}\n-                        onNavigate={(idx) => handleGroupNavigate(groupKey, idx)}\n-                        position={{\n-                          top: topPosition,\n-                          left: leftPosition\n-                        }}\n-                        isExpanded={isExpanded}\n-                        onToggleExpand={() => {\n-                          setExpandedCommentId(prev => {\n-                            const anyExpanded = group.comments.some(c => c.id === prev);\n-                            if (anyExpanded) return null;\n-                            return displayedComment.id;\n-                          });\n-                        }}\n-                        onStar={() => handleCommentStar(displayedComment.id)}\n-                        onKill={() => handleCommentKill(displayedComment.id)}\n-                        onSendChatMessage={(msg) => handleCommentChatSend(displayedComment.id, msg)}\n-                        isChatProcessing={commentChatProcessing.has(displayedComment.id)}\n-                        voiceConfigs={voiceConfigs}\n-                      />\n-                    );\n-                  });\n-                })()}\n-\n-                {/* @@@ Mobile comment popup - show when cursor is in highlighted area */}\n-                {isMobile && mobileActiveComment && (\n-                  <div style={{\n-                    position: 'fixed',\n-                    bottom: '20px',\n-                    left: '10px',\n-                    right: '10px',\n-                    background: '#fff',\n-                    border: '2px solid #ddd',\n-                    borderRadius: '12px',\n-                    padding: '16px',\n-                    boxShadow: '0 8px 24px rgba(0,0,0,0.2)',\n-                    zIndex: 100,\n-                    fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-                    animation: 'slideInFromBottom 0.3s ease-out'\n-                  }}>\n-                    <div style={{\n-                      display: 'flex',\n-                      gap: '12px',\n-                      alignItems: 'flex-start'\n-                    }}>\n-                      {(() => {\n-                        const Icon = iconMap[mobileActiveComment.icon as keyof typeof iconMap] || FaBrain;\n-                        const colors = colorMap[mobileActiveComment.color] || colorMap.blue;\n-                        return (\n-                          <>\n-                            <Icon size={20} color={colors.text} style={{ marginTop: '2px', flexShrink: 0 }} />\n-                            <div style={{ flex: 1 }}>\n-                              <div style={{ fontWeight: 600, fontSize: '16px', color: colors.text, marginBottom: '8px' }}>\n-                                {mobileActiveComment.voice}\n-                              </div>\n-                              <div style={{ fontSize: '15px', lineHeight: '1.5', color: '#444' }}>\n-                                {mobileActiveComment.comment}\n-                              </div>\n-                            </div>\n-                          </>\n-                        );\n-                      })()}\n-                    </div>\n-                  </div>\n-                )}\n-              </div>\n-\n-              {/* Debug stats bar at bottom */}\n-              <div style={{\n-                position: 'fixed',\n-                bottom: 0,\n-                left: 0,\n-                right: 0,\n-                padding: '10px 20px',\n-                borderTop: '1px solid #e0e0e0',\n-                fontSize: '12px',\n-                color: '#666',\n-                display: 'flex',\n-                gap: '20px',\n-                backgroundColor: '#fafafa',\n-                zIndex: 50\n-              }}>\n-                <span>Weight: {lastEntry?.weight || 0}</span>\n-                <span>Applied: {appliedComments.length}</span>\n-                <span>Groups: {commentGroups.size}</span>\n-                {showEnergyBar && (\n-                  <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>\n-                    <span>Energy:</span>\n-                    <span\n-                      key={energyPulseKey}\n-                      style={{\n-                        display: 'inline-flex',\n-                        padding: '2px',\n-                        borderRadius: '999px',\n-                        animation: energyPulseKey > 0 ? 'energyPulse 0.6s ease-out' : 'none'\n-                      }}\n-                    >\n-                      <span style={{\n-                        width: '120px',\n-                        height: '8px',\n-                        borderRadius: '999px',\n-                        background: 'rgba(102, 102, 102, 0.2)',\n-                        overflow: 'hidden',\n-                        display: 'block'\n-                      }}>\n-                        <span\n-                          style={{\n-                            display: 'block',\n-                            height: '100%',\n-                            width: `${Math.round(energyProgress * 100)}%`,\n-                            background: '#666',\n-                            borderRadius: '999px',\n-                            transition: 'width 0.25s ease',\n-                          }}\n-                        />\n-                      </span>\n-                    </span>\n-                  </span>\n-                )}\n-              </div>\n-            </div>\n-          </div>\n-\n-          {/* Agent dropdown */}\n-          {dropdownVisible && (\n-            <AgentDropdown\n-              voices={voiceConfigs}\n-              position={dropdownPosition}\n-              onSelect={handleAgentSelect}\n-              onClose={() => setDropdownVisible(false)}\n-            />\n-          )}\n-        </div>\n-      )}\n-      {currentView === 'decks' && (\n-        <div style={{\n-          position: 'fixed',\n-          top: 48,\n-          left: 0,\n-          right: 0,\n-          bottom: 0,\n-          background: '#f8f0e6',\n-          display: 'flex',\n-          overflow: 'hidden'\n-        }}>\n-          <DeckManager onUpdate={async () => {\n-            // @@@ Reload voice configs from deck system\n-            console.log('Deck system updated, reloading voices...');\n-            const updatedVoices = await loadVoicesFromDecks();\n-            setVoiceConfigs(updatedVoices);\n-\n-            if (engineRef.current) {\n-              engineRef.current.setVoiceConfigs(updatedVoices);\n-            }\n-\n-            console.log(`\u2705 Loaded ${Object.keys(updatedVoices).length} enabled voices`);\n-          }} />\n-        </div>\n-      )}\n-      {currentView === 'settings' && (\n-        <div style={{\n-          flex: 1,\n-          display: 'flex',\n-          justifyContent: 'center',\n-          padding: '60px 40px 120px 40px',\n-          overflow: 'auto',\n-          position: 'fixed',\n-          top: 48,\n-          left: 0,\n-          right: 0,\n-          bottom: 0,\n-          background: '#f8f0e6'\n-        }}>\n-          <div style={{\n-            maxWidth: 800,\n-            width: '100%'\n-          }}>\n-            <section style={{ marginBottom: 48 }}>\n-              <h2 style={{\n-                fontSize: 24,\n-                fontWeight: 600,\n-                color: '#2c2c2c',\n-                marginBottom: 16,\n-                fontFamily: 'Georgia, \"Times New Roman\", serif'\n-              }}>\n-                {t('nav.settings')}\n-              </h2>\n-              <div style={{\n-                background: 'rgba(255, 255, 255, 0.5)',\n-                border: '1px solid #d0c4b0',\n-                borderRadius: 8,\n-                padding: 24\n-              }}>\n-                <div style={{ marginBottom: 12 }}>\n-                  <label style={{\n-                    fontSize: 14,\n-                    fontWeight: 500,\n-                    color: '#2c2c2c',\n-                    marginBottom: 6,\n-                    display: 'block',\n-                    fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif'\n-                  }}>\n-                    Language / \u8bed\u8a00\n-                  </label>\n-                  <p style={{\n-                    margin: 0,\n-                    fontSize: 13,\n-                    color: '#666',\n-                    fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif'\n-                  }}>\n-                    {t('settings.language.description')}\n-                  </p>\n-                </div>\n-\n-                <div style={{ display: 'flex', gap: 12, flexWrap: 'wrap' }}>\n-                  {LANGUAGE_CODES.map(code => {\n-                    const isActive = currentLanguage === code;\n-                    return (\n-                      <button\n-                        key={code}\n-                        onClick={() => handleUILanguageChange(code)}\n-                        style={{\n-                          padding: '8px 16px',\n-                          background: isActive ? '#2c2c2c' : 'transparent',\n-                          color: isActive ? '#fff' : '#666',\n-                          border: isActive ? 'none' : '1px solid #d0c4b0',\n-                          borderRadius: 6,\n-                          fontSize: 14,\n-                          fontWeight: 500,\n-                          cursor: isActive ? 'default' : 'pointer',\n-                          fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif',\n-                          boxShadow: isActive ? '0 2px 8px rgba(0,0,0,0.15)' : 'none',\n-                          transition: 'all 0.2s ease'\n-                        }}\n-                      >\n-                        {t(`settings.language.options.${code}`)}\n-                      </button>\n-                    );\n-                  })}\n-                </div>\n-\n-                <p style={{\n-                  marginTop: 12,\n-                  fontSize: 12,\n-                  color: '#8a7a69',\n-                  fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif'\n-                }}>\n-                  {t('settings.language.preview')}\n-                </p>\n-\n-                <div style={{\n-                  marginTop: 20,\n-                  paddingTop: 16,\n-                  borderTop: '1px dashed #d0c4b0'\n-                }}>\n-                  <div style={{\n-                    display: 'flex',\n-                    alignItems: 'center',\n-                    justifyContent: 'space-between',\n-                    gap: 12\n-                  }}>\n-                    <div>\n-                      <div style={{\n-                        fontSize: 14,\n-                        fontWeight: 500,\n-                        color: '#2c2c2c',\n-                        fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif'\n-                      }}>\n-                        Energy Bar / \u80fd\u91cf\u6761\n-                      </div>\n-                      <div style={{\n-                        marginTop: 6,\n-                        fontSize: 12,\n-                        color: '#666',\n-                        fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif'\n-                      }}>\n-                        Toggle the energy progress bar in the bottom stats line.\n-                      </div>\n-                    </div>\n-                    <button\n-                      type=\"button\"\n-                      onClick={() => setShowEnergyBar(prev => !prev)}\n-                      aria-pressed={showEnergyBar}\n-                      style={{\n-                        width: 44,\n-                        height: 24,\n-                        borderRadius: 999,\n-                        border: showEnergyBar ? '1px solid #2c2c2c' : '1px solid #d0c4b0',\n-                        background: showEnergyBar ? '#2c2c2c' : 'transparent',\n-                        cursor: 'pointer',\n-                        position: 'relative',\n-                        padding: 0,\n-                        transition: 'all 0.2s ease'\n-                      }}\n-                    >\n-                      <span style={{\n-                        position: 'absolute',\n-                        top: 3,\n-                        left: showEnergyBar ? 24 : 4,\n-                        width: 16,\n-                        height: 16,\n-                        borderRadius: '50%',\n-                        background: showEnergyBar ? '#fff' : '#8a7a69',\n-                        transition: 'all 0.2s ease'\n-                      }} />\n-                    </button>\n-                  </div>\n-                </div>\n-              </div>\n-            </section>\n-\n-            {/* About Content */}\n-            <AboutView />\n-          </div>\n-        </div>\n-      )}\n-      {/* @@@ Always render timeline to pre-load data and position scroll */}\n-      <div style={{\n-        position: 'fixed',\n-        top: 48,\n-        left: 0,\n-        right: 0,\n-        bottom: 0,\n-        background: '#f8f0e6',\n-        display: currentView === 'timeline' ? 'flex' : 'none',\n-        overflow: 'hidden'\n-      }}>\n-        <CollectionsView\n-          isVisible={currentView === 'timeline'}\n-          voiceConfigs={voiceConfigs}\n-          timezone={userTimezone}\n-        />\n-      </div>\n-      {currentView === 'analysis' && (\n-        <div style={{\n-          position: 'fixed',\n-          top: 48,\n-          left: 0,\n-          right: 0,\n-          bottom: 0,\n-          background: '#f8f0e6',\n-          display: 'flex',\n-          overflow: 'hidden'\n-        }}>\n-          <AnalysisView />\n-        </div>\n-      )}\n-\n-      {/* Warning Dialog */}\n-      {showWarning && (\n-        <div style={{\n-          position: 'fixed',\n-          top: 0,\n-          left: 0,\n-          right: 0,\n-          bottom: 0,\n-          backgroundColor: 'rgba(0, 0, 0, 0.5)',\n-          display: 'flex',\n-          alignItems: 'center',\n-          justifyContent: 'center',\n-          zIndex: 1000\n-        }}>\n-          <div style={{\n-            backgroundColor: '#fffef9',\n-            border: '2px solid #d0c4b0',\n-            borderRadius: '8px',\n-            padding: '32px',\n-            maxWidth: '400px',\n-            boxShadow: '0 8px 24px rgba(0, 0, 0, 0.2)',\n-            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n-          }}>\n-            <h2 style={{\n-              margin: '0 0 16px 0',\n-              fontSize: '20px',\n-              color: '#333',\n-              fontWeight: 600\n-            }}>\n-              Start Fresh?\n-            </h2>\n-            <p style={{\n-              margin: '0 0 24px 0',\n-              fontSize: '16px',\n-              lineHeight: '1.6',\n-              color: '#555'\n-            }}>\n-              This will delete all your current writing and comments. This action cannot be undone.\n-            </p>\n-            <div style={{\n-              display: 'flex',\n-              gap: '12px',\n-              justifyContent: 'space-between'\n-            }}>\n-              <button\n-                onClick={handleConfirmStartFresh}\n-                style={{\n-                  padding: '8px 20px',\n-                  border: '1px solid #d44',\n-                  background: '#d44',\n-                  borderRadius: '4px',\n-                  cursor: 'pointer',\n-                  fontSize: '15px',\n-                  fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-                  color: '#fff',\n-                  fontWeight: 600,\n-                  transition: 'all 0.2s'\n-                }}\n-                onMouseEnter={(e) => {\n-                  e.currentTarget.style.backgroundColor = '#c33';\n-                }}\n-                onMouseLeave={(e) => {\n-                  e.currentTarget.style.backgroundColor = '#d44';\n-                }}\n-              >\n-                Delete All\n-              </button>\n-              <button\n-                onClick={() => setShowWarning(false)}\n-                style={{\n-                  padding: '8px 20px',\n-                  border: '1px solid #d0c4b0',\n-                  background: '#fff',\n-                  borderRadius: '4px',\n-                  cursor: 'pointer',\n-                  fontSize: '15px',\n-                  fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-                  color: '#333',\n-                  transition: 'all 0.2s'\n-                }}\n-                onMouseEnter={(e) => {\n-                  e.currentTarget.style.backgroundColor = '#f5f5f5';\n-                }}\n-                onMouseLeave={(e) => {\n-                  e.currentTarget.style.backgroundColor = '#fff';\n-                }}\n-              >\n-                Cancel\n-              </button>\n-            </div>\n-          </div>\n-        </div>\n-      )}\n-\n-      {/* Calendar Popup */}\n-      {showCalendarPopup && (\n-        <CalendarPopup\n-          onLoadEntry={handleLoadEntry}\n-          currentEntryId={state?.id}\n-          onEntryDeleted={handleCalendarEntryDeleted}\n-          onClose={() => setShowCalendarPopup(false)}\n-          timezone={userTimezone}\n-          initialDateKey={getLocalDayKey(state?.createdAt, userTimezone) ?? getTodayKeyInTimezone(userTimezone)}\n-        />\n-      )}\n-    </>\n-  );\n-}"
    }
  ]
}