{
  "cached_at": "2025-12-22T16:46:53.060763",
  "commit_sha": "b8ddd8cd3675184da6f5fe7113d7195a841677d5",
  "repo": "shuxueshuxue/ink-and-memory",
  "data": {
    "sha": "b8ddd8cd3675184da6f5fe7113d7195a841677d5",
    "node_id": "C_kwDOP2Zrm9oAKGI4ZGRkOGNkMzY3NTE4NGRhNmY1ZmU3MTEzZDcxOTVhODQxNjc3ZDU",
    "commit": {
      "author": {
        "name": "Shaobin-Jiang",
        "email": "shaobin-jiang@outlook.com",
        "date": "2025-12-02T07:11:56Z"
      },
      "committer": {
        "name": "Shaobin-Jiang",
        "email": "shaobin-jiang@outlook.com",
        "date": "2025-12-02T07:11:56Z"
      },
      "message": "voice input is entered directly",
      "tree": {
        "sha": "4c775814fdd5b7931a78dfef577cd25d48c9128a",
        "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/4c775814fdd5b7931a78dfef577cd25d48c9128a"
      },
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/b8ddd8cd3675184da6f5fe7113d7195a841677d5",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCAAdFiEEhfQW+O5+vUJlGXwjtnnMcOFZaR8FAmkukVIACgkQtnnMcOFZ\naR+dWQv+MAXKGq5NKov2+JaS6UEiUJzggp348IWn/j8h21CcIARA9j3PykVa8TZ/\nGcfBML5e1Fyj+okxR3rS94yIwo7f7NWCr5ldeHPKjBkWwXznbpdXz2EuNUHE54ei\nimtWY7ROioj++0vNz9NdrrBHi8Nqovkrqm6DSuYesCQrS9dsSxnYSTbBh+iC+mc/\nd6r9Gv1inzA8udmivISBW5repbwnS35gCp/z3RjbHWeFDe+L8Q3iZDXVP4txjFe+\nysQLZNw5Wfe3v1FafPEW/XUNFrcQyM+kA4oVgNxcxTeYCWB7LYZ5d0szApL92Rfm\n+ixuewrJRF8MZtytaCkA4wiCZ/jWAavQHfUfBh/r10hB83Sbfnk5PBshLhzCx8Ii\nAtixuDqHDI11lwIRXxFQdIrGA/sQQ8LMamYhIDFowN3CLyCo0KsD4cyRXK31mJGQ\ncTTHNAyfaTX78WWEFZzURhZ8f9jnoH8AoI2quyxdETOjQCyyxslgePO6ha9o+FqS\n/kGatC/e\n=n3f4\n-----END PGP SIGNATURE-----",
        "payload": "tree 4c775814fdd5b7931a78dfef577cd25d48c9128a\nparent a1e1a0b7f8fa00b8fc5cfa1d2ed600a525c9dea1\nauthor Shaobin-Jiang <shaobin-jiang@outlook.com> 1764659516 +0800\ncommitter Shaobin-Jiang <shaobin-jiang@outlook.com> 1764659516 +0800\n\nvoice input is entered directly\n",
        "verified_at": "2025-12-02T07:12:22Z"
      }
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/b8ddd8cd3675184da6f5fe7113d7195a841677d5",
    "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/b8ddd8cd3675184da6f5fe7113d7195a841677d5",
    "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/b8ddd8cd3675184da6f5fe7113d7195a841677d5/comments",
    "author": {
      "login": "Shaobin-Jiang",
      "id": 74588034,
      "node_id": "MDQ6VXNlcjc0NTg4MDM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74588034?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Shaobin-Jiang",
      "html_url": "https://github.com/Shaobin-Jiang",
      "followers_url": "https://api.github.com/users/Shaobin-Jiang/followers",
      "following_url": "https://api.github.com/users/Shaobin-Jiang/following{/other_user}",
      "gists_url": "https://api.github.com/users/Shaobin-Jiang/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Shaobin-Jiang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Shaobin-Jiang/subscriptions",
      "organizations_url": "https://api.github.com/users/Shaobin-Jiang/orgs",
      "repos_url": "https://api.github.com/users/Shaobin-Jiang/repos",
      "events_url": "https://api.github.com/users/Shaobin-Jiang/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Shaobin-Jiang/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "committer": {
      "login": "Shaobin-Jiang",
      "id": 74588034,
      "node_id": "MDQ6VXNlcjc0NTg4MDM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74588034?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Shaobin-Jiang",
      "html_url": "https://github.com/Shaobin-Jiang",
      "followers_url": "https://api.github.com/users/Shaobin-Jiang/followers",
      "following_url": "https://api.github.com/users/Shaobin-Jiang/following{/other_user}",
      "gists_url": "https://api.github.com/users/Shaobin-Jiang/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Shaobin-Jiang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Shaobin-Jiang/subscriptions",
      "organizations_url": "https://api.github.com/users/Shaobin-Jiang/orgs",
      "repos_url": "https://api.github.com/users/Shaobin-Jiang/repos",
      "events_url": "https://api.github.com/users/Shaobin-Jiang/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Shaobin-Jiang/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a1e1a0b7f8fa00b8fc5cfa1d2ed600a525c9dea1",
        "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/a1e1a0b7f8fa00b8fc5cfa1d2ed600a525c9dea1",
        "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/a1e1a0b7f8fa00b8fc5cfa1d2ed600a525c9dea1"
      }
    ],
    "stats": {
      "total": 370,
      "additions": 166,
      "deletions": 204
    },
    "files": [
      {
        "sha": "622bd95c65bdb4fe99d3c31be53520b680b448ae",
        "filename": "frontend/src/App.css",
        "status": "modified",
        "additions": 4,
        "deletions": 39,
        "changes": 43,
        "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/b8ddd8cd3675184da6f5fe7113d7195a841677d5/frontend%2Fsrc%2FApp.css",
        "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/b8ddd8cd3675184da6f5fe7113d7195a841677d5/frontend%2Fsrc%2FApp.css",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2FApp.css?ref=b8ddd8cd3675184da6f5fe7113d7195a841677d5",
        "patch": "@@ -265,45 +265,10 @@\n }\n \n .voice-input-modal {\n-  background-color: #25252588;\n-  display: flex;\n-  align-items: center;\n-  justify-content: center;\n-  height: 100vh;\n-  width: 100vw;\n+  height: calc(100vh - 85px);\n+  width: calc(100vw - 80px);\n   position: fixed;\n-  top: 0;\n-  left: 0;\n+  top: 49px;\n+  left: 80px;\n   z-index: 99999;\n }\n-\n-.voice-input-container {\n-  font-family: 'Excalifont', 'Xiaolai', 'Georgia', serif;\n-  background-color: #ddd;\n-  border-radius: 10px;\n-  width: 50%;\n-  height: 50%;\n-}\n-\n-.voice-input-result {\n-  font-size: 1.25rem;\n-  box-sizing: border-box;\n-  width: 100%;\n-  height: 80%;\n-  padding: 20px;\n-  overflow: auto;\n-}\n-\n-.voice-input-button-group {\n-  display: flex;\n-  align-items: center;\n-  justify-content: space-around;\n-  width: 100%;\n-  height: 18%;\n-}\n-\n-.voice-input-button-group button {\n-  font-family: 'Excalifont', 'Xiaolai', 'Georgia', serif;\n-  padding: 5px 10px;\n-  font-size: 1.25rem;\n-}"
      },
      {
        "sha": "500ec7fb748599be65aac8e24c51c2f477856c8d",
        "filename": "frontend/src/App.tsx",
        "status": "modified",
        "additions": 162,
        "deletions": 165,
        "changes": 327,
        "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/b8ddd8cd3675184da6f5fe7113d7195a841677d5/frontend%2Fsrc%2FApp.tsx",
        "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/b8ddd8cd3675184da6f5fe7113d7195a841677d5/frontend%2Fsrc%2FApp.tsx",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2FApp.tsx?ref=b8ddd8cd3675184da6f5fe7113d7195a841677d5",
        "patch": "@@ -47,15 +47,17 @@ function LeftToolbar({\n   onToggleAlign,\n   onShowCalendar,\n   onSaveToday,\n-  onStartTalking,\n-  isAligned\n+  onToggleTalking,\n+  isAligned,\n+  isTalking\n }: {\n   onInsertAgent: () => void;\n   onToggleAlign: () => void;\n   onShowCalendar: () => void;\n   onSaveToday: () => void;\n-  onStartTalking: () => void;\n+  onToggleTalking: () => void;\n   isAligned: boolean;\n+  isTalking: boolean;\n }) {\n   return (\n     <div style={{\n@@ -192,28 +194,28 @@ function LeftToolbar({\n \n       {/* Align button - last */}\n       <button\n-        onClick={onStartTalking}\n+        onClick={onToggleTalking}\n         title=\"Voice Input\"\n         style={{\n           width: '36px',\n           height: '36px',\n           border: 'none',\n           borderRadius: '4px',\n-          backgroundColor: isAligned ? '#e3f2fd' : '#fff',\n+          backgroundColor: isTalking ? '#e3f2fd' : '#fff',\n           cursor: 'pointer',\n           display: 'flex',\n           alignItems: 'center',\n           justifyContent: 'center',\n           transition: 'all 0.2s ease'\n         }}\n         onMouseEnter={(e) => {\n-          e.currentTarget.style.backgroundColor = isAligned ? '#bbdefb' : '#f0f0f0';\n+          e.currentTarget.style.backgroundColor = isTalking ? '#bbdefb' : '#f0f0f0';\n         }}\n         onMouseLeave={(e) => {\n-          e.currentTarget.style.backgroundColor = isAligned ? '#e3f2fd' : '#fff';\n+          e.currentTarget.style.backgroundColor = isTalking ? '#e3f2fd' : '#fff';\n         }}\n       >\n-        <FaMicrophone size={18} color={isAligned ? '#1976d2' : '#333'} />\n+        <FaMicrophone size={18} color={isTalking ? '#1976d2' : '#333'} />\n       </button>\n     </div>\n   );\n@@ -325,6 +327,15 @@ export default function App() {\n   // @@@ Comment alignment state\n   const [commentsAligned, setCommentsAligned] = useState(false);\n \n+  // @@@ Voice input enabled\n+  const [userTalking, setUserTalking] = useState(false);\n+  const focusedTextarea = useRef<HTMLTextAreaElement | undefined>(null);\n+  const focusedCell = useRef<TextCell | undefined>(null);\n+  const lastUpdateTime = useRef<number>(0);\n+  const voiceInputNewContent = useRef<string>('');\n+\n+  const stopTalking = useRef(() => {setUserTalking(false)});\n+\n   // @@@ Comment expansion state (for action toolbar + chat dropdown)\n   const [expandedCommentId, setExpandedCommentId] = useState<string | null>(null);\n   const [commentChatProcessing, setCommentChatProcessing] = useState<Set<string>>(new Set());\n@@ -1440,148 +1451,150 @@ export default function App() {\n     }\n   }, [ensureStateForPersistence, getFirstLineFromState, isAuthenticated, saveSessionToDatabase]);\n \n-  const handleStartTalking = useCallback(async () => {\n-    if (!textareaRefs.current) return;\n-    if (!isAuthenticated) {\n-      const toast = document.createElement('div');\n-      toast.textContent = 'Please sign in to enable voice input';\n-      toast.style.cssText = `\n-        position: fixed;\n-        top: 70px;\n-        right: 20px;\n-        background: #f44336;\n-        color: white;\n-        padding: 12px 20px;\n-        borderRadius: 6px;\n-        fontSize: 14px;\n-        fontFamily: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto;\n-        zIndex: 10000;\n-        boxShadow: 0 4px 12px rgba(0,0,0,0.15);\n-      `;\n-      document.body.appendChild(toast);\n-      setTimeout(() => {\n-        toast.style.opacity = '0';\n-        toast.style.transition = 'opacity 0.3s';\n-        setTimeout(() => document.body.removeChild(toast), 300);\n-      }, 2000);\n-      return;\n+  useEffect(() => {\n+    lastUpdateTime.current = performance.now();\n+    if (userTalking) {\n+      startTalking();\n+    } else {\n+      stopTalking.current();\n     }\n \n-    let voiceInputModal: HTMLDivElement = document.createElement('div');\n-    voiceInputModal.className = 'voice-input-modal';\n-    document.body.append(voiceInputModal);\n-\n-    let voiceInputContainer: HTMLDivElement = document.createElement('div');\n-    voiceInputContainer.className = 'voice-input-container';\n-    voiceInputModal.append(voiceInputContainer);\n-\n-    let voiceInputResult: HTMLParagraphElement = document.createElement('div');\n-    voiceInputResult.className = 'voice-input-result';\n-    voiceInputContainer.append(voiceInputResult);\n-\n-    let btnGroup: HTMLDivElement = document.createElement('div');\n-    btnGroup.className = 'voice-input-button-group';\n-    voiceInputContainer.append(btnGroup);\n-\n-    let startBtn: HTMLButtonElement = document.createElement('button');\n-    startBtn.innerText = 'Start';\n-\n-    let stopBtn: HTMLButtonElement = document.createElement('button');\n-    stopBtn.innerText = 'Pause';\n-    stopBtn.disabled = true;\n-\n-    let applyBtn: HTMLButtonElement = document.createElement('button');\n-    applyBtn.innerText = 'Apply';\n-    applyBtn.disabled = true;\n-\n-    let cancelBtn: HTMLButtonElement = document.createElement('button');\n-    cancelBtn.innerText = 'Cancel';\n-\n-    btnGroup.append(startBtn);\n-    btnGroup.append(stopBtn);\n-    btnGroup.append(applyBtn);\n-    btnGroup.append(cancelBtn);\n+    async function startTalking() {\n+      try {\n+        let audioCtx: AudioContext;\n+        let stream: MediaStream;\n+        let processor: ScriptProcessorNode;\n+        let source: MediaStreamAudioSourceNode;\n+        let ws: WebSocket;\n+        const targetSampleRate = 16000;\n+\n+        stopTalking.current = function () {\n+          document.querySelector('.voice-input-modal')?.remove();\n+          processor?.disconnect();\n+          source?.disconnect();\n+          audioCtx?.close();\n+          stream?.getTracks().forEach(t => t.stop());\n+          ws?.close();\n+        }\n \n-    try {\n-      let audioCtx: AudioContext;\n-      let stream: MediaStream;\n-      let processor: ScriptProcessorNode;\n-      let source: MediaStreamAudioSourceNode;\n-      let ws: WebSocket;\n-      const targetSampleRate = 16000;\n-\n-      let sentences: Array<string> = [];\n-      let sentenceId: number = -1;\n-\n-      function floatTo16BitPCM(float32Array: Float32Array): ArrayBuffer {\n-        const buffer = new ArrayBuffer(float32Array.length * 2);\n-        const view = new DataView(buffer);\n-        let offset = 0;\n-        for (let i = 0; i < float32Array.length; i++, offset += 2) {\n-          let s = Math.max(-1, Math.min(1, float32Array[i]));\n-          view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);\n+        if (!engineRef.current) {\n+          throw new Error('engineRef.current is empty');\n         }\n-        return buffer;\n-      }\n+        focusedCell.current = [...engineRef.current.getState().cells].reverse().find(c => c.type === 'text');\n+        focusedTextarea.current = textareaRefs.current.get(focusedCell.current?.id ?? '');\n \n-      function downsampleBuffer(buffer: Float32Array, inSampleRate: number, outSampleRate: number): Float32Array {\n-        if (outSampleRate === inSampleRate) {\n-          return buffer;\n+        if (!focusedTextarea.current || !focusedCell.current) {\n+          throw new Error('Cannot find focused cell');\n         }\n-        if (outSampleRate > inSampleRate) {\n-          console.warn(\"downsampleBuffer: target sample rate is higher than input, returning original\");\n+\n+        const currentContent = focusedCell.current.content;\n+        const cursorPos = focusedTextarea.current.selectionEnd;\n+        const contentBefore = currentContent.slice(0, cursorPos);\n+        const contentAfter = currentContent.slice(cursorPos);\n+\n+        let sentences: Array<string> = [];\n+        let sentenceId: number = -1;\n+\n+        function floatTo16BitPCM(float32Array: Float32Array): ArrayBuffer {\n+          const buffer = new ArrayBuffer(float32Array.length * 2);\n+          const view = new DataView(buffer);\n+          let offset = 0;\n+          for (let i = 0; i < float32Array.length; i++, offset += 2) {\n+            let s = Math.max(-1, Math.min(1, float32Array[i]));\n+            view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);\n+          }\n           return buffer;\n         }\n-        const sampleRateRatio = inSampleRate / outSampleRate;\n-        const newLength = Math.round(buffer.length / sampleRateRatio);\n-        const result = new Float32Array(newLength);\n-        let offsetResult = 0;\n-        let offsetBuffer = 0;\n-        while (offsetResult < result.length) {\n-          const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);\n-          let accum = 0, count = 0;\n-          for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {\n-            accum += buffer[i];\n-            count++;\n+\n+        function downsampleBuffer(buffer: Float32Array, inSampleRate: number, outSampleRate: number): Float32Array {\n+          if (outSampleRate === inSampleRate) {\n+            return buffer;\n+          }\n+          if (outSampleRate > inSampleRate) {\n+            console.warn(\"downsampleBuffer: target sample rate is higher than input, returning original\");\n+            return buffer;\n+          }\n+          const sampleRateRatio = inSampleRate / outSampleRate;\n+          const newLength = Math.round(buffer.length / sampleRateRatio);\n+          const result = new Float32Array(newLength);\n+          let offsetResult = 0;\n+          let offsetBuffer = 0;\n+          while (offsetResult < result.length) {\n+            const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);\n+            let accum = 0, count = 0;\n+            for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {\n+              accum += buffer[i];\n+              count++;\n+            }\n+            result[offsetResult] = count ? accum / count : 0;\n+            offsetResult++;\n+            offsetBuffer = nextOffsetBuffer;\n           }\n-          result[offsetResult] = count ? accum / count : 0;\n-          offsetResult++;\n-          offsetBuffer = nextOffsetBuffer;\n+          return result;\n         }\n-        return result;\n-      }\n \n-      async function start() {\n-        startBtn.disabled = true;\n-        stopBtn.disabled = false;\n-        applyBtn.disabled = false;\n+        let voiceInputModal: HTMLDivElement = document.createElement('div');\n+        voiceInputModal.className = 'voice-input-modal';\n+        document.body.append(voiceInputModal);\n \n         ws = new WebSocket('ws://127.0.0.1:8765/ws/speech-recognition');\n         ws.binaryType = 'arraybuffer';\n         ws.onerror = (e) => {\n           console.error('WS err', e);\n         };\n         ws.onmessage = (evt) => {\n+          let now = performance.now();\n+          if (now - lastUpdateTime.current < 300) {\n+            return;\n+          }\n+          lastUpdateTime.current = now;\n           try {\n+            if (!engineRef.current || !focusedCell.current || !focusedTextarea.current) {\n+              throw new Error('Lost focus');\n+            }\n+\n             const data = JSON.parse(evt.data);\n             let id = data.id;\n             if (id != sentenceId) {\n               sentenceId = id;\n               sentences.push('');\n             }\n             sentences[sentences.length - 1] = data.sentence;\n-            voiceInputResult.innerHTML = sentences.map(v => `<p>${v}</p>`).join('');\n+\n+            voiceInputNewContent.current = contentBefore + sentences.join('') + contentAfter;\n+            engineRef.current.updateTextCell(focusedCell.current.id, voiceInputNewContent.current);\n+            // engineRef.current.updateTextCell(focusedCell.current.id, 'Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world Hello world ');\n+\n+            // Postpone setting height\n+            setTimeout(() => {\n+              if (!engineRef.current) {\n+                return;\n+              }\n+              focusedCell.current = [...engineRef.current.getState().cells].reverse().find(c => c.type === 'text');\n+              focusedTextarea.current = textareaRefs.current.get(focusedCell.current?.id ?? '');\n+              if (focusedTextarea.current) {\n+                focusedTextarea.current.style.height = `${focusedTextarea.current.scrollHeight}px`;\n+              }\n+            }, 100);\n           } catch (e) {\n             console.log('Non-JSON message from server:', evt.data);\n           }\n         };\n \n+        let cb = () => {\n+          if (performance.now() - lastUpdateTime.current > 10000) {\n+            setUserTalking(false);\n+          } else {\n+            requestAnimationFrame(cb);\n+          }\n+        }\n+        requestAnimationFrame(cb);\n+\n         stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n         audioCtx = new window.AudioContext();\n         source = audioCtx.createMediaStreamSource(stream);\n \n         const inputSampleRate = audioCtx.sampleRate;\n-        console.log('input sample rate', inputSampleRate);\n \n         const bufferSize = 4096;\n         processor = audioCtx.createScriptProcessor(bufferSize, 1, 1);\n@@ -1597,59 +1610,41 @@ export default function App() {\n \n         source.connect(processor);\n         processor.connect(audioCtx.destination);\n-\n-        startBtn.disabled = true;\n-        stopBtn.disabled = false;\n-      }\n-\n-      function stop() {\n-        startBtn.disabled = false;\n-        stopBtn.disabled = true;\n-\n-        processor?.disconnect();\n-        source?.disconnect();\n-        audioCtx?.close();\n-        stream?.getTracks().forEach(t => t.stop());\n-        ws?.close();\n-        startBtn.disabled = false;\n-        stopBtn.disabled = true;\n-        sentenceId = -1;\n-      }\n-\n-      function apply() {\n-        stop();\n-        voiceInputModal.remove();\n-\n-        if (!engineRef.current) return;\n-        const lastTextCell = [...engineRef.current.getState().cells].reverse().find(c => c.type === 'text');\n-        if (!lastTextCell) return;\n-        const textarea = textareaRefs.current.get(lastTextCell.id);\n-        if (!textarea) return;\n-\n-        const currentContent = (lastTextCell as TextCell).content;\n-        const newContent = currentContent + sentences.join('');\n-        engineRef.current.updateTextCell(lastTextCell.id, newContent);\n-\n-        // Postpone setting of textarea height\n-        setTimeout(() => {\n-          textarea.style.height = `${textarea.scrollHeight}px`;\n-        }, 100);\n-      }\n-\n-      function cancel() {\n-        stop();\n-        voiceInputModal.remove();\n+      } catch (error) {\n+        console.error('Voice input encountered an unexpected error:', error);\n+        setUserTalking(false);\n       }\n+    }\n+  }, [userTalking]);\n \n-      startBtn.addEventListener('click', start);\n-      stopBtn.addEventListener('click', stop);\n-      applyBtn.addEventListener('click', apply);\n-      cancelBtn.addEventListener('click', cancel);\n-    \n-    } catch (error) {\n-      console.error('Voice input encountered an unexpected error:', error);\n-      voiceInputModal.remove();\n+  const handleToggleTalking = useCallback(async () => {\n+    if (!textareaRefs.current) return;\n+    if (!isAuthenticated) {\n+      const toast = document.createElement('div');\n+      toast.textContent = 'Please sign in to enable voice input';\n+      toast.style.cssText = `\n+        position: fixed;\n+        top: 70px;\n+        right: 20px;\n+        background: #f44336;\n+        color: white;\n+        padding: 12px 20px;\n+        borderRadius: 6px;\n+        fontSize: 14px;\n+        fontFamily: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto;\n+        zIndex: 10000;\n+        boxShadow: 0 4px 12px rgba(0,0,0,0.15);\n+      `;\n+      document.body.appendChild(toast);\n+      setTimeout(() => {\n+        toast.style.opacity = '0';\n+        toast.style.transition = 'opacity 0.3s';\n+        setTimeout(() => document.body.removeChild(toast), 300);\n+      }, 2000);\n+      return;\n     }\n+\n+    setUserTalking(prev => !prev);\n   }, [isAuthenticated]);\n \n   const handleLoadEntry = useCallback((entry: CalendarEntry) => {\n@@ -2348,8 +2343,9 @@ export default function App() {\n                 onToggleAlign={handleToggleAlign}\n                 onShowCalendar={() => setShowCalendarPopup(true)}\n                 onSaveToday={handleSaveToday}\n-                onStartTalking={handleStartTalking}\n+                onToggleTalking={handleToggleTalking}\n                 isAligned={commentsAligned}\n+                isTalking={userTalking}\n               />\n             </div>\n           )}\n@@ -2503,6 +2499,7 @@ export default function App() {\n                               }\n                             }}\n                             value={content}\n+                            onFocus={() => focusedCell.current = cell}\n                             onChange={(e) => handleTextChange(cell.id, e.target.value)}\n                             onCompositionStart={() => handleCompositionStart(cell.id)}\n                             onCompositionEnd={(e) => handleCompositionEnd(cell.id, e)}"
      }
    ]
  }
}