{
  "sha": "d0cbf1a66ea667569da3833d568e17a0efff2cf0",
  "node_id": "C_kwDOP2Zrm9oAKGQwY2JmMWE2NmVhNjY3NTY5ZGEzODMzZDU2OGUxN2EwZWZmZjJjZjA",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-12-09T11:06:12Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-12-09T11:06:12Z"
    },
    "message": "more efficient calendar",
    "tree": {
      "sha": "0290b4db20e6fc99520f4c82f73beef3365aa655",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/0290b4db20e6fc99520f4c82f73beef3365aa655"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/d0cbf1a66ea667569da3833d568e17a0efff2cf0",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/d0cbf1a66ea667569da3833d568e17a0efff2cf0",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/d0cbf1a66ea667569da3833d568e17a0efff2cf0",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/d0cbf1a66ea667569da3833d568e17a0efff2cf0/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "36b426fda4439133da58ae643f937a3d3bf23ce9",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/36b426fda4439133da58ae643f937a3d3bf23ce9",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/36b426fda4439133da58ae643f937a3d3bf23ce9"
    }
  ],
  "stats": {
    "total": 542,
    "additions": 372,
    "deletions": 170
  },
  "files": [
    {
      "sha": "7ee143b62663bde685ae355333cd7bbef73fc1a2",
      "filename": "backend/database.py",
      "status": "modified",
      "additions": 27,
      "deletions": 3,
      "changes": 30,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/d0cbf1a66ea667569da3833d568e17a0efff2cf0/backend%2Fdatabase.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/d0cbf1a66ea667569da3833d568e17a0efff2cf0/backend%2Fdatabase.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fdatabase.py?ref=d0cbf1a66ea667569da3833d568e17a0efff2cf0",
      "patch": "@@ -1071,16 +1071,40 @@ def get_session(user_id: int, session_id: str):\n         db.close()\n \n def list_sessions(user_id: int):\n-    \"\"\"List all sessions for a user.\"\"\"\n+    \"\"\"List all sessions for a user with a lightweight preview.\"\"\"\n     db = get_db()\n     try:\n         rows = db.execute(\"\"\"\n-        SELECT id, name, created_at, updated_at\n+        SELECT id, name, editor_state_json, created_at, updated_at\n         FROM user_sessions\n         WHERE user_id = ?\n         ORDER BY updated_at DESC\n         \"\"\", (user_id,)).fetchall()\n-        return [dict(row) for row in rows]\n+\n+        results = []\n+        for row in rows:\n+            first_line = \"\"\n+            try:\n+                state = json.loads(row[\"editor_state_json\"])\n+                first_text = next(\n+                    (c.get(\"content\", \"\").strip() for c in state.get(\"cells\", []) if c.get(\"type\") == \"text\" and c.get(\"content\")),\n+                    \"\"\n+                )\n+                if first_text:\n+                    first_line = first_text.split(\"\\n\")[0][:30]\n+            except Exception:\n+                first_line = \"\"\n+\n+            results.append(\n+                {\n+                    \"id\": row[\"id\"],\n+                    \"name\": row[\"name\"],\n+                    \"created_at\": row[\"created_at\"],\n+                    \"updated_at\": row[\"updated_at\"],\n+                    \"first_line\": first_line,\n+                }\n+            )\n+        return results\n     finally:\n         db.close()\n "
    },
    {
      "sha": "c16b975bf328219899bd89bdd0aaa21c6309fac1",
      "filename": "backend/server.py",
      "status": "modified",
      "additions": 29,
      "deletions": 3,
      "changes": 32,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/d0cbf1a66ea667569da3833d568e17a0efff2cf0/backend%2Fserver.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/d0cbf1a66ea667569da3833d568e17a0efff2cf0/backend%2Fserver.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fserver.py?ref=d0cbf1a66ea667569da3833d568e17a0efff2cf0",
      "patch": "@@ -9,6 +9,7 @@\n     time.tzset()\n \n import asyncio\n+from datetime import datetime\n import httpx\n from fastapi import FastAPI, HTTPException, Depends, Header, WebSocket\n from fastapi.middleware.cors import CORSMiddleware\n@@ -1256,15 +1257,40 @@ def import_calendar_recovery(\n     return {\"success\": True, \"imported\": {\"sessions\": len(sessions)}}\n \n \n+def _clean_timestamp(ts_raw: Optional[str]) -> Optional[datetime]:\n+    \"\"\"Best-effort ISO parser for timestamps stored in DB.\"\"\"\n+    if not ts_raw:\n+        return None\n+    try:\n+        cleaned = ts_raw.replace(\"Z\", \"+00:00\")\n+        if \"T\" not in cleaned and \" \" in cleaned:\n+            cleaned = cleaned.replace(\" \", \"T\")\n+        return datetime.fromisoformat(cleaned)\n+    except Exception:\n+        return None\n+\n+\n @app.get(\"/api/sessions\")\n-def list_sessions(current_user: dict = Depends(get_current_user)):\n+def list_sessions(timezone: str = \"Asia/Shanghai\", current_user: dict = Depends(get_current_user)):\n     \"\"\"\n     List all sessions for current user.\n-    Returns: Array of session metadata (without full editor state)\n+    Returns: Array of session metadata (without full editor state) plus local day key + first line.\n     \"\"\"\n     user_id = current_user[\"user_id\"]\n+    try:\n+        from zoneinfo import ZoneInfo\n+        tz = ZoneInfo(timezone)\n+    except Exception:\n+        raise HTTPException(status_code=400, detail=\"Invalid timezone\")\n+\n     sessions = database.list_sessions(user_id)\n-    return {\"sessions\": sessions}\n+    enriched = []\n+    for s in sessions:\n+        dt = _clean_timestamp(s.get(\"created_at\") or s.get(\"updated_at\"))\n+        date_key = dt.astimezone(tz).strftime(\"%Y-%m-%d\") if dt else None\n+        enriched.append({**s, \"date_key\": date_key})\n+\n+    return {\"sessions\": enriched}\n \n @app.get(\"/api/sessions/aggregate\")\n def get_sessions_aggregate(timezone: str = \"Asia/Shanghai\", current_user: dict = Depends(get_current_user)):"
    },
    {
      "sha": "835bbd67992f9691719799efa373e941ab7d7da4",
      "filename": "frontend/src/App.tsx",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/d0cbf1a66ea667569da3833d568e17a0efff2cf0/frontend%2Fsrc%2FApp.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/d0cbf1a66ea667569da3833d568e17a0efff2cf0/frontend%2Fsrc%2FApp.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2FApp.tsx?ref=d0cbf1a66ea667569da3833d568e17a0efff2cf0",
      "patch": "@@ -3028,6 +3028,7 @@ export default function App() {\n           onEntryDeleted={handleCalendarEntryDeleted}\n           onClose={() => setShowCalendarPopup(false)}\n           timezone={userTimezone}\n+          initialDateKey={getLocalDayKey(state?.createdAt, userTimezone) ?? getTodayKeyInTimezone(userTimezone)}\n         />\n       )}\n     </>"
    },
    {
      "sha": "619b54750dd00472c86c3821ef95dc5f3a651a20",
      "filename": "frontend/src/api/voiceApi.ts",
      "status": "modified",
      "additions": 7,
      "deletions": 3,
      "changes": 10,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/d0cbf1a66ea667569da3833d568e17a0efff2cf0/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/d0cbf1a66ea667569da3833d568e17a0efff2cf0/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fapi%2FvoiceApi.ts?ref=d0cbf1a66ea667569da3833d568e17a0efff2cf0",
      "patch": "@@ -390,10 +390,14 @@ export async function saveSession(sessionId: string, editorState: any, name?: st\n }\n \n /**\n- * List all sessions\n+ * List all sessions (metadata only). If timezone is provided, the backend will include a local-day key.\n  */\n-export async function listSessions(): Promise<any[]> {\n-  const response = await fetch(`${API_BASE}/api/sessions`, {\n+export async function listSessions(timezone?: string): Promise<any[]> {\n+  const url = timezone\n+    ? `${API_BASE}/api/sessions?timezone=${encodeURIComponent(timezone)}`\n+    : `${API_BASE}/api/sessions`;\n+\n+  const response = await fetch(url, {\n     headers: getAuthHeaders()\n   });\n "
    },
    {
      "sha": "9ef932681414b26d015d5a7948e779828d295ffe",
      "filename": "frontend/src/components/CalendarPopup.tsx",
      "status": "modified",
      "additions": 307,
      "deletions": 160,
      "changes": 467,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/d0cbf1a66ea667569da3833d568e17a0efff2cf0/frontend%2Fsrc%2Fcomponents%2FCalendarPopup.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/d0cbf1a66ea667569da3833d568e17a0efff2cf0/frontend%2Fsrc%2Fcomponents%2FCalendarPopup.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FCalendarPopup.tsx?ref=d0cbf1a66ea667569da3833d568e17a0efff2cf0",
      "patch": "@@ -8,67 +8,106 @@ import {\n   deleteEntry,\n   type CalendarEntry\n } from '../utils/calendarStorage';\n-import { loadSessionsGroupedByDate } from '../utils/sessionGrouping';\n import { useAuth } from '../contexts/AuthContext';\n+import { parseFlexibleTimestamp } from '../utils/timezone';\n \n interface Props {\n   onLoadEntry: (entry: CalendarEntry) => void;\n   onClose: () => void;\n   currentEntryId?: string | null;\n   onEntryDeleted?: (entryId: string) => void;\n   timezone: string;\n+  initialDateKey?: string | null;\n }\n \n-export default function CalendarPopup({ onLoadEntry, onClose, currentEntryId, onEntryDeleted, timezone }: Props) {\n+type CalendarListEntry = {\n+  id: string;\n+  timestamp: number;\n+  firstLine: string;\n+  state?: CalendarEntry['state'];\n+};\n+\n+export default function CalendarPopup({ onLoadEntry, onClose, currentEntryId, onEntryDeleted, timezone, initialDateKey }: Props) {\n   const { isAuthenticated } = useAuth();\n   const { t, i18n } = useTranslation();\n   const dateLocale = getDateLocale(i18n.language);\n-  const [currentMonth, setCurrentMonth] = useState(new Date());\n-  const [selectedDate, setSelectedDate] = useState<string | null>(getTodayKey());\n-  const [calendarData, setCalendarData] = useState<Record<string, CalendarEntry[]>>({});\n+  const [currentMonth, setCurrentMonth] = useState(() => {\n+    if (initialDateKey) {\n+      const [y, m] = initialDateKey.split('-').map(Number);\n+      return new Date(y, m - 1, 1);\n+    }\n+    return new Date();\n+  });\n+  const [selectedDate, setSelectedDate] = useState<string | null>(initialDateKey ?? getTodayKey());\n+  const [calendarData, setCalendarData] = useState<Record<string, CalendarListEntry[]>>({});\n+\n+  useEffect(() => {\n+    if (initialDateKey) {\n+      setSelectedDate(initialDateKey);\n+      const [y, m] = initialDateKey.split('-').map(Number);\n+      setCurrentMonth(new Date(y, m - 1, 1));\n+    }\n+  }, [initialDateKey]);\n \n-  // @@@ Shared loader for calendar data (DB or localStorage)\n   const refreshCalendarData = useCallback(async () => {\n     if (isAuthenticated) {\n       try {\n-        const { listSessions, getSession } = await import('../api/voiceApi');\n-        const grouped = await loadSessionsGroupedByDate(listSessions, getSession, {\n-          requireName: true,\n-          timezone\n+        const { listSessions } = await import('../api/voiceApi');\n+        const sessions = await listSessions(timezone);\n+        const grouped: Record<string, CalendarListEntry[]> = {};\n+\n+        sessions.forEach((session: any) => {\n+          const dateKey = session.date_key || getTodayKey();\n+          const tsRaw = session.updated_at || session.created_at;\n+          const ts = parseFlexibleTimestamp(tsRaw)?.getTime() ?? Date.now();\n+          const firstLine = session.first_line || session.name || 'Untitled';\n+          if (!grouped[dateKey]) grouped[dateKey] = [];\n+          grouped[dateKey].push({\n+            id: session.id,\n+            timestamp: ts,\n+            firstLine\n+          });\n         });\n+\n         setCalendarData(grouped);\n         return;\n       } catch (error) {\n         console.error('Failed to load calendar from database:', error);\n       }\n     }\n-    setCalendarData(getCalendarData());\n+    const localData = getCalendarData();\n+    const mapped: Record<string, CalendarListEntry[]> = {};\n+    Object.entries(localData).forEach(([dateKey, entries]) => {\n+      mapped[dateKey] = entries.map((entry) => ({\n+        id: entry.id,\n+        timestamp: entry.timestamp,\n+        firstLine: entry.firstLine,\n+        state: entry.state\n+      }));\n+    });\n+    setCalendarData(mapped);\n   }, [isAuthenticated, timezone]);\n \n-  // @@@ Initial load\n   useEffect(() => {\n     refreshCalendarData();\n   }, [refreshCalendarData]);\n \n   const today = getTodayKey();\n   const datesWithEntries = Object.keys(calendarData);\n \n-  // Calculate calendar grid\n   const year = currentMonth.getFullYear();\n   const month = currentMonth.getMonth();\n   const firstDay = new Date(year, month, 1);\n   const lastDay = new Date(year, month + 1, 0);\n   const daysInMonth = lastDay.getDate();\n-  const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday\n+  const startingDayOfWeek = firstDay.getDay();\n \n   const days: Array<{ date: number; dateKey: string; hasEntries: boolean; isToday: boolean } | null> = [];\n \n-  // Add empty slots for days before month starts\n   for (let i = 0; i < startingDayOfWeek; i++) {\n     days.push(null);\n   }\n \n-  // Add days of the month\n   for (let date = 1; date <= daysInMonth; date++) {\n     const dateObj = new Date(year, month, date);\n     const dateKey = getDateKey(dateObj);\n@@ -91,25 +130,23 @@ export default function CalendarPopup({ onLoadEntry, onClose, currentEntryId, on\n   const handleDateClick = (dateKey: string) => {\n     setSelectedDate(dateKey);\n   };\n+\n   const weekdayFormatter = new Intl.DateTimeFormat(dateLocale, { weekday: 'short' });\n   const weekdayLabels = Array.from({ length: 7 }, (_, idx) => weekdayFormatter.format(new Date(Date.UTC(2023, 0, idx + 1))));\n \n   const handleDeleteEntry = async (dateKey: string, entryId: string) => {\n     if (confirm(t('calendar.deleteConfirm'))) {\n       if (isAuthenticated) {\n         try {\n-          // Delete from database\n           const { deleteSession } = await import('../api/voiceApi');\n           await deleteSession(entryId);\n-\n           await refreshCalendarData();\n           onEntryDeleted?.(entryId);\n         } catch (error) {\n           console.error('Failed to delete from database:', error);\n           alert(t('calendar.deleteError'));\n         }\n       } else {\n-        // Guest mode: delete from localStorage\n         deleteEntry(dateKey, entryId);\n         setCalendarData(getCalendarData());\n         onEntryDeleted?.(entryId);\n@@ -119,6 +156,33 @@ export default function CalendarPopup({ onLoadEntry, onClose, currentEntryId, on\n \n   const selectedEntries = selectedDate ? calendarData[selectedDate] || [] : [];\n \n+  const handleOpenEntry = async (entry: CalendarListEntry) => {\n+    if (isAuthenticated) {\n+      try {\n+        const { getSession } = await import('../api/voiceApi');\n+        const full = await getSession(entry.id);\n+        if (!full?.editor_state) {\n+          alert(t('calendar.loadError'));\n+          return;\n+        }\n+        const payload: CalendarEntry = {\n+          id: entry.id,\n+          timestamp: entry.timestamp,\n+          state: full.editor_state,\n+          firstLine: entry.firstLine\n+        };\n+        onLoadEntry(payload);\n+        onClose();\n+      } catch (error) {\n+        console.error('Failed to load session:', error);\n+        alert(t('calendar.loadError'));\n+      }\n+    } else if (entry.state) {\n+      onLoadEntry(entry as CalendarEntry);\n+      onClose();\n+    }\n+  };\n+\n   return (\n     <div\n       style={{\n@@ -127,136 +191,136 @@ export default function CalendarPopup({ onLoadEntry, onClose, currentEntryId, on\n         left: 0,\n         right: 0,\n         bottom: 0,\n-        background: 'rgba(0,0,0,0.3)',\n+        background: 'rgba(0,0,0,0.4)',\n         display: 'flex',\n         alignItems: 'center',\n         justifyContent: 'center',\n         zIndex: 2000,\n-        backdropFilter: 'blur(2px)'\n+        backdropFilter: 'blur(4px)'\n       }}\n       onClick={onClose}\n     >\n       <div\n+        role=\"presentation\"\n         style={{\n-          background: '#fffef9',\n-          border: '2px solid #d0c4b0',\n-          borderRadius: '12px',\n-          width: '90%',\n-          maxWidth: '600px',\n-          maxHeight: '80vh',\n-          overflow: 'auto',\n-          boxShadow: '0 8px 32px rgba(0,0,0,0.2)',\n-          fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+          display: 'flex',\n+          gap: '24px',\n+          alignItems: 'flex-start',\n+          justifyContent: 'center',\n+          maxWidth: '1100px',\n+          width: 'min(94vw, 1100px)',\n+          maxHeight: '85vh',\n+          margin: '0 auto'\n         }}\n-        onClick={(e) => e.stopPropagation()}\n       >\n-        {/* Header */}\n-        <div style={{\n-          padding: '20px',\n-          borderBottom: '1px solid #e0d4c0',\n-          display: 'flex',\n-          justifyContent: 'space-between',\n-          alignItems: 'center',\n-          gap: '12px'\n-        }}>\n-          <div style={{ flex: 1 }}>\n-            <h2 style={{\n-              margin: 0,\n-              fontSize: '18px',\n-              fontWeight: 600,\n-              color: '#333'\n-            }}>\n-              {t('calendar.title')}\n-            </h2>\n-            <p style={{ margin: '4px 0 0', fontSize: 12, color: '#777' }}>\n-              {t('calendar.subtitle')}\n-            </p>\n-          </div>\n-          <button\n-            onClick={onClose}\n-            style={{\n-              border: 'none',\n-              background: 'transparent',\n-              fontSize: '24px',\n-              cursor: 'pointer',\n-              color: '#666',\n-              padding: '0 8px',\n-              lineHeight: 1\n-            }}\n-          >\n-            \u00d7\n-          </button>\n-        </div>\n-\n-        <div style={{ padding: '20px' }}>\n-          {/* Month navigation */}\n+        {/* Calendar grid - LEFT */}\n+        <div\n+          onClick={(e) => e.stopPropagation()}\n+          style={{\n+            flex: '0 0 auto',\n+            width: '460px',\n+            background: 'linear-gradient(145deg, #fffef9 0%, #faf8f3 100%)',\n+            border: '2px solid #d0c4b0',\n+            borderRadius: '16px',\n+            padding: '20px',\n+            boxShadow: '0 12px 40px rgba(0,0,0,0.15)',\n+            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+          }}\n+        >\n+          {/* Month header */}\n           <div style={{\n             display: 'flex',\n-            justifyContent: 'space-between',\n             alignItems: 'center',\n-            marginBottom: '16px'\n+            justifyContent: 'space-between',\n+            marginBottom: '20px'\n           }}>\n             <button\n               onClick={handlePrevMonth}\n               style={{\n-                border: '1px solid #d0c4b0',\n-                background: '#fff',\n-                borderRadius: '4px',\n-                padding: '6px 12px',\n+                border: 'none',\n+                background: 'transparent',\n                 cursor: 'pointer',\n-                fontSize: '14px',\n-                fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+                fontSize: '20px',\n+                padding: '8px 12px',\n+                borderRadius: '8px',\n+                color: '#666',\n+                transition: 'all 0.2s'\n+              }}\n+              onMouseEnter={(e) => {\n+                e.currentTarget.style.background = '#f0ebe0';\n+                e.currentTarget.style.color = '#333';\n+              }}\n+              onMouseLeave={(e) => {\n+                e.currentTarget.style.background = 'transparent';\n+                e.currentTarget.style.color = '#666';\n               }}\n             >\n-              {t('calendar.prev')}\n+              \u2039\n             </button>\n             <div style={{\n-              fontSize: '16px',\n+              fontSize: '20px',\n               fontWeight: 600,\n-              color: '#333'\n+              color: '#2c2c2c',\n+              letterSpacing: '0.5px'\n             }}>\n               {currentMonth.toLocaleDateString(dateLocale, { month: 'long', year: 'numeric' })}\n             </div>\n             <button\n               onClick={handleNextMonth}\n               style={{\n-                border: '1px solid #d0c4b0',\n-                background: '#fff',\n-                borderRadius: '4px',\n-                padding: '6px 12px',\n+                border: 'none',\n+                background: 'transparent',\n                 cursor: 'pointer',\n-                fontSize: '14px',\n-                fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+                fontSize: '20px',\n+                padding: '8px 12px',\n+                borderRadius: '8px',\n+                color: '#666',\n+                transition: 'all 0.2s'\n+              }}\n+              onMouseEnter={(e) => {\n+                e.currentTarget.style.background = '#f0ebe0';\n+                e.currentTarget.style.color = '#333';\n+              }}\n+              onMouseLeave={(e) => {\n+                e.currentTarget.style.background = 'transparent';\n+                e.currentTarget.style.color = '#666';\n               }}\n             >\n-              {t('calendar.next')}\n+              \u203a\n             </button>\n           </div>\n \n-          {/* Calendar grid */}\n+          {/* Weekday headers */}\n           <div style={{\n             display: 'grid',\n             gridTemplateColumns: 'repeat(7, 1fr)',\n             gap: '4px',\n-            marginBottom: '20px'\n+            marginBottom: '8px'\n           }}>\n-            {/* Day headers */}\n             {weekdayLabels.map((label, idx) => (\n               <div key={`${label}-${idx}`} style={{\n                 textAlign: 'center',\n                 fontSize: '12px',\n                 fontWeight: 600,\n-                color: '#888',\n-                padding: '4px 0'\n+                color: '#999',\n+                padding: '8px 0',\n+                textTransform: 'uppercase',\n+                letterSpacing: '0.5px'\n               }}>\n                 {label}\n               </div>\n             ))}\n+          </div>\n \n-            {/* Days */}\n+          {/* Days grid */}\n+          <div style={{\n+            display: 'grid',\n+            gridTemplateColumns: 'repeat(7, 1fr)',\n+            gap: '6px'\n+          }}>\n             {days.map((day, idx) => {\n               if (!day) {\n-                return <div key={`empty-${idx}`} />;\n+                return <div key={`empty-${idx}`} style={{ aspectRatio: '1' }} />;\n               }\n \n               const isSelected = selectedDate === day.dateKey;\n@@ -266,87 +330,155 @@ export default function CalendarPopup({ onLoadEntry, onClose, currentEntryId, on\n                   key={day.dateKey}\n                   onClick={() => handleDateClick(day.dateKey)}\n                   style={{\n-                    border: day.isToday ? '2px solid #333' : '1px solid #e0d4c0',\n-                    background: isSelected ? '#e3f2fd' : day.hasEntries ? '#fff' : '#fafafa',\n-                    borderRadius: '6px',\n-                    padding: '8px',\n+                    aspectRatio: '1',\n+                    border: 'none',\n+                    background: isSelected\n+                      ? 'linear-gradient(135deg, #4a90d9 0%, #357abd 100%)'\n+                      : day.hasEntries\n+                        ? '#fff'\n+                        : 'transparent',\n+                    borderRadius: '10px',\n                     cursor: 'pointer',\n-                    fontSize: '14px',\n+                    fontSize: '15px',\n                     fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n                     position: 'relative',\n-                    minHeight: '40px',\n                     display: 'flex',\n                     flexDirection: 'column',\n                     alignItems: 'center',\n                     justifyContent: 'center',\n-                    transition: 'all 0.2s'\n+                    transition: 'all 0.2s',\n+                    boxShadow: isSelected\n+                      ? '0 4px 12px rgba(74, 144, 217, 0.4)'\n+                      : day.hasEntries\n+                        ? '0 2px 8px rgba(0,0,0,0.08)'\n+                        : 'none',\n+                    color: isSelected && !day.isToday ? '#fff' : '#333',\n+                    fontWeight: day.isToday || isSelected ? 700 : 400\n                   }}\n                   onMouseEnter={(e) => {\n                     if (!isSelected) {\n-                      e.currentTarget.style.background = '#f5f5f5';\n+                      e.currentTarget.style.background = '#f0ebe0';\n+                      e.currentTarget.style.transform = 'scale(1.05)';\n                     }\n                   }}\n                   onMouseLeave={(e) => {\n                     if (!isSelected) {\n-                      e.currentTarget.style.background = day.hasEntries ? '#fff' : '#fafafa';\n+                      e.currentTarget.style.background = day.hasEntries ? '#fff' : 'transparent';\n+                      e.currentTarget.style.transform = 'scale(1)';\n                     }\n                   }}\n                 >\n-                  <div style={{ fontWeight: day.isToday ? 600 : 400 }}>\n-                    {day.date}\n-                  </div>\n+                  {day.isToday ? (\n+                    <span style={{\n+                      display: 'inline-flex',\n+                      alignItems: 'center',\n+                      justifyContent: 'center',\n+                      width: 28,\n+                      height: 28,\n+                      borderRadius: '50%',\n+                      border: '2px solid #fb8c00',\n+                      color: '#333',\n+                      background: isSelected ? 'rgba(255,255,255,0.9)' : 'transparent'\n+                    }}>\n+                      {day.date}\n+                    </span>\n+                  ) : (\n+                    <span>{day.date}</span>\n+                  )}\n                   {day.hasEntries && (\n                     <div style={{\n-                      width: '6px',\n-                      height: '6px',\n+                      position: 'absolute',\n+                      bottom: '6px',\n+                      width: '5px',\n+                      height: '5px',\n                       borderRadius: '50%',\n-                      background: '#2196F3',\n-                      marginTop: '2px'\n+                      background: isSelected ? 'rgba(255,255,255,0.8)' : '#4a90d9'\n                     }} />\n                   )}\n                 </button>\n               );\n             })}\n           </div>\n+        </div>\n \n-          {/* Entry list */}\n-          {selectedDate && (\n-            <div>\n+        {/* Entry list - RIGHT */}\n+        {selectedDate && (\n+          <div\n+            style={{\n+              flex: '1 1 380px',\n+              minWidth: '320px',\n+              maxWidth: '480px',\n+              maxHeight: '70vh',\n+              display: 'flex',\n+              flexDirection: 'column'\n+            }}\n+          >\n+            {/* Header */}\n+            <div\n+              onClick={(e) => e.stopPropagation()}\n+              style={{\n+                background: 'rgba(255,255,255,0.95)',\n+                borderRadius: '12px 12px 0 0',\n+                padding: '16px 20px',\n+                borderBottom: '1px solid #e0d4c0',\n+                backdropFilter: 'blur(8px)',\n+                boxShadow: '0 -4px 20px rgba(0,0,0,0.05)'\n+              }}\n+            >\n               <div style={{\n-                fontSize: '14px',\n+                fontSize: '16px',\n                 fontWeight: 600,\n-                color: '#666',\n-                marginBottom: '12px',\n-                borderBottom: '1px solid #e0d4c0',\n-                paddingBottom: '8px'\n+                color: '#444',\n+                fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n               }}>\n                 {selectedDate === today\n                   ? t('calendar.todayLabel')\n                   : new Date(selectedDate + 'T00:00:00').toLocaleDateString(dateLocale, {\n-                      year: 'numeric',\n-                      month: 'long',\n-                      day: 'numeric',\n-                      weekday: 'long'\n-                    })}\n-                {selectedEntries.length > 0 && ` (${t('calendar.entriesLabel', { count: selectedEntries.length })})`}\n+                    year: 'numeric',\n+                    month: 'long',\n+                    day: 'numeric',\n+                    weekday: 'short'\n+                  })}\n               </div>\n+              {selectedEntries.length > 0 && (\n+                <div style={{\n+                  fontSize: '13px',\n+                  color: '#888',\n+                  marginTop: '4px'\n+                }}>\n+                  {t('calendar.entriesLabel', { count: selectedEntries.length })}\n+                </div>\n+              )}\n+            </div>\n \n+            {/* Entries list */}\n+            <div\n+              onClick={(e) => e.stopPropagation()}\n+              style={{\n+                background: 'rgba(255,255,255,0.92)',\n+                borderRadius: '0 0 12px 12px',\n+                padding: '12px',\n+                flex: 1,\n+                overflow: 'auto',\n+                backdropFilter: 'blur(8px)',\n+                boxShadow: '0 12px 40px rgba(0,0,0,0.15)'\n+              }}\n+            >\n               {selectedEntries.length === 0 ? (\n                 <div style={{\n                   textAlign: 'center',\n                   color: '#999',\n-                  padding: '20px',\n-                  fontSize: '14px'\n+                  padding: '32px 20px',\n+                  fontSize: '14px',\n+                  fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n                 }}>\n                   {t('calendar.noEntriesForDate')}\n                 </div>\n               ) : (\n                 <div style={{\n                   display: 'flex',\n                   flexDirection: 'column',\n-                  gap: '8px',\n-                  maxHeight: '200px',\n-                  overflow: 'auto'\n+                  gap: '10px'\n                 }}>\n                   {selectedEntries.map((entry) => {\n                     const isCurrentEntry = currentEntryId === entry.id;\n@@ -359,85 +491,100 @@ export default function CalendarPopup({ onLoadEntry, onClose, currentEntryId, on\n                       <div\n                         key={entry.id}\n                         style={{\n-                          border: isCurrentEntry ? '2px solid #4CAF50' : '1px solid #d0c4b0',\n-                          borderRadius: '6px',\n-                          padding: '12px',\n-                          background: isCurrentEntry ? '#f0fff4' : '#fff',\n+                          borderRadius: '10px',\n+                          padding: '14px 16px',\n+                          background: isCurrentEntry\n+                            ? 'linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%)'\n+                            : '#fff',\n                           display: 'flex',\n                           justifyContent: 'space-between',\n                           alignItems: 'center',\n                           gap: '12px',\n-                          boxShadow: isCurrentEntry ? '0 0 0 1px rgba(76, 175, 80, 0.1)' : 'none'\n+                          boxShadow: isCurrentEntry\n+                            ? '0 2px 12px rgba(76, 175, 80, 0.2), inset 0 0 0 2px #4CAF50'\n+                            : '0 2px 8px rgba(0,0,0,0.06)',\n+                          transition: 'all 0.2s',\n+                          minWidth: 0\n                         }}\n                       >\n                         <button\n                           title={t('calendar.openButton')}\n-                          onClick={() => onLoadEntry(entry)}\n+                          onClick={() => handleOpenEntry(entry)}\n                           style={{\n                             flex: 1,\n                             textAlign: 'left',\n                             border: 'none',\n                             background: 'transparent',\n                             cursor: 'pointer',\n                             padding: 0,\n-                            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+                            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+                            minWidth: 0\n                           }}\n                         >\n                           <div style={{\n                             display: 'flex',\n                             alignItems: 'center',\n-                            gap: '8px',\n-                            marginBottom: '4px'\n+                            gap: '10px',\n+                            marginBottom: '6px'\n                           }}>\n                             <div style={{\n                               fontSize: '12px',\n-                              color: '#999'\n+                              color: '#888',\n+                              fontWeight: 500,\n+                              flexShrink: 0\n                             }}>\n                               {time}\n                             </div>\n                             {isCurrentEntry && (\n                               <span style={{\n-                                fontSize: '11px',\n+                                fontSize: '10px',\n                                 letterSpacing: '0.05em',\n                                 textTransform: 'uppercase',\n-                                padding: '2px 6px',\n+                                padding: '3px 8px',\n                                 borderRadius: '999px',\n-                                border: '1px solid #4CAF50',\n-                                color: '#256029',\n-                                background: '#e8f5e9',\n-                                fontWeight: 600\n+                                background: '#4CAF50',\n+                                color: '#fff',\n+                                fontWeight: 600,\n+                                flexShrink: 0\n                               }}>\n                                 {t('calendar.currentEntryLabel')}\n                               </span>\n                             )}\n                           </div>\n                           <div style={{\n                             fontSize: '14px',\n-                            color: '#333'\n+                            color: '#333',\n+                            lineHeight: 1.4,\n+                            overflow: 'hidden',\n+                            textOverflow: 'ellipsis',\n+                            whiteSpace: 'nowrap',\n+                            display: 'block',\n+                            maxWidth: '100%'\n                           }}>\n                             {entry.firstLine}\n                           </div>\n                         </button>\n                         <button\n                           onClick={() => handleDeleteEntry(selectedDate, entry.id)}\n                           style={{\n-                            border: '1px solid #d44',\n-                            background: '#fff',\n-                            borderRadius: '4px',\n-                            padding: '4px 8px',\n+                            border: 'none',\n+                            background: 'transparent',\n+                            borderRadius: '6px',\n+                            padding: '6px 10px',\n                             cursor: 'pointer',\n                             fontSize: '12px',\n-                            color: '#d44',\n+                            color: '#999',\n                             fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-                            transition: 'all 0.2s'\n+                            transition: 'all 0.2s',\n+                            flexShrink: 0\n                           }}\n                           onMouseEnter={(e) => {\n-                            e.currentTarget.style.background = '#d44';\n-                            e.currentTarget.style.color = '#fff';\n+                            e.currentTarget.style.background = '#fee';\n+                            e.currentTarget.style.color = '#d44';\n                           }}\n                           onMouseLeave={(e) => {\n-                            e.currentTarget.style.background = '#fff';\n-                            e.currentTarget.style.color = '#d44';\n+                            e.currentTarget.style.background = 'transparent';\n+                            e.currentTarget.style.color = '#999';\n                           }}\n                         >\n                           {t('calendar.deleteButton')}\n@@ -448,8 +595,8 @@ export default function CalendarPopup({ onLoadEntry, onClose, currentEntryId, on\n                 </div>\n               )}\n             </div>\n-          )}\n-        </div>\n+          </div>\n+        )}\n       </div>\n     </div>\n   );"
    },
    {
      "sha": "b6354930d907b1378c0e7c898b058ae6b906ed65",
      "filename": "frontend/src/components/CollectionsView.tsx",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/d0cbf1a66ea667569da3833d568e17a0efff2cf0/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/d0cbf1a66ea667569da3833d568e17a0efff2cf0/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx?ref=d0cbf1a66ea667569da3833d568e17a0efff2cf0",
      "patch": "@@ -533,7 +533,7 @@ function TimelinePage({ isVisible, voiceConfigs, dateLocale, friendToSelect, onF\n       if (isAuthenticated) {\n         try {\n           const { listSessions, getSession } = await import('../api/voiceApi');\n-          const groupedEntries = await loadSessionsGroupedByDate(listSessions, getSession, {\n+          const groupedEntries = await loadSessionsGroupedByDate(() => listSessions(timezone), getSession, {\n             requireName: true,\n             timezone\n           });"
    }
  ]
}