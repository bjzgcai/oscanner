commit 0ec0ecce3db148dd243d31c53feedd9eaa52527f
Author: lexicalmathical <lexicalmathical@gmail.com>
Date:   Wed Oct 1 19:46:18 2025 +0800

    Implement voice highlighting with custom Tiptap extension
    
    - Created VoiceHighlight extension using ProseMirror decorations
    - Highlights only first occurrence of trigger phrases ("i feel", "i think", "should i")
    - Uses decoration system instead of marks to avoid state conflicts
    - Applied watercolor brush styles via CSS classes
    - Removed Highlight extension and manual highlighting logic
    - Simplified component interfaces by removing editor instance passing
    - No cursor interference or infinite loop issues
    
    ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
    
    Co-Authored-By: Claude <noreply@anthropic.com>

diff --git a/frontend/src/App.css b/frontend/src/App.css
index df1693b..8acbcac 100644
--- a/frontend/src/App.css
+++ b/frontend/src/App.css
@@ -156,24 +156,23 @@
 }
 
 /* Watercolor highlight effects */
-mark {
-  background: url(https://s2.svgbox.net/pen-brushes.svg?ic=brush-9&color=ffff43);
+.voice-highlight {
   margin: -2px -6px;
   padding: 2px 6px;
 }
 
-mark[data-color="yellow"] {
+.voice-highlight-yellow {
   background: url(https://s2.svgbox.net/pen-brushes.svg?ic=brush-9&color=ffff43);
 }
 
-mark[data-color="blue"] {
+.voice-highlight-blue {
   background: url(https://s2.svgbox.net/pen-brushes.svg?ic=brush-7&color=a3d5ff);
 }
 
-mark[data-color="pink"] {
+.voice-highlight-pink {
   background: url(https://s2.svgbox.net/pen-brushes.svg?ic=brush-8&color=ffb3d9);
 }
 
-mark[data-color="green"] {
+.voice-highlight-green {
   background: url(https://s2.svgbox.net/pen-brushes.svg?ic=brush-6&color=b3ffb3);
 }
\ No newline at end of file
diff --git a/frontend/src/App.tsx b/frontend/src/App.tsx
index 525e2cb..a67e1f4 100644
--- a/frontend/src/App.tsx
+++ b/frontend/src/App.tsx
@@ -8,8 +8,18 @@ import BinderRings from './components/BinderRings'
 interface Voice {
   name: string;
   text: string;
+  range: { from: number; to: number };
+  color: string;
 }
 
+// Voice type to color mapping
+const VOICE_COLORS: Record<string, string> = {
+  'Logic': 'blue',
+  'Emotion': 'pink',
+  'Doubt': 'yellow',
+  'Memory': 'green',
+};
+
 function App() {
   const [text, setText] = useState('');
   const [voices, setVoices] = useState<Voice[]>([]);
@@ -18,18 +28,36 @@ function App() {
     setText(newText);
 
     const newVoices: Voice[] = [];
+    const lowerText = newText.toLowerCase();
 
-    if (newText.toLowerCase().includes('i feel')) {
-      newVoices.push({ name: 'Logic', text: 'Feelings are just chemical reactions.' });
-    }
-    if (newText.toLowerCase().includes('i think')) {
-      newVoices.push({ name: 'Emotion', text: 'But what does your heart say?' });
-    }
-    if (newText.toLowerCase().includes('should i')) {
-      newVoices.push({ name: 'Doubt', text: 'Are you sure you even want to know?' });
-    }
-    if (newText.length > 50) {
-      newVoices.push({ name: 'Memory', text: 'This reminds me of something you wrote before...' });
+    // Find trigger phrases
+    const triggers = [
+      { phrase: 'i feel', voice: 'Logic', comment: 'Feelings are just chemical reactions.' },
+      { phrase: 'i think', voice: 'Emotion', comment: 'But what does your heart say?' },
+      { phrase: 'should i', voice: 'Doubt', comment: 'Are you sure you even want to know?' },
+    ];
+
+    triggers.forEach(({ phrase, voice, comment }) => {
+      const index = lowerText.indexOf(phrase);
+      if (index !== -1) {
+        const color = VOICE_COLORS[voice];
+        newVoices.push({
+          name: voice,
+          text: comment,
+          range: { from: index, to: index + phrase.length },
+          color
+        });
+      }
+    });
+
+    // Memory voice for long text (no specific range)
+    if (newText.length > 50 && !newVoices.find(v => v.name === 'Memory')) {
+      newVoices.push({
+        name: 'Memory',
+        text: 'This reminds me of something you wrote before...',
+        range: { from: 0, to: 0 },
+        color: VOICE_COLORS['Memory']
+      });
     }
 
     setVoices(newVoices);
diff --git a/frontend/src/components/EditableTextArea.tsx b/frontend/src/components/EditableTextArea.tsx
index 6794319..b700dda 100644
--- a/frontend/src/components/EditableTextArea.tsx
+++ b/frontend/src/components/EditableTextArea.tsx
@@ -1,7 +1,6 @@
 import { useEditor, EditorContent } from '@tiptap/react';
 import StarterKit from '@tiptap/starter-kit';
-import Highlight from '@tiptap/extension-highlight';
-import { useEffect } from 'react';
+import { VoiceHighlight } from '../extensions/VoiceHighlight';
 
 interface EditableTextAreaProps {
   value: string;
@@ -12,9 +11,7 @@ export default function EditableTextArea({ value, onChange }: EditableTextAreaPr
   const editor = useEditor({
     extensions: [
       StarterKit,
-      Highlight.configure({
-        multicolor: true,
-      }),
+      VoiceHighlight,
     ],
     content: value,
     onUpdate: ({ editor }) => {
@@ -23,11 +20,5 @@ export default function EditableTextArea({ value, onChange }: EditableTextAreaPr
     autofocus: true,
   });
 
-  useEffect(() => {
-    if (editor && editor.getText() !== value) {
-      editor.commands.setContent(value);
-    }
-  }, [value, editor]);
-
   return <div className="editable-text-area"><EditorContent editor={editor} /></div>;
 }
\ No newline at end of file
diff --git a/frontend/src/extensions/VoiceHighlight.ts b/frontend/src/extensions/VoiceHighlight.ts
new file mode 100644
index 0000000..f81d832
--- /dev/null
+++ b/frontend/src/extensions/VoiceHighlight.ts
@@ -0,0 +1,85 @@
+import { Extension } from '@tiptap/core';
+import { Plugin, PluginKey } from '@tiptap/pm/state';
+import { Decoration, DecorationSet } from '@tiptap/pm/view';
+
+const VOICE_TRIGGERS = [
+  { phrase: 'i feel', color: 'blue' },
+  { phrase: 'i think', color: 'pink' },
+  { phrase: 'should i', color: 'yellow' },
+];
+
+export const VoiceHighlight = Extension.create({
+  name: 'voiceHighlight',
+
+  addProseMirrorPlugins() {
+    return [
+      new Plugin({
+        key: new PluginKey('voiceHighlight'),
+
+        state: {
+          init(_, { doc }) {
+            return findHighlights(doc);
+          },
+
+          apply(tr, oldState) {
+            // Only recalculate if document changed
+            if (tr.docChanged) {
+              return findHighlights(tr.doc);
+            }
+            return oldState;
+          },
+        },
+
+        props: {
+          decorations(state) {
+            return this.getState(state);
+          },
+        },
+      }),
+    ];
+  },
+});
+
+function findHighlights(doc: any): DecorationSet {
+  const decorations: Decoration[] = [];
+  const text = doc.textContent.toLowerCase();
+
+  VOICE_TRIGGERS.forEach(({ phrase, color }) => {
+    const pos = text.indexOf(phrase);
+
+    if (pos !== -1) {
+      // Convert text position to document position
+      let docPos = 0;
+      let textPos = 0;
+      let found = false;
+
+      doc.descendants((node: any, nodePos: number) => {
+        if (found) return false;
+
+        if (node.isText) {
+          const nodeText = node.text || '';
+          if (textPos + nodeText.length > pos) {
+            // The match starts in this text node
+            const offsetInNode = pos - textPos;
+            docPos = nodePos + offsetInNode;
+            found = true;
+            return false;
+          }
+          textPos += nodeText.length;
+        }
+
+        return true;
+      });
+
+      if (found) {
+        decorations.push(
+          Decoration.inline(docPos, docPos + phrase.length, {
+            class: `voice-highlight voice-highlight-${color}`,
+          })
+        );
+      }
+    }
+  });
+
+  return DecorationSet.create(doc, decorations);
+}
