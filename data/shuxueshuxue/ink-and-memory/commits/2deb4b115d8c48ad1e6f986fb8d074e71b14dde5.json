{
  "cached_at": "2025-12-20T11:18:34.257195",
  "commit_sha": "2deb4b115d8c48ad1e6f986fb8d074e71b14dde5",
  "repo": "shuxueshuxue/ink-and-memory",
  "data": {
    "sha": "2deb4b115d8c48ad1e6f986fb8d074e71b14dde5",
    "node_id": "C_kwDOP2Zrm9oAKDJkZWI0YjExNWQ4YzQ4YWQxZTZmOTg2ZmI4ZDA3NGU3MWIxNGRkZTU",
    "commit": {
      "author": {
        "name": "Shaobin-Jiang",
        "email": "shaobin-jiang@outlook.com",
        "date": "2025-11-28T03:23:56Z"
      },
      "committer": {
        "name": "Shaobin-Jiang",
        "email": "shaobin-jiang@outlook.com",
        "date": "2025-11-28T03:23:56Z"
      },
      "message": "create websocket endpoint for speech recognition",
      "tree": {
        "sha": "2a88c9855819f2b85a55aa801a4e8d8ea66ac8bf",
        "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/2a88c9855819f2b85a55aa801a4e8d8ea66ac8bf"
      },
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/2deb4b115d8c48ad1e6f986fb8d074e71b14dde5",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCAAdFiEEhfQW+O5+vUJlGXwjtnnMcOFZaR8FAmkpFdYACgkQtnnMcOFZ\naR94igwAyUuM7bdw5vQwSWLVjDBp057/szNuILU1F+0wK0BZqvq8duj0T5OfsTm+\nWyXYtQRPgiWI0fsYRoA3ugc7FrI2Ro+WRvAK09cuuTHf5DwiLfaUP2yYaSHUmsyK\nobzy2oThIk9yA+HppOFfFzVkduivK8eZHXJS12Z2NcR/pvFUusAFPP08dXc2Ou/a\nrIaOEOV3+Ow+S2NRzzqoyVH9SmcpDKUQlXSFBHqKRUqP4clMWLH+PdHdzy0Lyzmf\n54dUSf6WfoinUqvxk1urZbatmzWYODsiwvVNsmJTuefH7J0Bb7BV4FLs7tF69Dhh\ndGbNHg7RdWh7gdl65CMqXRYrM8Lml0cF7/fBZgsF6HmJAnA8U/Mwff6IW5pI6/+y\nhNaDs7XMJSQLUZyProTvnL4leUzTcJfWVUCspV71mxfFeoTgbKsGNtekAEnxE8YA\nOHXqjDFxQMpMv1aYcI8G35hDJSP0YgJvvDbh+0VJhqvGFkqFfPVOwST3FLKFfQPU\ne0fwgeLM\n=oYz6\n-----END PGP SIGNATURE-----",
        "payload": "tree 2a88c9855819f2b85a55aa801a4e8d8ea66ac8bf\nparent 9eccd63da64da70f8e813dc684cc60afab2805d7\nauthor Shaobin-Jiang <shaobin-jiang@outlook.com> 1764300236 +0800\ncommitter Shaobin-Jiang <shaobin-jiang@outlook.com> 1764300236 +0800\n\ncreate websocket endpoint for speech recognition\n",
        "verified_at": "2025-11-28T03:24:35Z"
      }
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/2deb4b115d8c48ad1e6f986fb8d074e71b14dde5",
    "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/2deb4b115d8c48ad1e6f986fb8d074e71b14dde5",
    "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/2deb4b115d8c48ad1e6f986fb8d074e71b14dde5/comments",
    "author": {
      "login": "Shaobin-Jiang",
      "id": 74588034,
      "node_id": "MDQ6VXNlcjc0NTg4MDM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74588034?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Shaobin-Jiang",
      "html_url": "https://github.com/Shaobin-Jiang",
      "followers_url": "https://api.github.com/users/Shaobin-Jiang/followers",
      "following_url": "https://api.github.com/users/Shaobin-Jiang/following{/other_user}",
      "gists_url": "https://api.github.com/users/Shaobin-Jiang/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Shaobin-Jiang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Shaobin-Jiang/subscriptions",
      "organizations_url": "https://api.github.com/users/Shaobin-Jiang/orgs",
      "repos_url": "https://api.github.com/users/Shaobin-Jiang/repos",
      "events_url": "https://api.github.com/users/Shaobin-Jiang/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Shaobin-Jiang/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "committer": {
      "login": "Shaobin-Jiang",
      "id": 74588034,
      "node_id": "MDQ6VXNlcjc0NTg4MDM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74588034?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Shaobin-Jiang",
      "html_url": "https://github.com/Shaobin-Jiang",
      "followers_url": "https://api.github.com/users/Shaobin-Jiang/followers",
      "following_url": "https://api.github.com/users/Shaobin-Jiang/following{/other_user}",
      "gists_url": "https://api.github.com/users/Shaobin-Jiang/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Shaobin-Jiang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Shaobin-Jiang/subscriptions",
      "organizations_url": "https://api.github.com/users/Shaobin-Jiang/orgs",
      "repos_url": "https://api.github.com/users/Shaobin-Jiang/repos",
      "events_url": "https://api.github.com/users/Shaobin-Jiang/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Shaobin-Jiang/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "9eccd63da64da70f8e813dc684cc60afab2805d7",
        "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/9eccd63da64da70f8e813dc684cc60afab2805d7",
        "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/9eccd63da64da70f8e813dc684cc60afab2805d7"
      }
    ],
    "stats": {
      "total": 82,
      "additions": 81,
      "deletions": 1
    },
    "files": [
      {
        "sha": "3b2aed97cbf84d4fc705b5f7e566f41fceecf806",
        "filename": "backend/server.py",
        "status": "modified",
        "additions": 9,
        "deletions": 1,
        "changes": 10,
        "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/2deb4b115d8c48ad1e6f986fb8d074e71b14dde5/backend%2Fserver.py",
        "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/2deb4b115d8c48ad1e6f986fb8d074e71b14dde5/backend%2Fserver.py",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fserver.py?ref=2deb4b115d8c48ad1e6f986fb8d074e71b14dde5",
        "patch": "@@ -10,12 +10,13 @@\n \n import asyncio\n import httpx\n-from fastapi import FastAPI, HTTPException, Depends, Header\n+from fastapi import FastAPI, HTTPException, Depends, Header, WebSocket\n from fastapi.middleware.cors import CORSMiddleware\n from polycli.orchestration.session_registry import session_def, get_registry\n from polycli.integrations.fastapi import mount_control_panel\n from polycli import PolyAgent\n from stateless_analyzer import analyze_stateless\n+from speech_recognition import init_speech_recognition\n import config\n from proxy_config import get_image_api_proxies\n from typing import Optional\n@@ -1623,6 +1624,13 @@ def get_friend_timeline(friend_id: int, limit: int = 30, current_user: dict = De\n         raise HTTPException(status_code=403, detail=\"Not friends or friend not found\")\n     return {\"pictures\": timeline}\n \n+@app.websocket(\"/ws/speech-recognition\")\n+async def speech_recognition(websocket: WebSocket):\n+    # TODO: find a way of authentication for websocket\n+    await websocket.accept()\n+    await init_speech_recognition(websocket)\n+\n+\n # @@@ Removed /api/analyze wrapper - frontend now calls /polycli/api/trigger-sync directly\n \n # @@@ Removed /api/chat wrapper - frontend now calls /polycli/api/trigger-sync directly"
      },
      {
        "sha": "72758a2060f1f71a2d10d4980f29d075eb79e8d8",
        "filename": "backend/speech_recognition.py",
        "status": "added",
        "additions": 72,
        "deletions": 0,
        "changes": 72,
        "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/2deb4b115d8c48ad1e6f986fb8d074e71b14dde5/backend%2Fspeech_recognition.py",
        "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/2deb4b115d8c48ad1e6f986fb8d074e71b14dde5/backend%2Fspeech_recognition.py",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fspeech_recognition.py?ref=2deb4b115d8c48ad1e6f986fb8d074e71b14dde5",
        "patch": "@@ -0,0 +1,72 @@\n+from fastapi import FastAPI, WebSocket, WebSocketDisconnect\n+from dashscope.audio.asr import Recognition, RecognitionCallback, RecognitionResult\n+import asyncio\n+import json\n+from typing import cast\n+\n+import dashscope\n+# TODO: move api key to config\n+dashscope.api_key = \"sk-c4063b5a8e094b1691875f05b700a036\"\n+\n+SAMPLE_RATE = 16000\n+MODEL_NAME = \"paraformer-realtime-v2\"\n+\n+app = FastAPI()\n+\n+async def init_speech_recognition(websocket: WebSocket):\n+    callback = Callback(websocket)\n+    recognition = Recognition(\n+        model=MODEL_NAME,\n+        format=\"pcm\",\n+        sample_rate=SAMPLE_RATE,\n+        callback=callback,\n+    )\n+    recognition.start()\n+    print(\"Recognition started (model=%s, sample_rate=%d)\" % (MODEL_NAME, SAMPLE_RATE))\n+    try:\n+        while True:\n+            try:\n+                data = await websocket.receive_bytes()\n+                recognition.send_audio_frame(data)\n+            except Exception as e:\n+                print(\"Error during speech streaming: \", e)\n+                break\n+    except WebSocketDisconnect:\n+        recognition.stop()\n+    except Exception as e:\n+        print(\"WebSocket handler error:\", e)\n+\n+class Callback(RecognitionCallback):\n+    def __init__(self, websocket: WebSocket) -> None:\n+        self.websocket = websocket\n+\n+    def on_event(self, result: RecognitionResult) -> None:\n+        \"\"\"\n+        Called by the recognition library when there's an update.\n+        Compute incremental new_word and schedule broadcast to connected clients.\n+\n+        Example response from model:\n+        {\n+            'sentence_id': 1,\n+            'begin_time': 0,\n+            'end_time': None,\n+            'text': '你好世界',\n+            'channel_id': 0,\n+            'speaker_id': None,\n+            'sentence_end': False,\n+            'words': [\n+                {'begin_time': 0, 'end_time': 940, 'text': '你好', 'punctuation': '', 'fixed': False, 'speaker_id': None},\n+                {'begin_time': 940, 'end_time': 1880, 'text': '世界', 'punctuation': '', 'fixed': False, 'speaker_id': None},\n+            ]\n+        }\n+        \"\"\"\n+        sentence = result.get_sentence()\n+        sentence = cast(dict, sentence)\n+\n+        sentence_id = sentence.get(\"sentence_id\") or -1\n+        text = sentence.get(\"text\")\n+        res = json.dumps({\"id\": sentence_id, \"sentence\": text})\n+\n+        async def send_text():\n+            await self.websocket.send_text(res)\n+        asyncio.run(send_text())"
      }
    ]
  }
}