{
  "cached_at": "2025-12-20T14:31:17.512706",
  "commit_sha": "da926c53764f2d6cbdf8fe3b73a21a4d2153ce02",
  "repo": "liwenyu2002/mamage-server",
  "data": {
    "sha": "da926c53764f2d6cbdf8fe3b73a21a4d2153ce02",
    "node_id": "C_kwDOQYJTNNoAKGRhOTI2YzUzNzY0ZjJkNmNiZGY4ZmUzYjczYTIxYTRkMjE1M2NlMDI",
    "commit": {
      "author": {
        "name": "HIT_LWY",
        "email": "75512499+liwenyu2002@users.noreply.github.com",
        "date": "2025-12-09T02:13:04Z"
      },
      "committer": {
        "name": "GitHub",
        "email": "noreply@github.com",
        "date": "2025-12-09T02:13:04Z"
      },
      "message": "Update deploy.yml",
      "tree": {
        "sha": "f7925ae50d9b0796b4e662533956cf5170774f8f",
        "url": "https://api.github.com/repos/liwenyu2002/mamage-server/git/trees/f7925ae50d9b0796b4e662533956cf5170774f8f"
      },
      "url": "https://api.github.com/repos/liwenyu2002/mamage-server/git/commits/da926c53764f2d6cbdf8fe3b73a21a4d2153ce02",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsFcBAABCAAQBQJpN4WwCRC1aQ7uu5UhlAAAgm0QAGhZ21V24xTNf42pXImzqC8L\nqtbvLWF20n6dreGoQU0UU+wuIMWfwYxg+tUlb7ni6rlyThSWvmvKVUS8V4QDs2zk\ndTsDpZKYyLt847WlxMY28EfMeO4Ntz7oCt//7zh3i5Rlod26pMoize0L1u+fy71w\nAjRhvvQFWbTE1lLIpWUd2URTcqext03LVeSQZGwR8YWc3b4if+hpeF9Ogcm+0raY\nxwKPmZZLpc8YvTODdOIMwDcFoH4oOfIPT3cRFBEURD54eTTgMaoVNdqhCn6awS+M\nn2BrTg7y3olL3V77lpQOmhMdvkXcsOAJQixNkkQOXrgZaGkrBwDL/huboAFqM9bZ\nNfr5EOIgfWZ9Bc1WjTnsOMkd2GUPGJghm46/ZLvWz8TOZm2l0TdgzxDgsoK6duF5\nPzoKK8yaKhYMA6v9HNWu5I/gnZbNznNQYUB/gjVzupLCndj6/sgn+s9vMHZKKfhT\n1WWHMA1nQRhB/zIEBqC9nbb2HNZFn/sG8tKyrcltN4JfFuvktaskA1Py91sy5iKZ\nzm5cJ/SxXu35HnRPc6LEXFiDONxt0uJBDrN3m6C8ex9mHAM0FH3bdKTwO+xutR77\nhMANOq9SPU66F7WG2FJsw1nSWirT0urfsUsHsSTxA1bK0N1QKwuCPIIOPMV6i0jw\ncpRQFnlxM6d8+8R3qako\n=B6JW\n-----END PGP SIGNATURE-----\n",
        "payload": "tree f7925ae50d9b0796b4e662533956cf5170774f8f\nparent 5fdb8ae85b1cdc367cec03e767177560ffe1e5cd\nauthor HIT_LWY <75512499+liwenyu2002@users.noreply.github.com> 1765246384 +0800\ncommitter GitHub <noreply@github.com> 1765246384 +0800\n\nUpdate deploy.yml",
        "verified_at": "2025-12-09T02:13:05Z"
      }
    },
    "url": "https://api.github.com/repos/liwenyu2002/mamage-server/commits/da926c53764f2d6cbdf8fe3b73a21a4d2153ce02",
    "html_url": "https://github.com/liwenyu2002/mamage-server/commit/da926c53764f2d6cbdf8fe3b73a21a4d2153ce02",
    "comments_url": "https://api.github.com/repos/liwenyu2002/mamage-server/commits/da926c53764f2d6cbdf8fe3b73a21a4d2153ce02/comments",
    "author": {
      "login": "liwenyu2002",
      "id": 75512499,
      "node_id": "MDQ6VXNlcjc1NTEyNDk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/75512499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/liwenyu2002",
      "html_url": "https://github.com/liwenyu2002",
      "followers_url": "https://api.github.com/users/liwenyu2002/followers",
      "following_url": "https://api.github.com/users/liwenyu2002/following{/other_user}",
      "gists_url": "https://api.github.com/users/liwenyu2002/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/liwenyu2002/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/liwenyu2002/subscriptions",
      "organizations_url": "https://api.github.com/users/liwenyu2002/orgs",
      "repos_url": "https://api.github.com/users/liwenyu2002/repos",
      "events_url": "https://api.github.com/users/liwenyu2002/events{/privacy}",
      "received_events_url": "https://api.github.com/users/liwenyu2002/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "committer": {
      "login": "web-flow",
      "id": 19864447,
      "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
      "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/web-flow",
      "html_url": "https://github.com/web-flow",
      "followers_url": "https://api.github.com/users/web-flow/followers",
      "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
      "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
      "organizations_url": "https://api.github.com/users/web-flow/orgs",
      "repos_url": "https://api.github.com/users/web-flow/repos",
      "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/web-flow/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5fdb8ae85b1cdc367cec03e767177560ffe1e5cd",
        "url": "https://api.github.com/repos/liwenyu2002/mamage-server/commits/5fdb8ae85b1cdc367cec03e767177560ffe1e5cd",
        "html_url": "https://github.com/liwenyu2002/mamage-server/commit/5fdb8ae85b1cdc367cec03e767177560ffe1e5cd"
      }
    ],
    "stats": {
      "total": 35,
      "additions": 20,
      "deletions": 15
    },
    "files": [
      {
        "sha": "71b70c8c4c04e2a8b9a55411feefab9182f13dfc",
        "filename": ".github/workflows/deploy.yml",
        "status": "modified",
        "additions": 20,
        "deletions": 15,
        "changes": 35,
        "blob_url": "https://github.com/liwenyu2002/mamage-server/blob/da926c53764f2d6cbdf8fe3b73a21a4d2153ce02/.github%2Fworkflows%2Fdeploy.yml",
        "raw_url": "https://github.com/liwenyu2002/mamage-server/raw/da926c53764f2d6cbdf8fe3b73a21a4d2153ce02/.github%2Fworkflows%2Fdeploy.yml",
        "contents_url": "https://api.github.com/repos/liwenyu2002/mamage-server/contents/.github%2Fworkflows%2Fdeploy.yml?ref=da926c53764f2d6cbdf8fe3b73a21a4d2153ce02",
        "patch": "@@ -9,19 +9,21 @@ jobs:\n     runs-on: ubuntu-latest\n \n     steps:\n+      # 1. 在 GitHub runner 上拉代码\n       - name: Checkout code\n         uses: actions/checkout@v4\n \n+      # 2. 准备 Node 环境（跑依赖/测试用，非必须但建议保留）\n       - name: Use Node.js 20\n         uses: actions/setup-node@v4\n         with:\n           node-version: \"20\"\n \n-      # 可选：CI 里先跑一次安装，提前发现依赖问题\n+      # 3. 在 CI 上先装一遍依赖，提前暴露问题\n       - name: Install dependencies\n         run: npm ci || npm install\n \n-      # 可选：有测试就跑，没有就略过\n+      # 4. （可选）跑测试，没有测试的话会直接 continue\n       - name: Run tests (optional)\n         run: |\n           if npm test ; then\n@@ -30,33 +32,36 @@ jobs:\n             echo \"no tests or tests failed, continue anyway\"\n           fi\n \n-      # 配置 SSH，使用你在仓库里配置的 DEPLOY_SSH_KEY\n+      # 5. 配置 SSH agent，加载你在仓库 Secrets 里的 DEPLOY_SSH_KEY\n       - name: Setup SSH agent\n         uses: webfactory/ssh-agent@v0.9.0\n         with:\n           ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}\n \n-      # 部署到服务器\n-      - name: Deploy to server via SSH\n+      # 6. 用 rsync 将当前仓库内容同步到 ECS（替代原来的 git fetch/reset）\n+      - name: Sync code to server via rsync\n+        run: |\n+          rsync -avz --delete \\\n+            --exclude \".git/\" \\\n+            --exclude \"node_modules/\" \\\n+            --exclude \".github/\" \\\n+            -e \"ssh -p ${{ secrets.DEPLOY_PORT }} -o StrictHostKeyChecking=no\" \\\n+            ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/home/liwy/mamage-server/\n+\n+      # 7. SSH 登录 ECS，安装依赖并重启 pm2\n+      - name: Install & restart on server\n         run: |\n           ssh -o StrictHostKeyChecking=no -p ${{ secrets.DEPLOY_PORT }} \\\n             ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'\n           set -e\n-\n-          # 后端项目所在目录\n           cd /home/liwy/mamage-server\n \n-          # 拉最新代码\n-          git fetch origin main\n-          git reset --hard origin/main\n-\n-          # 安装依赖（生产环境省略 devDependencies）\n+          # 在服务器上安装生产依赖\n           npm ci --omit=dev || npm install --omit=dev\n \n-          # 重启 pm2 进程，第一次没有的话就 start\n+          # 重启 pm2 进程，第一次没有就 start\n           pm2 restart mamage-server || pm2 start app.js --name mamage-server\n \n-          # 保存 pm2 进程列表，保证重启后还能自启（如果你配置了 pm2 startup）\n+          # 保存 pm2 进程列表（如果配置了 pm2 startup）\n           pm2 save\n-\n           EOF"
      }
    ]
  }
}