{
  "cached_at": "2025-12-20T14:34:15.367251",
  "commit_sha": "4c088b5d4e1d277a416947f05903296701a514aa",
  "repo": "malabz/Cax",
  "data": {
    "sha": "4c088b5d4e1d277a416947f05903296701a514aa",
    "node_id": "C_kwDOPt61otoAKDRjMDg4YjVkNGUxZDI3N2E0MTY5NDdmMDU5MDMyOTY3MDFhNTE0YWE",
    "commit": {
      "author": {
        "name": "ripple-jmx",
        "email": "mingxuanjiang@hust.edu.cn",
        "date": "2025-11-08T08:38:18Z"
      },
      "committer": {
        "name": "ripple-jmx",
        "email": "mingxuanjiang@hust.edu.cn",
        "date": "2025-11-08T08:38:18Z"
      },
      "message": "feat: add dedicated run settings screen and runtime configs",
      "tree": {
        "sha": "0b34ca244643cba4bbdb9d81821d3e152e7e0d50",
        "url": "https://api.github.com/repos/malabz/Cax/git/trees/0b34ca244643cba4bbdb9d81821d3e152e7e0d50"
      },
      "url": "https://api.github.com/repos/malabz/Cax/git/commits/4c088b5d4e1d277a416947f05903296701a514aa",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null,
        "verified_at": null
      }
    },
    "url": "https://api.github.com/repos/malabz/Cax/commits/4c088b5d4e1d277a416947f05903296701a514aa",
    "html_url": "https://github.com/malabz/Cax/commit/4c088b5d4e1d277a416947f05903296701a514aa",
    "comments_url": "https://api.github.com/repos/malabz/Cax/commits/4c088b5d4e1d277a416947f05903296701a514aa/comments",
    "author": {
      "login": "ripple-jmx",
      "id": 55392975,
      "node_id": "MDQ6VXNlcjU1MzkyOTc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/55392975?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ripple-jmx",
      "html_url": "https://github.com/ripple-jmx",
      "followers_url": "https://api.github.com/users/ripple-jmx/followers",
      "following_url": "https://api.github.com/users/ripple-jmx/following{/other_user}",
      "gists_url": "https://api.github.com/users/ripple-jmx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ripple-jmx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ripple-jmx/subscriptions",
      "organizations_url": "https://api.github.com/users/ripple-jmx/orgs",
      "repos_url": "https://api.github.com/users/ripple-jmx/repos",
      "events_url": "https://api.github.com/users/ripple-jmx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ripple-jmx/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "committer": {
      "login": "ripple-jmx",
      "id": 55392975,
      "node_id": "MDQ6VXNlcjU1MzkyOTc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/55392975?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ripple-jmx",
      "html_url": "https://github.com/ripple-jmx",
      "followers_url": "https://api.github.com/users/ripple-jmx/followers",
      "following_url": "https://api.github.com/users/ripple-jmx/following{/other_user}",
      "gists_url": "https://api.github.com/users/ripple-jmx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ripple-jmx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ripple-jmx/subscriptions",
      "organizations_url": "https://api.github.com/users/ripple-jmx/orgs",
      "repos_url": "https://api.github.com/users/ripple-jmx/repos",
      "events_url": "https://api.github.com/users/ripple-jmx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ripple-jmx/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b549253116f9c2205d594b9a48fd8c4c6e7d090d",
        "url": "https://api.github.com/repos/malabz/Cax/commits/b549253116f9c2205d594b9a48fd8c4c6e7d090d",
        "html_url": "https://github.com/malabz/Cax/commit/b549253116f9c2205d594b9a48fd8c4c6e7d090d"
      }
    ],
    "stats": {
      "total": 454,
      "additions": 398,
      "deletions": 56
    },
    "files": [
      {
        "sha": "f71463e5bf7c685d1e366413942f7ec88365394d",
        "filename": "CHANGELOG.md",
        "status": "modified",
        "additions": 12,
        "deletions": 0,
        "changes": 12,
        "blob_url": "https://github.com/malabz/Cax/blob/4c088b5d4e1d277a416947f05903296701a514aa/CHANGELOG.md",
        "raw_url": "https://github.com/malabz/Cax/raw/4c088b5d4e1d277a416947f05903296701a514aa/CHANGELOG.md",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/CHANGELOG.md?ref=4c088b5d4e1d277a416947f05903296701a514aa",
        "patch": "@@ -2,6 +2,18 @@\n \n All notable changes to this project will be documented in this file.\n \n+## [0.2.2] - Unreleased\n+\n+### UI\n+- The cactus-prepare wizard now lives inside a full-height scroll container with a dedicated footer so form fields remain focusable while actions stay pinned, even in narrow or short terminals.\n+- Instructions switch between compact and detailed copy, and resize-driven layout classes collapse spacing and stack buttons when needed to keep the wizard readable at any screen size.\n+- Pressing `R` now switches to a dedicated Run Settings screen that gathers verbose/log streaming and the shared cactus/RaMAx thread count in one place before execution, removing the in-plan toggles.\n+- The Run Settings screen shows a live plan summary next to the form, updates instantly as you toggle verbose or edit the thread count, and exposes keyboard hints (`Tab`, `Ctrl+Enter`, `V`) so the entire flow can be driven without the mouse. All instructional text has been converted to English for consistency.\n+\n+### CLI & Planner\n+- `cax ui` still accepts `--threads N`, but the value now seeds the Run Settings dialog (or the post-UI prompt when `--run-after` is used) instead of bloating the plan definition; the planner applies `--maxCores/--threads` overrides only at execution time.\n+- Plan serialization drops the `verbose`/`thread_count` fields, keeping plan files focused on cactus/RaMAx steps while run-only options live alongside the executor.\n+\n ## [0.2.1] - 2025-11-07\n \n ### Highlights"
      },
      {
        "sha": "27f6967d183d90b0b4aac2b6e2617a211e2a9b2f",
        "filename": "README.md",
        "status": "modified",
        "additions": 4,
        "deletions": 2,
        "changes": 6,
        "blob_url": "https://github.com/malabz/Cax/blob/4c088b5d4e1d277a416947f05903296701a514aa/README.md",
        "raw_url": "https://github.com/malabz/Cax/raw/4c088b5d4e1d277a416947f05903296701a514aa/README.md",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/README.md?ref=4c088b5d4e1d277a416947f05903296701a514aa",
        "patch": "@@ -44,17 +44,19 @@ cax\n   ```bash\n   cax --from-file steps-output/prepare_output.txt\n   ```\n+- Pass `--threads 32` to seed the run-settings prompt so cactus steps inherit `--maxCores 32` and RaMAx receives `--threads 32`; leave it unset to default to each command's original flag.\n \n ### 2. Work inside the UI\n \n - The left pane renders the cactus progressive tree; press **Space** to toggle the selected subtree between cactus and RaMAx (use **Ctrl+Space** to expand or collapse nodes).\n - The details pane now includes an environment summary card (RaMAx/cactus paths, versions, GPU, CPU, memory, disk) plus a compact plan overview table that adapts to narrow terminals.\n - `E`: edit commands for the selected round or RaMAx replacement in a multi-line editor (press **Ctrl+S** to save).\n-- `R`: run the entire plan immediately.\n+- `R`: run the entire plan; CAX switches to the Run Settings screen so you can review verbose logging and the shared thread count before execution.\n+- Run Settings shows a live plan summary next to the form, and you can drive it entirely with the keyboard (`Tab` / `Shift+Tab` to focus fields, `Ctrl+Enter` to launch, `V` to toggle verbose).\n - `S`: export all commands to `ramax_commands.txt` inside the chosen output directory.\n - `P`: refresh the overview table.\n - `Q`: quit the UI.\n-- `V`: toggle verbose logging (when on, all command output is streamed to the console; off by default).\n+- Verbose streaming is only controlled via the run-settings dialog so you can review the choice right before execution.\n \n When RaMAx is enabled for a round or subtree, execution stops on the first failure—it does not fall back to cactus `blast`/`align` automatically.\n "
      },
      {
        "sha": "9abd97ae92bd274205ddfea927881bb4ad18e8fa",
        "filename": "cax/cli.py",
        "status": "modified",
        "additions": 48,
        "deletions": 3,
        "changes": 51,
        "blob_url": "https://github.com/malabz/Cax/blob/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Fcli.py",
        "raw_url": "https://github.com/malabz/Cax/raw/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Fcli.py",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/cax%2Fcli.py?ref=4c088b5d4e1d277a416947f05903296701a514aa",
        "patch": "@@ -11,6 +11,7 @@\n import shutil\n \n from . import command_prompt, history, parser, render, ui as ui_module\n+from .models import RunSettings\n from .runner import PlanRunner\n \n app = typer.Typer(help=\"Cactus-RaMAx interactive tools (ui only)\")\n@@ -49,6 +50,11 @@ def ui(\n     prepare_args: Optional[str] = typer.Option(None, help=\"Arguments passed through to cactus-prepare\"),\n     from_file: Optional[Path] = typer.Option(None, help=\"Parse prepare output from an existing file\"),\n     run_after: bool = typer.Option(False, help=\"Run the plan after exiting the UI\"),\n+    threads: Optional[int] = typer.Option(\n+        None,\n+        min=1,\n+        help=\"Override cactus/RaMAx thread count for all steps (leave unset for command defaults)\",\n+    ),\n ) -> None:\n     \"\"\"Launch the interactive Textual UI for plan editing.\"\"\"\n \n@@ -65,19 +71,58 @@ def ui(\n     _ensure_clean_environment(out_dir_preview, job_store_preview)\n     text = _load_prepare_text(prepare_args, from_file, executable=executable)\n     plan = parser.parse_prepare_script(text)\n-    result = ui_module.launch(plan)\n+    run_settings = RunSettings(verbose=False, thread_count=threads)\n+    result = ui_module.launch(plan, run_settings=run_settings)\n     plan = result.plan\n+    run_settings = result.run_settings or run_settings\n     if result.action == \"run\" or run_after:\n-        runner = PlanRunner(plan, verbose=plan.verbose)\n+        if result.action != \"run\":\n+            run_settings = _prompt_run_settings(run_settings)\n+        runner = PlanRunner(plan, run_settings=run_settings)\n         runner.run()\n     else:\n-        print(render.plan_overview(plan))\n+        print(render.plan_overview(plan, run_settings=run_settings))\n \n \n if __name__ == \"__main__\":\n     app()\n \n \n+def _prompt_run_settings(defaults: RunSettings) -> RunSettings:\n+    \"\"\"Collect run-time settings from the user just before execution.\"\"\"\n+\n+    typer.echo(\"[cax] Configure run settings before execution:\")\n+    verbose = typer.confirm(\n+        \"Enable verbose logging (stream every command output)?\",\n+        default=defaults.verbose,\n+    )\n+\n+    thread_count = defaults.thread_count\n+    while True:\n+        default_display = \"\" if thread_count is None else str(thread_count)\n+        prompt = typer.prompt(\n+            \"Thread count for cactus/RaMAx (blank = auto)\",\n+            default=default_display,\n+            show_default=bool(default_display),\n+        )\n+        stripped = prompt.strip()\n+        if not stripped:\n+            thread_count = None\n+            break\n+        try:\n+            value = int(stripped)\n+        except ValueError:\n+            typer.echo(\"[cax] Please enter a positive integer or leave blank.\")\n+            continue\n+        if value <= 0:\n+            typer.echo(\"[cax] Thread count must be at least 1.\")\n+            continue\n+        thread_count = value\n+        break\n+\n+    return RunSettings(verbose=verbose, thread_count=thread_count)\n+\n+\n def _prepare_plan_preview(\n     executable: str,\n     prepare_args: Optional[str],"
      },
      {
        "sha": "3312cccf7227ddf5a4ea40553efae09878b63234",
        "filename": "cax/models.py",
        "status": "modified",
        "additions": 9,
        "deletions": 1,
        "changes": 10,
        "blob_url": "https://github.com/malabz/Cax/blob/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Fmodels.py",
        "raw_url": "https://github.com/malabz/Cax/raw/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Fmodels.py",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/cax%2Fmodels.py?ref=4c088b5d4e1d277a416947f05903296701a514aa",
        "patch": "@@ -1,6 +1,7 @@\n \"\"\"Core data models for the Cactus-RaMAx workflow.\"\"\"\n from __future__ import annotations\n \n+from dataclasses import dataclass\n from datetime import datetime\n from typing import Literal, Optional\n \n@@ -90,11 +91,18 @@ class Plan(BaseModel):\n     out_dir: Optional[str] = None\n     dry_run: bool = False\n     global_ramax_opts: list[str] = Field(default_factory=list)\n-    verbose: bool = False\n \n     @field_validator(\"out_seq_file\")\n     @classmethod\n     def _validate_out_seq_file(cls, value: str) -> str:\n         if not value:\n             raise ValueError(\"out_seq_file cannot be empty\")\n         return value\n+\n+\n+@dataclass\n+class RunSettings:\n+    \"\"\"Runtime-only options applied immediately before executing a plan.\"\"\"\n+\n+    verbose: bool = False\n+    thread_count: Optional[int] = None"
      },
      {
        "sha": "4e669550c9497a474106fb12a29a66d2b03f364e",
        "filename": "cax/planner.py",
        "status": "modified",
        "additions": 76,
        "deletions": 9,
        "changes": 85,
        "blob_url": "https://github.com/malabz/Cax/blob/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Fplanner.py",
        "raw_url": "https://github.com/malabz/Cax/raw/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Fplanner.py",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/cax%2Fplanner.py?ref=4c088b5d4e1d277a416947f05903296701a514aa",
        "patch": "@@ -29,7 +29,11 @@ def shell_preview(self) -> str:\n         return shlex.join(self.command)\n \n \n-def build_execution_plan(plan: Plan, base_dir: Optional[Path] = None) -> list[PlannedCommand]:\n+def build_execution_plan(\n+    plan: Plan,\n+    base_dir: Optional[Path] = None,\n+    thread_count: Optional[int] = None,\n+) -> list[PlannedCommand]:\n     \"\"\"Materialise the full list of commands that should be executed.\"\"\"\n \n     base_dir = base_dir or Path.cwd()\n@@ -39,29 +43,46 @@ def build_execution_plan(plan: Plan, base_dir: Optional[Path] = None) -> list[Pl\n     skip_roots = _compute_skipped_roots(plan, tree)\n \n     for step in plan.preprocess:\n-        commands.append(_from_step(step, category=\"preprocess\", base_dir=base_dir))\n+        commands.append(\n+            _from_step(\n+                step,\n+                category=\"preprocess\",\n+                base_dir=base_dir,\n+                thread_count=thread_count,\n+            )\n+        )\n \n     for round_entry in plan.rounds:\n         if round_entry.root in skip_roots:\n             continue\n-        commands.extend(_round_commands(plan, round_entry, base_dir))\n+        commands.extend(_round_commands(plan, round_entry, base_dir, thread_count))\n \n     for step in plan.hal_merges:\n         if step.root and step.root in skip_roots:\n             continue\n-        commands.append(_from_step(step, category=\"halmerge\", base_dir=base_dir))\n+        commands.append(\n+            _from_step(\n+                step,\n+                category=\"halmerge\",\n+                base_dir=base_dir,\n+                thread_count=thread_count,\n+            )\n+        )\n \n     return commands\n \n \n-def _round_commands(plan: Plan, round_entry: Round, base_dir: Path) -> list[PlannedCommand]:\n+def _round_commands(\n+    plan: Plan,\n+    round_entry: Round,\n+    base_dir: Path,\n+    thread_count: Optional[int],\n+) -> list[PlannedCommand]:\n     cmds: list[PlannedCommand] = []\n     round_name = round_entry.name\n \n     if round_entry.replace_with_ramax:\n-        cmds.append(\n-            _ramax_command(plan, round_entry, base_dir)\n-        )\n+        cmds.append(_ramax_command(plan, round_entry, base_dir, thread_count))\n     else:\n         if round_entry.blast_step:\n             cmds.append(\n@@ -70,6 +91,7 @@ def _round_commands(plan: Plan, round_entry: Round, base_dir: Path) -> list[Plan\n                     category=\"blast\",\n                     base_dir=base_dir,\n                     round_name=round_name,\n+                    thread_count=thread_count,\n                 )\n             )\n         if round_entry.align_step:\n@@ -79,6 +101,7 @@ def _round_commands(plan: Plan, round_entry: Round, base_dir: Path) -> list[Plan\n                     category=\"align\",\n                     base_dir=base_dir,\n                     round_name=round_name,\n+                    thread_count=thread_count,\n                 )\n             )\n \n@@ -89,6 +112,7 @@ def _round_commands(plan: Plan, round_entry: Round, base_dir: Path) -> list[Plan\n                 category=\"hal2fasta\",\n                 base_dir=base_dir,\n                 round_name=round_name,\n+                thread_count=thread_count,\n             )\n         )\n \n@@ -100,10 +124,12 @@ def _from_step(\n     category: str,\n     base_dir: Path,\n     round_name: Optional[str] = None,\n+    thread_count: Optional[int] = None,\n ) -> PlannedCommand:\n     command = _split_command(step.raw)\n     if step.kind == \"hal2fasta\":\n         command = _normalize_hal2fasta(command)\n+    command = _ensure_cactus_threads(command, thread_count)\n     log_path = Path(step.log_file) if step.log_file else None\n     display_name = step.short_label()\n     return PlannedCommand(\n@@ -116,7 +142,12 @@ def _from_step(\n     )\n \n \n-def _ramax_command(plan: Plan, round_entry: Round, base_dir: Path) -> PlannedCommand:\n+def _ramax_command(\n+    plan: Plan,\n+    round_entry: Round,\n+    base_dir: Path,\n+    thread_count: Optional[int],\n+) -> PlannedCommand:\n     workdir = round_entry.workdir\n     if not workdir and plan.out_dir:\n         workdir = str(Path(plan.out_dir) / \"temps\" / f\"blast-{round_entry.root}\")\n@@ -137,6 +168,7 @@ def _ramax_command(plan: Plan, round_entry: Round, base_dir: Path) -> PlannedCom\n             command.extend([\"-w\", workdir])\n         command.extend(plan.global_ramax_opts)\n         command.extend(round_entry.ramax_opts)\n+        command = _ensure_ramax_threads(command, thread_count)\n \n     log_path = _guess_ramax_log_path(plan, round_entry, base_dir)\n \n@@ -221,6 +253,41 @@ def _normalize_hal2fasta(command: List[str]) -> List[str]:\n     return cleaned\n \n \n+def _ensure_cactus_threads(command: List[str], thread_count: Optional[int]) -> List[str]:\n+    if thread_count is None or not command:\n+        return command\n+    name = Path(command[0]).name\n+    if not name.startswith(\"cactus\"):\n+        return command\n+    if _has_flag(command, \"--maxCores\"):\n+        return command\n+    adjusted = list(command)\n+    adjusted.extend([\"--maxCores\", str(thread_count)])\n+    return adjusted\n+\n+\n+def _ensure_ramax_threads(command: List[str], thread_count: Optional[int]) -> List[str]:\n+    if thread_count is None or not command:\n+        return command\n+    name = Path(command[0]).name.lower()\n+    if name != \"ramax\":\n+        return command\n+    if _has_flag(command, \"--threads\"):\n+        return command\n+    adjusted = list(command)\n+    adjusted.extend([\"--threads\", str(thread_count)])\n+    return adjusted\n+\n+\n+def _has_flag(command: List[str], flag: str) -> bool:\n+    for token in command:\n+        if token == flag:\n+            return True\n+        if token.startswith(flag + \"=\"):\n+            return True\n+    return False\n+\n+\n def _compute_skipped_roots(plan: Plan, tree: Optional[tree_utils.AlignmentTree]) -> set[str]:\n     if tree is None:\n         return set()"
      },
      {
        "sha": "151affb2b73924f18cc36581dda1ebd85333cf45",
        "filename": "cax/render.py",
        "status": "modified",
        "additions": 10,
        "deletions": 3,
        "changes": 13,
        "blob_url": "https://github.com/malabz/Cax/blob/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Frender.py",
        "raw_url": "https://github.com/malabz/Cax/raw/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Frender.py",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/cax%2Frender.py?ref=4c088b5d4e1d277a416947f05903296701a514aa",
        "patch": "@@ -10,11 +10,11 @@\n from rich.table import Table\n from rich.text import Text\n \n-from .models import Plan\n+from .models import Plan, RunSettings\n from .planner import PlannedCommand\n \n \n-def plan_overview(plan: Plan, compact: bool = False) -> Panel:\n+def plan_overview(plan: Plan, run_settings: Optional[RunSettings] = None, compact: bool = False) -> Panel:\n     \"\"\"Return a Rich Panel summarising the plan (auto-resizes in UI).\"\"\"\n \n     table = Table(\n@@ -46,7 +46,14 @@ def plan_overview(plan: Plan, compact: bool = False) -> Panel:\n             row.append(round_entry.workdir or \"\")\n         table.add_row(*row)\n \n-    footer = Text(f\"Verbose logging: {'on' if plan.verbose else 'off'}\", style=\"dim\")\n+    settings = run_settings or RunSettings()\n+    thread_label = (\n+        \"auto (command defaults)\"\n+        if settings.thread_count is None\n+        else f\"{settings.thread_count} threads (--maxCores/--threads)\"\n+    )\n+    footer_text = f\"Verbose logging: {'on' if settings.verbose else 'off'} | Thread target: {thread_label}\"\n+    footer = Text(footer_text, style=\"dim\")\n     content = Group(table, footer)\n     return Panel(content, border_style=\"magenta\", expand=True)\n "
      },
      {
        "sha": "6df4548eeef68a2728e64cbf6ca38ab2cf2dfbc2",
        "filename": "cax/runner.py",
        "status": "modified",
        "additions": 10,
        "deletions": 4,
        "changes": 14,
        "blob_url": "https://github.com/malabz/Cax/blob/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Frunner.py",
        "raw_url": "https://github.com/malabz/Cax/raw/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Frunner.py",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/cax%2Frunner.py?ref=4c088b5d4e1d277a416947f05903296701a514aa",
        "patch": "@@ -12,7 +12,7 @@\n from rich.progress import Progress, SpinnerColumn, TextColumn, TimeElapsedColumn, TaskID\n \n from . import planner\n-from .models import Plan\n+from .models import Plan, RunSettings\n \n \n IMPORTANT_KEYWORDS = (\"error\", \"failed\", \"exception\", \"critical\")\n@@ -27,7 +27,7 @@ def __init__(\n         base_dir: Optional[Path] = None,\n         env: Optional[dict[str, str]] = None,\n         mirror_stdout: bool = True,\n-        verbose: bool = False,\n+        run_settings: Optional[RunSettings] = None,\n     ):\n         self.plan = plan\n         self.base_dir = Path(base_dir) if base_dir else Path.cwd()\n@@ -38,13 +38,19 @@ def __init__(\n         self.master_log_path = self.log_root / \"cax-run.log\"\n         self.mirror_stdout = mirror_stdout\n         self.console = Console(stderr=True)\n-        self.verbose = verbose\n+        self.run_settings = run_settings or RunSettings()\n+        self.verbose = self.run_settings.verbose\n+        self.thread_count = self.run_settings.thread_count\n \n     def run(self, dry_run: Optional[bool] = None) -> None:\n         \"\"\"Execute the plan. When ``dry_run`` is True, commands are only logged.\"\"\"\n \n         effective_dry = self.plan.dry_run if dry_run is None else dry_run\n-        planned_commands = planner.build_execution_plan(self.plan, self.base_dir)\n+        planned_commands = planner.build_execution_plan(\n+            self.plan,\n+            self.base_dir,\n+            thread_count=self.thread_count,\n+        )\n         self.log_root.mkdir(parents=True, exist_ok=True)\n         total_commands = len(planned_commands)\n         completed_commands = 0"
      },
      {
        "sha": "05814d6fdc623da57edbcfa36b15c60c4ff539ea",
        "filename": "cax/ui.py",
        "status": "modified",
        "additions": 229,
        "deletions": 34,
        "changes": 263,
        "blob_url": "https://github.com/malabz/Cax/blob/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Fui.py",
        "raw_url": "https://github.com/malabz/Cax/raw/4c088b5d4e1d277a416947f05903296701a514aa/cax%2Fui.py",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/cax%2Fui.py?ref=4c088b5d4e1d277a416947f05903296701a514aa",
        "patch": "@@ -9,20 +9,21 @@\n from textual.binding import Binding\n from textual.containers import Container\n from textual.geometry import Size\n-from textual.screen import ModalScreen\n-from textual.widgets import Button, Footer, Header, Input, ListItem, ListView, Static, Tree, TextArea\n+from textual.screen import ModalScreen, Screen\n+from textual.widgets import Button, Checkbox, Footer, Header, Input, ListItem, ListView, Static, Tree, TextArea\n \n from rich.text import Text\n \n from . import detectors, planner, render, tree_utils\n-from .models import Plan, Round, Step\n+from .models import Plan, Round, RunSettings, Step\n \n \n @dataclass\n class UIResult:\n     plan: Plan\n     action: str\n     payload: Optional[Path] = None\n+    run_settings: RunSettings | None = None\n \n \n @dataclass\n@@ -37,6 +38,8 @@ class CommandTarget:\n     index: int | None = None\n \n \n+\n+\n class CommandSelectionModal(ModalScreen[CommandTarget | None]):\n     \"\"\"Modal dialog listing all editable commands for a round.\"\"\"\n \n@@ -97,6 +100,12 @@ def on_list_view_selected(self, event: ListView.Selected) -> None:\n     def action_cancel(self) -> None:\n         self.dismiss(None)\n \n+    def on_button_pressed(self, event: Button.Pressed) -> None:\n+        if event.button.id == \"save\":\n+            self.action_save()\n+        elif event.button.id == \"cancel\":\n+            self.action_cancel()\n+\n \n class CommandEditModal(ModalScreen[str | None]):\n     \"\"\"Modal dialog allowing the user to edit a command string.\"\"\"\n@@ -175,12 +184,197 @@ def action_save(self) -> None:\n     def action_cancel(self) -> None:\n         self.dismiss(None)\n \n+\n+class RunSettingsScreen(Screen[RunSettings | None]):\n+    \"\"\"Dedicated screen for confirming run-time configuration.\"\"\"\n+\n+    BINDINGS = [\n+        Binding(\"escape\", \"cancel\", \"Back\"),\n+        Binding(\"ctrl+enter\", \"save\", \"Run\"),\n+        Binding(\"ctrl+r\", \"save\", \"Run\"),\n+        Binding(\"v\", \"toggle_verbose\", \"Toggle verbose\"),\n+    ]\n+\n+    CSS = \"\"\"\n+    RunSettingsScreen > .screen {\n+        layout: vertical;\n+    }\n+    #run-root {\n+        padding: 1 2;\n+        height: 1fr;\n+        width: 100%;\n+        layout: vertical;\n+        min-height: 0;\n+    }\n+    #run-title {\n+        padding-bottom: 1;\n+    }\n+    #run-body {\n+        layout: horizontal;\n+        min-height: 0;\n+    }\n+    #run-summary {\n+        width: 60%;\n+        min-width: 40;\n+        margin-right: 2;\n+        height: 1fr;\n+        overflow-y: auto;\n+    }\n+    #run-form {\n+        width: 40%;\n+        min-width: 32;\n+        height: 1fr;\n+        border: round $accent;\n+        padding: 1;\n+        background: $panel;\n+        layout: vertical;\n+    }\n+    #run-instructions {\n+        color: $text-muted;\n+        padding-bottom: 1;\n+    }\n+    #run-verbose {\n+        margin-bottom: 1;\n+    }\n+    #run-threads {\n+        width: 100%;\n+    }\n+    #run-hint {\n+        padding-top: 1;\n+        color: $text-muted;\n+    }\n+    #run-status {\n+        padding-top: 1;\n+        color: $error;\n+    }\n+    #run-buttons {\n+        padding-top: 1;\n+        layout: horizontal;\n+        content-align: right middle;\n+    }\n+    #run-buttons Button {\n+        margin-left: 1;\n+    }\n+    #run-buttons Button:first-child {\n+        margin-left: 0;\n+    }\n+    \"\"\"\n+\n+    def __init__(self, plan: Plan, current: RunSettings, compact: bool):\n+        super().__init__()\n+        self.plan = plan\n+        self.current = current\n+        self.compact = compact\n+        self._summary: Static | None = None\n+        self._input: Input | None = None\n+        self._verbose: Checkbox | None = None\n+        self._status: Static | None = None\n+\n+    def compose(self) -> ComposeResult:\n+        yield Header()\n+        with Container(id=\"run-root\"):\n+            yield Static(\"Plan is ready. Review run settings before execution:\", id=\"run-title\")\n+            with Container(id=\"run-body\"):\n+                summary = Static(id=\"run-summary\")\n+                self._summary = summary\n+                summary.update(render.plan_overview(self.plan, run_settings=self.current, compact=self.compact))\n+                yield summary\n+                with Container(id=\"run-form\"):\n+                    yield Static(\"• Tab/Shift+Tab to move between controls\\n• Ctrl+Enter to run immediately\\n• V toggles verbose logging\", id=\"run-instructions\")\n+                    verbose_box = Checkbox(\n+                        \"Verbose logging (stream every command output)\",\n+                        value=self.current.verbose,\n+                        id=\"run-verbose\",\n+                    )\n+                    self._verbose = verbose_box\n+                    yield verbose_box\n+                    threads_input = Input(\n+                        value=\"\" if self.current.thread_count is None else str(self.current.thread_count),\n+                        placeholder=\"Leave blank to keep each command's thread defaults\",\n+                        id=\"run-threads\",\n+                    )\n+                    self._input = threads_input\n+                    yield threads_input\n+                    yield Static(\"Threads propagate to cactus --maxCores and RaMAx --threads.\", id=\"run-hint\")\n+                    status = Static(\"\", id=\"run-status\")\n+                    self._status = status\n+                    yield status\n+                    with Container(id=\"run-buttons\"):\n+                        yield Button(\"Run plan (Ctrl+Enter)\", id=\"run-confirm\", variant=\"success\")\n+                        yield Button(\"Back to plan (Esc)\", id=\"run-cancel\")\n+        yield Footer()\n+\n+    def on_mount(self) -> None:\n+        if self._input:\n+            self.set_focus(self._input)\n+\n+    def _validate_threads(self) -> tuple[bool, Optional[int], Optional[str]]:\n+        if not self._input:\n+            return True, None, None\n+        text = self._input.value.strip()\n+        if not text:\n+            return True, None, None\n+        try:\n+            value = int(text)\n+        except ValueError:\n+            return False, None, \"Thread count must be a positive integer.\"\n+        if value <= 0:\n+            return False, None, \"Thread count must be at least 1.\"\n+        return True, value, None\n+\n+    def _update_status(self, message: str | None) -> None:\n+        if self._status is not None:\n+            self._status.update(message or \"\")\n+\n+    def action_save(self) -> None:\n+        ok, threads, error = self._validate_threads()\n+        if not ok:\n+            self._update_status(error)\n+            return\n+        self._update_status(\"\")\n+        verbose = self._verbose.value if self._verbose else False\n+        self.dismiss(RunSettings(verbose=verbose, thread_count=threads))\n+\n+    def action_cancel(self) -> None:\n+        self.dismiss(None)\n+\n+    def action_toggle_verbose(self) -> None:\n+        if self._verbose:\n+            self._verbose.value = not self._verbose.value\n+            self._refresh_summary()\n+\n+    def on_input_submitted(self, event: Input.Submitted) -> None:\n+        if event.input.id == \"run-threads\":\n+            self.action_save()\n+\n+    def on_input_changed(self, event: Input.Changed) -> None:\n+        if event.input.id == \"run-threads\":\n+            self._refresh_summary()\n+\n+    def on_checkbox_changed(self, event: Checkbox.Changed) -> None:\n+        if event.checkbox.id == \"run-verbose\":\n+            self._refresh_summary()\n+\n     def on_button_pressed(self, event: Button.Pressed) -> None:\n-        if event.button.id == \"save\":\n+        if event.button.id == \"run-confirm\":\n             self.action_save()\n-        else:\n+        elif event.button.id == \"run-cancel\":\n             self.action_cancel()\n \n+    def _current_settings_preview(self) -> RunSettings:\n+        verbose = self._verbose.value if self._verbose else self.current.verbose\n+        ok, threads, _ = self._validate_threads()\n+        thread_val = threads if ok else self.current.thread_count\n+        return RunSettings(verbose=verbose, thread_count=thread_val)\n+\n+    def _refresh_summary(self) -> None:\n+        if not self._summary:\n+            return\n+        settings = self._current_settings_preview()\n+        self._summary.update(\n+            render.plan_overview(self.plan, run_settings=settings, compact=self.compact)\n+        )\n+\n \n class RamaxOptionsModal(ModalScreen[tuple[list[str], list[str]] | None]):\n     \"\"\"Modal dialog for editing global and per-round RaMAx options.\"\"\"\n@@ -429,10 +623,9 @@ class PlanUIApp(App[UIResult]):\n         Binding(\"s\", \"save_commands\", \"Save commands\"),\n         Binding(\"r\", \"run_plan\", \"Run\"),\n         Binding(\"q\", \"quit\", \"Quit\"),\n-        Binding(\"v\", \"toggle_verbose\", \"Toggle verbose\"),\n     ]\n \n-    def __init__(self, plan: Plan, base_dir: Optional[Path] = None):\n+    def __init__(self, plan: Plan, base_dir: Optional[Path] = None, run_settings: Optional[RunSettings] = None):\n         super().__init__()\n         self.plan = plan\n         self.base_dir = Path(base_dir) if base_dir else Path.cwd()\n@@ -442,6 +635,7 @@ def __init__(self, plan: Plan, base_dir: Optional[Path] = None):\n         self.round_list: ListView | None = None\n         self.detail_panel: Static | None = None\n         self._environment_card: Static | None = None\n+        self.run_settings = run_settings or RunSettings()\n \n     def compose(self) -> ComposeResult:\n         yield Header()\n@@ -476,7 +670,7 @@ def compose(self) -> ComposeResult:\n             with Container(id=\"details\"):\n                 yield environment_card\n                 detail = Static(\n-                    render.plan_overview(self.plan, compact=self._is_compact()),\n+                    render.plan_overview(self.plan, run_settings=self.run_settings, compact=self._is_compact()),\n                     id=\"plan-overview\",\n                 )\n                 self.detail_panel = detail\n@@ -536,42 +730,29 @@ def action_toggle_round(self) -> None:\n \n     def action_preview_plan(self) -> None:\n         if self.detail_panel:\n-            preview = render.plan_overview(self.plan, compact=self._is_compact())\n+            preview = render.plan_overview(self.plan, run_settings=self.run_settings, compact=self._is_compact())\n             self.detail_panel.update(preview)\n \n     def action_run_plan(self) -> None:\n-        self.exit(UIResult(plan=self.plan, action=\"run\"))\n+        screen = RunSettingsScreen(self.plan, self.run_settings, compact=self._is_compact())\n+        self.push_screen(screen, self._finalize_run_settings)\n \n     def action_save_commands(self) -> None:\n         output_dir = Path(self.plan.out_dir or self.base_dir)\n         output_dir.mkdir(parents=True, exist_ok=True)\n         output_path = output_dir / \"ramax_commands.txt\"\n-        commands = planner.build_execution_plan(self.plan, self.base_dir)\n+        commands = planner.build_execution_plan(\n+            self.plan,\n+            self.base_dir,\n+            thread_count=self.run_settings.thread_count,\n+        )\n         lines = [cmd.shell_preview() for cmd in commands]\n         output_path.write_text(\"\\n\".join(lines) + \"\\n\", encoding=\"utf-8\")\n         if self.detail_panel:\n             self.detail_panel.update(f\"Commands saved to {output_path}\")\n \n     def action_quit(self) -> None:\n-        self.exit(UIResult(plan=self.plan, action=\"quit\"))\n-\n-    def action_toggle_verbose(self) -> None:\n-        self.plan.verbose = not self.plan.verbose\n-        message = \"Verbose logging enabled\" if self.plan.verbose else \"Verbose logging disabled\"\n-        if self.alignment_tree and self.tree_widget:\n-            node = self._selected_alignment_node()\n-            if node:\n-                self._show_alignment_node(node, status=message)\n-            elif self.detail_panel:\n-                self.detail_panel.update(message)\n-        elif self.round_list and self.round_items:\n-            index = self.round_list.index or 0\n-            if index < len(self.plan.rounds):\n-                self._show_round(index, status=message)\n-            elif self.detail_panel:\n-                self.detail_panel.update(message)\n-        elif self.detail_panel:\n-            self.detail_panel.update(message)\n+        self.exit(UIResult(plan=self.plan, action=\"quit\", run_settings=self.run_settings))\n \n     def _apply_env_visibility(self) -> None:\n         if not self._environment_card:\n@@ -887,21 +1068,35 @@ def _apply_ramax_options(\n                 return\n         self._show_round(round_index, status=status)\n \n+    def _finalize_run_settings(self, result: RunSettings | None) -> None:\n+        if result is None:\n+            return\n+        self.run_settings = result\n+        self.exit(UIResult(plan=self.plan, action=\"run\", run_settings=self.run_settings))\n+\n     def _ramax_command_preview(self, round_entry: Round) -> str:\n         if round_entry.manual_ramax_command:\n             return round_entry.manual_ramax_command\n-        commands = planner.build_execution_plan(self.plan, self.base_dir)\n+        commands = planner.build_execution_plan(\n+            self.plan,\n+            self.base_dir,\n+            thread_count=self.run_settings.thread_count,\n+        )\n         for command in commands:\n             if command.is_ramax and command.round_name == round_entry.name:\n                 return command.shell_preview()\n         return \"\"\n \n \n-def launch(plan: Plan, base_dir: Optional[Path] = None) -> UIResult:\n+def launch(\n+    plan: Plan,\n+    base_dir: Optional[Path] = None,\n+    run_settings: Optional[RunSettings] = None,\n+) -> UIResult:\n     \"\"\"Run the Textual UI and return the resulting plan/action.\"\"\"\n \n-    app = PlanUIApp(plan, base_dir=base_dir)\n+    app = PlanUIApp(plan, base_dir=base_dir, run_settings=run_settings)\n     result = app.run()\n     if isinstance(result, UIResult):\n         return result\n-    return UIResult(plan=plan, action=\"quit\")\n+    return UIResult(plan=plan, action=\"quit\", run_settings=run_settings)"
      }
    ]
  }
}