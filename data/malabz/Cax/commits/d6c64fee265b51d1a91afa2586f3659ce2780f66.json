{
  "cached_at": "2025-12-20T14:35:11.949591",
  "commit_sha": "d6c64fee265b51d1a91afa2586f3659ce2780f66",
  "repo": "malabz/Cax",
  "data": {
    "sha": "d6c64fee265b51d1a91afa2586f3659ce2780f66",
    "node_id": "C_kwDOPt61otoAKGQ2YzY0ZmVlMjY1YjUxZDFhOTFhZmEyNTg2ZjM2NTljZTI3ODBmNjY",
    "commit": {
      "author": {
        "name": "metaphysicser",
        "email": "zpl010720@qq.com",
        "date": "2025-11-03T08:52:41Z"
      },
      "committer": {
        "name": "metaphysicser",
        "email": "zpl010720@qq.com",
        "date": "2025-11-03T08:52:41Z"
      },
      "message": "feat: improve cactus-prepare onboarding UX\n\n- persist recent commands and allow quick selection from history\n- add parameter wizard and template picker to simplify command entry\n- introduce example/custom template management for generating standard cactus-prepare invocations",
      "tree": {
        "sha": "c0494849d37a67181c43fab10df440f322ba92fc",
        "url": "https://api.github.com/repos/malabz/Cax/git/trees/c0494849d37a67181c43fab10df440f322ba92fc"
      },
      "url": "https://api.github.com/repos/malabz/Cax/git/commits/d6c64fee265b51d1a91afa2586f3659ce2780f66",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null,
        "verified_at": null
      }
    },
    "url": "https://api.github.com/repos/malabz/Cax/commits/d6c64fee265b51d1a91afa2586f3659ce2780f66",
    "html_url": "https://github.com/malabz/Cax/commit/d6c64fee265b51d1a91afa2586f3659ce2780f66",
    "comments_url": "https://api.github.com/repos/malabz/Cax/commits/d6c64fee265b51d1a91afa2586f3659ce2780f66/comments",
    "author": {
      "login": "metaphysicser",
      "id": 62839294,
      "node_id": "MDQ6VXNlcjYyODM5Mjk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/62839294?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/metaphysicser",
      "html_url": "https://github.com/metaphysicser",
      "followers_url": "https://api.github.com/users/metaphysicser/followers",
      "following_url": "https://api.github.com/users/metaphysicser/following{/other_user}",
      "gists_url": "https://api.github.com/users/metaphysicser/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/metaphysicser/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/metaphysicser/subscriptions",
      "organizations_url": "https://api.github.com/users/metaphysicser/orgs",
      "repos_url": "https://api.github.com/users/metaphysicser/repos",
      "events_url": "https://api.github.com/users/metaphysicser/events{/privacy}",
      "received_events_url": "https://api.github.com/users/metaphysicser/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "committer": {
      "login": "metaphysicser",
      "id": 62839294,
      "node_id": "MDQ6VXNlcjYyODM5Mjk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/62839294?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/metaphysicser",
      "html_url": "https://github.com/metaphysicser",
      "followers_url": "https://api.github.com/users/metaphysicser/followers",
      "following_url": "https://api.github.com/users/metaphysicser/following{/other_user}",
      "gists_url": "https://api.github.com/users/metaphysicser/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/metaphysicser/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/metaphysicser/subscriptions",
      "organizations_url": "https://api.github.com/users/metaphysicser/orgs",
      "repos_url": "https://api.github.com/users/metaphysicser/repos",
      "events_url": "https://api.github.com/users/metaphysicser/events{/privacy}",
      "received_events_url": "https://api.github.com/users/metaphysicser/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "21a3d0beddc8039f4bb00ea91ed2c57958fca539",
        "url": "https://api.github.com/repos/malabz/Cax/commits/21a3d0beddc8039f4bb00ea91ed2c57958fca539",
        "html_url": "https://github.com/malabz/Cax/commit/21a3d0beddc8039f4bb00ea91ed2c57958fca539"
      }
    ],
    "stats": {
      "total": 445,
      "additions": 442,
      "deletions": 3
    },
    "files": [
      {
        "sha": "0261ecad0d3cc03b74606631c05902f65a690f57",
        "filename": "cax/cli.py",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/malabz/Cax/blob/d6c64fee265b51d1a91afa2586f3659ce2780f66/cax%2Fcli.py",
        "raw_url": "https://github.com/malabz/Cax/raw/d6c64fee265b51d1a91afa2586f3659ce2780f66/cax%2Fcli.py",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/cax%2Fcli.py?ref=d6c64fee265b51d1a91afa2586f3659ce2780f66",
        "patch": "@@ -10,7 +10,7 @@\n from rich import print\n import shutil\n \n-from . import command_prompt, parser, render, ui as ui_module\n+from . import command_prompt, history, parser, render, ui as ui_module\n from .runner import PlanRunner\n \n app = typer.Typer(help=\"Cactus-RaMAx interactive tools (ui only)\")\n@@ -29,6 +29,7 @@ def _load_prepare_text(\n             typer.echo(result.stderr, err=True)\n             raise typer.Exit(code=result.returncode)\n         output = result.stdout or \"\"\n+        history.add_command(shlex.join(cmd))\n         Path(\"steps-output\").mkdir(exist_ok=True, parents=True)\n         Path(\"steps-output/cax_prepare_debug.txt\").write_text(output, encoding=\"utf-8\")\n         return output"
      },
      {
        "sha": "b6e8d50878a7550f577f1235dbf24cd70dbc2ffa",
        "filename": "cax/command_prompt.py",
        "status": "modified",
        "additions": 285,
        "deletions": 2,
        "changes": 287,
        "blob_url": "https://github.com/malabz/Cax/blob/d6c64fee265b51d1a91afa2586f3659ce2780f66/cax%2Fcommand_prompt.py",
        "raw_url": "https://github.com/malabz/Cax/raw/d6c64fee265b51d1a91afa2586f3659ce2780f66/cax%2Fcommand_prompt.py",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/cax%2Fcommand_prompt.py?ref=d6c64fee265b51d1a91afa2586f3659ce2780f66",
        "patch": "@@ -8,7 +8,10 @@\n \n from textual.app import App, ComposeResult\n from textual.binding import Binding\n-from textual.widgets import Footer, Header, Input, Static\n+from textual.screen import Screen\n+from textual.widgets import Button, Footer, Header, Input, ListItem, ListView, Static\n+\n+from . import history, templates\n \n \n @dataclass\n@@ -20,6 +23,130 @@ class PromptResult:\n     action: Literal[\"submit\", \"quit\"]\n \n \n+class PrepareWizard(Screen[str | None]):\n+    \"\"\"Popup wizard that collects cactus-prepare arguments field by field.\"\"\"\n+\n+    BINDINGS = [\n+        Binding(\"escape\", \"cancel\", \"Back\"),\n+    ]\n+\n+    def __init__(self, defaults: dict[str, str] | None = None) -> None:\n+        super().__init__()\n+        self._status: Static | None = None\n+        self._fields: dict[str, Input] = {}\n+        self._defaults = defaults or {}\n+\n+    def compose(self) -> ComposeResult:\n+        yield Header()\n+        yield Static(\"Fill out the fields below and press “Generate command” to return.\", id=\"instructions\")\n+        for field_id, label, placeholder in [\n+            (\"spec\", \"Spec or plan file\", \"examples/evolverMammals.txt\"),\n+            (\"out_dir\", \"--outDir\", \"steps-output\"),\n+            (\"out_seq\", \"--outSeqFile\", \"steps-output/out.txt\"),\n+            (\"out_hal\", \"--outHal\", \"steps-output/out.hal\"),\n+            (\"job_store\", \"--jobStore\", \"jobstore\"),\n+            (\"extra\", \"Additional arguments\", \"--optionA foo --optionB\"),\n+        ]:\n+            value = self._defaults.get(field_id, \"\")\n+            input_widget = Input(value=value, placeholder=placeholder, id=field_id)\n+            self._fields[field_id] = input_widget\n+            yield Static(label)\n+            yield input_widget\n+        self._status = Static(\"\", id=\"status\")\n+        yield Button(\"Generate command\", id=\"submit\", variant=\"success\")\n+        yield Button(\"Cancel\", id=\"cancel\")\n+        yield self._status\n+        yield Footer()\n+\n+    def action_cancel(self) -> None:\n+        self.dismiss(None)\n+\n+    def on_button_pressed(self, event: Button.Pressed) -> None:  # type: ignore[override]\n+        if event.button.id == \"cancel\":\n+            self.dismiss(None)\n+            return\n+        if event.button.id != \"submit\":\n+            return\n+        spec = self._fields[\"spec\"].value.strip()\n+        if not spec:\n+            self._set_status(\"[red]Spec or plan file cannot be empty[/red]\")\n+            return\n+        spec_path = Path(spec)\n+        if not spec_path.exists():\n+            self._set_status(\"[red]Specified plan file does not exist[/red]\")\n+            return\n+        command = [\"cactus-prepare\", spec]\n+        out_dir = self._fields[\"out_dir\"].value.strip()\n+        if out_dir:\n+            command.extend([\"--outDir\", out_dir])\n+        out_seq = self._fields[\"out_seq\"].value.strip()\n+        if out_seq:\n+            command.extend([\"--outSeqFile\", out_seq])\n+        out_hal = self._fields[\"out_hal\"].value.strip()\n+        if out_hal:\n+            command.extend([\"--outHal\", out_hal])\n+        job_store = self._fields[\"job_store\"].value.strip()\n+        if job_store:\n+            command.extend([\"--jobStore\", job_store])\n+        extra = self._fields[\"extra\"].value.strip()\n+        if extra:\n+            command.extend(shlex.split(extra))\n+        self.dismiss(shlex.join(command))\n+\n+    def _set_status(self, message: str) -> None:\n+        if self._status:\n+            self._status.update(message)\n+\n+\n+class TemplateSelector(Screen[templates.Template | None]):\n+    \"\"\"Simple list view that lets the user pick a template.\"\"\"\n+\n+    BINDINGS = [\n+        Binding(\"escape\", \"cancel\", \"Back\"),\n+    ]\n+\n+    def __init__(self, template_list: list[templates.Template]) -> None:\n+        super().__init__()\n+        self._templates = template_list\n+        self._list_view: ListView | None = None\n+\n+    def compose(self) -> ComposeResult:\n+        yield Header()\n+        if not self._templates:\n+            yield Static(\"No templates available.\", id=\"instructions\")\n+        else:\n+            yield Static(\"Use the arrow keys to choose a template, then press Enter.\", id=\"instructions\")\n+            items: list[ListItem] = []\n+            for idx, template in enumerate(self._templates):\n+                description = f\"{template.name}\\n{template.spec}\"\n+                item = ListItem(Static(description), id=f\"template-{idx}\")\n+                items.append(item)\n+            list_view = ListView(*items, id=\"template-list\")\n+            self._list_view = list_view\n+            yield list_view\n+        yield Footer()\n+\n+    def action_cancel(self) -> None:\n+        self.dismiss(None)\n+\n+    def on_list_view_selected(self, event: ListView.Selected) -> None:  # type: ignore[override]\n+        if not event.item.id:\n+            return\n+        if not event.item.id.startswith(\"template-\"):\n+            return\n+        try:\n+            index = int(event.item.id.split(\"-\", 1)[1])\n+        except ValueError:\n+            return\n+        if index < 0 or index >= len(self._templates):\n+            return\n+        self.dismiss(self._templates[index])\n+\n+    def on_mount(self) -> None:  # type: ignore[override]\n+        if self._list_view:\n+            self._list_view.index = 0\n+\n+\n class PrepareCommandPrompt(App[PromptResult]):\n     \"\"\"Minimal Textual app that requests a cactus-prepare command.\"\"\"\n \n@@ -30,6 +157,10 @@ class PrepareCommandPrompt(App[PromptResult]):\n     #instructions {\n         padding: 1 2;\n     }\n+    #history {\n+        padding: 0 2;\n+        color: #b3b3b3;\n+    }\n     #command {\n         margin: 1 2;\n     }\n@@ -41,16 +172,33 @@ class PrepareCommandPrompt(App[PromptResult]):\n     BINDINGS = [\n         Binding(\"escape\", \"quit\", \"Quit\"),\n         Binding(\"ctrl+c\", \"quit\", \"Quit\"),\n+        Binding(\"f2\", \"open_wizard\", \"Wizard\"),\n+        Binding(\"f3\", \"choose_template\", \"Templates\"),\n+        Binding(\"ctrl+shift+w\", \"open_wizard\", \"Wizard\"),\n+        Binding(\"ctrl+shift+t\", \"choose_template\", \"Templates\"),\n     ]\n \n     def __init__(self) -> None:\n         super().__init__()\n         self._command_input: Input | None = None\n         self._status: Static | None = None\n+        self._history_text: Static | None = None\n+        self._history_entries = history.load_history()\n+        self._templates = templates.load_templates()\n+        self._template_defaults: dict[str, str] | None = None\n \n     def compose(self) -> ComposeResult:\n         yield Header(show_clock=True)\n-        yield Static(\"Enter the full cactus-prepare command and press Enter to submit.\", id=\"instructions\")\n+        instructions = (\n+            \"Enter a full cactus-prepare command and press Enter to submit. \"\n+            \"To reuse history, type `!N` (for example `!1`) and press Enter to load, then press Enter again to submit. \"\n+            \"Press F2 or Ctrl+Shift+W to open the argument wizard, F3 or Ctrl+Shift+T to pick a template, \"\n+            \"or type `:wizard` / `:template` directly in the prompt.\"\n+        )\n+        yield Static(instructions, id=\"instructions\")\n+        history_widget = Static(self._render_history(), id=\"history\")\n+        self._history_text = history_widget\n+        yield history_widget\n         command_input = Input(placeholder=\"cactus-prepare …\", id=\"command\")\n         self._command_input = command_input\n         yield command_input\n@@ -61,13 +209,38 @@ def compose(self) -> ComposeResult:\n \n     def on_mount(self) -> None:  # type: ignore[override]\n         if self._command_input:\n+            if self._history_entries:\n+                self._command_input.value = self._history_entries[0].command\n             self._command_input.focus()\n \n     def on_input_submitted(self, event: Input.Submitted) -> None:  # type: ignore[override]\n         command = event.value.strip()\n+        if command.startswith(\"!\"):\n+            if len(command) == 1:\n+                self._update_status(\"[red]Provide a history index, e.g. !1[/red]\")\n+                return\n+            try:\n+                index = int(command[1:]) - 1\n+            except ValueError:\n+                self._update_status(\"[red]History index must be a number, e.g. !1[/red]\")\n+                return\n+            if index < 0 or index >= len(self._history_entries):\n+                self._update_status(\"[red]History entry not found[/red]\")\n+                return\n+            selected = self._history_entries[index].command\n+            if self._command_input:\n+                self._command_input.value = selected\n+            self._update_status(f\"[green]Loaded history command #{index + 1}[/green]\")\n+            return\n         if not command:\n             self._update_status(\"[red]Command cannot be empty[/red]\")\n             return\n+        if command == \":wizard\":\n+            self.action_open_wizard()\n+            return\n+        if command == \":template\":\n+            self.action_choose_template()\n+            return\n         try:\n             tokens = shlex.split(command)\n         except ValueError as exc:\n@@ -87,10 +260,70 @@ def action_quit(self) -> None:\n         value = self._command_input.value.strip() if self._command_input else \"\"\n         self.exit(PromptResult(executable=\"\", args=value, action=\"quit\"))\n \n+    def action_open_wizard(self) -> None:\n+        defaults = self._suggest_defaults()\n+        self.push_screen(PrepareWizard(defaults), self._wizard_finished)\n+\n+    def action_choose_template(self) -> None:\n+        if not self._templates:\n+            self._update_status(\"[yellow]No templates available yet. Save history or add custom templates first.[/yellow]\")\n+            return\n+        self.push_screen(TemplateSelector(self._templates), self._template_chosen)\n+\n     def _update_status(self, message: str) -> None:\n         if self._status:\n             self._status.update(message)\n \n+    def _render_history(self) -> str:\n+        if not self._history_entries:\n+            return \"No history yet.\"\n+        lines: list[str] = [\"Recent history:\"]\n+        for idx, entry in enumerate(self._history_entries[:5], start=1):\n+            lines.append(f\"{idx}. {entry.command}\")\n+        if len(self._history_entries) > 5:\n+            lines.append(\"…\")\n+        return \"\\n\".join(lines)\n+\n+    def _wizard_finished(self, result: str | None) -> None:\n+        if not result:\n+            self._update_status(\"[yellow]Wizard cancelled[/yellow]\")\n+            return\n+        if self._command_input:\n+            self._command_input.value = result\n+        self._update_status(\"[green]Wizard generated a command. Press Enter to submit.[/green]\")\n+        self._template_defaults = None\n+\n+    def _template_chosen(self, template: templates.Template | None) -> None:\n+        if not template:\n+            self._update_status(\"[yellow]Template selection cancelled[/yellow]\")\n+            return\n+        command = template.build_command()\n+        if self._command_input:\n+            self._command_input.value = command\n+        self._template_defaults = template.to_wizard_defaults()\n+        self._update_status(f\"[green]Applied template: {template.name}[/green]\")\n+\n+    def _suggest_defaults(self) -> dict[str, str]:\n+        defaults: dict[str, str] = {}\n+        if self._template_defaults:\n+            defaults.update(self._template_defaults)\n+        if self._command_input and self._command_input.value.strip():\n+            try:\n+                tokens = shlex.split(self._command_input.value.strip())\n+            except ValueError:\n+                tokens = []\n+            if tokens and Path(tokens[0]).name == \"cactus-prepare\":\n+                parsed = tokens[1:]\n+                defaults.update(_tokens_to_defaults(parsed))\n+        elif self._history_entries:\n+            command = self._history_entries[0].command\n+            try:\n+                tokens = shlex.split(command)\n+            except ValueError:\n+                tokens = []\n+            defaults.update(_tokens_to_defaults(tokens[1:]))\n+        return defaults\n+\n \n def prompt_prepare_command() -> PromptResult:\n     \"\"\"Launch the Textual prompt and return the user's command selection.\"\"\"\n@@ -100,3 +333,53 @@ def prompt_prepare_command() -> PromptResult:\n     if isinstance(result, PromptResult):\n         return result\n     return PromptResult(executable=\"\", args=\"\", action=\"quit\")\n+\n+\n+def _tokens_to_defaults(tokens: list[str]) -> dict[str, str]:\n+    \"\"\"Helper that infers wizard defaults from an existing command.\"\"\"\n+\n+    defaults: dict[str, str] = {}\n+    if not tokens:\n+        return defaults\n+    # Spec is the first non-flag token\n+    for token in tokens:\n+        if not token.startswith(\"-\"):\n+            defaults[\"spec\"] = token\n+            break\n+    flag_map = {\n+        \"--outDir\": \"out_dir\",\n+        \"--outSeqFile\": \"out_seq\",\n+        \"--outHal\": \"out_hal\",\n+        \"--jobStore\": \"job_store\",\n+        \"--jobstore\": \"job_store\",\n+    }\n+    extra: list[str] = []\n+    i = 0\n+    while i < len(tokens):\n+        token = tokens[i]\n+        if token.startswith(\"--\") and \"=\" in token:\n+            flag, value = token.split(\"=\", 1)\n+            field = flag_map.get(flag)\n+            if field:\n+                defaults[field] = value\n+            else:\n+                extra.append(token)\n+            i += 1\n+            continue\n+        if token in flag_map:\n+            field = flag_map[token]\n+            if i + 1 < len(tokens) and not tokens[i + 1].startswith(\"--\"):\n+                defaults[field] = tokens[i + 1]\n+                i += 2\n+                continue\n+            extra.append(token)\n+            i += 1\n+            continue\n+        if not token.startswith(\"-\"):\n+            i += 1\n+            continue\n+        extra.append(token)\n+        i += 1\n+    if extra:\n+        defaults[\"extra\"] = \" \".join(extra)\n+    return defaults"
      },
      {
        "sha": "835c92cd5c2cd2e387047100bedf5435f58f3f55",
        "filename": "cax/history.py",
        "status": "added",
        "additions": 57,
        "deletions": 0,
        "changes": 57,
        "blob_url": "https://github.com/malabz/Cax/blob/d6c64fee265b51d1a91afa2586f3659ce2780f66/cax%2Fhistory.py",
        "raw_url": "https://github.com/malabz/Cax/raw/d6c64fee265b51d1a91afa2586f3659ce2780f66/cax%2Fhistory.py",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/cax%2Fhistory.py?ref=d6c64fee265b51d1a91afa2586f3659ce2780f66",
        "patch": "@@ -0,0 +1,57 @@\n+\"\"\"Simple history helper for cactus-prepare commands.\"\"\"\n+from __future__ import annotations\n+\n+from dataclasses import dataclass\n+import json\n+from pathlib import Path\n+from typing import Iterable, List\n+\n+HISTORY_FILE = Path(\"steps-output/cax_history.json\")\n+HISTORY_LIMIT = 20\n+\n+\n+@dataclass\n+class HistoryEntry:\n+    \"\"\"Represents a stored history command.\"\"\"\n+\n+    command: str\n+\n+\n+def load_history() -> list[HistoryEntry]:\n+    \"\"\"Load history entries, newest command first.\"\"\"\n+\n+    try:\n+        data = json.loads(HISTORY_FILE.read_text(encoding=\"utf-8\"))\n+        if not isinstance(data, list):\n+            return []\n+        entries: list[HistoryEntry] = []\n+        for item in data:\n+            if isinstance(item, str) and item.strip():\n+                entries.append(HistoryEntry(command=item))\n+        return entries\n+    except FileNotFoundError:\n+        return []\n+    except (OSError, json.JSONDecodeError):\n+        return []\n+\n+\n+def save_history(commands: Iterable[str]) -> None:\n+    \"\"\"Persist the provided command sequence to disk.\"\"\"\n+\n+    HISTORY_FILE.parent.mkdir(parents=True, exist_ok=True)\n+    normalized = [cmd for cmd in commands if cmd.strip()]\n+    HISTORY_FILE.write_text(json.dumps(normalized[:HISTORY_LIMIT], ensure_ascii=False, indent=2), encoding=\"utf-8\")\n+\n+\n+def add_command(command: str) -> None:\n+    \"\"\"Insert a command at the front of history with dedupe and trimming.\"\"\"\n+\n+    command = command.strip()\n+    if not command:\n+        return\n+    entries = load_history()\n+    merged: list[str] = [command]\n+    for entry in entries:\n+        if entry.command != command:\n+            merged.append(entry.command)\n+    save_history(merged)"
      },
      {
        "sha": "8f63adc32227c2927e29b9c98bc16f4452f0109e",
        "filename": "cax/templates.py",
        "status": "added",
        "additions": 98,
        "deletions": 0,
        "changes": 98,
        "blob_url": "https://github.com/malabz/Cax/blob/d6c64fee265b51d1a91afa2586f3659ce2780f66/cax%2Ftemplates.py",
        "raw_url": "https://github.com/malabz/Cax/raw/d6c64fee265b51d1a91afa2586f3659ce2780f66/cax%2Ftemplates.py",
        "contents_url": "https://api.github.com/repos/malabz/Cax/contents/cax%2Ftemplates.py?ref=d6c64fee265b51d1a91afa2586f3659ce2780f66",
        "patch": "@@ -0,0 +1,98 @@\n+\"\"\"Template management for cactus-prepare argument presets.\"\"\"\n+from __future__ import annotations\n+\n+from dataclasses import dataclass\n+import json\n+from pathlib import Path\n+import shlex\n+\n+TEMPLATE_FILE = Path(\"steps-output/cax_templates.json\")\n+EXAMPLE_DIR = Path(\"examples\")\n+FLAG_MAP = {\n+    \"out_dir\": \"--outDir\",\n+    \"out_seq\": \"--outSeqFile\",\n+    \"out_hal\": \"--outHal\",\n+    \"job_store\": \"--jobStore\",\n+    \"extra\": None,\n+}\n+\n+\n+@dataclass\n+class Template:\n+    \"\"\"A reusable cactus-prepare template.\"\"\"\n+\n+    name: str\n+    spec: str\n+    params: dict[str, str]\n+    source: str = \"builtin\"\n+\n+    def to_wizard_defaults(self) -> dict[str, str]:\n+        defaults = {\"spec\": self.spec}\n+        defaults.update(self.params)\n+        return defaults\n+\n+    def build_command(self, executable: str = \"cactus-prepare\") -> str:\n+        tokens: list[str] = [executable, self.spec]\n+        for key, flag in FLAG_MAP.items():\n+            value = self.params.get(key, \"\").strip()\n+            if not value:\n+                continue\n+            if key == \"extra\":\n+                tokens.extend(shlex.split(value))\n+                continue\n+            tokens.append(flag)\n+            tokens.append(value)\n+        return shlex.join(tokens)\n+\n+\n+def load_templates() -> list[Template]:\n+    templates: list[Template] = []\n+    templates.extend(_load_builtin_templates())\n+    templates.extend(_load_user_templates())\n+    return templates\n+\n+\n+def _load_builtin_templates() -> list[Template]:\n+    templates: list[Template] = []\n+    if not EXAMPLE_DIR.exists():\n+        return templates\n+    for path in sorted(EXAMPLE_DIR.glob(\"*.txt\")):\n+        stem = path.stem\n+        params = {\n+            \"out_dir\": \"steps-output\",\n+            \"out_seq\": f\"steps-output/{stem}.txt\",\n+            \"out_hal\": f\"steps-output/{stem}.hal\",\n+            \"job_store\": \"jobstore\",\n+        }\n+        templates.append(\n+            Template(\n+                name=f\"Example: {stem}\",\n+                spec=str(path),\n+                params=params,\n+                source=\"builtin\",\n+            )\n+        )\n+    return templates\n+\n+\n+def _load_user_templates() -> list[Template]:\n+    try:\n+        data = json.loads(TEMPLATE_FILE.read_text(encoding=\"utf-8\"))\n+    except FileNotFoundError:\n+        return []\n+    except (OSError, json.JSONDecodeError):\n+        return []\n+    if not isinstance(data, list):\n+        return []\n+    templates: list[Template] = []\n+    for item in data:\n+        if not isinstance(item, dict):\n+            continue\n+        name = str(item.get(\"name\") or \"\").strip()\n+        spec = str(item.get(\"spec\") or \"\").strip()\n+        params = item.get(\"params\") or {}\n+        if not name or not spec or not isinstance(params, dict):\n+            continue\n+        clean_params = {k: str(v) for k, v in params.items() if k in FLAG_MAP}\n+        templates.append(Template(name=name, spec=spec, params=clean_params, source=\"user\"))\n+    return templates"
      }
    ]
  }
}